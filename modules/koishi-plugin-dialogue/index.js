var he=Object.defineProperty;var Me=Object.getOwnPropertyDescriptor;var Le=Object.getOwnPropertyNames;var Ce=Object.prototype.hasOwnProperty;var me=(e,t)=>()=>(e&&(t=e(e=0)),t);var ve=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var ie=(e,t,a,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Le(t))!Ce.call(e,r)&&r!==a&&he(e,r,{get:()=>t[r],enumerable:!(i=Me(t,r))||i.enumerable});return e},H=(e,t,a)=>(ie(e,t,"default"),a&&ie(a,t,"default"));var O=e=>ie(he({},"__esModule",{value:!0}),e);import{Buffer as ne}from"https://registry.koishi.chat/modules/buffer/index.js";import oe from"https://registry.koishi.chat/modules/process/index.js";var R=me(()=>{});var E={};import*as lt from"https://registry.koishi.chat/modules/koishi/index.js";var j=me(()=>{R();H(E,lt)});var we=ve(L=>{"use strict";R();L.__esModule=!0;L.distance=L.closest=void 0;var q=new Uint32Array(65536),ze=function(e,t){for(var a=e.length,i=t.length,r=1<<a-1,n=-1,o=0,l=a,u=a;u--;)q[e.charCodeAt(u)]|=1<<u;for(u=0;u<i;u++){var d=q[t.charCodeAt(u)],c=d|o;d|=(d&n)+n^n,o|=~(d|n),n&=d,o&r&&l++,n&r&&l--,o=o<<1|1,n=n<<1|~(c|o),o&=c}for(u=a;u--;)q[e.charCodeAt(u)]=0;return l},Fe=function(e,t){for(var a=t.length,i=e.length,r=[],n=[],o=Math.ceil(a/32),l=Math.ceil(i/32),u=0;u<o;u++)n[u]=-1,r[u]=0;for(var d=0;d<l-1;d++){for(var c=0,s=-1,g=d*32,x=Math.min(32,i)+g,p=g;p<x;p++)q[e.charCodeAt(p)]|=1<<p;for(var u=0;u<a;u++){var v=q[t.charCodeAt(u)],y=n[u/32|0]>>>u&1,_=r[u/32|0]>>>u&1,b=v|c,m=((v|_)&s)+s^s|v|_,h=c|~(m|s),$=s&m;h>>>31^y&&(n[u/32|0]^=1<<u),$>>>31^_&&(r[u/32|0]^=1<<u),h=h<<1|y,$=$<<1|_,s=$|~(b|h),c=h&b}for(var p=g;p<x;p++)q[e.charCodeAt(p)]=0}for(var T=0,M=-1,W=d*32,fe=Math.min(32,i-W)+W,p=W;p<fe;p++)q[e.charCodeAt(p)]|=1<<p;for(var ae=i,u=0;u<a;u++){var v=q[t.charCodeAt(u)],y=n[u/32|0]>>>u&1,_=r[u/32|0]>>>u&1,b=v|T,m=((v|_)&M)+M^M|v|_,h=T|~(m|M),$=M&m;ae+=h>>>i-1&1,ae-=$>>>i-1&1,h>>>31^y&&(n[u/32|0]^=1<<u),$>>>31^_&&(r[u/32|0]^=1<<u),h=h<<1|y,$=$<<1|_,M=$|~(b|h),T=h&b}for(var p=W;p<fe;p++)q[e.charCodeAt(p)]=0;return ae},ye=function(e,t){if(e.length<t.length){var a=t;t=e,e=a}return t.length===0?e.length:e.length<=32?ze(e,t):Fe(e,t)};L.distance=ye;var Qe=function(e,t){for(var a=1/0,i=0,r=0;r<t.length;r++){var n=ye(e,t[r]);n<a&&(a=n,i=r)}return t[i]};L.closest=Qe});var rt=ve((st,De)=>{R();var N=Object.defineProperty,We=Object.getOwnPropertyDescriptor,xe=Object.getOwnPropertyNames,He=Object.prototype.hasOwnProperty,f=(e,t)=>N(e,"name",{value:t,configurable:!0}),Be=(e,t)=>function(){return t||(0,e[xe(e)[0]])((t={exports:{}}).exports,t),t.exports},Ue=(e,t)=>{for(var a in t)N(e,a,{get:t[a],enumerable:!0})},Ne=(e,t,a,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of xe(t))!He.call(e,r)&&r!==a&&N(e,r,{get:()=>t[r],enumerable:!(i=We(t,r))||i.enumerable});return e},Ze=e=>Ne(N({},"__esModule",{value:!0}),e),Ge=Be({"plugins/dialogue/packages/core/src/locales/zh.yml"(e,t){t.exports={commands:{teach:{description:"添加教学对话",options:{search:"搜索已有问答",page:"设置搜索结果的页码",autoMerge:"自动合并相同的问题和回答",recursive:"禁用递归查询",pipe:"对每个搜索结果执行操作",review:"查看最近的修改",revert:"回退最近的修改",includeLast:"包含最近的修改数量",excludeLast:"排除最近的修改数量",target:"查看或修改已有问题",remove:"彻底删除问答",ignoreHint:"忽略智能提示","regexp.true":"使用正则表达式匹配","regexp.false":"取消使用正则表达式匹配",redirect:"重定向到其他问答",probabilityStrict:"设置问题的触发权重",probabilityAppellative:"设置被称呼时问题的触发权重"},messages:{"options-conflict":"选项 {0} 不能同时使用。","too-many-arguments":"存在多余的参数，请检查指令语法或将含有空格或换行的问答置于一对引号内。","missing-question-or-answer":"缺少问题或回答，请检查指令语法。","prohibited-command":"禁止在教学回答中插值调用 {0} 指令。","prohibited-cq-code":"问题必须是纯文本。","illegal-regexp":"问题含有错误的或不支持的正则表达式语法。","probably-modify-answer":"推测你想修改的是回答而不是问题。发送句号以修改回答，使用 -I 选项以忽略本提示。","probably-regexp":"推测你想{0}的问题是正则表达式。发送句号以添加 -x 选项，使用 -I 选项以忽略本提示。","upload-failed":"上传资源时发生错误。",redirections:"重定向到：","create-success":"问答已添加，编号为 {0}。","modify-success":"问答 {0} 已成功修改。","remove-success":"问答 {0} 已成功删除。","revert-success":"问答 {0} 已回退完成。",unchanged:"问答 {0} 没有发生改动。","create-modified":"修改了已存在的问答，编号为 {0}。","create-unchanged":"问答已存在，编号为 {0}，如要修改请尝试使用 {1} 指令。","revert-unknown":"最近无人修改过编号为 {0} 的问答。","modify-unknown":"没有搜索到编号为 {0} 的问答。","permission-denied":"问答 {0} 因权限过低无法{1}。","low-permission":"该问答因权限过低无法添加。","unknown-error":"{0}问答时遇到错误。","no-history":"没有搜索到满足条件的教学操作。","recent-history":"近期执行的教学操作有：","max-previews":"一次最多同时预览 {0} 个问答。",review:"{0}于：<i18n:time value={1}/>前","detail-header":"问答 {0} 的{1}：",detail:"{0}：{1}",entity:{question:"问题",answer:"回答",regexp:"正则",detail:"详细信息",history:"历史版本"},operation:{create:"添加",modify:"修改",remove:"删除",revert:"回退"},search:{count:"共 {0} 个",empty:"没有搜索到任何问答。",regexp:"正则","regexp-hint":"，请尝试使用正则表达式匹配",probability:"实际触发概率：","result-all":"全部问答如下{2}：","result-answer":"回答“{1}”的问题如下{2}：","result-question":"问题“{0}”的回答如下{2}：","result-dialogue":"“{0}”“{1}”匹配的回答如下{2}：","result-regexp-answer":"回答正则表达式“{1}”的搜索结果如下{2}：","result-regexp-question":"问题正则表达式“{0}”的搜索结果如下{2}：","result-regexp-dialogue":"问答正则表达式“{0}”“{1}”的搜索结果如下{2}：","empty-all":"没有搜索到任何回答，尝试切换到其他环境。","empty-answer":"没有搜索到回答“{1}”{2}。","empty-question":"没有搜索到问题“{0}”{2}。","empty-dialogue":"没有搜索到问答“{0}”“{1}”{2}。","empty-regexp-answer":"没有搜索到含有正则表达式“{1}”的回答。","empty-regexp-question":"没有搜索到含有正则表达式“{0}”的问题。","empty-regexp-dialogue":"没有搜索到含有正则表达式“{0}”“{1}”的问答。","page-hint":" (第 {0}/{1} 页)","page-footer":"可以使用 /+页码 以调整输出的条目页数。"},probability:{detail:"触发权重：p={probS}, P={probA}","zero-to-one":"应为不超过 1 的正数。"}}},dialogue:{description:"触发教学对话",stats:{messages:{output:"共收录了 {questions} 个问题和 {dialogues} 个回答。"}}}}}}}),$e={};Ue($e,{Dialogue:()=>S,DialogueService:()=>le,MessageBuffer:()=>se,OrderedList:()=>K,RE_DIALOGUES:()=>Xe,analyze:()=>te,apply:()=>Ie,create:()=>re,equal:()=>Ae,escapeAnswer:()=>z,formatAbstract:()=>J,formatAnswer:()=>Z,formatAnswers:()=>X,formatPrefix:()=>V,getAbstract:()=>G,getTotalWeight:()=>Y,handleError:()=>Q,isZeroToOne:()=>U,name:()=>et,prepareTargets:()=>ee,schema:()=>Ye,sendResult:()=>D,split:()=>ce,triggerDialogue:()=>C,unescapeAnswer:()=>pe,using:()=>tt});De.exports=Ze($e);var w=(j(),O(E)),A=(j(),O(E)),Je=",,.~?!()[]",_e="，、。～？！（）【】",Ve=new RegExp(`[${_e}]`);function Se(e,t="",a=""){return e.length?new RegExp(`^${t}(${e.map(A.escapeRegExp).join("|")})${a}`):/$^/}f(Se,"createLeadingRE");var le=class extends A.Service{constructor(e,t){super(e,"dialogue",!0),this.config=t,this.states=Object.create(null),this.history=Object.create(null),e.model.extend("dialogue",{id:"unsigned",flag:"unsigned(4)",probS:{type:"decimal",precision:4,scale:3,initial:1},probA:{type:"decimal",precision:4,scale:3,initial:0},original:"string(255)",question:"string(255)",answer:"text"},{autoInc:!0}),this.nameRE=Se((0,A.makeArray)(e.root.config.nickname),"@?","([,，]\\s*|\\s+|$)")}flag(e){this.ctx.before("dialogue/search",(t,a)=>{a[e]=t.argv.options[e]}),this.ctx.on("dialogue/modify",(t,a)=>{let{options:i}=t.argv;i[e]!==void 0&&(a.flag&=~S.Flag[e],a.flag|=+i[e]*S.Flag[e])}),this.ctx.on("dialogue/query",(t,a)=>{t[e]!==void 0&&a.$and.push({flag:{[t[e]?"$bitsAllSet":"$bitsAllClear"]:S.Flag[e]}})})}async stats(){let e=this.ctx.database.select("dialogue"),[t,a]=await Promise.all([e.execute(i=>A.$.count(i.id)),e.execute(i=>A.$.count(i.question))]);return{dialogues:t,questions:a}}async get(e,t){if(Array.isArray(e)){let a=await this.ctx.database.get("dialogue",e,t);return a.forEach(i=>(0,A.defineProperty)(i,"_backup",(0,A.clone)(i))),a}else{let a={$and:[]};this.ctx.emit("dialogue/query",e,a);let i=await this.ctx.database.get("dialogue",a);return i.forEach(r=>(0,A.defineProperty)(r,"_backup",(0,A.clone)(r))),i}}async update(e,t){let a=[],{options:i}=t.argv;for(let r of e)Object.keys(r.$diff).length?(i.updated.push(r.id),a.push({...r.$diff,id:r.id}),r.$diff={},this.addHistory(r._backup,"modify",t,!1)):i.skipped.push(r.id);await this.ctx.database.upsert("dialogue",a)}async remove(e,t,a=!1){let i=e.map(r=>r.id);for(let r of i)this.addHistory(t.argv.options.dialogueMap[r],"remove",t,a);return await this.ctx.database.remove("dialogue",i),i}async revert(e,t){let a=e.filter(r=>r._type==="create"),i=e.filter(r=>r._type!=="create");return await this.remove(a,t,!0),await this.recover(i,t),t.text(".revert-success",[e.map(r=>r.id).sort((r,n)=>r-n).join(", ")])}async recover(e,t){await this.ctx.database.upsert("dialogue",e);for(let a of e)this.addHistory(a,"modify",t,!0)}addHistory(e,t,a,i){if(i)return delete this.history[e.id];this.history[e.id]=e;let r=Date.now();(0,A.defineProperty)(e,"_timestamp",r),(0,A.defineProperty)(e,"_operator",a.userId),(0,A.defineProperty)(e,"_type",t),this.ctx.setTimeout(()=>{var n;((n=this.history[e.id])==null?void 0:n._timestamp)===r&&delete this.history[e.id]},this.config.historyTimeout)}stripQuestion(e){let t=A.segment.unescape(e);e=A.segment.transform(e,{text({content:r}){return A.segment.unescape(""+r).toLowerCase().replace(/\s+/g,"").replace(Ve,n=>Je[_e.indexOf(n)])}}),e=e.replace(/^\(*/,""),e=e.replace(/[\.,?!()~]*$/,"");let a=this.nameRE.exec(e),i=a?e.slice(a[0].length):e;return{original:t,parsed:i||e,appellative:i&&i!==e,activated:!i&&i!==e}}formatDialogue(e,t){let a=G(e,t),{original:i,answer:r}=t,n=e.text(`commands.teach.messages.entity.${a.questionType||"question"}`),o=e.text(`commands.teach.messages.entity.${a.answerType||"answer"}`);return[e.text("commands.teach.messages.detail",[J(t,a)+n,i]),e.text("commands.teach.messages.detail",[o,Z(r,this.config)])].join(e.text("general.comma"))}list(e,t,a=""){return t.map(i=>{let r=[a+this.formatDialogue(e,i)];return this.ctx.emit("dialogue/appendix",i,r,a,e),r.join(`
`)})}};f(le,"DialogueService");function Z(e,{maxAnswerLength:t=100}){let a=!1,i=e.split(/(\r?\n|\$n)/g);return i.length>1&&(a=!0,e=i[0].trim()),e=e.replace(/<image [^>]+>/g,"[图片]"),e.length>t&&(a=!0,e=e.slice(0,t)),a&&!e.endsWith("……")&&(e.endsWith("…")?e+="…":e+="……"),e}f(Z,"formatAnswer");function G(e,t){let a=[];return e.app.emit("dialogue/abstract",t,a,e),a}f(G,"getAbstract");function J(e,t){return`${e.id}. ${t.length?`[${t.join(", ")}] `:""}`}f(J,"formatAbstract");function V(e,t,a=!1){let i=G(e,t),r=J(t,i);return i.questionType&&(r+=`[${e.text("commands.teach.messages.entity."+i.questionType)}] `),a&&i.answerType&&(r+=`[${e.text("commands.teach.messages.entity."+i.answerType)}] `),r}f(V,"formatPrefix");function X(e,t,a=""){let i=e.app;return t.map(r=>{let{answer:n}=r,o=[`${a}${V(e,r,!0)}${Z(n,i.dialogue.config)}`];return i.emit("dialogue/appendix",r,o,a,e),o.join(`
`)})}f(X,"formatAnswers");var P=(j(),O(E));function ce(e){return e?e.split(",").flatMap(t=>{if(!t.includes(".."))return+t;let a=t.split(".."),i=+a[0],r=+a[1];return r<i?[]:new Array(r-i+1).fill(0).map((n,o)=>i+o)}):[]}f(ce,"split");function Ae(e,t){return e.slice().sort().join()===t.slice().sort().join()}f(Ae,"equal");var Xe=/^\d+(\.\.\d+)?(,\d+(\.\.\d+)?)*$/,K=class{constructor(){this.output=[]}add(e,t){t??(t=0);let a=this.output.findIndex(i=>i[1]<t);a>=0?this.output.splice(a,0,[e,t]):this.output.push([e,t])}toString(){return this.output.map(e=>e[0]).join(`
`)}};f(K,"OrderedList");var Ke=f((e,t)=>{let{authority:a}=e.user,{authority:i,prefix:r}=t,n=r[r.length-1],o=new K;return o.add(`教学系统基本用法：
　添加问答：${r} 问题 回答
　搜索回答：${r}${n} 问题
　搜索问题：${r}${n} ~ 回答
　查看问答：${r}id
　修改问题：${r}id 问题
　修改回答：${r}id ~ 回答
　删除问答：${r}id -r
　批量查看：${r}${n}id
搜索选项：
　管道语法：　　　|
　结果页码：　　　/ page
　禁用递归查询：　-R${a>=i.regExp?`
　正则+合并结果：${r}${n}${n}`:""}`,1e3),o.add("问答选项：",600),o.add(`　忽略智能提示：　-I
　重定向：　　　　=>`,510),o.add("匹配规则：",500),a>=i.regExp&&o.add("　正则表达式：　　-x/-X",490),o.add(`　严格匹配权重：　-p prob
　称呼匹配权重：　-P prob`,480),o.add(`回退功能：
　查看近期改动：　-v
　回退近期改动：　-V
　设置查看区间：　-l/-L
特殊语法：
　$$：一个普通的 $ 字符
　$0：收到的原文本
　$n：分条发送
　$a：@说话人
　$m：@${e.app.config.nickname[0]}
　$s：说话人的名字
　$()：指令插值
　\${}：表达式插值`,0),e.app.emit("dialogue/usage",o,e),o.toString()},"cheatSheet");function Ee(e,t){let{prefix:a}=t,i="\\d+(?:\\.\\.\\d+)?",r=a[a.length-1],n=(0,P.escapeRegExp)(a),o=(0,P.escapeRegExp)(r),l=new RegExp(`^${n}(${o}?)((${i}(?:,${i})*)?|${o}?)$`);e.before("parse",(u,d)=>{let c=P.Argv.parse(u);if(d.quote||!c.tokens.length)return;let s=c.tokens[0].content;d.parsed.prefix&&(s=d.parsed.prefix+s);try{P.segment.transform(s,{text:!0,default:()=>{throw new Error}})}catch{return}s=P.segment.unescape(s);let g=l.exec(s);if(!g)return;c.tokens.shift(),c.tokens.forEach(P.Argv.revert),c.source=d.parsed.content,c.options={};let{length:x}=c.tokens;if(g[1]===r){if(!c.tokens.length)return c.name="dialogue.stats",c;c.options.action="search",g[2]===r&&(c.options.autoMerge=!0,c.options.regexp=!0)}else!g[2]&&!x&&(c.options.help=!0);return g[2]&&g[2]!==r&&(c.options.target=(0,P.deduplicate)(ce(g[2]))),c.name="teach",c}),e.command("teach",{authority:t.authority.base,checkUnknown:!0,hideOptions:!0}).userFields(["authority","id"]).option("target","").usage(u=>Ke(u,t)).before(({session:u})=>e.serial("dialogue/before-action",u),!0).action(({session:u})=>e.bail("dialogue/action",u))}f(Ee,"command");var k=(j(),O(E));function z(e){return e.replace(/\$/g,"@@__PLACEHOLDER__@@")}f(z,"escapeAnswer");function pe(e){return e.replace(/@@__PLACEHOLDER__@@/g,"$")}f(pe,"unescapeAnswer");k.Context.prototype.getSessionState=function(e){let{channelId:t,userId:a,app:i}=e;i.dialogue.states[t]||this.emit("dialogue/state",i.dialogue.states[t]={channelId:t});let r=Object.create(i.dialogue.states[t]);return r.session=e,r.userId=a,r};async function Y(e,t){let{session:a,dialogues:i}=t;e.emit(a,"dialogue/prepare",t);let r=new Set(["name","flag"]);return e.emit(a,"dialogue/before-attach-user",t,r),await a.observeUser(r),e.bail(a,"dialogue/attach-user",t)?0:i.reduce((n,o)=>n+o._weight,0)}f(Y,"getTotalWeight");var se=class{constructor(e){this.session=e,this.buffer="",this.original=!1,this.hasData=!1,this.send=e.send.bind(e),this.sendQueued=e.sendQueued.bind(e),e.send=async t=>{if(t){if(this.hasData=!0,this.original)return this.send(t);this.buffer+=t}},e.sendQueued=async(t,a)=>{if(t)return this.hasData=!0,this.original?this.sendQueued(t,a):this._flush(this.buffer+t,a)}}write(e){e&&(this.hasData=!0,this.buffer+=e)}async _flush(e,t){this.original=!0,e=e.trim();let a=await this.sendQueued(e,t);return this.buffer="",this.original=!1,a}flush(){return this._flush(this.buffer)}async execute(e){this.original=!1;let t=this.session.send,a=this.session.sendQueued;await this.session.execute(e),this.session.sendQueued=a,this.session.send=t,this.original=!0}async end(e=""){this.write(e),await this.flush(),this.original=!0,delete this.session.send,delete this.session.sendQueued}};f(se,"MessageBuffer");var de=new k.Argv.Tokenizer;de.interpolate("$n","",e=>({rest:e,tokens:[],source:""}));async function C(e,t,a=k.noop){if(!t.content)return;let i=e.getSessionState(t);if(i.next=a,i.test={},e.bail("dialogue/receive",i))return a();let r=e.logger("dialogue");r.debug("[receive]",t.messageId,t.content);let n=i.dialogues=await e.dialogue.get(i.test),o,l=await Y(e,i);if(!l)return a();let u=k.Random.real(Math.max(1,l)),d=0;for(let p of n)if(d+=p._weight,u<d){o=p;break}if(!o)return a();if(r.debug("[attach]",t.messageId),i.dialogue=o,i.dialogues=[o],i.answer=o.answer.replace(/\$\$/g,"@@__PLACEHOLDER__@@").replace(/\$A/g,(0,k.segment)("at",{type:"all"}).toString()).replace(/\$a/g,(0,k.segment)("at",{id:t.userId}).toString()).replace(/\$m/g,(0,k.segment)("at",{id:t.selfId}).toString()).replace(/\$s/g,()=>z(t.username)).replace(/\$0/g,z(t.content)),o.flag&S.Flag.regexp){let p=o._capture||new RegExp(o.original,"i").exec(i.test.original);if(!p)return;p.forEach((v,y)=>{y&&y<=9&&(i.answer=i.answer.replace(new RegExp(`\\$${y}`,"g"),z(v||"")))})}if(await e.serial(t,"dialogue/before-send",i))return;r.debug("[send]",t.messageId,"->",o.answer);let c=new se(t);t._redirected=(t._redirected||0)+1;let s,{content:g,inters:x}=de.parseToken(pe(i.answer));for(;x.length;){let p=x.shift();c.write(g.slice(s,p.pos)),p.initiator==="$n"?await c.flush():await c.execute(p),s=p.pos}await c.end(g.slice(s)),await e.parallel(t,"dialogue/send",i)}f(C,"triggerDialogue");function qe(e,t){let{maxRedirections:a=3}=t,i=e.guild();e.before("attach",n=>{if(n.parsed.appel)return;let{activated:o}=e.getSessionState(n);o[n.userId]&&(n.parsed.appel=!0)}),i.middleware(async(n,o)=>C(e,n,o)),e.on("notice/poke",async n=>{if(n.targetId!==n.selfId)return;let{flag:o}=await n.observeChannel(["flag"]);o&k.Channel.Flag.ignore||(n.content="hook:poke",C(e,n))});async function r(n,o){let{flag:l,assignee:u}=await o.observeChannel(["flag","assignee"]);u===o.selfId&&(l&k.Channel.Flag.ignore||(o.content="hook:"+n+(o.userId===o.selfId?":self":":others"),C(e,o)))}f(r,"triggerNotice"),e.on("notice/honor",async n=>{await r(n.subsubtype,n)}),e.on("guild-member-added",r.bind(null,"join")),e.on("guild-member-deleted",r.bind(null,"leave")),e.on("dialogue/receive",({session:n})=>{var o;if(((o=n.user)==null?void 0:o.authority)<t.authority.receive)return!0}),e.on("dialogue/receive",({session:n,test:o})=>{if(n.content.includes("<image "))return!0;let{original:l,parsed:u,appellative:d,activated:c}=e.dialogue.stripQuestion(n.content);o.question=u,o.original=l,o.activated=c,o.appellative=d}),e.before("dialogue/attach-user",({dialogues:n,session:o},l)=>{for(let u of n){let{inters:d}=de.parseToken(u.answer);for(let c of d)o.collect("user",c,l)}}),i.command("dialogue <message:text>").action(async({session:n},o="")=>{if(!(n._redirected>a))return n.content=o,C(e,n)})}f(qe,"receiver");function ke(e){e.command("dialogue.stats").action(async({session:t})=>{let a=await e.dialogue.stats();return t.text(".output",a)}),e.command("teach").option("page","/ <page:posint>").option("autoMerge","").option("recursive","-R",{value:!1}).option("pipe","| <op:text>"),e.on("dialogue/appendix",({_redirections:t},a,i,r)=>{t&&a.push(...X(r,t,i+"= "))}),e.on("dialogue/abstract",({flag:t},a)=>{t&S.Flag.regexp&&(a.questionType="regexp")}),e.before("dialogue/search",({argv:t},a)=>{a.noRecursive=t.options.recursive===!1}),e.before("dialogue/search",({argv:t},a)=>{a.appellative=t.options.appellative}),e.on("dialogue/search",async(t,a,i)=>{let{options:r}=t.argv;r.questionMap||(r.questionMap={[a.question]:i});for(let n of i){let{answer:o}=n;if(!o.startsWith("%{dialogue "))continue;let{original:l,parsed:u}=e.dialogue.stripQuestion(o.slice(11,-1).trimStart());if(u in r.questionMap)continue;let d=r.questionMap[u]=await e.dialogue.get({...a,regexp:null,question:u,original:l});Object.defineProperty(n,"_redirections",{writable:!0,value:d}),await e.parallel("dialogue/search",t,a,d)}}),e.on("dialogue/action",t=>{let{options:a}=t.argv;if(a.action==="search")return je(t)},!0)}f(ke,"apply");async function je(e){let t=e.app,{options:a,args:[i,r]}=e.argv,{regexp:n,page:o=1,original:l,pipe:u,recursive:d,autoMerge:c}=a,{itemsPerPage:s=30,mergeThreshold:g=5}=t.dialogue.config,x={question:i,answer:r,regexp:n,original:l};if(t.bail("dialogue/before-search",e,x))return"";let p=await t.dialogue.get(x);if(u){if(!p.length)return e.text(".search.empty");let b=t.command("teach"),m={...b.parse(u),session:e,command:b},h=m.options.target=p.map($=>$.id).join(",");return m.source=`#${h} ${u}`,b.execute(m)}if(d!==!1&&!c&&await t.parallel("dialogue/search",e,x,p),!l&&!r)return p.length?_(".search.result-all",t.dialogue.list(e,p)):y(".search.empty-all");if(!a.regexp){let b=a.regexp!==!1?e.text(".search.regexp-hint"):"";if(l)if(r){if(!p.length)return y(".search.empty-dialogue",b);let m=[p.map(h=>h.id).join(", ")];return _(".search.result-dialogue",m)}else{if(!p.length)return y(".search.empty-question",b);let m=X(e,p),h=t.getSessionState(e);h.isSearch=!0,h.test=x,h.dialogues=p;let $=await Y(t,h),T=p.length>1?e.text(".search.probability")+Math.min($,1).toFixed(3):"";return _(".search.result-question",m,T)}else{if(!p.length)return y(".search.empty-answer",b);let m=p.map(h=>`${V(e,h)}${h.original}`);return _(".search.result-answer",m)}}let v;if(!c||i&&r)v=t.dialogue.list(e,p);else{let b={};for(let h of p){let $=i?h.original:h.answer;b[$]||(b[$]=[]),b[$].push(h.id)}let m=e.text("commands.teach.messages.entity."+(i?"answer":"question"));v=Object.keys(b).map(h=>{let{length:$}=b[h];return $<=g?`${h} (#${b[h].join(", #")})`:`${h} (${e.text(".search.count",[$])}${m})`})}if(l)return r?p.length?_(".search.result-regexp-dialogue",v):y(".search.empty-regexp-dialogue"):p.length?_(".search.result-regexp-question",v):y(".search.empty-regexp-question");return p.length?_(".search.result-regexp-answer",v):y(".search.empty-regexp-answer");function y(b,m){return e.text(b,[l,r,m])}function _(b,m,h){if(m.length<=s)m.unshift(e.text(b,[l,r])),h&&m.push(h);else{let $=Math.ceil(m.length/s);m=m.slice((o-1)*s,o*s);let T=e.text(".search.page-hint",[o,$]);m.unshift(e.text(b,[l,r,T])),h&&m.push(h),m.push(e.text(".search.page-footer"))}return m.join(`
`)}}f(je,"showSearch");var I=(j(),O(E));function Te(e){e.command("teach").option("action","-r",{value:"remove"}),e.on("dialogue/action",t=>{let{options:a}=t.argv;if(a.target)return te(t)},!0),e.on("dialogue/action",t=>re(t)),e.before("dialogue/detail",async t=>{let{action:a,dialogues:i}=t.argv.options;a!=="modify"&&await e.parallel("dialogue/search",t,{},i)}),e.on("dialogue/detail",({original:t,answer:a,flag:i},r,n)=>{let o=n.text(`.entity.${i&S.Flag.regexp?"regexp":"question"}`);r.add(n.text(".detail",[o,I.h.parse(t)]),1100),r.add(n.text(".detail",[n.text(".entity.answer"),I.h.parse(a)]),1e3)})}f(Te,"apply");async function Q(e,t){try{return await t(e)}catch(a){let{action:i}=e.argv.options;return e.app.logger("dialogue").warn(a),e.text(".unknown-error",[e.text(`.operation.${i}`)])}}f(Q,"handleError");function ee(e,t){let{options:a}=e.argv;t||(t=a.dialogues);let i=t.filter(r=>!e.app.bail("dialogue/permit",e,r));return a.forbidden.unshift(...(0,I.difference)(t,i).map(r=>r.id)),i.map(r=>(0,I.observe)(r))}f(ee,"prepareTargets");function ge(e){let{options:t}=e.argv;t.forbidden=[],t.updated=[],t.skipped=[]}f(ge,"prepareModifyOptions");async function te(e){let t=e.app,{options:a,args:i}=e.argv,{maxPreviews:r=10,previewDelay:n=500}=t.dialogue.config,{target:o,action:l}=a;if(!a.action&&(Object.keys(a).length>1||i.length))a.action="modify";else if(!a.action&&o.length>r)return e.text(".max-previews",[r]);ge(e);let u=a.dialogues=l==="review"||l==="revert"?Object.values((0,I.pick)(t.dialogue.history,o)).filter(Boolean):await t.dialogue.get(o);a.dialogueMap=Object.fromEntries(u.map(c=>[c.id,{...c}]));let d=a.dialogues.map(c=>c.id);if(a.unknown=(0,I.difference)(o,d),await t.serial("dialogue/before-detail",e),!a.action){a.unknown.length&&await e.send(e.text(`.${a.action==="review"?"revert":"modify"}-unknown`,[a.unknown.join(", ")]));for(let c=0;c<u.length;c++){let s=e.text(`.entity.${a.action==="review"?"history":"detail"}`),g=new K;g.add(e.text(".detail-header",[u[c].id,s]),1/0),t.emit("dialogue/detail",u[c],g,e),c&&await(0,I.sleep)(n),await e.send(g.toString())}return""}return Q(e,async()=>{let c=ee(e);if(l==="revert"){let s=c.length?await t.dialogue.revert(c,e):"";return D(e,s)}if(l==="remove"){let s="";if(c.length){let g=await t.dialogue.remove(c,e);s=e.text(".remove-success",[g.join(", ")])}return await t.serial("dialogue/after-modify",e),D(e,s)}if(c.length){let s=await t.serial("dialogue/before-modify",e);if(typeof s=="string")return s;for(let g of c)t.emit("dialogue/modify",e,g);await t.dialogue.update(c,e),await t.serial("dialogue/after-modify",e)}return D(e)})}f(te,"analyze");async function re(e){let{options:t,args:[a,i]}=e.argv,r=e.app;t.action="create",t.unknown=[],ge(e),t.dialogues=await r.dialogue.get({question:a,answer:i,regexp:!1}),await r.serial("dialogue/before-detail",e);let n=await r.serial("dialogue/before-modify",e);if(typeof n=="string")return n;if(t.dialogues.length){t.target=t.dialogues.map(u=>u.id),t.dialogueMap=Object.fromEntries(t.dialogues.map(u=>[u.id,u]));let l=ee(e);for(let u of l)r.emit("dialogue/modify",e,u);return await r.dialogue.update(l,e),await r.serial("dialogue/after-modify",e),D(e)}let o={flag:0};return r.bail("dialogue/permit",e,o)?e.text(".low-permission"):Q(e,async()=>{r.emit("dialogue/modify",e,o);let l=await r.database.create("dialogue",o);return r.dialogue.addHistory(o,"create",e,!1),t.dialogues=[l],await r.serial("dialogue/after-modify",e),D(e,e.text(".create-success",[t.dialogues[0].id]))})}f(re,"create");function D(e,t,a){let{prefix:i}=e.app.dialogue.config,{action:r,forbidden:n,unknown:o,skipped:l,updated:u,target:d}=e.argv.options,c=[];if(t&&c.push(t),u.length&&(r==="create"?c.push(e.text(".create-modified",[u.join(", ")])):c.push(e.text(".modify-success",[u.join(", ")]))),l.length&&(r==="create"?c.push(e.text(".create-unchanged",[d.join(", "),i+l.join(",")])):c.push(e.text(".unchanged",[l.join(", ")]))),n.length){let s=e.text(".operation."+(r==="create"?"modify":r));c.push(e.text(".permission-denied",[n.join(", "),s]))}return o.length&&c.push(e.text(`.${r==="revert"?"revert":"modify"}-unknown`,[o.join(", ")])),a&&c.push(a),c.join(`
`)}f(D,"sendResult");var F=(j(),O(E));function Oe(e){e.command("teach").option("action","-v",{value:"review"}).option("action","-V",{value:"revert"}).option("includeLast","-l [count]",{type:ue}).option("excludeLast","-L [count]",{type:ue}),e.on("dialogue/action",t=>{let{options:a}=t.argv,{includeLast:i,excludeLast:r,action:n,target:o}=a;if(n!=="review"&&n!=="revert"||o)return;let l=Date.now(),u=F.Time.parseTime(i),d=F.Time.parseTime(r),c=Object.values(e.dialogue.history).filter(s=>{if(s._operator!==t.userId)return;let g=l-s._timestamp;if(!(u&&g>=u)&&!(d&&g<d))return!0}).sort((s,g)=>g._timestamp-s._timestamp).filter((s,g,x)=>{if(!(!u&&i&&g>=+i)&&!(!d&&r&&g<x.length-+r))return!0});if(!c.length)return t.text(".no-history");if(n==="review"){let s=c.map(g=>t.app.dialogue.formatDialogue(t,g));return s.unshift(t.text(".recent-history")),s.join(`
`)}return Q(t,()=>t.app.dialogue.revert(c,t))},!0),e.on("dialogue/abstract",({_type:t,_timestamp:a},i,r)=>{t&&i.unshift(`${r.text(`.operation.${t}`)}-${F.Time.format(Date.now()-a)}`)}),e.on("dialogue/detail",({_type:t,_timestamp:a},i,r)=>{t&&i.add(r.text(".review",[r.text(`.operation.${t}`),Date.now()-a]),-100)})}f(Oe,"apply");function ue(e){let t=+e;if(t*0===0){if((0,F.isInteger)(t)&&t>0)return t;throw new Error}else{if(F.Time.parseTime(e))return e;throw new Error}}f(ue,"isIntegerOrInterval");var B=(j(),O(E)),be=we();function Re(e,t){e.command("teach").option("ignoreHint","-I").option("regexp","-x",{authority:t.authority.regExp}).option("regexp","-X",{value:!1}).option("redirect","=> <answer:string>"),e.before("dialogue/action",r=>{function n(){if(!l.length)return"";let x=l.shift();return!x||x==="~"||x==="～"?"":x.trim()}f(n,"parseArgument");let{options:o,args:l}=r.argv,u=n(),d=o.redirect?`$(dialogue ${o.redirect})`:n();if(l.length)return r.text(".too-many-arguments");try{u=B.segment.transform(u,{text:!0,face:!0,default(){throw new Error}})}catch{return r.text(".prohibited-cq-code")}let{original:c,parsed:s,appellative:g}=o.regexp?{original:B.segment.unescape(u),parsed:u,appellative:!1}:e.dialogue.stripQuestion(u);(0,B.defineProperty)(o,"appellative",g),(0,B.defineProperty)(o,"original",c),l[0]=s,l[1]=d,!l[0]&&!l[1]&&l.splice(0,1/0)});function a(r,n){return n.every(o=>{let l=(0,be.distance)(r,o.answer);return l<o.answer.length/2&&l<(0,be.distance)(r,o.question)})}f(a,"maybeAnswer");function i(r){return r.startsWith("^")||r.endsWith("$")}f(i,"maybeRegExp"),e.before("dialogue/modify",async r=>{let{options:n,args:o}=r.argv,{ignoreHint:l,regexp:u,target:d,dialogues:c}=n,[s,g]=o;function x(p){return p.withScope("commands.teach.messages",()=>p.argv.options.target?te(p):re(p))}if(f(x,"applySuggestion"),d&&!l&&s&&!g&&a(s,c)){let p=r.middleware(({content:v},y)=>(p(),v=v.trim(),v&&v!=="."&&v!=="。"?y():(o[1]=n.original,o[0]="",x(r))));return r.text(".probably-modify-answer")}if(s&&!u&&i(s)&&!l&&(!d||!c.every(p=>p.flag&S.Flag.regexp))){let p=r.middleware(({content:y},_)=>(p(),y=y.trim(),y&&y!=="."&&y!=="。"?_():(n.regexp=!0,x(r)))),v=r.text(".operation",[d?"modify":"create"]);return r.text(".probably-regexp",[v])}if(u||u!==!1&&s&&c.some(p=>p.flag&S.Flag.regexp)){let p=s?[s]:c.map(v=>v.question);try{p.forEach(v=>new RegExp(v))}catch{return r.text(".illegal-regexp")}}}),e.before("dialogue/modify",async r=>{let{options:n,args:o}=r.argv;if(n.action==="create"&&!n.target&&!(o[0]&&o[1]))return r.text(".missing-question-or-answer")}),e.on("dialogue/modify",(r,n)=>{let{args:o,options:l}=r.argv;o[1]&&(n.answer=o[1]),l.regexp!==void 0&&(n.flag=n.flag&~S.Flag.regexp|+l.regexp*S.Flag.regexp),o[0]&&(n.question=o[0],n.original=l.original)}),e.on("dialogue/detail",async(r,n,o)=>{var l;(l=r._redirections)!=null&&l.length&&n.add([o.text(".redirections"),...e.dialogue.list(o,r._redirections)].join(`
`),-1e3)}),e.before("command/execute",({command:r,session:n})=>{if(r.config.noInterp&&n._redirected)return n.text(".prohibited-command",[r.name])}),e.before("dialogue/modify",async r=>{let{args:n}=r.argv;if(!(!n[1]||!e.assets))try{n[1]=await e.assets.transform(n[1])}catch(o){return e.logger("teach").warn(o.message),r.text(".upload-failed")}}),e.on("dialogue/query",({regexp:r,answer:n,question:o,original:l},u)=>{if(r){n&&(u.answer={$regex:new RegExp(n,"i")}),l&&(u.original={$regex:new RegExp(l,"i")});return}if(n&&(u.answer=n),r===!1)o&&(u.question=o);else if(l){let d=[{flag:{$bitsAllSet:S.Flag.regexp},original:{$regexFor:l}}];o&&d.push({flag:{$bitsAllClear:S.Flag.regexp},question:o}),u.$and.push({$or:d})}})}f(Re,"apply");function U(e){let t=+e;if(t>=0&&t<=1)return t;throw new Error("commands.teach.messages.probability.zero-to-one")}f(U,"isZeroToOne");function Pe(e,t){let{appellationTimeout:a=2e4}=t;e.command("teach").option("probabilityStrict","-p <prob>",{type:U}).option("probabilityAppellative","-P <prob>",{type:U}),e.on("dialogue/modify",(i,r)=>{var n,o;let{options:l}=i.argv;l.action==="create"?(r.probS=(n=l.probabilityStrict)!=null?n:1-+l.appellative,r.probA=(o=l.probabilityAppellative)!=null?o:+l.appellative):(l.probabilityStrict!==void 0&&(r.probS=l.probabilityStrict),l.probabilityAppellative!==void 0&&(r.probA=l.probabilityAppellative))}),e.on("dialogue/state",i=>{i.activated={}}),e.on("dialogue/prepare",({test:i,userId:r,dialogues:n,activated:o})=>{let l=n.some(u=>!(u.flag&S.Flag.regexp));n.forEach(u=>{if(l&&u.flag&S.Flag.regexp)u._weight=0;else if(r in o)u._weight=Math.max(u.probS,u.probA);else if(!i.appellative||!(u.flag&S.Flag.regexp))u._weight=i.appellative?u.probA:u.probS;else{let d=new RegExp(u.question),c=u.probS>=u.probA?[[i.original,u.probS],[i.question,u.probA]]:[[i.question,u.probA],[i.original,u.probS]];for(let[s,g]of c)if(u._capture=d.exec(s),u._weight=g,u._capture)break}})}),e.before("dialogue/send",({test:i,activated:r,userId:n})=>{if(!i.activated)return;let o=r[n]=Date.now();setTimeout(()=>{r[n]===o&&delete r[n]},a)}),e.on("dialogue/detail",(i,r,n)=>{let{probS:o,probA:l}=i;(o<1||l>0)&&r.add(n.text(".probability.detail",i),900)}),e.on("dialogue/abstract",({probS:i,probA:r},n)=>{i<1&&n.push(`p=${i}`),r>0&&n.push(`P=${r}`)})}f(Pe,"probability");var S;(e=>{let t;(a=>{a[a.frozen=1]="frozen",a[a.regexp=2]="regexp",a[a.context=4]="context",a[a.substitute=8]="substitute",a[a.complement=16]="complement"})(t=e.Flag||(e.Flag={}))})(S||(S={}));var Ye=w.Schema.intersect([w.Schema.object({prefix:w.Schema.string().description("教学指令的前缀。").default("#"),historyTimeout:w.Schema.natural().role("ms").description("教学操作在内存中的保存时间。").default(w.Time.minute*10)}).description("通用设置"),w.Schema.object({authority:w.Schema.object({base:w.Schema.natural().description("可访问教学系统的权限等级。").default(2),admin:w.Schema.natural().description("可修改非自己创建的问答的权限等级。").default(3),context:w.Schema.natural().description("可修改上下文设置的权限等级。").default(3),frozen:w.Schema.natural().description("可修改锁定的问答的权限等级。").default(4),regExp:w.Schema.natural().description("可使用正则表达式的权限等级。").default(3),writer:w.Schema.natural().description("可设置作者或匿名的权限等级。").default(2)})}).description("权限设置"),w.Schema.object({maxRedirections:w.Schema.natural().description("问题重定向的次数上限。").default(3),successorTimeout:w.Schema.natural().role("ms").description("问答触发后继问答的持续时间。").default(w.Time.second*20),appellationTimeout:w.Schema.natural().role("ms").description("称呼作为问题触发的后续效果持续时间。").default(w.Time.minute*10)}).description("触发设置"),w.Schema.object({maxPreviews:w.Schema.natural().description("同时查看的最大问答数量。").default(10),previewDelay:w.Schema.natural().role("ms").description("显示两个问答之间的时间间隔。").default(w.Time.second*.5),itemsPerPage:w.Schema.natural().description("搜索结果每一页显示的最大数量。").default(30),maxAnswerLength:w.Schema.natural().description("搜索结果中回答显示的长度限制。").default(100),mergeThreshold:w.Schema.natural().description("合并搜索模式中，相同的问题和回答被合并的最小数量。").default(5)}).description("显示设置")]),et="dialogue",tt=["database"];function Ie(e,t){e.i18n.define("zh",Ge()),e.plugin(le,t),e.plugin(Ee,t),e.plugin(qe,t),e.plugin(ke,t),e.plugin(Te,t),e.plugin(Oe,t),e.plugin(Re,t),e.plugin(Pe,t)}f(Ie,"apply")});export default rt();
