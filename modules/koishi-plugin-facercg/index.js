var ne=Object.defineProperty;var me=Object.getOwnPropertyDescriptor;var ge=Object.getOwnPropertyNames;var ye=Object.prototype.hasOwnProperty;var Z=(e,r)=>()=>(e&&(r=e(e=0)),r);var q=(e,r)=>()=>(r||e((r={exports:{}}).exports,r),r.exports);var Y=(e,r,p,o)=>{if(r&&typeof r=="object"||typeof r=="function")for(let c of ge(r))!ye.call(e,c)&&c!==p&&ne(e,c,{get:()=>r[c],enumerable:!(o=me(r,c))||o.enumerable});return e},k=(e,r,p)=>(Y(e,r,"default"),p&&Y(p,r,"default"));var se=e=>Y(ne({},"__esModule",{value:!0}),e);import{Buffer as R}from"https://registry.koishi.chat/modules/buffer/index.js";import K from"https://registry.koishi.chat/modules/process/index.js";var w=Z(()=>{});var B={};import*as Pe from"https://registry.koishi.chat/modules/cosmokit/index.js";var ae=Z(()=>{w();k(B,Pe)});var pe=q((Fe,ce)=>{w();var be=Object.defineProperty,h=(e,r)=>be(e,"name",{value:r,configurable:!0}),b=(ae(),se(B)),oe=Symbol.for("satori.element");function U(e){return e&&typeof e=="object"&&e[oe]}h(U,"isElement");function E(e){if(typeof e=="string"||typeof e=="number"||typeof e=="boolean"){if(e=""+e,e)return A("text",{content:e})}else{if(U(e))return e;if(!(0,b.isNullable)(e))throw new TypeError(`Invalid content: ${e}`)}}h(E,"toElement");function M(e){return Array.isArray(e)?e.map(E).filter(r=>r):[E(e)].filter(r=>r)}h(M,"toElementArray");var L=class{get data(){return this.attrs}toString(e=!1){if(this.type==="text")return e?this.attrs.content:A.escape(this.attrs.content);let r=this.children.map(o=>o.toString(e)).join("");if(e)return r;let p=Object.entries(this.attrs).map(([o,c])=>(0,b.isNullable)(c)?"":(o=(0,b.hyphenate)(o),c===!0?` ${o}`:c===!1?` no-${o}`:` ${o}="${A.escape(""+c,!0)}"`)).join("");return this.children.length?`<${this.type}${p}>${r}</${this.type}>`:`<${this.type}${p}/>`}};h(L,"ElementConstructor");(0,b.defineProperty)(L,"name","Element");(0,b.defineProperty)(L.prototype,oe,!0);function A(e,...r){let p=Object.create(L.prototype),o={},c=[];if(r[0]&&typeof r[0]=="object"&&!U(r[0])&&!Array.isArray(r[0])){let $=r.shift();for(let[x,m]of Object.entries($))(0,b.isNullable)(m)||(x==="children"?r.push(...(0,b.makeArray)(m)):o[x]=m)}for(let $ of r)c.push(...M($));return Object.assign(p,{type:e,attrs:o,children:c})}h(A,"Element");var _e=new Function("expr","context",`
  try {
    with (context) {
      return eval(expr)
    }
  } catch {}
`);(e=>{e.jsx=e,e.jsxs=e,e.jsxDEV=e,e.Fragment="template";function r(i,t){return typeof i!="string"?M(i):e.parse(i,t)}e.normalize=r,h(r,"normalize");function p(i,t=!1){let n=i.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return t?n.replace(/"/g,"&quot;"):n}e.escape=p,h(p,"escape");function o(i){return i.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#(\d+);/g,(t,n)=>n==="38"?t:String.fromCharCode(+n)).replace(/&#x([0-9a-f]+);/gi,(t,n)=>n==="26"?t:String.fromCharCode(parseInt(n,16))).replace(/&(amp|#38|#x26);/g,"&")}e.unescape=o,h(o,"unescape");function c(i,t={}){var n;let a=z(i);return t.caret?t.type&&((n=a[0])==null?void 0:n.type)!==t.type?void 0:a[0]:m(a,t.type||"*")[0]}e.from=c,h(c,"from");let $=/ *([ >+~]) */g;function x(i){return i.split(",").map(t=>{let n=[];t=t.trim();let a,f=" ";for(;a=$.exec(t);)n.push({type:t.slice(0,a.index),combinator:f}),f=a[1],t=t.slice(a.index+a[0].length);return n.push({type:t,combinator:f}),n})}e.parseSelector=x,h(x,"parseSelector");function m(i,t){if(!i||!t)return[];if(typeof i=="string"&&(i=z(i)),typeof t=="string"&&(t=x(t)),!t.length)return[];let n=[],a=[];for(let[f,y]of i.entries()){let v=[],u=[...t,...n];n=[];let _=!1;for(let s of u){let{type:d,combinator:S}=s[0];(d===y.type||d==="*")&&(s.length===1?_=!0:[" ",">"].includes(s[1].combinator)?v.push(s.slice(1)):s[1].combinator==="+"?n.push(s.slice(1)):t.push(s.slice(1))),S===" "&&v.push(s)}_&&a.push(i[f]),a.push(...m(y.children,v))}return a}e.select=m,h(m,"select");function j(i,t){var n;if(i=i.trim(),!/^[\w.]+$/.test(i))return(n=_e(i,t))!=null?n:"";let a=t;for(let f of i.split("."))if(a=a[f],(0,b.isNullable)(a))return"";return a??""}e.interpolate=j,h(j,"interpolate");let D=/<!--[\s\S]*?-->|<(\/?)([^!\s>/]*)([^>]*?)\s*(\/?)>/,I=/([^\s=]+)(?:="([^"]*)"|='([^']*)')?/g,C=/([^\s=]+)(?:="([^"]*)"|='([^']*)'|=\{([^}]+)\})?/g,G=/\{([^}]*)\}/;function z(i,t){let n=[];function a(s){s&&n.push(e("text",{content:s}))}h(a,"pushText");let f=t?C:I,y;for(;y=D.exec(i);){v(i.slice(0,y.index));let[s,d,S,Q,X]=y;if(i=i.slice(y.index+s.length),s.startsWith("<!"))continue;let O={source:s,type:S||e.Fragment,close:d,empty:X,attrs:{}},te;for(;te=f.exec(Q);){let[ke,T,de,re=de,ie]=te;ie?O.attrs[(0,b.camelize)(T)]=j(ie,t):(0,b.isNullable)(re)?T.startsWith("no-")?O.attrs[(0,b.camelize)(T.slice(3))]=!1:O.attrs[(0,b.camelize)(T)]=!0:O.attrs[(0,b.camelize)(T)]=o(re)}n.push(O)}v(i);function v(s){if(s=s.replace(/^\s*\n\s*/,"").replace(/\s*\n\s*$/,""),t){let d;for(;d=G.exec(s);){let[S,Q]=d;a(o(s.slice(0,d.index))),s=s.slice(d.index+S.length);let X=j(Q,t);n.push(...M(X))}}a(o(s))}h(v,"parseContent");let u=[e(e.Fragment)];function _(s){for(;s>0;s--){let{children:d}=u.shift(),{source:S}=u[0].children.pop();u[0].children.push(e("text",{content:S})),u[0].children.push(...d)}}h(_,"rollback");for(let s of n)if(U(s))u[0].children.push(s);else if(s.close){let d=0;for(;d<u.length&&u[d].type!==s.type;)d++;if(d===u.length)u[0].children.push(e("text",{content:s.source}));else{_(d);let S=u.shift();delete S.source}}else{let d=e(s.type,s.attrs);u[0].children.push(d),s.empty||(d.source=s.source,u.unshift(d))}return _(u.length-1),u[0].children}e.parse=z,h(z,"parse");function H(i,t,n){var a,f;let{type:y,attrs:v,children:u}=i;if(typeof t=="function")return t(i,n);{let _=(f=(a=t[y])!=null?a:t.default)!=null?f:!0;return typeof _=="function"&&(_=_(v,u,n)),_}}h(H,"visit");function V(i,t,n){let a=typeof i=="string"?z(i):i,f=[];return a.forEach(y=>{let{type:v,attrs:u,children:_}=y,s=H(y,t,n);s===!0?f.push(e(v,u,V(_,t,n))):s!==!1&&f.push(...r(s))}),typeof i=="string"?f.join(""):f}e.transform=V,h(V,"transform");async function J(i,t,n){let a=typeof i=="string"?z(i):i,f=(await Promise.all(a.map(async y=>{let{type:v,attrs:u,children:_}=y,s=await H(y,t,n);return s===!0?[e(v,u,await J(_,t,n))]:s!==!1?r(s):[]}))).flat(1);return typeof i=="string"?f.join(""):f}e.transformAsync=J,h(J,"transformAsync");function F(i,...t){return(...n)=>{let a=e(i);return t.forEach((f,y)=>{(0,b.isNullable)(n[y])||(a.attrs[f]=n[y])}),n[t.length]&&Object.assign(a.attrs,n[t.length]),a}}h(F,"createFactory"),e.warn=h(()=>{},"warn");function N(i){return(t,...n)=>{let a="base64://";return typeof n[0]=="string"&&(a=`data:${n.shift()};base64,`),(0,b.is)("Buffer",t)?t=a+t.toString("base64"):(0,b.is)("ArrayBuffer",t)&&(t=a+(0,b.arrayBufferToBase64)(t)),t.startsWith("base64://")&&(0,e.warn)('protocol "base64:" is deprecated and will be removed in the future, please use "data:" instead'),e(i,{...n[0],url:t})}}h(N,"createAssetFactory"),e.text=F("text","content"),e.at=F("at","id"),e.sharp=F("sharp","id"),e.quote=F("quote","id"),e.image=N("image"),e.video=N("video"),e.audio=N("audio"),e.file=N("file")})(A||(A={}));ce.exports=A});var P={};import*as Re from"https://registry.koishi.chat/modules/koishi/index.js";var le=Z(()=>{w();k(P,Re)});var fe=q((We,xe)=>{xe.exports={commands:{facercg:{description:"人脸识别,百度api",messages:{noimg:"缺少图片,请重试",running:"正在预测",noface:"未从图片中发现人脸"}}}}});var $e=q(l=>{w();Object.defineProperty(l,"__esModule",{value:!0});l.apply=l.get_access_token=l.Config=l.logger=l.usage=l.msg=l.div_items=l.name=void 0;var W=pe(),g=(le(),se(P));l.name="facercg";var ee={headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64); AppleWebKit/537.36 (KHTML, like Gecko); Chrome/54.0.2840.99 Safari/537.36"}},ue={image_type:"BASE64",face_field:"gender,beauty",max_face_num:120},ve=e=>{let r=[];for(var p in e){var o=e[p].location,c=`transform: rotate(${o.rotation}deg);position: absolute;font-size: 10px;width: ${o.width}px;height: ${o.height}px;left: ${o.left}px;top: ${o.top}px;rotation: ${o.rotation}deg;background: transparent;border: 1px solid green`;r.push(c)}return r.map((x,m)=>(0,W.jsxs)("div",{style:x,children:["face",m]}))};l.div_items=ve;var Se=e=>{let r=[];for(var p in e){var o=e[p].gender,c=e[p].beauty;r.push(`第${p}张脸,颜值:${c} 性别:${o.type}｜概率:${o.probability}`)}return r.map((x,m)=>(0,W.jsx)("p",{children:x}))};l.msg=Se;l.usage=`
## 注意事项
> 使用前在 <a href="https://console.bce.baidu.com/ai/#/ai/face/overview/index">百度智能云</a> 中获取apikey及secret_key
或者<a href="https://github.com/initialencounter/beauty-predict-server">自建服务端</a>
> 对于部署者行为及所产生的任何纠纷
Koishi 及 koishi-plugin-facercg 概不负责。
如果有更多文本内容想要修改，可以在<a href="/locales">本地化</a>中修改 zh 内容
## 效果展示
<img src = 'https://github.com/initialencounter/mykoishi/raw/main/screenshot/3-2-1.jpg'>
`;l.logger=new g.Logger(l.name);l.Config=g.Schema.intersect([g.Schema.object({type:g.Schema.union([g.Schema.const("BaiduApi").description("百度api"),g.Schema.const("Pca").description("随机森林")]).default("BaiduApi").description("后端选择")}).description("基础设置"),g.Schema.union([g.Schema.object({type:g.Schema.const("BaiduApi"),key:g.Schema.string().description("api_key").required(),secret_key:g.Schema.string().description("secret_key").required()}),g.Schema.object({type:g.Schema.const("Pca"),endpoint:g.Schema.string().description("API 服务器地址。").required()})]),g.Schema.object({authority:g.Schema.number().description("允许使用的最低权限").default(3),usage:g.Schema.number().description("每人每日可用次数").default(10),cmd:g.Schema.string().description("触发命令").default("face")}).description("进阶设置")]);async function he(e,r){let p="https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials";return await(await e.http.axios(`${p}&client_id=${r.key}&&client_secret=${r.secret_key}`,ee)).data.access_token}l.get_access_token=he;async function we(e,r){let p;r.type=="BaiduApi"&&(p=await he(e,r));let o="https://aip.baidubce.com/rest/2.0/face/v3/detect";e.i18n.define("zh",fe()),e.command("facercg <prompt:text>",{authority:r.authority,maxUsage:r.usage,usageName:"face"}).alias(r.cmd).action(async({session:c})=>{if(c.send(c.text(".running")),c.content.indexOf("url=")==-1)return c.text(".noimg");let x=g.segment.select(c.content,"image")[0]?.attrs?.url,m;try{if(r.type=="BaiduApi"){let C=await e.http.get(x,{responseType:"arraybuffer",headers:ee}),G=R.from(C).toString("base64");ue.image=G,m=await e.http.post(`${o}?access_token=${p}`,ue,ee)}else m=await e.http.post(r.endpoint,{type:"url",data:x})}catch(C){return l.logger.warn(C),String(C)}if(m.error_msg=="pic not has face")return c.text(".noface");if(m.error_msg!="SUCCESS")return l.logger.warn(`错误信息: ${m.error_msg}`),`错误信息: ${m.error_msg}`;let j=m.result.face_list,D=(0,l.div_items)(j),I=(0,l.msg)(j);return e.puppeteer?(0,W.jsxs)("html",{children:[(0,W.jsx)("img",{src:x}),D,(0,W.jsx)("p",{children:I})]}):I})}l.apply=we});export default $e();
