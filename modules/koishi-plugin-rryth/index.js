var W=Object.defineProperty;var ne=Object.getOwnPropertyDescriptor;var ie=Object.getOwnPropertyNames;var oe=Object.prototype.hasOwnProperty;var H=(t,e)=>()=>(t&&(e=t(t=0)),e);var P=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var L=(t,e,r,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of ie(e))!oe.call(t,o)&&o!==r&&W(t,o,{get:()=>e[o],enumerable:!(i=ne(e,o))||i.enumerable});return t},E=(t,e,r)=>(L(t,e,"default"),r&&L(r,e,"default"));var k=t=>L(W({},"__esModule",{value:!0}),t);import{Buffer as T}from"https://registry.koishi.chat/modules/buffer/index.js";import I from"https://registry.koishi.chat/modules/process/index.js";var f=H(()=>{});var v={};import*as Oe from"https://registry.koishi.chat/modules/koishi/index.js";var M=H(()=>{f();E(v,Oe)});var A=P(g=>{"use strict";f();Object.defineProperty(g,"__esModule",{value:!0});g.parseInput=g.parseForbidden=g.Config=g.PromptConfig=void 0;var s=(M(),k(v)),se=["nsfw, lowres, bad anatomy, bad hands, text, error, missing fingers","extra digit, fewer digits, cropped, worst quality, low quality","normal quality, jpeg artifacts, signature, watermark, username, blurry"].join(", ");g.PromptConfig=s.Schema.object({basePrompt:s.Schema.string().role("textarea").description("默认附加的标签。").default("masterpiece, best quality"),negativePrompt:s.Schema.string().role("textarea").description("默认附加的反向标签。").default(se),forbidden:s.Schema.string().role("textarea").description("违禁词列表。请求中的违禁词将会被自动删除。").default(""),placement:s.Schema.union([s.Schema.const("before").description("置于最前"),s.Schema.const("after").description("置于最后")]).description("默认附加标签的位置。").default("after"),translator:s.Schema.boolean().description("是否启用自动翻译。").default(!1),latinOnly:s.Schema.boolean().description("是否只接受英文输入。").default(!0)}).description("输入设置");g.Config=s.Schema.intersect([s.Schema.object({weigh:s.Schema.number().description("默认宽度比").default(1),hight:s.Schema.number().description("默认高度比").default(1.3),strength:s.Schema.number().description("默认图转图强度").default(.6),scale:s.Schema.number().description("默认提示词相关度").default(11),censor:s.Schema.boolean().description("是否启用图像审核。").default(!1)}),g.PromptConfig,s.Schema.object({output:s.Schema.union([s.Schema.const("minimal").description("仅图片"),s.Schema.const("default").description("标准输出"),s.Schema.const("verbose").description("详细输出")]).description("输出方式。").default("default"),requestTimeout:s.Schema.number().role("time").description("当请求超过这个时间时会中止并提示超时。").default(s.Time.minute),recallTimeout:s.Schema.number().role("time").description("图片发送后自动撤回的时间 (设置为 0 以禁用此功能)。").default(0),maxConcurrency:s.Schema.number().description("单个频道下的最大并发数量 (设置为 0 以禁用此功能)。").default(0)}).description("高级设置")]);function ce(t){return t.trim().toLowerCase().replace(/，/g,",").split(/(?:,\s*|\s*\n\s*)/g).filter(Boolean).map(e=>{let r=e.endsWith("!");return r&&(e=e.slice(0,-1)),e=e.replace(/[^a-z0-9]+/g," ").trim(),{pattern:e,strict:r}})}g.parseForbidden=ce;var K=/@@__BACKSLASH__@@/g;function ue(t,e,r,i){if(t=t.toLowerCase().replace(/\\\\/g,K.source).replace(/，/g,",").replace(/（/g,"(").replace(/）/g,")"),t=t.split("\\{").map(n=>n.replace(/\{/g,"(")).join("\\{").split("\\}").map(n=>n.replace(/\}/g,")")).join("\\}"),t=t.replace(K,"\\").replace(/_/g," "),e.latinOnly&&/[^\s\w"'“”‘’.,:|\\()\[\]{}-]/.test(t))return{errPath:".latin-only"};let o=[],p=(n,l)=>{let y=l.split(/,\s*/g);e.placement==="before"&&y.reverse();for(let m of y)m=m.trim().toLowerCase(),!(!m||n.includes(m))&&(e.placement==="before"?n.unshift(m):n.push(m))},w=t.match(/(,\s*|\s+)(-u\s+|--undesired\s+|negative prompts?:\s*)([\s\S]+)/m);w?.[3]&&(t=t.slice(0,w.index).trim(),p(o,w[3]));let a=t.split(/,\s*/g).filter(n=>{if(n=n.replace(/[\x00-\x7f]/g,l=>l.replace(/[^0-9a-zA-Z]/," ")).replace(/\s+/," ").trim(),!n)return!1;for(let{pattern:l,strict:y}of r){if(y&&n.split(/\W+/g).includes(l))return!1;if(!y&&n.includes(l))return!1}return!0});return i||(p(a,e.basePrompt),p(o,e.negativePrompt)),{errPath:null,positive:a,uc:o.join(", ")}}g.parseInput=ue});var Z=P(()=>{f()});var X=P(h=>{"use strict";f();var le=h&&h.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(h,"__esModule",{value:!0});h.NetworkError=h.download=h.arrayBufferToBase64=h.getImageSize=void 0;var R=(M(),k(v)),Ee=le(Z());function de(t){{let e=new Blob([t]),r=new Image;return r.src=URL.createObjectURL(e),(0,R.pick)(r,["width","height"])}}h.getImageSize=de;function V(t){{let e="";for(let i=0;i<t.byteLength;i+=8192)e+=String.fromCharCode.apply(null,t.slice(i,i+8192));return btoa(e)}}h.arrayBufferToBase64=V;var pe=10485760,Q=["image/jpeg","image/png","image/webp"];async function he(t,e,r={}){if(e.startsWith("data:")){let[,i,o]=e.match(/^data:(image\/\w+);base64,(.*)$/);if(!Q.includes(i))throw new x(".unsupported-file-type");let p=atob(o),w=new Uint8Array(p.length);for(let a=0;a<p.length;a++)w[a]=p.charCodeAt(a);return{buffer:w,base64:o,dataUrl:e}}else{let i=await t.http.head(e,{headers:r});if(+i["content-length"]>pe)throw new x(".file-too-large");let o=i["content-type"];if(!Q.includes(o))throw new x(".unsupported-file-type");let p=await t.http.get(e,{responseType:"arraybuffer",headers:r}),w=V(p);return{buffer:p,base64:w,dataUrl:`data:${o};base64,${w}`}}}h.download=he;var x=class extends Error{constructor(e,r={}){super(e),this.params=r}};h.NetworkError=x;x.catch=t=>e=>{if(R.Quester.isAxiosError(e)){let r=e.response?.status;for(let i in t)if(r===+i)throw new x(t[i])}throw e}});var Y=P((Be,me)=>{me.exports={commands:{rryth:{description:"人人有图画计划 2.4.3",usage:`输入 sai 空格提示词即可画画，提示词是用逗号分隔的英文
示例 sai -r 512x768 -t 28 -c 7 tree, yellow -u green
本插件基于 novelai-bot 修改完成，旨在提供免费画画方案
好用的话去点个 star https://github.com/MirrorCY/rryth`,options:{resolution:"设定图片比例(1.5x1.2)",seed:"设置随机种子(随意一个数字)",scale:"提示词相关性(0-20)",strength:"图片修改强度(0-1)",undesired:"反向提示词(加在提示词后)",override:"去除插件附加的提示词"},messages:{"expect-prompt":"请输入标签。","expect-image":"请输入图片。","latin-only":"只接受英文输入。","concurrent-jobs":`<random>
  <>等会再约稿吧，我已经忙不过来了……</>
  <>是数位板没电了，才…才不是我不想画呢！</>
  <>那你得先教我画画（理直气壮</>
</random>`,waiting:`<random>
  <>少女绘画中……</>
  <>在画了在画了</>
  <>你就在此地不要走动，等我给你画一幅</>
</random>`,pending:"在画了在画了，不过前面还有 {0} 个稿……","file-too-large":"文件体积过大。","unsupported-file-type":"不支持的文件格式。","download-error":"图片解析失败。","unknown-error":"发生未知错误。","response-error":"发生未知错误 ({0})。","empty-response":"服务器返回了空白图片，请稍后重试。","request-failed":"请求失败 ({0})，请稍后重试。","request-timeout":"请求超时。"}}}}});var ye=P(u=>{f();var fe=u&&u.__createBinding||(Object.create?function(t,e,r,i){i===void 0&&(i=r);var o=Object.getOwnPropertyDescriptor(e,r);(!o||("get"in o?!e.__esModule:o.writable||o.configurable))&&(o={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,i,o)}:function(t,e,r,i){i===void 0&&(i=r),t[i]=e[r]}),ge=u&&u.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&fe(e,t,r)};Object.defineProperty(u,"__esModule",{value:!0});u.apply=u.name=u.reactive=void 0;var b=(M(),k(v)),G=A(),U=X();ge(A(),u);u.reactive=!0;u.name="rryth";var z=new b.Logger(u.name);function be(t,e){if(b.Quester.isAxiosError(e)){if(e.response?.data)return z.error(e.response.data),t.text(e.response.data.message);if(e.response?.status===402)return t.text(".unauthorized");if(e.response?.status)return t.text(".response-error",[e.response.status]);if(e.code==="ETIMEDOUT")return t.text(".request-timeout");if(e.code)return t.text(".request-failed",[e.code])}return z.error(e),t.text(".unknown-error")}function we(t,e){t.i18n.define("zh",Y());let r,i=Object.create(null),o=new Set;t.accept(["forbidden"],a=>{r=(0,G.parseForbidden)(a.forbidden)},{immediate:!0});let p=a=>{let n=a.match(/^(\d*\.?\d+)[x×](\d*\.?\d+)$/);if(!n)throw new Error;let l=+n[1],y=+n[2];return{width:l,height:y}},w=t.command(`${u.name} <prompts:text>`).alias("sai","rr").userFields(["authority"]).option("resolution","-r <resolution>",{type:p}).option("override","-O").option("seed","-x <seed:number>").option("scale","-c <scale:number>").option("strength","-N <strength:number>").option("undesired","-u <undesired>").action(async({session:a,options:n},l)=>{var y;if(!l?.trim())return a.execute(`help ${u.name}`);let m,q;if(l=b.h.transform(l,{image(c){return m=c.url,""}}),!l.trim()&&!e.basePrompt)return a.text(".expect-prompt");let{errPath:$,positive:J,uc:N}=(0,G.parseInput)(l,e,r,n.override),O=J.join(", ");if($)return a.text($);if(e.translator&&t.translator){let c=O.match(/[\u4e00-\u9fa5]+/g);if(c?.length>0)try{let _=(await t.translator.translate({input:c.join(","),target:"en"})).toLocaleLowerCase().split(",");c.forEach((S,j)=>{O=O.replace(S,_[j]).replace("，",",")})}catch(_){z.warn(_)}}let D=n.seed||Math.floor(Math.random()*Math.pow(2,32)),d={seed:D,prompt:O,uc:N,scale:n.scale??e.scale??11,steps:m?50:28};if(m){try{q=await(0,U.download)(t,m)}catch(c){return c instanceof U.NetworkError?a.text(c.message,c.params):(z.error(c),a.text(".download-error"))}n.resolution||(n.resolution=(0,U.getImageSize)(q.buffer)),Object.assign(d,{height:n.resolution.height,width:n.resolution.width,strength:n.strength??e.strength??.3})}else n.resolution||(n.resolution={height:e.hight,width:e.weigh}),Object.assign(d,{height:n.resolution.height,width:n.resolution.width});let C=Math.random().toString(36).slice(2);if(e.maxConcurrency){let c=i[y=a.cid]||(i[y]=new Set);if(c.size>=e.maxConcurrency)return a.text(".concurrent-jobs");c.add(C)}a.send(o.size?a.text(".pending",[o.size]):a.text(".waiting")),o.add(C);let F=()=>{i[a.cid]?.delete(C),o.delete(C)},ee=(()=>({init_images:q&&[q.dataUrl],prompt:d.prompt,seed:d.seed,negative_prompt:d.uc,cfg_scale:d.scale,width:d.width,height:d.height,denoising_strength:d.strength,steps:d.steps}))(),te=()=>t.http.axios("https://rryth.elchapo.cn:11000/v2",{method:"POST",timeout:e.requestTimeout,headers:{api:"42",...e.headers},data:ee}).then(c=>c.data.images),B;for(;;)try{B=await te(),F();break}catch(c){return F(),be(a,c)}async function re(){let c=e.censor?(0,b.h)("censor",(0,b.h)("image",{url:"data:image/png;base64,"+B[0]})):(0,b.h)("image",{url:"data:image/png;base64,"+B[0]}),_={userId:a.userId,nickname:a.author?.nickname||a.username};if(e.output==="minimal")return c;let S=(0,b.h)("figure"),j=[`种子 = ${D}`];return e.output==="verbose"&&(j.push("模型 = Anything 3.0"),j.push(`提示词相关度 = ${d.scale}`),d.image&&j.push(`图转图强度 = ${d.strength}`)),S.children.push((0,b.h)("message",_,j.join(`
`))),S.children.push((0,b.h)("message",_,`关键词 = ${O}`)),e.output==="verbose"&&S.children.push((0,b.h)("message",_,`排除关键词 = ${N}`)),S.children.push(c),e.output==="verbose"&&S.children.push((0,b.h)("message",_,"工作站名称 = 42")),S}let ae=await a.send(await re());e.recallTimeout&&t.setTimeout(()=>{for(let c of ae)a.bot.deleteMessage(a.channelId,c)},e.recallTimeout)})}u.apply=we});export default ye();
