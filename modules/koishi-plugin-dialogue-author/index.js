var I=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var x=Object.prototype.hasOwnProperty;var O=(e,a)=>()=>(e&&(a=e(e=0)),a);var B=(e,a)=>()=>(a||e((a={exports:{}}).exports,a),a.exports);var z=(e,a,u,r)=>{if(a&&typeof a=="object"||typeof a=="function")for(let t of $(a))!x.call(e,t)&&t!==u&&I(e,t,{get:()=>a[t],enumerable:!(r=C(a,t))||r.enumerable});return e},d=(e,a,u)=>(z(e,a,"default"),u&&z(u,a,"default"));var P=e=>z(I({},"__esModule",{value:!0}),e);import{Buffer as S}from"https://registry.koishi.chat/modules/buffer/index.js";import F from"https://registry.koishi.chat/modules/process/index.js";var p=O(()=>{});var c={};import*as ie from"https://registry.koishi.chat/modules/koishi/index.js";var k=O(()=>{p();d(c,ie)});var b={};import*as ue from"https://registry.koishi.chat/modules/koishi-plugin-dialogue/index.js";var j=O(()=>{p();d(b,ue)});var Y=B((ne,A)=>{p();var _=Object.defineProperty,E=Object.getOwnPropertyDescriptor,q=Object.getOwnPropertyNames,H=Object.prototype.hasOwnProperty,J=(e,a)=>_(e,"name",{value:a,configurable:!0}),R=(e,a)=>function(){return a||(0,e[q(e)[0]])((a={exports:{}}).exports,a),a.exports},X=(e,a)=>{for(var u in a)_(e,u,{get:a[u],enumerable:!0})},G=(e,a,u,r)=>{if(a&&typeof a=="object"||typeof a=="function")for(let t of q(a))!H.call(e,t)&&t!==u&&_(e,t,{get:()=>a[t],enumerable:!(r=E(a,t))||r.enumerable});return e},W=e=>G(_({},"__esModule",{value:!0}),e),K=R({"plugins/dialogue/packages/author/src/locales/zh.yml"(e,a){a.exports={commands:{teach:{options:{"frozen.true":"锁定这个问答","frozen.false":"解锁这个问答",writer:"添加或设置问题的作者","writer.":"添加或设置匿名问题","substitute.true":"由教学者完成问答的执行","substitute.false":"由触发者完成问答的执行"},messages:{writer:{"target-not-exist":"指定的目标用户不存在。",detail:{writer:"来源：{0}",unknown:"未知用户",frozen:"此问答已锁定。",substitute:"回答中的指令由教学者代行。"},abstract:{frozen:"锁定",substitute:"代行"}}}}}}}}),N={};X(N,{Config:()=>L,apply:()=>U,name:()=>Q,using:()=>V});A.exports=W(N);var y=(k(),P(c)),f=(j(),P(b)),T="__AUTHOR_NOT_EXIST__",L=y.Schema.object({authority:y.Schema.object({writer:y.Schema.number().default(2).description("设置作者或匿名的权限等级。"),frozen:y.Schema.number().default(4).description("修改锁定状态的权限等级。")})}),Q="koishi-plugin-dialogue-author",V=["dialogue"];function U(e,a){let{authority:u}=a;e.i18n.define("zh",K()),e.model.extend("dialogue",{writer:"unsigned(20)"}),e.on("dialogue/usage",(r,t)=>{t.user.authority>=u.frozen&&(r.add("　锁定问答：　　　-f/-F",550),r.add("　教学者代行：　　-s/-S",550)),t.user.authority>=u.writer&&(r.add("　设置问题作者：　-a user",550),r.add("　设置为匿名：　　-A",550))}),e.command("teach").option("frozen","-f",{authority:u.frozen}).option("frozen","-F, --no-frozen",{authority:u.frozen,value:!1}).option("writer","-a <uid:user>").option("writer","-A, --anonymous",{authority:u.writer,value:""}).option("substitute","-s").option("substitute","-S, --no-substitute",{value:!1}),e.dialogue.flag("frozen"),e.dialogue.flag("substitute"),e.before("dialogue/detail",async r=>{var t;let{options:i}=r.argv;i.nameMap={},i.authMap={};let{nameMap:o,dialogues:s,authMap:g}=i,h=new Set(s.map(n=>n.writer).filter(Boolean)),m=["id","authority",r.platform];if(i.writer){let[n,l]=i.writer.split(":"),v=await e.database.getUser(n,l,m);v?(h.add(v.id),i.writer=""+v.id):i.writer=T}i.action!=="modify"&&m.push("name");let w=await e.database.get("user",{id:[...h]},m),M=!1,D={};for(let n of w){if(g[n.id]=n.authority,i.action==="modify")continue;let l=n[r.platform];n.name?o[n.id]=`${n.name} (${l})`:l===r.userId?o[n.id]=`${r.author.nickname||r.author.username} (${r.userId})`:(M=!0,D[l]=n.id)}if(i.action!=="modify"&&M&&r.subtype==="group")try{let n=await r.bot.getGuildMemberMap(r.guildId);for(let l in n)o[t=D[l]]||(o[t]=n[l])}catch{}}),e.on("dialogue/detail",({writer:r,flag:t},i,o)=>{if(t&f.Dialogue.Flag.frozen&&i.add(o.text(".writer.detail.frozen"),100),r){let{nameMap:s}=o.argv.options,g=s[r]||o.text(".writer.detail.unknown");i.add(o.text(".writer.detail.writer",[g]),100),t&f.Dialogue.Flag.substitute&&i.add(o.text(".writer.detail.substitute"),100)}}),e.on("dialogue/permit",(r,{writer:t,flag:i})=>{let{target:o,substitute:s,writer:g,authMap:h}=r.argv.options,{id:m,authority:w}=r.user;return g&&w<=h[g]&&+g!==m||i&f.Dialogue.Flag.frozen&&w<a.authority.frozen||t!==m&&(o&&w<e.dialogue.config.authority.admin||(s||i&f.Dialogue.Flag.substitute)&&w<=(h[t]||e.dialogue.config.authority.base))}),e.on("dialogue/abstract",({flag:r},t,i)=>{r&f.Dialogue.Flag.frozen&&t.push(i.text(".writer.abstract.frozen")),r&f.Dialogue.Flag.substitute&&t.push(i.text(".writer.abstract.substitute"))}),e.before("dialogue/search",(r,t)=>{(0,y.isNullable)(r.argv.options.writer)||(t.writer=+r.argv.options.writer)}),e.before("dialogue/modify",async r=>{let{writer:t}=r.argv.options;if(t===T)return r.text(".writer.target-not-exist")}),e.on("dialogue/modify",(r,t)=>{let{target:i,writer:o}=r.argv.options;typeof o<"u"?t.writer=+o:i||(t.writer=r.user.id)}),e.before("dialogue/attach-user",(r,t)=>{for(let i of r.dialogues)i.flag&f.Dialogue.Flag.substitute&&t.add("id")}),e.on("dialogue/before-send",async r=>{let{dialogue:t,session:i}=r;if(t.flag&f.Dialogue.Flag.substitute&&t.writer&&i.user.id!==t.writer){let{platform:o}=i,s=new Set(["name","flag",o]);e.emit(i,"dialogue/before-attach-user",r,s),i.platform="id",i.userId=t.writer,await i.observeUser(s),i.platform=o,i.userId=i.user[o]}}),e.on("dialogue/query",(r,t)=>{r.writer!==void 0&&(t.writer=r.writer)})}J(U,"apply")});export default Y();
