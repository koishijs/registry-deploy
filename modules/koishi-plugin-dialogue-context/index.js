var h=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var w=Object.getOwnPropertyNames;var F=Object.prototype.hasOwnProperty;var v=(r,a)=>()=>(r&&(a=r(r=0)),a);var R=(r,a)=>()=>(a||r((a={exports:{}}).exports,a),a.exports);var _=(r,a,t,e)=>{if(a&&typeof a=="object"||typeof a=="function")for(let l of w(a))!F.call(r,l)&&l!==t&&h(r,l,{get:()=>a[l],enumerable:!(e=q(a,l))||e.enumerable});return r},d=(r,a,t)=>(_(r,a,"default"),t&&_(t,a,"default"));var G=r=>_(h({},"__esModule",{value:!0}),r);import{Buffer as x}from"https://registry.koishi.chat/modules/buffer/index.js";import y from"https://registry.koishi.chat/modules/process/index.js";var c=v(()=>{});var s={};import*as X from"https://registry.koishi.chat/modules/koishi/index.js";var D=v(()=>{c();d(s,X)});var b={};import*as Z from"https://registry.koishi.chat/modules/koishi-plugin-dialogue/index.js";var P=v(()=>{c();d(b,Z)});var K=R((ee,C)=>{c();var m=Object.defineProperty,j=Object.getOwnPropertyDescriptor,O=Object.getOwnPropertyNames,k=Object.prototype.hasOwnProperty,A=(r,a)=>m(r,"name",{value:a,configurable:!0}),z=(r,a)=>function(){return a||(0,r[O(r)[0]])((a={exports:{}}).exports,a),a.exports},U=(r,a)=>{for(var t in a)m(r,t,{get:a[t],enumerable:!0})},J=(r,a,t,e)=>{if(a&&typeof a=="object"||typeof a=="function")for(let l of O(a))!k.call(r,l)&&l!==t&&m(r,l,{get:()=>a[l],enumerable:!(e=j(a,l))||e.enumerable});return r},N=r=>J(m({},"__esModule",{value:!0}),r),B=z({"plugins/dialogue/packages/context/src/locales/zh.yml"(r,a){a.exports={commands:{teach:{options:{disable:"在当前环境下禁用问答",disableGlobal:"在所有环境下禁用问答",enable:"在当前环境下启用问答",enableGlobal:"在所有环境下启用问答",guilds:"设置具体的生效环境",global:"无视上下文搜索"},messages:{context:{"modifier-expected":"选项 -g, --guilds 必须与 -d/-D/-e/-E 之一同时使用。","private-context":"非群聊上下文中请使用 -E/-D 进行操作或指定 -g, --guilds 选项。","enable-all":"生效环境：全局","enable-except-some":"生效环境：除 {0} 个群外的所有群","enable-except-current-only":"生效环境：除本群","enable-except-current-and-more":"生效环境：除本群等 {0} 个群外的所有群","disable-all":"生效环境：全局禁止","disable-except-some":"生效环境：{0} 个群","disable-except-current-only":"生效环境：仅本群","disable-except-current-and-more":"生效环境：本群等 {0} 个群"}}}}}}}),$={};U($,{Config:()=>M,RE_GROUPS:()=>E,apply:()=>S,name:()=>H,using:()=>I});C.exports=N($);var p=(D(),G(s)),g=(P(),G(b)),E=/^\d+(,\d+)*$/,M=p.Schema.object({authority:p.Schema.number().default(3).description("修改上下文设置的权限等级。")}),H="koishi-plugin-dialogue-context",I=["dialogue"];function S(r,a){let{authority:t}=a;r.i18n.define("zh",B()),r.model.extend("dialogue",{guilds:"list(255)"}),r.command("teach").option("disable","-d").option("disableGlobal","-D",{authority:t}).option("enable","-e").option("enableGlobal","-E",{authority:t}).option("guilds","-g <gids:string>",{authority:t,type:E}).option("global","-G").before(({options:e,session:l})=>{if(e.disable&&e.enable)return l.text(".options-conflict",["-d, -e"]);if(e.disableGlobal&&e.enableGlobal)return l.text(".options-conflict",["-D, -E"]);if(e.disableGlobal&&e.disable)return l.text(".options-conflict",["-D, -d"]);if(e.enable&&e.enableGlobal)return l.text(".options-conflict",["-E, -e"]);let i=!1,o,n,u;if(e.disable?(o=!0,n=!e.enableGlobal,u=[l.gid]):e.disableGlobal?(o=!!e.guilds,n=!1,u=e.enable?[l.gid]:[]):e.enableGlobal?(o=!e.guilds,n=!1,u=[]):(i=!e.enable,(e.target?e.enable:!e.global)&&(o=!1,n=!0,u=[l.gid])),(0,p.defineProperty)(e,"reversed",o),(0,p.defineProperty)(e,"partial",n),"guilds"in e){if(i)return l.text(".context.modifier-expected");(0,p.defineProperty)(e,"_guilds",e.guilds?e.guilds.split(",").map(f=>`${l.platform}:${f}`):[])}else{if(l.subtype!=="group"&&e.partial)return l.text(".context.private-context");(0,p.defineProperty)(e,"_guilds",u)}}),r.on("dialogue/usage",(e,l)=>{e.add(`上下文选项：
　允许本群：　　　-e
　禁止本群：　　　-d`,700),!(l.user.authority<t)&&e.add(`　全局允许：　　　-E
　全局禁止：　　　-D
　设置群号：　　　-g id
　无视上下文搜索：-G`,700)}),r.on("dialogue/modify",(e,l)=>{let{_guilds:i,partial:o,reversed:n}=e.argv.options;if(i)if(l.guilds||(l.guilds=[]),o){let u=!(l.flag&g.Dialogue.Flag.complement)===n?(0,p.difference)(l.guilds,i):(0,p.union)(l.guilds,i);(0,g.equal)(l.guilds,u)||(l.guilds=u.sort())}else l.flag=l.flag&~g.Dialogue.Flag.complement|+n*g.Dialogue.Flag.complement,(0,g.equal)(l.guilds,i)||(l.guilds=i.sort())}),r.before("dialogue/search",(e,l)=>{let{options:i}=e.argv;l.partial=i.partial,l.reversed=i.reversed,l.guilds=i._guilds}),r.on("dialogue/detail",({guilds:e,flag:l},i,o)=>{let n=o.subtype==="group"&&e.includes(o.gid),u=l&g.Dialogue.Flag.complement?"enable-":"disable-",f=n?"except-current-"+(e.length-1?"and-more":"only"):e.length?"except-some":"all";i.add(o.text(".context."+u+f,[e.length]),500)}),r.on("dialogue/abstract",({guilds:e,flag:l},i,o)=>{let{options:n}=o.argv;if(!n._guilds&&o.subtype==="group"){let u=l&g.Dialogue.Flag.complement,f=e.includes(o.gid);i.unshift(!u===f?u?"E":"e":u?"d":"D")}}),r.on("dialogue/receive",({session:e,test:l})=>{l.partial=!0,l.reversed=!1,l.guilds=[e.gid]}),r.on("dialogue/query",(e,l)=>{!e.guilds||!e.guilds.length||l.$and.push({$or:[{flag:{[e.reversed?"$bitsAllSet":"$bitsAllClear"]:g.Dialogue.Flag.complement},$and:e.guilds.map(i=>({guilds:{$el:i}}))},{flag:{[e.reversed?"$bitsAllClear":"$bitsAllSet"]:g.Dialogue.Flag.complement},$not:{guilds:{$el:e.guilds}}}]})})}A(S,"apply")});export default K();
