var C=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var G=Object.getOwnPropertyNames;var H=Object.prototype.hasOwnProperty;var N=(t,e)=>()=>(t&&(e=t(t=0)),e);var x=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var v=(t,e,a,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of G(e))!H.call(t,i)&&i!==a&&C(t,i,{get:()=>e[i],enumerable:!(r=F(e,i))||r.enumerable});return t},y=(t,e,a)=>(v(t,e,"default"),a&&v(a,e,"default"));var z=t=>v(C({},"__esModule",{value:!0}),t);import{Buffer as w}from"https://registry.koishi.chat/modules/buffer/index.js";import S from"https://registry.koishi.chat/modules/process/index.js";var d=N(()=>{});var f={};import*as ce from"https://registry.koishi.chat/modules/koishi/index.js";var _=N(()=>{d();y(f,ce)});var A=x(c=>{"use strict";d();Object.defineProperty(c,"__esModule",{value:!0});c.stripDataPrefix=c.NetworkError=c.download=c.arrayBufferToBase64=void 0;var K=(_(),z(f));function D(t){{let e="";for(let r=0;r<t.byteLength;r+=8192)e+=String.fromCharCode.apply(null,t.slice(r,r+8192));return btoa(e)}}c.arrayBufferToBase64=D;var V=10485760,B=["image/jpeg","image/png"];async function X(t,e,a={}){if(e.startsWith("data:")){let[,r,i]=e.match(/^data:(image\/\w+);base64,(.*)$/);if(!B.includes(r))throw new m(".unsupported-file-type");let n=atob(i),l=new Uint8Array(n.length);for(let p=0;p<n.length;p++)l[p]=n.charCodeAt(p);return{buffer:l,base64:i,dataUrl:e}}else{let r=await t.http.head(e,{headers:a});if(+r["content-length"]>V)throw new m(".file-too-large");let i=r["content-type"];if(!B.includes(i))throw new m(".unsupported-file-type");let n=await t.http.get(e,{responseType:"arraybuffer",headers:a}),l=D(n);return{buffer:n,base64:l,dataUrl:`data:${i};base64,${l}`}}}c.download=X;var m=class extends Error{constructor(e,a={}){super(e),this.params=a}};c.NetworkError=m;m.catch=t=>e=>{if(K.Quester.isAxiosError(e)){let a=e.response?.status;for(let r in t)if(a===+r)throw new m(t[r])}throw e};function Y(t){return t.replace(/^data:image\/[\w-]+;base64,/,"")}c.stripDataPrefix=Y});var M=x(T=>{"use strict";d();Object.defineProperty(T,"__esModule",{value:!0});T.Config=void 0;var u=(_(),z(f));T.Config=u.Schema.intersect([u.Schema.object({endpoint:u.Schema.string().description("API 服务器地址。例如 http://127.0.0.1:7860").default("http://127.0.0.1:7860"),headers:u.Schema.dict(String).description("要附加的额外请求头。如无必要，此项不填写。")}).description("接入设置"),u.Schema.object({upscalers:u.Schema.array(String).description("允许使用的超分辨率模型，默认使用第一个。").default(["SwinIR 4x","ScuNET","ScuNET PSNR","ESRGAN_4x","LDSR","Nearest","Lanczos","None"])}).description("模型设置"),u.Schema.object({maxRetryCount:u.Schema.natural().description("连接失败时最大的重试次数。").default(3),requestTimeout:u.Schema.number().role("time").description("当请求超过这个时间时会中止并提示超时。").default(u.Time.minute),recallTimeout:u.Schema.number().role("time").description("图片发送后自动撤回的时间 (设置为 0 以禁用此功能)。").default(0),maxConcurrency:u.Schema.number().description("单个频道下的最大并发数量 (设置为 0 以禁用此功能)。").default(0)}).description("高级设置")])});var U=x((me,Z)=>{Z.exports={commands:{extra:{description:"使用 SD-WebUI 对输入的图像进行超分辨率处理。",usage:`对输入的图像进行超分辨率处理
此插件基于 https://github.com/koishijs/novelai-bot 修改完成, 快去给原项目点个 star 吧！`,options:{resize:"放大倍数 (1~4) 默认为 2",upscaler:"通过名称选择模型（没做完",upscalerIndex:"通过序号选择模型（没做完"},example:"extra [图片]; extra -r 1.5 [图片]。",messages:{"expect-image":"请输入图片。","concurrent-jobs@random":["等会再约稿吧，我已经忙不过来了……","是数位板没电了，才…才不是我不想画呢！","那你得先教我画画（理直气壮"],"waiting@random":["少女绘画中……","在画了在画了","你就在此地不要走动，等我给你画一幅"],pending:"在画了在画了，不过前面还有 {0} 个稿……","file-too-large":"文件体积过大。","unsupported-file-type":"不支持的文件格式。","download-error":"图片解析失败。","unknown-error":"发生未知错误。","response-error":"发生未知错误 ({0})。","empty-response":"服务器返回了空白图片，请稍后重试。","request-failed":"请求失败 ({0})，请稍后重试。","request-timeout":"请求超时。"}}}}});var ae=x(s=>{d();var J=s&&s.__createBinding||(Object.create?function(t,e,a,r){r===void 0&&(r=a);var i=Object.getOwnPropertyDescriptor(e,a);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[a]}}),Object.defineProperty(t,r,i)}:function(t,e,a,r){r===void 0&&(r=a),t[r]=e[a]}),ee=s&&s.__exportStar||function(t,e){for(var a in t)a!=="default"&&!Object.prototype.hasOwnProperty.call(e,a)&&J(e,t,a)};Object.defineProperty(s,"__esModule",{value:!0});s.apply=s.name=s.reactive=void 0;var h=(_(),z(f)),I=A();ee(M(),s);s.reactive=!0;s.name="extra";var k=new h.Logger("extra");function te(t,e){if(h.Quester.isAxiosError(e)){if(e.response?.status===402)return t.text(".unauthorized");if(e.response?.status)return t.text(".response-error",[e.response.status]);if(e.code==="ETIMEDOUT")return t.text(".request-timeout");if(e.code)return t.text(".request-failed",[e.code])}return k.error(e),t.text(".unknown-error")}function re(t,e){t.i18n.define("zh",U());let a=Object.create(null),r=new Set,i=t.command("extra <prompts:text>").alias("ext").userFields(["authority"]).shortcut("放大",{fuzzy:!0}).option("resize","-r <resize:number>").option("upscaler","-s <upscaler:string>").option("upscalerIndex","-i <upscalerIndex:number>").action(async({session:n,options:l},p)=>{var P;if(!p?.trim())return n.execute("help extra");let E,O;p=h.segment.transform(p,{image(o){return E=o.url,""}});let g={resize:2,upscalerIndex:0,upscaler:void 0};if(Object.assign(g,{resize:l.resize??2,upscalerIndex:l.upscalerIndex??0}),E)try{O=await(0,I.download)(t,E)}catch(o){return o instanceof I.NetworkError?n.text(o.message,o.params):(k.error(o),n.text(".download-error"))}let b=Math.random().toString(36).slice(2);if(e.maxConcurrency){let o=a[P=n.cid]||(a[P]=new Set);if(o.size>=e.maxConcurrency)return n.text(".concurrent-jobs");o.add(b)}n.send(r.size?n.text(".pending",[r.size]):n.text(".waiting")),r.add(b);let q=()=>{a[n.cid]?.delete(b),r.delete(b)},L=(()=>({image:O&&O.dataUrl,upscaling_resize:g.resize,upscaler_1:g.upscaler??e.upscalers[g.upscalerIndex??0]}))(),R=()=>t.http.axios((0,h.trimSlash)(e.endpoint)+"/sdapi/v1/extra-single-image",{method:"POST",timeout:e.requestTimeout,headers:{...e.headers},data:L}).then(o=>(0,I.stripDataPrefix)(o.data.image)),j,Q=0;for(;;)try{j=await R(),q();break}catch(o){if(h.Quester.isAxiosError(o)&&o.code&&o.code!=="ETIMEDOUT"&&++Q<e.maxRetryCount)continue;return q(),te(n,o)}if(!j.trim())return n.text(".empty-response");function W(){return h.segment.image("base64://"+j)}let $=await n.send(W());e.recallTimeout&&t.setTimeout(()=>{for(let o of $)n.bot.deleteMessage(n.channelId,o)},e.recallTimeout)})}s.apply=re});export default ae();
