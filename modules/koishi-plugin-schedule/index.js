var I=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var z=Object.getOwnPropertyNames;var B=Object.prototype.hasOwnProperty;var k=(t,r)=>()=>(t&&(r=t(t=0)),r);var $=(t,r)=>()=>(r||t((r={exports:{}}).exports,r),r.exports);var T=(t,r,g,p)=>{if(r&&typeof r=="object"||typeof r=="function")for(let l of z(r))!B.call(t,l)&&l!==g&&I(t,l,{get:()=>r[l],enumerable:!(p=H(r,l))||p.enumerable});return t},w=(t,r,g)=>(T(t,r,"default"),g&&T(g,r,"default"));var J=t=>T(I({},"__esModule",{value:!0}),t);import{Buffer as j}from"https://registry.koishi.chat/modules/buffer/index.js";import M from"https://registry.koishi.chat/modules/process/index.js";var v=k(()=>{});var y={};import*as R from"https://registry.koishi.chat/modules/koishi/index.js";var N=k(()=>{v();w(y,R)});var O=$((V,L)=>{L.exports={general:{days:["日","一","二","三","四","五","六"],everyday:"每天 {0}",everyweek:"每周{0} {1}",interval:"每隔 <i18n:time value={0}/> (剩余 <i18n:time value={1}/>)"},commands:{schedule:{description:"设置定时命令",options:{rest:"要执行的指令",interval:"设置触发的间隔秒数",list:"查看已经设置的日程",ensure:"错过时间也确保执行",full:"查找全部上下文",delete:"删除已经设置的日程"},messages:{context:"，上下文：{0}","context.private":"私聊 {userId}","context.guild":"频道 {channelId}","delete-success":"日程 {0} 已删除。","create-success":"日程已创建，编号为 {0}。","list-empty":"当前没有等待执行的日程。","command-expected":"请输入要执行的指令。","date-invalid":"请输入合法的日期。","date-invalid-suggestion":"请输入合法的日期。你要输入的是不是 {0}s？","date-expected":"请输入执行时间。","date-past":"不能指定过去的时间为执行时间。","interval-invalid":"请输入合法的时间间隔。","interval-too-short":"时间间隔过短。"}}}}});var U=$(o=>{v();Object.defineProperty(o,"__esModule",{value:!0});o.apply=o.Config=o.using=o.name=void 0;var s=(N(),J(y)),S=new s.Logger("schedule");o.name="schedule";o.using=["database"];o.Config=s.Schema.object({minInterval:s.Schema.natural().role("ms").description("允许的最小时间间隔。").default(s.Time.minute)});function _(t){return`${s.Time.toDigits(t.getHours())}:${s.Time.toDigits(t.getMinutes())}`}function P(t,{minInterval:r}){t.i18n.define("zh",O());function g(e,a,n){if(a){if(a===s.Time.day)return n.text("general.everyday",[_(e)]);if(a===s.Time.week)return n.text("general.everyweek",[n.text("general.days."+e.getDay()),_(e)]);{let i=Date.now();return n.text("general.interval",[a,+e<i?a-(i-+e)%a:+e-i])}}else return s.Time.template("yyyy-MM-dd hh:mm:ss",e)}t.model.extend("schedule",{id:"unsigned",assignee:"string",time:"timestamp",lastCall:"timestamp",interval:"integer",command:"text",session:"json"},{autoInc:!0});async function p(e){return(await t.database.get("schedule",[e])).length}async function l({id:e,interval:a,command:n,time:i,lastCall:u},m){let d=Date.now(),f=i.valueOf();async function c(){S.debug("execute %d: %c",e,n),await m.execute(n),!(!u||!a)&&(u=new Date,await t.database.set("schedule",e,{lastCall:u}))}if(!a){if(f<d){t.database.remove("schedule",[e]),u&&c();return}return S.debug("prepare %d: %c at %s",e,n,i),t.setTimeout(async()=>{await p(e)&&(t.database.remove("schedule",[e]),c())},f-d)}S.debug("prepare %d: %c from %s every %s",e,n,i,s.Time.format(a));let h=f<d?a-(d-f)%a:f-d;u&&h+d-a>+u&&c(),t.setTimeout(async()=>{if(!await p(e))return;let x=t.setInterval(async()=>{if(!await p(e))return x();c()},a);c()},h)}t.on("ready",async()=>{let e=await t.database.get("schedule",{}),a={};e.forEach(n=>{let{session:i,assignee:u}=n,m=t.bots[u];m?l(n,new s.Session(m,i)):(a[u]||(a[u]=[])).push(n)}),t.on("bot-status-updated",n=>{if(n.status!=="online")return;let i=a[n.sid];i&&(delete a[n.sid],i.forEach(u=>{l(u,new s.Session(n,u.session))}))})}),t.command("schedule [time]",{authority:3,checkUnknown:!0}).option("rest","-- <command:text>").option("interval","/ <interval:string>",{authority:4}).option("list","-l").option("ensure","-e").option("full","-f",{authority:4}).option("delete","-d <id>").action(async({session:e,options:a},...n)=>{if(a.delete)return await t.database.remove("schedule",[a.delete]),e.text(".delete-success",[a.delete]);if(a.list){let c=await t.database.get("schedule",{assignee:[e.sid]});return a.full||(c=c.filter(h=>e.channelId===h.session.channelId)),c.length?c.map(({id:h,time:x,interval:q,command:E,session:b})=>{let D=`${h}. ${g(x,q,e)}：${E}`;return a.full&&(D+=e.text(".context",[b.subtype==="private"?e.text(".context.private",b):e.text(".context.guild",b)])),D}).join(`
`):e.text(".list-empty")}if(!a.rest)return e.text(".command-expected");let i=n.join("-"),u=s.Time.parseDate(i),m=+u;if(Number.isNaN(m)||m>2147483647e3)return/^\d+$/.test(i)?e.text(".date-invalid-suggestion",[i]):e.text(".date-invalid");if(!a.interval)if(i){if(m<=Date.now())return e.text(".date-past")}else return e.text(".date-expected");let d=s.Time.parseTime(a.interval);if(!d&&a.interval)return e.text(".interval-invalid");if(d&&d<r)return e.text(".interval-too-short");let f=await t.database.create("schedule",{time:u,assignee:e.sid,interval:d,command:a.rest,session:e.toJSON()});return l(f,e),e.text(".create-success",[f.id])})}o.apply=P});export default U();
