var at=Object.defineProperty;var _t=Object.getOwnPropertyDescriptor;var yt=Object.getOwnPropertyNames;var bt=Object.prototype.hasOwnProperty;var tt=(t,e)=>()=>(t&&(e=t(t=0)),e);var W=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var E=(t,e,r,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of yt(e))!bt.call(t,n)&&n!==r&&at(t,n,{get:()=>e[n],enumerable:!(s=_t(e,n))||s.enumerable});return t},O=(t,e,r)=>(E(t,e,"default"),r&&E(r,e,"default"));var lt=t=>E(at({},"__esModule",{value:!0}),t);import{Buffer as L}from"https://registry.koishi.chat/modules/buffer/index.js";import K from"https://registry.koishi.chat/modules/process/index.js";var C=tt(()=>{});var P={};import*as Nt from"https://registry.koishi.chat/modules/cosmokit/index.js";var ct=tt(()=>{C();O(P,Nt)});var ht=W((Ut,pt)=>{C();var kt=Object.defineProperty,x=(t,e)=>kt(t,"name",{value:e,configurable:!0}),k=(ct(),lt(P)),ft=Symbol.for("satori.element");function G(t){return t&&typeof t=="object"&&t[ft]}x(G,"isElement");function et(t){if(typeof t=="string"||typeof t=="number"||typeof t=="boolean"){if(t=""+t,t)return D("text",{content:t})}else{if(G(t))return t;if(!(0,k.isNullable)(t))throw new TypeError(`Invalid content: ${t}`)}}x(et,"toElement");function V(t){return Array.isArray(t)?t.map(et).filter(e=>e):[et(t)].filter(e=>e)}x(V,"toElementArray");var H=class{get data(){return this.attrs}toString(t=!1){if(this.type==="text")return t?this.attrs.content:D.escape(this.attrs.content);let e=this.children.map(s=>s.toString(t)).join("");if(t)return e;let r=Object.entries(this.attrs).map(([s,n])=>(0,k.isNullable)(n)?"":(s=(0,k.hyphenate)(s),n===!0?` ${s}`:n===!1?` no-${s}`:` ${s}="${D.escape(""+n,!0)}"`)).join("");return this.children.length?`<${this.type}${r}>${e}</${this.type}>`:`<${this.type}${r}/>`}};x(H,"ElementConstructor");(0,k.defineProperty)(H,"name","Element");(0,k.defineProperty)(H.prototype,ft,!0);function D(t,...e){let r=Object.create(H.prototype),s={},n=[];if(e[0]&&typeof e[0]=="object"&&!G(e[0])&&!Array.isArray(e[0])){let p=e.shift();for(let[h,u]of Object.entries(p))(0,k.isNullable)(u)||(h==="children"?e.push(...(0,k.makeArray)(u)):s[h]=u)}for(let p of e)n.push(...V(p));return Object.assign(r,{type:t,attrs:s,children:n})}x(D,"Element");var zt=new Function("expr","context",`
  try {
    with (context) {
      return eval(expr)
    }
  } catch {}
`);(t=>{t.jsx=t,t.jsxs=t,t.jsxDEV=t,t.Fragment="template";function e(o,i){return typeof o!="string"?V(o):t.parse(o,i)}t.normalize=e,x(e,"normalize");function r(o,i=!1){let a=o.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return i?a.replace(/"/g,"&quot;"):a}t.escape=r,x(r,"escape");function s(o){return o.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#(\d+);/g,(i,a)=>a==="38"?i:String.fromCharCode(+a)).replace(/&#x([0-9a-f]+);/gi,(i,a)=>a==="26"?i:String.fromCharCode(parseInt(a,16))).replace(/&(amp|#38|#x26);/g,"&")}t.unescape=s,x(s,"unescape");function n(o,i={}){var a;let c=S(o);return i.caret?i.type&&((a=c[0])==null?void 0:a.type)!==i.type?void 0:c[0]:u(c,i.type||"*")[0]}t.from=n,x(n,"from");let p=/ *([ >+~]) */g;function h(o){return o.split(",").map(i=>{let a=[];i=i.trim();let c,m=" ";for(;c=p.exec(i);)a.push({type:i.slice(0,c.index),combinator:m}),m=c[1],i=i.slice(c.index+c[0].length);return a.push({type:i,combinator:m}),a})}t.parseSelector=h,x(h,"parseSelector");function u(o,i){if(!o||!i)return[];if(typeof o=="string"&&(o=S(o)),typeof i=="string"&&(i=h(i)),!i.length)return[];let a=[],c=[];for(let[m,b]of o.entries()){let $=[],g=[...i,...a];a=[];let v=!1;for(let l of g){let{type:_,combinator:A}=l[0];(_===b.type||_==="*")&&(l.length===1?v=!0:[" ",">"].includes(l[1].combinator)?$.push(l.slice(1)):l[1].combinator==="+"?a.push(l.slice(1)):i.push(l.slice(1))),A===" "&&$.push(l)}v&&c.push(o[m]),c.push(...u(b.children,$))}return c}t.select=u,x(u,"select");function w(o,i){var a;if(o=o.trim(),!/^[\w.]+$/.test(o))return(a=zt(o,i))!=null?a:"";let c=i;for(let m of o.split("."))if(c=c[m],(0,k.isNullable)(c))return"";return c??""}t.interpolate=w,x(w,"interpolate");let y=/<!--[\s\S]*?-->|<(\/?)([^!\s>/]*)([^>]*?)\s*(\/?)>/,d=/([^\s=]+)(?:="([^"]*)"|='([^']*)')?/g,z=/([^\s=]+)(?:="([^"]*)"|='([^']*)'|=\{([^}]+)\})?/g,F=/\{([^}]*)\}/;function S(o,i){let a=[];function c(l){l&&a.push(t("text",{content:l}))}x(c,"pushText");let m=i?z:d,b;for(;b=y.exec(o);){$(o.slice(0,b.index));let[l,_,A,Y,Z]=b;if(o=o.slice(b.index+l.length),l.startsWith("<!"))continue;let U={source:l,type:A||t.Fragment,close:_,empty:Z,attrs:{}},it;for(;it=m.exec(Y);){let[Dt,q,xt,nt=xt,ot]=it;ot?U.attrs[(0,k.camelize)(q)]=w(ot,i):(0,k.isNullable)(nt)?q.startsWith("no-")?U.attrs[(0,k.camelize)(q.slice(3))]=!1:U.attrs[(0,k.camelize)(q)]=!0:U.attrs[(0,k.camelize)(q)]=s(nt)}a.push(U)}$(o);function $(l){if(l=l.replace(/^\s*\n\s*/,"").replace(/\s*\n\s*$/,""),i){let _;for(;_=F.exec(l);){let[A,Y]=_;c(s(l.slice(0,_.index))),l=l.slice(_.index+A.length);let Z=w(Y,i);a.push(...V(Z))}}c(s(l))}x($,"parseContent");let g=[t(t.Fragment)];function v(l){for(;l>0;l--){let{children:_}=g.shift(),{source:A}=g[0].children.pop();g[0].children.push(t("text",{content:A})),g[0].children.push(..._)}}x(v,"rollback");for(let l of a)if(G(l))g[0].children.push(l);else if(l.close){let _=0;for(;_<g.length&&g[_].type!==l.type;)_++;if(_===g.length)g[0].children.push(t("text",{content:l.source}));else{v(_);let A=g.shift();delete A.source}}else{let _=t(l.type,l.attrs);g[0].children.push(_),l.empty||(_.source=l.source,g.unshift(_))}return v(g.length-1),g[0].children}t.parse=S,x(S,"parse");function B(o,i,a){var c,m;let{type:b,attrs:$,children:g}=o;if(typeof i=="function")return i(o,a);{let v=(m=(c=i[b])!=null?c:i.default)!=null?m:!0;return typeof v=="function"&&(v=v($,g,a)),v}}x(B,"visit");function M(o,i,a){let c=typeof o=="string"?S(o):o,m=[];return c.forEach(b=>{let{type:$,attrs:g,children:v}=b,l=B(b,i,a);l===!0?m.push(t($,g,M(v,i,a))):l!==!1&&m.push(...e(l))}),typeof o=="string"?m.join(""):m}t.transform=M,x(M,"transform");async function X(o,i,a){let c=typeof o=="string"?S(o):o,m=(await Promise.all(c.map(async b=>{let{type:$,attrs:g,children:v}=b,l=await B(b,i,a);return l===!0?[t($,g,await X(v,i,a))]:l!==!1?e(l):[]}))).flat(1);return typeof o=="string"?m.join(""):m}t.transformAsync=X,x(X,"transformAsync");function I(o,...i){return(...a)=>{let c=t(o);return i.forEach((m,b)=>{(0,k.isNullable)(a[b])||(c.attrs[m]=a[b])}),a[i.length]&&Object.assign(c.attrs,a[i.length]),c}}x(I,"createFactory"),t.warn=x(()=>{},"warn");function N(o){return(i,...a)=>{let c="base64://";return typeof a[0]=="string"&&(c=`data:${a.shift()};base64,`),(0,k.is)("Buffer",i)?i=c+i.toString("base64"):(0,k.is)("ArrayBuffer",i)&&(i=c+(0,k.arrayBufferToBase64)(i)),i.startsWith("base64://")&&(0,t.warn)('protocol "base64:" is deprecated and will be removed in the future, please use "data:" instead'),t(o,{...a[0],url:i})}}x(N,"createAssetFactory"),t.text=I("text","content"),t.at=I("at","id"),t.sharp=I("sharp","id"),t.quote=I("quote","id"),t.image=N("image"),t.video=N("video"),t.audio=N("audio"),t.file=N("file")})(D||(D={}));pt.exports=D});var T={};import*as Wt from"https://registry.koishi.chat/modules/koishi/index.js";var ut=tt(()=>{C();O(T,Wt)});var mt=W(J=>{"use strict";C();Object.defineProperty(J,"__esModule",{value:!0});J.Klotsk=void 0;var dt=console.log,rt=class{constructor(e){this.cmd_strs="",this.theme=[],this.drctn_dist={U:[-1,0],D:[1,0],L:[0,-1],R:[0,1]},this.drctn_list=["U","D","L","R"],this.mode=e,this.klotsk=[],this.num=1,this.crtpuzzle=[];for(let s=0;s<this.mode;s++){var r=[];for(let n=0;n<this.mode;n++)r.push(this.num),this.num++;this.crtpuzzle.push([].concat(r)),this.klotsk.push([].concat(r))}this.crtpuzzle[this.mode-1][this.mode-1]=0,this.klotsk[this.mode-1][this.mode-1]=0,this.start_time=new Date().getTime(),this.end_time=0,this.shfl()}find_0(){for(let e=0;e<this.mode;e++)for(let r=0;r<this.mode;r++)if(this.klotsk[e][r]==0)return[e,r]}move(e){let[r,s]=this.find_0();if(r==0&&e=="U")return"";if(r==this.mode-1&&e=="D")return"";if(s==0&&e=="L")return"";if(s==this.mode-1&&e=="R")return"";let[n,p]=this.drctn_dist[e],h=this.klotsk[n+r][p+s];return this.klotsk[r][s]=h,this.klotsk[n+r][p+s]=0,e}check(){for(let e=0;e<this.mode;e++)for(let r=0;r<this.mode;r++)if(this.klotsk[e][r]!=this.crtpuzzle[e][r])return!1;return!0}move_sqnc(e){this.cmd_strs="";let r=e.split("");for(var s in r){var n=this.move(r[s]);if(this.cmd_strs+=n,this.check()){let p=this.duration();return dt(`已还原,用时${p}`),this.logf(),!0}}return!1}shfl(){for(let e=0;e<1e3;e++){let r=(Math.random()*3).toFixed(0);this.move(this.drctn_list[r])}}logf(){for(var e in this.klotsk)dt(this.klotsk[e])}duration(){let r=new Date().getTime()-this.start_time;return this.strftime(r)}strftime(e){let r=Math.floor(e/3600),s=Math.floor(e%3600/60),n=Math.floor(e%60);return`${r}:${s}:${n}`}};J.Klotsk=rt});var gt=W((Ht,vt)=>{vt.exports={commands:{puzzle:{description:"数字华容道",options:{mode:"模式,示例：pz -m 5",ranke:"排行榜,示例 pz - r 5",size:"图片大小，单位：px，示例：pz -s 100"},messages:{"bad-mode":"模式不支持,仅支持(3-5阶)",gameover:"游戏结束",notFound:"游戏不存在"}},def:{description:"自定义华容道",messages:{"bad-mode":"模式不支持,仅支持(3-5阶)"}}}}});var Rt=W(f=>{C();Object.defineProperty(f,"__esModule",{value:!0});f.apply=f.draw_img=f.quickSort=f.add_scroe=f.game=f.replace_n=f.find_color=f.theme=f.Config=f.log=f.usage=f.name=void 0;var j=ht(),st=(ut(),lt(T)),jt=mt();f.name="puzzle";f.usage=`
## 注意事项
> 原游戏 <a href="http://tapsss.com">扫雷联萌</a>
本插件仅供学习参考，请勿用于商业行为
对于部署者行为及所产生的任何纠纷， Koishi 及 koishi-plugin-puzzle 概不负责。
如果有更多文本内容想要修改，可以在<a href="/locales">本地化</a>中修改 zh 内容
`;f.log=console.log;f.Config=st.Schema.object({maxConcurrency:st.Schema.number().default(3).description("最大排队数"),size:st.Schema.number().default(50).description("图片大小")});f.theme=[["#707070","#707070","#707070","#707070","#707070"],["#444444","#00C91A","#00C91A","#00C91A","#00C91A"],["#444444","#008314","#006FFF","#006FFF","#006FFF"],["#444444","#008314","#001EE1","#FF0000","#FF0000"],["#444444","#008314","#001EE1","#BB0000","#ED9512"]];var wt=(t,e)=>{var r=0;for(let s=0;s<e;s++)for(let n=0;n<e;n++){if(t==r)return f.theme[s][n];r++}};f.find_color=wt;var $t=t=>{if(t.indexOf(`
`)==-1)return t;var e=t.replace(`
`," ");return(0,f.replace_n)(e)};f.replace_n=$t;var R={},Ft=["U","D","L","R"],Ct=async(t,e,r,s)=>{let n=R[t],h=e.toUpperCase().split(""),u="";if(h.forEach(y=>{Ft.includes(y)&&(u+=y)}),n.move_sqnc(u)){let y=`已还原,执行操作${u},
用时${n.duration()}`;await(0,f.add_scroe)(s,t,r,n.mode);let d=[].concat(n.klotsk);return delete R[t],[y,d]}else return[`执行操作${u},
用时${n.duration()}`,n.klotsk]};f.game=Ct;var At=async(t,e,r,s)=>{let n=await t.database.get("puzzle",["id","score"]);(n.length=0)?await t.database.create("puzzle",{gid:e,uid:r,mode:s,score:1}):await t.database.set("puzzle",[n[0].id],{score:n[0].score+1})};f.add_scroe=At;function Q(t){if(t.length<2)return t;let e=t[0].score,r=[],s=[];for(let n=1;n<t.length;n++)t[n].score>e?r.push(t[n]):s.push(t[n]);return Q(r).concat([t[0]]).concat(Q(s))}f.quickSort=Q;var St=(t,e,r,s)=>{if(t.puppeteer){let h=[];for(let y=0;y<e.length;y++)for(let d=0;d<e.length;d++){var n=`position: absolute;font-size: ${r/1.7}px;text-align: center;width: ${r}px;height: ${r}px;left: ${d*r+8}px;top: ${y*r+8}px;background: ${(0,f.find_color)(e[y][d],e.length)}`;h.push([n,e[y][d]])}let w=h.map(y=>(0,j.jsx)("div",{style:y[0],children:y[1]}));return w.push((0,j.jsx)("p",{style:`position: absolute;text-align: center;font-size: ${r/3}px;width: ${r*e.length}px;height: ${r/4}px;left: 8px;top: ${e.length*r+8}px`,children:s})),w}else{var p="";for(let h=0;h<e.length;h++){for(let u=0;u<e.length;u++)p+=e[h][u]+" ";p+=`
`}return p+=s,(0,j.jsx)("p",{children:p})}};f.draw_img=St;function Ot(t,e){t.i18n.define("zh",gt()),t.model.extend("puzzle",{id:"unsigned",gid:"string",uid:"string",mode:"integer",score:"integer"},{autoInc:!0}),t.command("def <prompt:text>").option("size","-s <size:number>").action(({session:r,options:s},n)=>{let p=s.size?s.size:e.size;if(n){let w=n,d=(0,f.replace_n)(w).split(" "),z=Math.sqrt(d.length);if(z>5)return r.text(".bad-mode");let F=[];var h=0;for(let B=0;B<z;B++){var u=[];for(let M=0;M<z;M++)u.push(parseInt(d[h])),h++;F.push(u)}let S=(0,f.draw_img)(t,F,p,n.slice(0,12)+`
`+n.slice(12,-1));return(0,j.jsxs)("html",{children:[(0,j.jsx)("div",{style:{width:z*p+"px",height:z*p+100+"px",background:"transparent"}}),S]})}}),t.command("puzzle <prompt:string>").alias("pz").option("mode","-m <mode:number>").option("opt","-o <opt:string>").option("size","-s <size:number>").option("rank","-r <rank:number>").action(async({session:r,options:s},n)=>{let p=r.channelId,h=r.userId;if(s.rank){let d=await t.database.get("puzzle",{mode:[s.rank]},["uid","score"]),z=Q(d),F=[];for(var u in z){var w=z[u];F.push((0,j.jsx)("div",{style:"font-size:40px;width:200px;height:50px",children:`${w.uid}:${w.score}`}))}return F.push((0,j.jsx)("div",{style:"font-size:20px;width:200px;height:50px",children:"----------------------"})),F.push((0,j.jsx)("div",{style:"font-size:20px;width:200px;height:50px",children:`${s.rank}x${s.rank}排行榜`})),(0,j.jsxs)("html",{children:[(0,j.jsx)("div",{style:{width:"200px",height:(d.length+1)*50+30+"px",background:"transparent"}}),F]})}if(s.mode>5)return r.text(".bad-mode");if(s.opt=="stop")return Object.keys(R).includes(p)?(delete R[p],r.text(".gameover")):r.text(".notFound");if(Object.keys(R).includes(p)){let d=await(0,f.game)(p,n||"",h,t),z=(0,f.draw_img)(t,d[1],s.size?s.size:e.size,d[0]);var y=R[p];return(0,j.jsxs)("html",{children:[(0,j.jsx)("div",{style:{width:y.mode*e.size+"px",height:y.mode*e.size+60+"px",background:"transparent"}}),z]})}else if(e.maxConcurrency){if(Object.keys(R).length>=e.maxConcurrency)return r.text(".concurrent-jobs");{let d=new jt.Klotsk(s.mode?s.mode:5);R[p]=d;let z=await(0,f.game)(p,n||"",h,t),F=(0,f.draw_img)(t,z[1],s.size?s.size:e.size,z[0]);return(0,j.jsxs)("html",{children:[(0,j.jsx)("div",{style:{width:d.mode*e.size+"px",height:d.mode*e.size+60+"px",background:"transparent"}}),F]})}}})}f.apply=Ot});export default Rt();
