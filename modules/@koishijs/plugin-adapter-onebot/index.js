var ke=Object.create;var T=Object.defineProperty;var xe=Object.getOwnPropertyDescriptor;var Se=Object.getOwnPropertyNames;var qe=Object.getPrototypeOf,Ge=Object.prototype.hasOwnProperty;var U=(e,t)=>()=>(e&&(t=e(e=0)),t);var ie=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),Me=(e,t)=>{for(var i in t)T(e,i,{get:t[i],enumerable:!0})},W=(e,t,i,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Se(t))!Ge.call(e,r)&&r!==i&&T(e,r,{get:()=>t[r],enumerable:!(s=xe(t,r))||s.enumerable});return e},p=(e,t,i)=>(W(e,t,"default"),i&&W(i,t,"default")),se=(e,t,i)=>(i=e!=null?ke(qe(e)):{},W(t||!e||!e.__esModule?T(i,"default",{value:e,enumerable:!0}):i,e)),m=e=>W(T({},"__esModule",{value:!0}),e);import{Buffer as Q}from"https://registry.koishi.chat/modules/buffer/index.js";import j from"https://registry.koishi.chat/modules/process/index.js";var _=U(()=>{});var g={};import*as Je from"https://registry.koishi.chat/modules/koishi/index.js";var y=U(()=>{_();p(g,Je)});var q={};import*as Ve from"https://registry.koishi.chat/modules/qface/index.js";var ne=U(()=>{_();p(q,Ve)});import Oe from"https://registry.koishi.chat/modules/crypto-browserify/index.js";var ae=ie((Xe,re)=>{_();re.exports=Oe});var ee=ie((Ze,we)=>{_();var Be=Object.create,N=Object.defineProperty,Ce=Object.getOwnPropertyDescriptor,Ee=Object.getOwnPropertyNames,Qe=Object.getPrototypeOf,je=Object.prototype.hasOwnProperty,l=(e,t)=>N(e,"name",{value:t,configurable:!0}),ce=(e,t)=>{for(var i in t)N(e,i,{get:t[i],enumerable:!0})},pe=(e,t,i,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Ee(t))!je.call(e,r)&&r!==i&&N(e,r,{get:()=>t[r],enumerable:!(s=Ce(t,r))||s.enumerable});return e},Pe=(e,t,i)=>(i=e!=null?Be(Qe(e)):{},pe(t||!e||!e.__esModule?N(i,"default",{value:e,enumerable:!0}):i,e)),Ae=e=>pe(N({},"__esModule",{value:!0}),e),ge={};ce(ge,{BaseBot:()=>x,CQCode:()=>$,HttpServer:()=>O,OneBot:()=>_e,OneBotBot:()=>E,OneBotMessenger:()=>Y,QQGuildBot:()=>Z,WsClient:()=>B,WsServer:()=>C,accept:()=>R,default:()=>We});we.exports=Ae(ge);var h=(y(),m(g)),w=(y(),m(g)),_e={};ce(_e,{Internal:()=>n,SafetyLevel:()=>fe,TimeoutError:()=>V,adaptAuthor:()=>ve,adaptChannel:()=>D,adaptGuild:()=>L,adaptGuildMember:()=>J,adaptMessage:()=>A,adaptQQGuildMemberInfo:()=>ye,adaptQQGuildMemberProfile:()=>be,adaptSession:()=>X,adaptUser:()=>M,dispatchSession:()=>z});var f=(y(),m(g)),Le=Pe((ne(),m(q))),he=(y(),m(g)),fe=(e=>(e[e.safe=0]="safe",e[e.unknown=1]="unknown",e[e.danger=2]="danger",e))(fe||{}),V=class extends Error{constructor(e,t){super(`Timeout with request ${t}, args: ${JSON.stringify(e)}`),Object.defineProperties(this,{args:{value:e},url:{value:t}})}};l(V,"TimeoutError");var me=class extends Error{constructor(e,t,i){super(`Error with request ${t}, args: ${JSON.stringify(e)}, retcode: ${i}`),Object.defineProperties(this,{code:{value:i},args:{value:e},url:{value:t}})}};l(me,"SenderError");var oe=new he.Logger("onebot"),v=class{async _get(e,t={}){oe.debug("[request] %s %o",e,t);let i=await this._request(e,t);oe.debug("[response] %o",i);let{data:s,retcode:r}=i;if(r===0)return s;throw new me(t,e,r)}async setGroupAnonymousBan(e,t,i){let s={group_id:e,duration:i};s[typeof t=="string"?"flag":"anonymous"]=t,await this._get("set_group_anonymous_ban",s)}async setGroupAnonymousBanAsync(e,t,i){let s={group_id:e,duration:i};s[typeof t=="string"?"flag":"anonymous"]=t,await this._get("set_group_anonymous_ban_async",s)}static prepareMethod(e){let t=(0,he.camelize)(e.replace(/^[_.]/,"")),i=v.asyncPrefixes.some(s=>t.startsWith(s));return[t,i]}static define(e,...t){let[i,s]=v.prepareMethod(e);v.prototype[i]=async function(...r){let o=await this._get(e,Object.fromEntries(t.map((a,d)=>[a,r[d]])));if(!s)return o},s&&(v.prototype[i+"Async"]=async function(...r){await this._get(e+"_async",Object.fromEntries(t.map((o,a)=>[o,r[a]])))})}static defineExtract(e,t,...i){let[s,r]=v.prepareMethod(e);v.prototype[s]=async function(...o){return(await this._get(e,Object.fromEntries(i.map((d,u)=>[d,o[u]]))))[t]},r&&(v.prototype[s+"Async"]=async function(...o){await this._get(e+"_async",Object.fromEntries(i.map((a,d)=>[a,o[d]])))})}},n=v;l(n,"Internal");n.asyncPrefixes=["set","send","delete","create","upload"];n.defineExtract("send_private_msg","message_id","user_id","message","auto_escape");n.defineExtract("send_group_msg","message_id","group_id","message","auto_escape");n.defineExtract("send_group_forward_msg","message_id","group_id","messages");n.defineExtract("send_private_forward_msg","message_id","user_id","messages");n.define("delete_msg","message_id");n.define("mark_msg_as_read","message_id");n.define("set_essence_msg","message_id");n.define("delete_essence_msg","message_id");n.define("send_group_sign","group_id");n.define("send_like","user_id","times");n.define("get_msg","message_id");n.define("get_essence_msg_list","group_id");n.define("ocr_image","image");n.defineExtract("get_forward_msg","messages","message_id");n.defineExtract(".get_word_slices","slices","content");n.define("get_group_msg_history","group_id","message_seq");n.define("set_friend_add_request","flag","approve","remark");n.define("set_group_add_request","flag","sub_type","approve","reason");n.defineExtract("_get_model_show","variants","model");n.define("_set_model_show","model","model_show");n.define("set_group_kick","group_id","user_id","reject_add_request");n.define("set_group_ban","group_id","user_id","duration");n.define("set_group_whole_ban","group_id","enable");n.define("set_group_admin","group_id","user_id","enable");n.define("set_group_anonymous","group_id","enable");n.define("set_group_card","group_id","user_id","card");n.define("set_group_leave","group_id","is_dismiss");n.define("set_group_special_title","group_id","user_id","special_title","duration");n.define("set_group_name","group_id","group_name");n.define("set_group_portrait","group_id","file","cache");n.define("_send_group_notice","group_id","content");n.define("_get_group_notice","group_id");n.define("_del_group_notice","group_id","notice_id");n.define("get_group_at_all_remain","group_id");n.define("get_login_info");n.define("qidian_get_login_info");n.define("set_qq_profile","nickname","company","email","college","personal_note");n.define("get_stranger_info","user_id","no_cache");n.define("_get_vip_info","user_id");n.define("get_friend_list");n.define("get_unidirectional_friend_list");n.define("delete_friend","user_id");n.define("delete_unidirectional_friend","user_id");n.define("get_group_info","group_id","no_cache");n.define("get_group_list");n.define("get_group_member_info","group_id","user_id","no_cache");n.define("get_group_member_list","group_id");n.define("get_group_honor_info","group_id","type");n.define("get_group_system_msg");n.define("get_group_file_system_info","group_id");n.define("get_group_root_files","group_id");n.define("get_group_files_by_folder","group_id","folder_id");n.define("upload_private_file","user_id","file","name");n.define("upload_group_file","group_id","file","name","folder");n.define("create_group_file_folder","group_id","folder_id","name");n.define("delete_group_folder","group_id","folder_id");n.define("delete_group_file","group_id","folder_id","file_id","busid");n.defineExtract("get_group_file_url","url","group_id","file_id","busid");n.defineExtract("download_file","file","url","headers","thread_count");n.defineExtract("get_online_clients","clients","no_cache");n.defineExtract("check_url_safely","level","url");n.defineExtract("get_cookies","cookies","domain");n.defineExtract("get_csrf_token","token");n.define("get_credentials","domain");n.define("get_record","file","out_format","full_path");n.define("get_image","file");n.defineExtract("can_send_image","yes");n.defineExtract("can_send_record","yes");n.define("get_status");n.define("get_version_info");n.define("set_restart","delay");n.define("reload_event_filter");n.define("get_guild_service_profile");n.define("get_guild_list");n.define("get_guild_meta_by_guest","guild_id");n.define("get_guild_channel_list","guild_id","no_cache");n.define("get_guild_member_list","guild_id","next_token");n.define("get_guild_member_profile","guild_id","user_id");n.defineExtract("send_guild_channel_msg","message_id","guild_id","channel_id","message");var $e=new f.Logger("onebot"),M=l(e=>({userId:e.tiny_id||e.user_id.toString(),avatar:e.user_id?`http://q.qlogo.cn/headimg_dl?dst_uin=${e.user_id}&spec=640`:void 0,username:e.nickname}),"adaptUser"),J=l(e=>({...M(e),nickname:e.card,roles:[e.role]}),"adaptGuildMember"),ye=l(e=>({userId:e.tiny_id,username:e.nickname,nickname:e.nickname,roles:e.role_name?[e.role_name]:[],isBot:e.role_name==="机器人"}),"adaptQQGuildMemberInfo"),be=l(e=>{var t,i;return{userId:e.tiny_id,username:e.nickname,nickname:e.nickname,roles:((t=e.roles)==null?void 0:t.map(s=>s.role_name))||[],isBot:(i=e.roles)==null?void 0:i.some(s=>s.role_name==="机器人")}},"adaptQQGuildMemberProfile"),ve=l((e,t)=>({...M(e),nickname:t?.name||e.card,anonymous:t?.flag,roles:[e.role]}),"adaptAuthor");async function A(e,t,i={}){var s;i.author=ve(t.sender,t.anonymous),i.userId=i.author.userId,i.messageId=t.message_id.toString(),i.timestamp=t.time*1e3,t.guild_id?(i.guildId=t.guild_id,i.channelId=t.channel_id):t.group_id?i.guildId=i.channelId=t.group_id.toString():i.channelId="private:"+i.author.userId;let r=$.parse(t.message);if(e.config.advanced.splitMixedContent&&r.forEach((o,a)=>{if(o.type!=="image")return;let d=r[a-1];d&&d.type==="text"&&d.attrs.content.trimEnd()===d.attrs.content&&(d.attrs.content+=" ");let u=r[a+1];u&&u.type==="text"&&u.attrs.content.trimStart()===u.attrs.content&&(u.attrs.content=" "+u.attrs.content)}),i.elements=f.segment.transform(r,{at({qq:o}){return o!=="all"?f.segment.at(o):(0,f.segment)("at",{type:"all"})},face({id:o}){return(0,f.segment)("face",{id:o,platform:e.platform},[f.segment.image(Le.getUrl(o))])},record(o){return(0,f.segment)("audio",o)}}),((s=i.elements[0])==null?void 0:s.type)==="reply"){let o=i.elements.shift();i.quote=await e.getMessage(i.channelId,o.attrs.id).catch(a=>{$e.warn(a)})}return i.content=i.elements.join(""),i}l(A,"adaptMessage");var L=l(e=>{if(e.guild_id){let t=e;return{guildId:t.guild_id,guildName:t.guild_name}}else{let t=e;return{guildId:t.group_id.toString(),guildName:t.group_name}}},"adaptGuild"),D=l(e=>{if(e.channel_id){let t=e;return{channelId:t.channel_id.toString(),channelName:t.channel_name}}else{let t=e;return{channelId:t.group_id.toString(),channelName:t.group_name}}},"adaptChannel");async function z(e,t){if(t.self_tiny_id&&(e=e.guildBot,!e))return;let i=await X(e,t);i&&((0,f.defineProperty)(i,"onebot",Object.create(e.internal)),Object.assign(i.onebot,t),e.dispatch(i))}l(z,"dispatchSession");async function X(e,t){let i=e.session();if(i.selfId=t.self_tiny_id?t.self_tiny_id:""+t.self_id,i.type=t.post_type,t.post_type==="message"||t.post_type==="message_sent")return await A(e,t,i),t.post_type==="message_sent"&&!i.guildId&&(i.channelId="private:"+t.target_id),i.type="message",i.subtype=t.message_type==="guild"?"group":t.message_type,i.subsubtype=t.message_type,i;if(i.subtype=t.sub_type,t.user_id&&(i.userId=""+t.user_id),t.group_id&&(i.guildId=i.channelId=""+t.group_id),t.guild_id&&(i.guildId=""+t.guild_id),t.channel_id&&(i.channelId=""+t.channel_id),t.target_id&&(i.targetId=""+t.target_id),t.operator_id&&(i.operatorId=""+t.operator_id),t.message_id&&(i.messageId=""+t.message_id),t.post_type==="request")i.content=t.comment,i.messageId=t.flag,t.request_type==="friend"?(i.type="friend-request",i.channelId=`private:${i.userId}`):t.sub_type==="add"?i.type="guild-member-request":i.type="guild-request";else if(t.post_type==="notice")switch(t.notice_type){case"group_recall":i.type="message-deleted",i.subtype="group",i.subsubtype="group";break;case"friend_recall":i.type="message-deleted",i.subtype="private",i.channelId=`private:${i.userId}`,i.subsubtype="private";break;case"guild_channel_recall":i.type="message-deleted",i.subtype="guild",i.subsubtype="guild";break;case"friend_add":i.type="friend-added";break;case"group_upload":i.type="guild-file-added";break;case"group_admin":i.type="guild-member",i.subtype="role";break;case"group_ban":i.type="guild-member",i.subtype="ban";break;case"group_decrease":i.type=i.userId===i.selfId?"guild-deleted":"guild-member-deleted",i.subtype=i.userId===i.operatorId?"active":"passive";break;case"group_increase":i.type=i.userId===i.selfId?"guild-added":"guild-member-added",i.subtype=i.userId===i.operatorId?"active":"passive";break;case"group_card":i.type="guild-member",i.subtype="nickname";break;case"notify":i.type="notice",i.subtype=(0,f.hyphenate)(t.sub_type),i.subtype==="poke"?i.channelId||(i.channelId=`private:${i.userId}`):i.subtype==="honor"&&(i.subsubtype=(0,f.hyphenate)(t.honor_type));break;case"message_reactions_updated":i.type="onebot",i.subtype="message-reactions-updated";break;case"channel_created":i.type="onebot",i.subtype="channel-created";break;case"channel_updated":i.type="onebot",i.subtype="channel-updated";break;case"channel_destroyed":i.type="onebot",i.subtype="channel-destroyed";break;default:return}else return;return i}l(X,"adaptSession");var Ne=ae(),de=new w.Logger("onebot"),O=class extends w.Adapter.Server{async fork(e,t){let i=t.config,{endpoint:s,token:r}=i;if(!s)return;let o=e.http.extend(i).extend({headers:{"Content-Type":"application/json",Authorization:`Token ${r}`}});return t.internal._request=async(a,d)=>o.post("/"+a,d),t.initialize()}async start(e){let{secret:t,path:i="/onebot"}=e.config;e.ctx.router.post(i,s=>{if(t){let a=s.headers["x-signature"];if(!a)return s.status=401;let d=(0,Ne.createHmac)("sha1",t).update(s.request.rawBody).digest("hex");if(a!==`sha1=${d}`)return s.status=403}let r=s.headers["x-self-id"].toString(),o=this.bots.find(a=>a.selfId===r);if(!o)return s.status=403;de.debug("receive %o",s.request.body),z(o,s.request.body)})}async stop(){de.debug("http server closing")}};l(O,"HttpServer");(e=>{e.Config=w.Schema.intersect([w.Schema.object({protocol:w.Schema.const("http").required(),path:w.Schema.string().description("服务器监听的路径。").default("/onebot"),secret:w.Schema.string().description("接收事件推送时用于验证的字段，应该与 OneBot 的 secret 配置保持一致。").role("secret")}).description("连接设置"),w.Quester.createConfig(!0)])})(O||(O={}));var c=(y(),m(g)),F=new c.Logger("onebot"),B=class extends c.Adapter.WsClient{constructor(){super(...arguments),this.accept=R}prepare(e){let{token:t,endpoint:i}=e.config,s=this.ctx.http.extend(e.config);return t&&(s.config.headers.Authorization=`Bearer ${t}`),s.ws(i)}};l(B,"WsClient");(e=>{e.Config=c.Schema.intersect([c.Schema.object({protocol:c.Schema.const("ws").required(!1),responseTimeout:c.Schema.natural().role("time").default(c.Time.minute).description("等待响应的时间 (单位为毫秒)。")}).description("连接设置"),c.Quester.createConfig(!0),c.Adapter.WsClient.Config])})(B||(B={}));var C=class extends c.Adapter.Server{constructor(e,t){super();let{path:i="/onebot"}=t.config;this.wsServer=e.router.ws(i,(s,{headers:r})=>{if(F.debug("connected with",r),r["x-client-role"]!=="Universal")return s.close(1008,"invalid x-client-role");let o=r["x-self-id"].toString(),a=this.bots.find(d=>d.selfId===o);if(!a)return s.close(1008,"invalid x-self-id");a.socket=s,R(a)}),e.on("dispose",()=>{F.debug("ws server closing"),this.wsServer.close()})}async stop(e){var t;(t=e.socket)==null||t.close(),e.socket=null}};l(C,"WsServer");(e=>{e.Config=c.Schema.object({protocol:c.Schema.const("ws-reverse").required(!0),path:c.Schema.string().description("服务器监听的路径。").default("/onebot"),responseTimeout:c.Schema.natural().role("time").default(c.Time.minute).description("等待响应的时间 (单位为毫秒)。")}).description("连接设置")})(C||(C={}));var le=0,P={};function R(e){e.socket.addEventListener("message",({data:t})=>{let i;try{i=JSON.parse(t.toString())}catch{return F.warn("cannot parse message",t)}"post_type"in i?(F.debug("receive %o",i),z(e,i)):i.echo in P&&(P[i.echo](i),delete P[i.echo])}),e.socket.addEventListener("close",()=>{delete e.internal._request}),e.internal._request=(t,i)=>{let s={action:t,params:i,echo:++le};return s.echo=++le,new Promise((r,o)=>{P[s.echo]=r,setTimeout(()=>{delete P[s.echo],o(new V(i,t))},e.config.responseTimeout),e.socket.send(JSON.stringify(s),a=>{a&&o(a)})})},e.initialize()}l(R,"accept");var K=(y(),m(g)),ue=(y(),m(g)),H=class{constructor(e){this.type=e,this.author={},this.children=[]}};l(H,"State");var Y=class extends ue.Messenger{constructor(){super(...arguments),this.stack=[new H("message")],this.children=[]}async forward(){if(!this.stack[0].children.length)return;let e=this.bot.session(this.session);e.messageId=this.guildId?""+await this.bot.internal.sendGroupForwardMsg(this.guildId,this.stack[0].children):""+await this.bot.internal.sendPrivateForwardMsg(this.channelId.slice(8),this.stack[0].children),e.app.emit(e,"send",e),this.results.push(e)}async flush(){for(;;){let s=this.children[0];if(s?.type!=="text"||(s.data.text=s.data.text.trimStart(),s.data.text))break;this.children.shift()}for(;;){let s=this.children[this.children.length-1];if(s?.type!=="text"||(s.data.text=s.data.text.trimEnd(),s.data.text))break;this.children.pop()}if(!this.children.length)return;let{type:e,author:t}=this.stack[0];if(e==="forward"){this.stack[1].children.push({type:"node",data:{name:t.nickname||t.username||this.bot.nickname||this.bot.username,uin:t.userId||this.bot.userId,content:this.children}}),this.children=[];return}let i=this.bot.session(this.session);i.messageId=this.bot.parent?""+await this.bot.internal.sendGuildChannelMsg(this.guildId,this.channelId,this.children):this.guildId?""+await this.bot.internal.sendGroupMsg(this.guildId,this.children):""+await this.bot.internal.sendPrivateMsg(this.channelId.slice(8),this.children),i.app.emit(i,"send",i),this.results.push(i),this.children=[]}text(e){this.children.push({type:"text",data:{text:e}})}async visit(e){let{type:t,attrs:i,children:s}=e;if(t==="text")this.text(i.content);else if(t==="p"){let r=this.children[this.children.length-1];r?.type==="text"?r.data.text.endsWith(`
`)||(r.data.text+=`
`):this.text(`
`),await this.render(s),this.text(`
`)}else if(t==="at")i.type==="all"?this.children.push({type:"at",data:{qq:"all"}}):this.children.push({type:"at",data:{qq:i.id,name:i.name}});else if(t==="sharp")i.id&&this.text(i.id);else if(t==="face")i.platform&&i.platform!==this.bot.platform?await this.render(s):this.children.push({type:"face",data:{id:i.id}});else if(t==="a")await this.render(s),i.href&&this.text(` (${i.href}) `);else if(["video","audio","image"].includes(t)){t==="audio"&&(t="record"),i={...i},i.file=i.url,delete i.url;let r=/^data:([\w/-]+);base64,/.exec(i.file);r&&(i.file="base64://"+i.file.slice(r[0].length)),this.children.push({type:t,data:i})}else t==="onebot:music"?(await this.flush(),this.children.push({type:"music",data:i})):t==="onebot:tts"?(await this.flush(),this.children.push({type:"tts",data:i})):t==="onebot:poke"?(await this.flush(),this.children.push({type:"poke",data:i})):t==="onebot:gift"?(await this.flush(),this.children.push({type:"gift",data:i})):t==="author"?Object.assign(this.stack[0].author,i):t==="figure"&&!this.bot.parent?(await this.flush(),this.stack.unshift(new H("forward")),await this.render(s),await this.flush(),this.stack.shift(),await this.forward()):t==="figure"?(await this.render(s),await this.flush()):t==="quote"?(await this.flush(),this.children.push({type:"reply",data:i})):t==="message"?(await this.flush(),"forward"in i&&!this.bot.parent?(this.stack.unshift(new H("forward")),await this.render(s),await this.flush(),this.stack.shift(),await this.forward()):(Object.assign(this.stack[0].author,(0,ue.pick)(i,["userId","username","nickname","avatar"])),await this.render(s),await this.flush())):await this.render(s)}};l(Y,"OneBotMessenger");var x=class extends K.Bot{sendMessage(e,t,i,s){return!this.parent&&!e.startsWith("private:")&&(i=e),new Y(this,e,i,s).send(t)}sendPrivateMessage(e,t,i){return this.sendMessage("private:"+e,t,null,i)}async getMessage(e,t){let i=await this.internal.getMsg(t);return await A(this,i)}async deleteMessage(e,t){await this.internal.deleteMsg(t)}async getSelf(){let e=await this.internal.getLoginInfo();return M(e)}async getUser(e){let t=await this.internal.getStrangerInfo(e);return M(t)}async getFriendList(){return(await this.internal.getFriendList()).map(M)}async handleFriendRequest(e,t,i){await this.internal.setFriendAddRequest(e,t,i)}async handleGuildRequest(e,t,i){await this.internal.setGroupAddRequest(e,"invite",t,i)}async handleGuildMemberRequest(e,t,i){await this.internal.setGroupAddRequest(e,"add",t,i)}async deleteFriend(e){await this.internal.deleteFriend(e)}async getMessageList(e,t){let i;if(t){let s=await this.internal.getMsg(t);s?.message_seq&&(i=(await this.internal.getGroupMsgHistory(Number(e),s.message_seq)).messages)}else i=(await this.internal.getGroupMsgHistory(Number(e))).messages;return await Promise.all(i.map(s=>A(this,s)))}};l(x,"BaseBot");(e=>{e.AdvancedConfig=K.Schema.object({splitMixedContent:K.Schema.boolean().description("是否自动在混合内容间插入空格。").default(!0)}).description("高级设置")})(x||(x={}));var Z=class extends x{constructor(e,t){super(e,t),this.hidden=!0,this.parent=t.parent,this.internal=t.parent.internal,this.selfId=t.profile.tiny_id,this.avatar=t.profile.avatar_url,this.username=t.profile.nickname,this.parent.guildBot=this}get status(){return this.parent.status}set status(e){this.parent.status=e}async start(){await this.ctx.parallel("bot-connect",this)}async stop(){this.parent&&(this.parent=void 0,await this.ctx.parallel("bot-disconnect",this))}async getChannel(e,t){return(await this.getChannelList(t)).find(s=>s.channelId===e)}async getChannelList(e){return(await this.internal.getGuildChannelList(e,!1)||[]).map(D)}async getGuild(e){let t=await this.internal.getGuildMetaByGuest(e);return L(t)}async getGuildList(){return(await this.internal.getGuildList()).map(L)}async getGuildMember(e,t){let i=await this.internal.getGuildMemberProfile(e,t);return be(i)}async getGuildMemberList(e){var t;let i,s=[];for(;;){let r=await this.internal.getGuildMemberList(e,i);if(!((t=r.members)!=null&&t.length)||(s=s.concat(r.members.map(ye)),r.finished))break;i=r.next_token}return s}};l(Z,"QQGuildBot");var G=(y(),m(g));function $(e,t){if(e==="text")return t.content;let i="[CQ:"+e;for(let s in t)t[s]&&(i+=`,${s}=${G.segment.escape(t[s],!0)}`);return i+"]"}l($,"CQCode");(e=>{function t(a,d=!1){let u=String(a).replace(/&/g,"&amp;").replace(/\[/g,"&#91;").replace(/\]/g,"&#93;");return d?u.replace(/,/g,"&#44;").replace(/(\ud83c[\udf00-\udfff])|(\ud83d[\udc00-\ude4f\ude80-\udeff])|[\u2600-\u2B55]/g," "):u}e.escape=t,l(t,"escape");function i(a){return String(a).replace(/&#91;/g,"[").replace(/&#93;/g,"]").replace(/&#44;/g,",").replace(/&amp;/g,"&")}e.unescape=i,l(i,"unescape");let s=/\[CQ:(\w+)((,\w+=[^,\]]*)*)\]/;function r(a){let d=s.exec(a);if(!d)return null;let[,u,I]=d,k={};return I&&I.slice(1).split(",").forEach(b=>{let te=b.indexOf("=");k[b.slice(0,te)]=i(b.slice(te+1))}),{type:u,data:k,capture:d}}e.from=r,l(r,"from");function o(a){if(typeof a!="string")return a.map(({type:I,data:k})=>I==="text"?(0,G.segment)("text",{content:k.text}):(0,G.segment)(I,k));let d=[],u;for(;u=r(a);){let{type:I,data:k,capture:b}=u;b.index&&d.push((0,G.segment)("text",{content:i(a.slice(0,b.index))})),d.push((0,G.segment)(I,k)),a=a.slice(b.index+b[0].length)}return a&&d.push((0,G.segment)("text",{content:i(a)})),d}e.parse=o,l(o,"parse")})($||($={}));var E=class extends x{constructor(e,t){super(e,t),this.selfId=t.selfId,this.internal=new n,this.avatar=`http://q.qlogo.cn/headimg_dl?dst_uin=${t.selfId}&spec=640`,t.protocol==="http"?e.plugin(O,this):t.protocol==="ws"?e.plugin(B,this):t.protocol==="ws-reverse"&&e.plugin(C,this)}async stop(){this.guildBot&&delete this.ctx.bots[this.guildBot.sid],await super.stop()}async initialize(){await Promise.all([this.getSelf().then(e=>Object.assign(this,e)),this.setupGuildService().catch(h.noop)]).then(()=>this.online(),e=>this.offline(e))}async setupGuildService(){let e=await this.internal.getGuildServiceProfile();!e?.tiny_id||e.tiny_id==="0"||this.ctx.plugin(Z,{...this.config.qqguild,profile:e,parent:this,advanced:this.config.advanced})}async getChannel(e){let t=await this.internal.getGroupInfo(e);return D(t)}async getGuild(e){let t=await this.internal.getGroupInfo(e);return L(t)}async getGuildList(){return(await this.internal.getGroupList()).map(L)}async getGuildMember(e,t){let i=await this.internal.getGroupMemberInfo(e,t);return J(i)}async getGuildMemberList(e){return(await this.internal.getGroupMemberList(e)).map(J)}async kickGuildMember(e,t,i){return this.internal.setGroupKick(e,t,i)}async muteGuildMember(e,t,i){return this.internal.setGroupBan(e,t,i/1e3)}async muteChannel(e,t,i){return this.internal.setGroupWholeBan(e,i)}};l(E,"OneBotBot");E.prototype.platform="onebot";(e=>{e.QQGuildConfig=h.Schema.object({platform:h.Schema.string().default("qqguild").description("QQ 频道的平台名称")}),e.BaseConfig=h.Schema.object({selfId:h.Schema.string().description("机器人的账号。").required(),token:h.Schema.string().role("secret").description("发送信息时用于验证的字段，应与 OneBot 配置文件中的 `access_token` 保持一致。"),protocol:h.Schema.const("ws").default("ws"),qqguild:e.QQGuildConfig.hidden()}),e.Config=h.Schema.intersect([e.BaseConfig,h.Schema.union([O.Config,B.Config,C.Config]),h.Schema.object({advanced:x.AdvancedConfig})])})(E||(E={}));var We=E});var S={};Me(S,{default:()=>Te});_();var Ie=se(ee(),1);p(S,se(ee(),1));var Te=Ie.OneBotBot;export{Te as default};
