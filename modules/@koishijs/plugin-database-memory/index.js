var De=Object.create;var Z=Object.defineProperty;var Me=Object.getOwnPropertyDescriptor;var Se=Object.getOwnPropertyNames;var Te=Object.getPrototypeOf,Re=Object.prototype.hasOwnProperty;var ue=(e,t)=>()=>(e&&(t=e(e=0)),t);var pe=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var z=(e,t,r,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of Se(t))!Re.call(e,s)&&s!==r&&Z(e,s,{get:()=>t[s],enumerable:!(i=Me(t,s))||i.enumerable});return e},U=(e,t,r)=>(z(e,t,"default"),r&&z(r,t,"default")),Ie=(e,t,r)=>(r=e!=null?De(Te(e)):{},z(t||!e||!e.__esModule?Z(r,"default",{value:e,enumerable:!0}):r,e)),M=e=>z(Z({},"__esModule",{value:!0}),e);import{Buffer as W}from"https://registry.koishi.chat/modules/buffer/index.js";import B from"https://registry.koishi.chat/modules/process/index.js";var w=ue(()=>{});var g={};import*as nt from"https://registry.koishi.chat/modules/cosmokit/index.js";var E=ue(()=>{w();U(g,nt)});var _e=pe((ot,we)=>{"use strict";w();var V=Object.defineProperty,Ne=Object.getOwnPropertyDescriptor,Qe=Object.getOwnPropertyNames,Fe=Object.prototype.hasOwnProperty,u=(e,t)=>V(e,"name",{value:t,configurable:!0}),Ce=(e,t)=>{for(var r in t)V(e,r,{get:t[r],enumerable:!0})},ze=(e,t,r,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of Qe(t))!Fe.call(e,s)&&s!==r&&V(e,s,{get:()=>t[s],enumerable:!(i=Ne(t,s))||i.enumerable});return e},Ue=e=>ze(V({},"__esModule",{value:!0}),e),me={};Ce(me,{$:()=>c,Database:()=>be,Driver:()=>xe,Eval:()=>c,Field:()=>J,Model:()=>Q,RuntimeError:()=>ce,Selection:()=>b,executeEval:()=>l,executeQuery:()=>N,executeSort:()=>ge,executeUpdate:()=>ye,isEvalExpr:()=>ae});we.exports=Ue(me);var ee=(E(),M(g)),H=(E(),M(g));function se(e){return typeof e=="string"||typeof e=="number"||typeof e=="boolean"||e instanceof Date}u(se,"isComparable");var he="abcdefghijklmnopqrstuvwxyz";function ve(){return Array(8).fill(0).map(()=>he[Math.floor(Math.random()*he.length)]).join("")}u(ve,"randomId");function ne(e){return e instanceof RegExp?e:new RegExp(e)}u(ne,"makeRegExp");function ae(e){return e&&Object.keys(e).some(t=>t.startsWith("$"))}u(ae,"isEvalExpr");var We=Symbol("expr"),at=Symbol("type"),c=u((e,t)=>(0,H.defineProperty)({["$"+e]:t},We,!0),"Eval"),j={};j.$=G;function k(e,t){return j[`$${e}`]=t,r=>c(e,r)}u(k,"unary");function y(e,t){return j[`$${e}`]=t,(...r)=>c(e,r)}u(y,"multary");function P(e,t){return j[`$${e}`]=(r,i)=>{let s=l(i,r[0]),n=l(i,r[1]);return(0,H.isNullable)(s)||(0,H.isNullable)(n)?!0:t(s.valueOf(),n.valueOf())},(...r)=>c(e,r)}u(P,"comparator");c.switch=(e,t)=>c("switch",{branches:e,default:t});j.$switch=(e,t)=>{for(let r of e.branches)if(l(t,r.case))return l(t,r.then);return l(t,e.default)};c.if=y("if",([e,t,r],i)=>l(i,e)?l(i,t):l(i,r));c.ifNull=y("ifNull",([e,t],r)=>{var i;return(i=l(r,e))!=null?i:l(r,t)});c.add=y("add",(e,t)=>e.reduce((r,i)=>r+l(t,i),0));c.multiply=y("multiply",(e,t)=>e.reduce((r,i)=>r*l(t,i),1));c.subtract=y("subtract",([e,t],r)=>l(r,e)-l(r,t));c.divide=y("divide",([e,t],r)=>l(r,e)/l(r,t));c.eq=P("eq",(e,t)=>e===t);c.ne=P("ne",(e,t)=>e!==t);c.gt=P("gt",(e,t)=>e>t);c.gte=P("gte",(e,t)=>e>=t);c.lt=P("lt",(e,t)=>e<t);c.lte=P("lte",(e,t)=>e<=t);c.in=y("in",([e,t],r)=>t.includes(l(r,e)));c.nin=y("nin",([e,t],r)=>!t.includes(l(r,e)));c.concat=y("concat",(e,t)=>e.map(r=>l(t,r)).join(""));c.regex=y("regex",([e,t],r)=>ne(l(r,t)).test(l(r,e)));c.and=y("and",(e,t)=>e.every(r=>l(t,r)));c.or=y("or",(e,t)=>e.some(r=>l(t,r)));c.not=k("not",(e,t)=>!l(t,e));c.sum=k("sum",(e,t)=>t.reduce((r,i)=>r+T(e,i),0));c.avg=k("avg",(e,t)=>t.reduce((r,i)=>r+T(e,i),0)/t.length);c.max=k("max",(e,t)=>Math.max(...t.map(r=>T(e,r))));c.min=k("min",(e,t)=>Math.min(...t.map(r=>T(e,r))));c.count=k("count",(e,t)=>new Set(t.map(r=>T(e,r))).size);function G(e,t){if(typeof e=="string")return G(["_",e],t);let[r,i]=e,s=t[r];if(!s)return s;if(i in s)return s[i];let n=Object.keys(s).find(a=>i.startsWith(a+"."))||i.split(".",1)[0],o=i.slice(n.length+1).split(".").filter(Boolean);o.unshift(n);for(let a of o)if(s=s[a],!s)return s;return s}u(G,"getRecursive");function oe(e,t){for(let r in e)if(r in j)return j[r](e[r],t);return e}u(oe,"executeEvalExpr");function T(e,t){return typeof e=="string"?G(e,t):oe(e,t)}u(T,"executeAggr");function l(e,t){return se(t)||(0,H.isNullable)(t)?t:oe(t,e)}u(l,"executeEval");function ye(e,t,r){for(let i in t){let s=e,n=i.split("."),o=n.pop();for(let a of n)s=s[a]||(s[a]={});s[o]=l({[r]:e,_:e},t[i])}return e}u(ye,"executeUpdate");var I=(E(),M(g)),J;(e=>{e.number=["integer","unsigned","float","double","decimal"],e.string=["char","string","text"],e.boolean=["boolean"],e.date=["timestamp","date","time"],e.object=["list","json"];let t=/^(\w+)(?:\((.+)\))?$/;function r(i){if(typeof i=="function")return{type:"expr",expr:i};if(typeof i!="string")return{initial:null,...i};let s=t.exec(i);if(!s)throw new TypeError("invalid field definition");let n=s[1],o=(s[2]||"").split(","),a={type:n};return a.initial===void 0&&(e.number.includes(a.type)&&(a.initial=0),e.string.includes(a.type)&&(a.initial=""),a.type==="list"&&(a.initial=[]),a.type==="json"&&(a.initial={})),n==="decimal"?(a.precision=+o[0],a.scale=+o[1]):o[0]&&(a.length=+o[0]),a}e.parse=r,u(r,"parse")})(J||(J={}));var Q=class{constructor(e){this.name=e,this.fields={},this.migrations=new Map,this.autoInc=!1,this.primary="id",this.unique=[],this.foreign={}}extend(e={},t={}){let{primary:r,autoInc:i,unique:s=[],foreign:n,callback:o}=t;this.primary=r||this.primary,this.autoInc=i||this.autoInc,this.unique.push(...s),Object.assign(this.foreign,n),o&&this.migrations.set(o,Object.keys(e));for(let a in e)this.fields[a]=J.parse(e[a]),this.fields[a].deprecated=!!o;this.checkIndex(this.primary),this.unique.forEach(a=>this.checkIndex(a))}checkIndex(e){for(let t of(0,I.makeArray)(e))if(!this.fields[t])throw new TypeError(`missing field definition for index key "${t}"`)}resolveValue(e,t){var r;if((0,I.isNullable)(t))return t;if(((r=this.fields[e])==null?void 0:r.type)==="time"){let i=new Date(0);return i.setHours(t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()),i}return t}format(e,t=!0,r="",i={}){let s=Object.keys(this.fields);return Object.entries(e).map(([n,o])=>{if(n=r+n,s.includes(n))i[n]=o;else if(!o||typeof o!="object"||ae(o)){if(s.find(f=>n.startsWith(f+".")))i[n]=o;else if(t)throw new TypeError(`unknown field "${n}" in model ${this.name}`)}else this.format(o,t,n+".",i)}),i}parse(e){var t;let r={};for(let i in e){let s=r,n=i.split(".").reverse(),o="";for(let a=n.length-1;a>0;a--){let f=n[a];o+=f+".",s=(t=s[f])!=null?t:s[f]={}}if(i in e){let a=this.resolveValue(i,e[i]);s[n[0]]=a}}return r}create(e){let t={},r=(0,I.makeArray)(this.primary);for(let i in this.fields){let{initial:s,deprecated:n}=this.fields[i];n||!r.includes(i)&&!(0,I.isNullable)(s)&&(t[i]=(0,I.clone)(s))}return this.parse({...t,...e})}};u(Q,"Model");var q=(E(),M(g)),te=u((e,t={},r="")=>new Proxy(t,{get(i,s){return typeof s=="symbol"||s in i||s.startsWith("$")?Reflect.get(i,s):te(e,c("",[e,`${r}${s}`]),`${r}${s}.`)}}),"createRow"),re=class{constructor(e,t){Object.assign(this,t);let r={};if(typeof t.table!="string"&&!(t.table instanceof b))for(let i in t.table)r[i]=te(i);(0,q.defineProperty)(this,"driver",e),(0,q.defineProperty)(this,"row",te(this.ref,r)),(0,q.defineProperty)(this,"model",e.model(this.table))}resolveQuery(e={}){if(typeof e=="function")return{$expr:e(this.row)};if(Array.isArray(e)||e instanceof RegExp||["string","number"].includes(typeof e)){let{primary:t}=this.model;if(Array.isArray(t))throw new TypeError("invalid shorthand for composite primary key");return{[t]:e}}return e}resolveField(e){if(typeof e=="string")return this.row[e];if(typeof e=="function")return e(this.row);throw new TypeError("invalid field definition")}resolveFields(e){if(typeof e=="string"&&(e=[e]),Array.isArray(e)){let t=Object.keys(this.model.fields),r=e.flatMap(i=>this.model.fields[i]?i:t.filter(s=>s.startsWith(i+".")));return Object.fromEntries(r.map(i=>[i,this.row[i]]))}else return(0,q.valueMap)(e,t=>this.resolveField(t))}async execute(){return await this.driver.database.prepared(),this.driver[this.type](this,...this.args)}};u(re,"Executable");var b=class extends re{constructor(e,t,r){super(e,{type:"get",ref:ve(),table:t,query:null,args:[{sort:[],limit:1/0,offset:0,group:[],having:c.and(),optional:{}}]}),this.tables={},this.tables[this.ref]=this.model,this.query=this.resolveQuery(r),typeof t!="string"&&Object.assign(this.tables,t.tables)}where(e){var t;return(t=this.query).$and||(t.$and=[]),this.query.$and.push(this.resolveQuery(e)),this}limit(...e){return e.length>1&&this.offset(e.shift()),this.args[0].limit=e[0],this}offset(e){return this.args[0].offset=e,this}orderBy(e,t="asc"){return this.args[0].sort.push([this.resolveField(e),t]),this}groupBy(e,...t){this.args[0].fields=this.resolveFields(e),this.args[0].group=Object.keys(this.args[0].fields);let r=typeof t[0]=="function"?void 0:t.shift();return Object.assign(this.args[0].fields,this.resolveFields(r||{})),t[0]&&this.having(t[0]),new b(this.driver,this)}having(e){return this.args[0].having.$and.push(this.resolveField(e)),this}project(e){return this.args[0].fields=this.resolveFields(e),new b(this.driver,this)}_action(e,...t){return new re(this.driver,{...this,type:e,args:t})}evaluate(e){return new b(this.driver,this)._action("eval",this.resolveField(e))}execute(e){if(typeof e=="function")return this.evaluate(e).execute();if(Array.isArray(e)?e={fields:e}:e||(e={}),e.fields&&this.project(e.fields),e.limit!==void 0&&this.limit(e.limit),e.offset!==void 0&&this.offset(e.offset),e.sort)for(let t in e.sort)this.orderBy(t,e.sort[t]);return super.execute()}};u(b,"Selection");function ge(e,t,r){let{limit:i,offset:s,sort:n}=t;return e.sort((o,a)=>{for(let[f,v]of n){let O=v==="asc"?1:-1,D=l({[r]:o,_:o},f),C=l({[r]:a,_:a},f);if(D<C)return-O;if(D>C)return O}return 0}),e.slice(s,s+i)}u(ge,"executeSort");var be=class{constructor(){this.tables=Object.create(null),this.drivers=Object.create(null),this.migrating=!1,this.prepareTasks=Object.create(null),this.migrateTasks=Object.create(null),this.stashed=new Set}refresh(){for(let e in this.tables)this.prepareTasks[e]=this.prepare(e)}async prepared(){await Promise.all(Object.values(this.prepareTasks)),this.migrating||await Promise.all(Object.values(this.migrateTasks))}getDriver(e){let t=Object.values(this.drivers)[0];return t&&(t.database=this),t}async prepare(e){var t;this.stashed.add(e),await this.prepareTasks[e],await Promise.resolve(),this.stashed.delete(e)&&await((t=this.getDriver(e))==null?void 0:t.prepare(e))}extend(e,t,r={}){let i=this.tables[e];i||(i=this.tables[e]=new Q(e)),i.extend(t,r),this.prepareTasks[e]=this.prepare(e)}migrate(e,t,r){this.extend(e,t,{callback:r})}select(e,t){return new b(this.getDriver(e),e,t)}join(e,t,r){if(Array.isArray(e)){let i=new b(this.getDriver(e[0]),Object.fromEntries(e.map(s=>[s,s])));return typeof t=="function"&&(i.args[0].having=c.and(t(...e.map(s=>i.row[s])))),i.args[0].optional=Object.fromEntries(e.map((s,n)=>[s,r?.[n]])),i}else{let i=new b(this.getDriver(e[0]),e);return typeof t=="function"&&(i.args[0].having=c.and(t(i.row))),i.args[0].optional=r,i}}async get(e,t,r){return this.select(e,t).execute(r)}async eval(e,t,r){return this.select(e,r).execute(typeof t=="function"?t:()=>t)}async set(e,t,r){let i=this.select(e,t);if(typeof r=="function"&&(r=r(i.row)),(0,ee.makeArray)(i.model.primary).some(n=>n in r))throw new TypeError("cannot modify primary key");await i._action("set",i.model.format(r)).execute()}async remove(e,t){await this.select(e,t)._action("remove").execute()}async create(e,t){let r=this.select(e);return r._action("create",r.model.create(t)).execute()}async upsert(e,t,r){let i=this.select(e);typeof t=="function"&&(t=t(i.row)),t=t.map(s=>i.model.format(s)),r=(0,ee.makeArray)(r||i.model.primary),await i._action("upsert",t,r).execute()}async stopAll(){let e=Object.values(this.drivers);this.drivers=Object.create(null),await Promise.all(e.map(t=>t.stop()))}async drop(e){await this.getDriver(e).drop(e)}async dropAll(){await Promise.all(Object.values(this.drivers).map(e=>e.drop()))}async stats(){let e={size:0,tables:{}};return await Promise.all(Object.values(this.drivers).map(async t=>{let{size:r=0,tables:i}=await t.stats();e.size+=r,Object.assign(e.tables,i)})),e}};u(be,"Database");var xe=class{constructor(e){this.database=e}model(e){if(typeof e=="string"){let r=this.database.tables[e];if(r)return r;throw new TypeError(`unknown table name "${e}"`)}if(e instanceof b){if(!e.args[0].fields)return e.model;let r=new Q("temp");return r.fields=(0,ee.valueMap)(e.args[0].fields,(i,s)=>({type:"expr"})),r}let t=new Q("temp");for(let r in e){let i=this.model(e[r]);for(let s in i.fields)t.fields[`${r}.${s}`]={type:"expr",expr:{$:[r,s]}}}return t}async migrate(e,t){let r=Object.create(this.database),i=this.model(e);r.migrating=!0,this.database.migrating&&await r.migrateTasks[e],r.migrateTasks[e]=Promise.resolve(r.migrateTasks[e]).then(()=>Promise.all([...i.migrations].map(async([s,n])=>{try{if(!t.before(n))return;await s(r),t.after(n)}catch(o){t.error(o)}}))).then(t.finalize).catch(t.error)}};u(xe,"Driver");var ce=class extends Error{constructor(e,t){super(t||e.replace("-"," ")),this.code=e,this.name="RuntimeError"}static check(e,t){return e instanceof ce?!t||e.message===t:!1}};u(ce,"RuntimeError");var ie=(E(),M(g)),de={$or:(e,t)=>e.reduce((r,i)=>r||S(i,t),!1),$and:(e,t)=>e.reduce((r,i)=>r&&S(i,t),!0),$not:(e,t)=>!S(e,t),$exists:(e,t)=>e!==(0,ie.isNullable)(t),$eq:(e,t)=>t.valueOf()===e.valueOf(),$ne:(e,t)=>t.valueOf()!==e.valueOf(),$gt:(e,t)=>t.valueOf()>e.valueOf(),$gte:(e,t)=>t.valueOf()>=e.valueOf(),$lt:(e,t)=>t.valueOf()<e.valueOf(),$lte:(e,t)=>t.valueOf()<=e.valueOf(),$in:(e,t)=>e.includes(t),$nin:(e,t)=>!e.includes(t),$regex:(e,t)=>ne(e).test(t),$regexFor:(e,t)=>new RegExp(t,"i").test(e),$bitsAllSet:(e,t)=>(e&t)===e,$bitsAllClear:(e,t)=>(e&t)===0,$bitsAnySet:(e,t)=>(e&t)!==0,$bitsAnyClear:(e,t)=>(e&t)!==e,$el:(e,t)=>t.some(r=>S(e,r)),$size:(e,t)=>t.length===e};function S(e,t){if(Array.isArray(e))return e.includes(t);if(e instanceof RegExp)return e.test(t);if(se(e))return t.valueOf()===e.valueOf();if((0,ie.isNullable)(e))return(0,ie.isNullable)(t);for(let r in e)if(r in de&&!de[r](e[r],t))return!1;return!0}u(S,"executeFieldQuery");function N(e,t,r){return Object.entries(t).every(([s,n])=>{if(s==="$and")return n.reduce((o,a)=>o&&N(e,a,r),!0);if(s==="$or")return n.reduce((o,a)=>o||N(e,a,r),!1);if(s==="$not")return!N(e,n,r);if(s==="$expr")return l({[r]:e,_:e},n);try{return S(n,e[s])}catch{return!1}})}u(N,"executeQuery")});var ke=pe((mt,je)=>{"use strict";w();var K=Object.defineProperty,Be=Object.getOwnPropertyDescriptor,qe=Object.getOwnPropertyNames,He=Object.prototype.hasOwnProperty,Oe=(e,t)=>K(e,"name",{value:t,configurable:!0}),Je=(e,t)=>{for(var r in t)K(e,r,{get:t[r],enumerable:!0})},Ve=(e,t,r,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of qe(t))!He.call(e,s)&&s!==r&&K(e,s,{get:()=>t[s],enumerable:!(i=Be(t,s))||i.enumerable});return e},Ge=e=>Ve(K({},"__esModule",{value:!0}),e),$e=(e,t,r)=>{if(!t.has(e))throw TypeError("Cannot "+r)},F=(e,t,r)=>($e(e,t,"read from private field"),r?r.call(e):t.get(e)),Ke=(e,t,r)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,r)},Le=(e,t,r,i)=>($e(e,t,"write to private field"),i?i.call(e,r):t.set(e,r),r),Ee={};Je(Ee,{MemoryDriver:()=>le,default:()=>Xe});je.exports=Ge(Ee);var A=(E(),M(g)),h=_e(),_,le=class extends h.Driver{constructor(e,t){super(e),this.database=e,this.config=t,Ke(this,_,{_fields:[]})}async prepare(e){}async start(){}async $save(e){}async stop(){}table(e,t){var r,i;if(typeof e=="string")return(r=F(this,_))[e]||(r[e]=[]);if(!(e instanceof h.Selection)){let m=Object.entries(e).map(([d,p])=>[d,this.table(p)]),x=Oe(d=>{if(!d.length)return[];let[[p,R],...fe]=d;return fe.length?R.flatMap(Y=>x(fe).map(Ae=>({...Ae,[p]:Y}))):R.map(Y=>({[p]:Y}))},"catesian");return x(m).filter(d=>(0,h.executeEval)(d,t))}let{ref:s,query:n,table:o,args:a,model:f}=e,{fields:v,group:O,having:D}=e.args[0],C=this.table(o,D).filter(m=>(0,h.executeQuery)(m,n,s)),L=[],X=O.length?(0,A.pick)(v,O):v;for(let m of(0,h.executeSort)(C,a[0],s)){m=f.format(m,!1);for(let p in f.fields)f.fields[p].deprecated||(i=m[p])!=null||(m[p]=null);let x=m;v&&(x=(0,A.valueMap)(X,p=>(0,h.executeEval)({[s]:m},p)));let d=L.find(p=>{if(!X)return!1;for(let R in X)if(p.index[R]!==x[R])return!1;return!0});d||(d={index:x,table:[]},L.push(d)),d.table.push(m)}return L.map(({index:m,table:x})=>{if(O.length){if(D&&!(0,h.executeEval)(x.map(p=>({[s]:p,_:p})),D))return;for(let d in(0,A.omit)(v,O))m[d]=(0,h.executeEval)(x.map(p=>({[s]:p,_:p})),v[d])}return f.parse(m)}).filter(Boolean)}async drop(e){e?delete F(this,_)[e]:Le(this,_,{_fields:[]})}async stats(){return{}}async get(e){return this.table(e)}async eval(e,t){let{query:r,table:i}=e,s=typeof i=="string"?e.ref:i.ref,n=this.table(i).filter(o=>(0,h.executeQuery)(o,r,s));return(0,h.executeEval)(n.map(o=>({[s]:o,_:o})),t)}async set(e,t){let{table:r,ref:i,query:s}=e;this.table(r).filter(n=>(0,h.executeQuery)(n,s,i)).forEach(n=>(0,h.executeUpdate)(n,t,i)),this.$save(r)}async remove(e){let{ref:t,query:r,table:i}=e;F(this,_)[i]=this.table(i).filter(s=>!(0,h.executeQuery)(s,r,t)),this.$save(i)}async create(e,t){let{table:r,model:i}=e,{primary:s,autoInc:n}=i,o=this.table(r);if(!Array.isArray(s)&&n&&!(s in t)){let f=F(this,_)._fields.find(v=>v.table===r&&v.field===s);f||(f={table:r,field:s,autoInc:0},F(this,_)._fields.push(f)),f.autoInc+=1,t[s]=f.autoInc}else if((await this.database.get(r,(0,A.pick)(t,(0,A.makeArray)(s)))).length)throw new h.RuntimeError("duplicate-entry");let a=i.create(t);return o.push(a),this.$save(r),(0,A.clone)(a)}async upsert(e,t,r){let{table:i,model:s,ref:n}=e;for(let o of t){let a=this.table(i).find(f=>r.every(v=>f[v]===o[v]));if(a)(0,h.executeUpdate)(a,o,n);else{let f=(0,h.executeUpdate)(s.create(),o,n);await this.database.create(i,f).catch(A.noop)}}this.$save(i)}};Oe(le,"MemoryDriver");_=new WeakMap;var Xe=le});w();var Pe=Ie(ke(),1);import{defineDriver as Ye,Schema as Ze}from"https://registry.koishi.chat/modules/koishi/index.js";var bt=Ye(Pe.MemoryDriver,Ze.object({}));export{bt as default};
