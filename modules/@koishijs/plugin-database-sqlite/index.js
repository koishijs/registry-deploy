var Wi=Object.create;var lr=Object.defineProperty;var zi=Object.getOwnPropertyDescriptor;var Ci=Object.getOwnPropertyNames;var Bi=Object.getPrototypeOf,Ki=Object.prototype.hasOwnProperty;var fr=(r,n)=>()=>(r&&(n=r(r=0)),n);var Te=(r,n)=>()=>(n||r((n={exports:{}}).exports,n),n.exports);var Ot=(r,n,s,l)=>{if(n&&typeof n=="object"||typeof n=="function")for(let c of Ci(n))!Ki.call(r,c)&&c!==s&&lr(r,c,{get:()=>n[c],enumerable:!(l=zi(n,c))||l.enumerable});return r},Oe=(r,n,s)=>(Ot(r,n,"default"),s&&Ot(s,n,"default")),Ji=(r,n,s)=>(s=r!=null?Wi(Bi(r)):{},Ot(n||!r||!r.__esModule?lr(s,"default",{value:r,enumerable:!0}):s,r)),_e=r=>Ot(lr({},"__esModule",{value:!0}),r);import{Buffer as ue}from"https://registry.koishi.chat/modules/buffer/index.js";import B from"https://registry.koishi.chat/modules/process/index.js";var U=fr(()=>{});var oe={};import*as Ss from"https://registry.koishi.chat/modules/cosmokit/index.js";var xe=fr(()=>{U();Oe(oe,Ss)});var wr=Te((Ns,In)=>{"use strict";U();var jt=Object.defineProperty,Yi=Object.getOwnPropertyDescriptor,Vi=Object.getOwnPropertyNames,Xi=Object.prototype.hasOwnProperty,L=(r,n)=>jt(r,"name",{value:n,configurable:!0}),Zi=(r,n)=>{for(var s in n)jt(r,s,{get:n[s],enumerable:!0})},es=(r,n,s,l)=>{if(n&&typeof n=="object"||typeof n=="function")for(let c of Vi(n))!Xi.call(r,c)&&c!==s&&jt(r,c,{get:()=>n[c],enumerable:!(l=Yi(n,c))||l.enumerable});return r},ts=r=>es(jt({},"__esModule",{value:!0}),r),xn={};Zi(xn,{$:()=>j,Database:()=>Mn,Driver:()=>Rn,Eval:()=>j,Field:()=>qt,Model:()=>ot,RuntimeError:()=>br,Selection:()=>he,executeEval:()=>N,executeQuery:()=>st,executeSort:()=>jn,executeUpdate:()=>qn,isEvalExpr:()=>vr});In.exports=ts(xn);var cr=(xe(),_e(oe)),At=(xe(),_e(oe));function dr(r){return typeof r=="string"||typeof r=="number"||typeof r=="boolean"||r instanceof Date}L(dr,"isComparable");var $n="abcdefghijklmnopqrstuvwxyz";function An(){return Array(8).fill(0).map(()=>$n[Math.floor(Math.random()*$n.length)]).join("")}L(An,"randomId");function yr(r){return r instanceof RegExp?r:new RegExp(r)}L(yr,"makeRegExp");function vr(r){return r&&Object.keys(r).some(n=>n.startsWith("$"))}L(vr,"isEvalExpr");var rs=Symbol("expr"),Ts=Symbol("type"),j=L((r,n)=>(0,At.defineProperty)({["$"+r]:n},rs,!0),"Eval"),Ne={};Ne.$=Mt;function ke(r,n){return Ne[`$${r}`]=n,s=>j(r,s)}L(ke,"unary");function ee(r,n){return Ne[`$${r}`]=n,(...s)=>j(r,s)}L(ee,"multary");function De(r,n){return Ne[`$${r}`]=(s,l)=>{let c=N(l,s[0]),o=N(l,s[1]);return(0,At.isNullable)(c)||(0,At.isNullable)(o)?!0:n(c.valueOf(),o.valueOf())},(...s)=>j(r,s)}L(De,"comparator");j.switch=(r,n)=>j("switch",{branches:r,default:n});Ne.$switch=(r,n)=>{for(let s of r.branches)if(N(n,s.case))return N(n,s.then);return N(n,r.default)};j.if=ee("if",([r,n,s],l)=>N(l,r)?N(l,n):N(l,s));j.ifNull=ee("ifNull",([r,n],s)=>{var l;return(l=N(s,r))!=null?l:N(s,n)});j.add=ee("add",(r,n)=>r.reduce((s,l)=>s+N(n,l),0));j.multiply=ee("multiply",(r,n)=>r.reduce((s,l)=>s*N(n,l),1));j.subtract=ee("subtract",([r,n],s)=>N(s,r)-N(s,n));j.divide=ee("divide",([r,n],s)=>N(s,r)/N(s,n));j.eq=De("eq",(r,n)=>r===n);j.ne=De("ne",(r,n)=>r!==n);j.gt=De("gt",(r,n)=>r>n);j.gte=De("gte",(r,n)=>r>=n);j.lt=De("lt",(r,n)=>r<n);j.lte=De("lte",(r,n)=>r<=n);j.in=ee("in",([r,n],s)=>n.includes(N(s,r)));j.nin=ee("nin",([r,n],s)=>!n.includes(N(s,r)));j.concat=ee("concat",(r,n)=>r.map(s=>N(n,s)).join(""));j.regex=ee("regex",([r,n],s)=>yr(N(s,n)).test(N(s,r)));j.and=ee("and",(r,n)=>r.every(s=>N(n,s)));j.or=ee("or",(r,n)=>r.some(s=>N(n,s)));j.not=ke("not",(r,n)=>!N(n,r));j.sum=ke("sum",(r,n)=>n.reduce((s,l)=>s+ze(r,l),0));j.avg=ke("avg",(r,n)=>n.reduce((s,l)=>s+ze(r,l),0)/n.length);j.max=ke("max",(r,n)=>Math.max(...n.map(s=>ze(r,s))));j.min=ke("min",(r,n)=>Math.min(...n.map(s=>ze(r,s))));j.count=ke("count",(r,n)=>new Set(n.map(s=>ze(r,s))).size);function Mt(r,n){if(typeof r=="string")return Mt(["_",r],n);let[s,l]=r,c=n[s];if(!c)return c;if(l in c)return c[l];let o=Object.keys(c).find(v=>l.startsWith(v+"."))||l.split(".",1)[0],y=l.slice(o.length+1).split(".").filter(Boolean);y.unshift(o);for(let v of y)if(c=c[v],!c)return c;return c}L(Mt,"getRecursive");function _r(r,n){for(let s in r)if(s in Ne)return Ne[s](r[s],n);return r}L(_r,"executeEvalExpr");function ze(r,n){return typeof r=="string"?Mt(r,n):_r(r,n)}L(ze,"executeAggr");function N(r,n){return dr(n)||(0,At.isNullable)(n)?n:_r(n,r)}L(N,"executeEval");function qn(r,n,s){for(let l in n){let c=r,o=l.split("."),y=o.pop();for(let v of o)c=c[v]||(c[v]={});c[y]=N({[s]:r,_:r},n[l])}return r}L(qn,"executeUpdate");var it=(xe(),_e(oe)),qt;(r=>{r.number=["integer","unsigned","float","double","decimal"],r.string=["char","string","text"],r.boolean=["boolean"],r.date=["timestamp","date","time"],r.object=["list","json"];let n=/^(\w+)(?:\((.+)\))?$/;function s(l){if(typeof l=="function")return{type:"expr",expr:l};if(typeof l!="string")return{initial:null,...l};let c=n.exec(l);if(!c)throw new TypeError("invalid field definition");let o=c[1],y=(c[2]||"").split(","),v={type:o};return v.initial===void 0&&(r.number.includes(v.type)&&(v.initial=0),r.string.includes(v.type)&&(v.initial=""),v.type==="list"&&(v.initial=[]),v.type==="json"&&(v.initial={})),o==="decimal"?(v.precision=+y[0],v.scale=+y[1]):y[0]&&(v.length=+y[0]),v}r.parse=s,L(s,"parse")})(qt||(qt={}));var ot=class{constructor(r){this.name=r,this.fields={},this.migrations=new Map,this.autoInc=!1,this.primary="id",this.unique=[],this.foreign={}}extend(r={},n={}){let{primary:s,autoInc:l,unique:c=[],foreign:o,callback:y}=n;this.primary=s||this.primary,this.autoInc=l||this.autoInc,this.unique.push(...c),Object.assign(this.foreign,o),y&&this.migrations.set(y,Object.keys(r));for(let v in r)this.fields[v]=qt.parse(r[v]),this.fields[v].deprecated=!!y;this.checkIndex(this.primary),this.unique.forEach(v=>this.checkIndex(v))}checkIndex(r){for(let n of(0,it.makeArray)(r))if(!this.fields[n])throw new TypeError(`missing field definition for index key "${n}"`)}resolveValue(r,n){var s;if((0,it.isNullable)(n))return n;if(((s=this.fields[r])==null?void 0:s.type)==="time"){let l=new Date(0);return l.setHours(n.getHours(),n.getMinutes(),n.getSeconds(),n.getMilliseconds()),l}return n}format(r,n=!0,s="",l={}){let c=Object.keys(this.fields);return Object.entries(r).map(([o,y])=>{if(o=s+o,c.includes(o))l[o]=y;else if(!y||typeof y!="object"||vr(y)){if(c.find(I=>o.startsWith(I+".")))l[o]=y;else if(n)throw new TypeError(`unknown field "${o}" in model ${this.name}`)}else this.format(y,n,o+".",l)}),l}parse(r){var n;let s={};for(let l in r){let c=s,o=l.split(".").reverse(),y="";for(let v=o.length-1;v>0;v--){let I=o[v];y+=I+".",c=(n=c[I])!=null?n:c[I]={}}if(l in r){let v=this.resolveValue(l,r[l]);c[o[0]]=v}}return s}create(r){let n={},s=(0,it.makeArray)(this.primary);for(let l in this.fields){let{initial:c,deprecated:o}=this.fields[l];o||!s.includes(l)&&!(0,it.isNullable)(c)&&(n[l]=(0,it.clone)(c))}return this.parse({...n,...r})}};L(ot,"Model");var xt=(xe(),_e(oe)),hr=L((r,n={},s="")=>new Proxy(n,{get(l,c){return typeof c=="symbol"||c in l||c.startsWith("$")?Reflect.get(l,c):hr(r,j("",[r,`${s}${c}`]),`${s}${c}.`)}}),"createRow"),pr=class{constructor(r,n){Object.assign(this,n);let s={};if(typeof n.table!="string"&&!(n.table instanceof he))for(let l in n.table)s[l]=hr(l);(0,xt.defineProperty)(this,"driver",r),(0,xt.defineProperty)(this,"row",hr(this.ref,s)),(0,xt.defineProperty)(this,"model",r.model(this.table))}resolveQuery(r={}){if(typeof r=="function")return{$expr:r(this.row)};if(Array.isArray(r)||r instanceof RegExp||["string","number"].includes(typeof r)){let{primary:n}=this.model;if(Array.isArray(n))throw new TypeError("invalid shorthand for composite primary key");return{[n]:r}}return r}resolveField(r){if(typeof r=="string")return this.row[r];if(typeof r=="function")return r(this.row);throw new TypeError("invalid field definition")}resolveFields(r){if(typeof r=="string"&&(r=[r]),Array.isArray(r)){let n=Object.keys(this.model.fields),s=r.flatMap(l=>this.model.fields[l]?l:n.filter(c=>c.startsWith(l+".")));return Object.fromEntries(s.map(l=>[l,this.row[l]]))}else return(0,xt.valueMap)(r,n=>this.resolveField(n))}async execute(){return await this.driver.database.prepared(),this.driver[this.type](this,...this.args)}};L(pr,"Executable");var he=class extends pr{constructor(r,n,s){super(r,{type:"get",ref:An(),table:n,query:null,args:[{sort:[],limit:1/0,offset:0,group:[],having:j.and(),optional:{}}]}),this.tables={},this.tables[this.ref]=this.model,this.query=this.resolveQuery(s),typeof n!="string"&&Object.assign(this.tables,n.tables)}where(r){var n;return(n=this.query).$and||(n.$and=[]),this.query.$and.push(this.resolveQuery(r)),this}limit(...r){return r.length>1&&this.offset(r.shift()),this.args[0].limit=r[0],this}offset(r){return this.args[0].offset=r,this}orderBy(r,n="asc"){return this.args[0].sort.push([this.resolveField(r),n]),this}groupBy(r,...n){this.args[0].fields=this.resolveFields(r),this.args[0].group=Object.keys(this.args[0].fields);let s=typeof n[0]=="function"?void 0:n.shift();return Object.assign(this.args[0].fields,this.resolveFields(s||{})),n[0]&&this.having(n[0]),new he(this.driver,this)}having(r){return this.args[0].having.$and.push(this.resolveField(r)),this}project(r){return this.args[0].fields=this.resolveFields(r),new he(this.driver,this)}_action(r,...n){return new pr(this.driver,{...this,type:r,args:n})}evaluate(r){return new he(this.driver,this)._action("eval",this.resolveField(r))}execute(r){if(typeof r=="function")return this.evaluate(r).execute();if(Array.isArray(r)?r={fields:r}:r||(r={}),r.fields&&this.project(r.fields),r.limit!==void 0&&this.limit(r.limit),r.offset!==void 0&&this.offset(r.offset),r.sort)for(let n in r.sort)this.orderBy(n,r.sort[n]);return super.execute()}};L(he,"Selection");function jn(r,n,s){let{limit:l,offset:c,sort:o}=n;return r.sort((y,v)=>{for(let[I,O]of o){let M=O==="asc"?1:-1,b=N({[s]:y,_:y},I),k=N({[s]:v,_:v},I);if(b<k)return-M;if(b>k)return M}return 0}),r.slice(c,c+l)}L(jn,"executeSort");var Mn=class{constructor(){this.tables=Object.create(null),this.drivers=Object.create(null),this.migrating=!1,this.prepareTasks=Object.create(null),this.migrateTasks=Object.create(null),this.stashed=new Set}refresh(){for(let r in this.tables)this.prepareTasks[r]=this.prepare(r)}async prepared(){await Promise.all(Object.values(this.prepareTasks)),this.migrating||await Promise.all(Object.values(this.migrateTasks))}getDriver(r){let n=Object.values(this.drivers)[0];return n&&(n.database=this),n}async prepare(r){var n;this.stashed.add(r),await this.prepareTasks[r],await Promise.resolve(),this.stashed.delete(r)&&await((n=this.getDriver(r))==null?void 0:n.prepare(r))}extend(r,n,s={}){let l=this.tables[r];l||(l=this.tables[r]=new ot(r)),l.extend(n,s),this.prepareTasks[r]=this.prepare(r)}migrate(r,n,s){this.extend(r,n,{callback:s})}select(r,n){return new he(this.getDriver(r),r,n)}join(r,n,s){if(Array.isArray(r)){let l=new he(this.getDriver(r[0]),Object.fromEntries(r.map(c=>[c,c])));return typeof n=="function"&&(l.args[0].having=j.and(n(...r.map(c=>l.row[c])))),l.args[0].optional=Object.fromEntries(r.map((c,o)=>[c,s?.[o]])),l}else{let l=new he(this.getDriver(r[0]),r);return typeof n=="function"&&(l.args[0].having=j.and(n(l.row))),l.args[0].optional=s,l}}async get(r,n,s){return this.select(r,n).execute(s)}async eval(r,n,s){return this.select(r,s).execute(typeof n=="function"?n:()=>n)}async set(r,n,s){let l=this.select(r,n);if(typeof s=="function"&&(s=s(l.row)),(0,cr.makeArray)(l.model.primary).some(o=>o in s))throw new TypeError("cannot modify primary key");await l._action("set",l.model.format(s)).execute()}async remove(r,n){await this.select(r,n)._action("remove").execute()}async create(r,n){let s=this.select(r);return s._action("create",s.model.create(n)).execute()}async upsert(r,n,s){let l=this.select(r);typeof n=="function"&&(n=n(l.row)),n=n.map(c=>l.model.format(c)),s=(0,cr.makeArray)(s||l.model.primary),await l._action("upsert",n,s).execute()}async stopAll(){let r=Object.values(this.drivers);this.drivers=Object.create(null),await Promise.all(r.map(n=>n.stop()))}async drop(r){await this.getDriver(r).drop(r)}async dropAll(){await Promise.all(Object.values(this.drivers).map(r=>r.drop()))}async stats(){let r={size:0,tables:{}};return await Promise.all(Object.values(this.drivers).map(async n=>{let{size:s=0,tables:l}=await n.stats();r.size+=s,Object.assign(r.tables,l)})),r}};L(Mn,"Database");var Rn=class{constructor(r){this.database=r}model(r){if(typeof r=="string"){let s=this.database.tables[r];if(s)return s;throw new TypeError(`unknown table name "${r}"`)}if(r instanceof he){if(!r.args[0].fields)return r.model;let s=new ot("temp");return s.fields=(0,cr.valueMap)(r.args[0].fields,(l,c)=>({type:"expr"})),s}let n=new ot("temp");for(let s in r){let l=this.model(r[s]);for(let c in l.fields)n.fields[`${s}.${c}`]={type:"expr",expr:{$:[s,c]}}}return n}async migrate(r,n){let s=Object.create(this.database),l=this.model(r);s.migrating=!0,this.database.migrating&&await s.migrateTasks[r],s.migrateTasks[r]=Promise.resolve(s.migrateTasks[r]).then(()=>Promise.all([...l.migrations].map(async([c,o])=>{try{if(!n.before(o))return;await c(s),n.after(o)}catch(y){n.error(y)}}))).then(n.finalize).catch(n.error)}};L(Rn,"Driver");var br=class extends Error{constructor(r,n){super(n||r.replace("-"," ")),this.code=r,this.name="RuntimeError"}static check(r,n){return r instanceof br?!n||r.message===n:!1}};L(br,"RuntimeError");var mr=(xe(),_e(oe)),On={$or:(r,n)=>r.reduce((s,l)=>s||We(l,n),!1),$and:(r,n)=>r.reduce((s,l)=>s&&We(l,n),!0),$not:(r,n)=>!We(r,n),$exists:(r,n)=>r!==(0,mr.isNullable)(n),$eq:(r,n)=>n.valueOf()===r.valueOf(),$ne:(r,n)=>n.valueOf()!==r.valueOf(),$gt:(r,n)=>n.valueOf()>r.valueOf(),$gte:(r,n)=>n.valueOf()>=r.valueOf(),$lt:(r,n)=>n.valueOf()<r.valueOf(),$lte:(r,n)=>n.valueOf()<=r.valueOf(),$in:(r,n)=>r.includes(n),$nin:(r,n)=>!r.includes(n),$regex:(r,n)=>yr(r).test(n),$regexFor:(r,n)=>new RegExp(n,"i").test(r),$bitsAllSet:(r,n)=>(r&n)===r,$bitsAllClear:(r,n)=>(r&n)===0,$bitsAnySet:(r,n)=>(r&n)!==0,$bitsAnyClear:(r,n)=>(r&n)!==r,$el:(r,n)=>n.some(s=>We(r,s)),$size:(r,n)=>n.length===r};function We(r,n){if(Array.isArray(r))return r.includes(n);if(r instanceof RegExp)return r.test(n);if(dr(r))return n.valueOf()===r.valueOf();if((0,mr.isNullable)(r))return(0,mr.isNullable)(n);for(let s in r)if(s in On&&!On[s](r[s],n))return!1;return!0}L(We,"executeFieldQuery");function st(r,n,s){return Object.entries(n).every(([c,o])=>{if(c==="$and")return o.reduce((y,v)=>y&&st(r,v,s),!0);if(c==="$or")return o.reduce((y,v)=>y||st(r,v,s),!1);if(c==="$not")return!st(r,o,s);if(c==="$expr")return N({[s]:r,_:r},o);try{return We(o,r[c])}catch{return!1}})}L(st,"executeQuery")});var Pn=Te((Gs,Dn)=>{"use strict";U();var Rt=Object.defineProperty,ns=Object.getOwnPropertyDescriptor,is=Object.getOwnPropertyNames,ss=Object.prototype.hasOwnProperty,Tn=(r,n)=>Rt(r,"name",{value:n,configurable:!0}),os=(r,n)=>{for(var s in n)Rt(r,s,{get:n[s],enumerable:!0})},as=(r,n,s,l)=>{if(n&&typeof n=="object"||typeof n=="function")for(let c of is(n))!ss.call(r,c)&&c!==s&&Rt(r,c,{get:()=>n[c],enumerable:!(l=ns(n,c))||l.enumerable});return r},us=r=>as(Rt({},"__esModule",{value:!0}),r),Nn={};os(Nn,{Builder:()=>kn,escapeId:()=>te});Dn.exports=us(Nn);var Sn=(xe(),_e(oe)),ls=wr();function te(r){return"`"+r+"`"}Tn(te,"escapeId");var kn=class{constructor(r){this.tables=r,this.escapeMap={},this.types={},this.createEqualQuery=this.comparator("="),this.queryOperators={$or:(n,s)=>this.logicalOr(s.map(l=>this.parseFieldQuery(n,l))),$and:(n,s)=>this.logicalAnd(s.map(l=>this.parseFieldQuery(n,l))),$not:(n,s)=>this.logicalNot(this.parseFieldQuery(n,s)),$exists:(n,s)=>this.createNullQuery(n,s),$eq:this.createEqualQuery,$ne:this.comparator("!="),$gt:this.comparator(">"),$gte:this.comparator(">="),$lt:this.comparator("<"),$lte:this.comparator("<="),$in:(n,s)=>this.createMemberQuery(n,s,""),$nin:(n,s)=>this.createMemberQuery(n,s," NOT"),$regex:(n,s)=>this.createRegExpQuery(n,s),$regexFor:(n,s)=>`${this.escape(s)} regexp ${n}`,$bitsAllSet:(n,s)=>`${n} & ${this.escape(s)} = ${this.escape(s)}`,$bitsAllClear:(n,s)=>`${n} & ${this.escape(s)} = 0`,$bitsAnySet:(n,s)=>`${n} & ${this.escape(s)} != 0`,$bitsAnyClear:(n,s)=>`${n} & ${this.escape(s)} != ${this.escape(s)}`,$el:(n,s)=>{if(Array.isArray(s))return this.logicalOr(s.map(l=>this.createElementQuery(n,l)));if(typeof s!="number"&&typeof s!="string")throw new TypeError("query expr under $el is not supported");return this.createElementQuery(n,s)},$size:(n,s)=>s?`${n} AND LENGTH(${n}) - LENGTH(REPLACE(${n}, ${this.escape(",")}, ${this.escape("")})) = ${this.escape(s)} - 1`:this.logicalNot(n)},this.evalOperators={$:n=>this.getRecursive(n),$if:n=>`if(${n.map(s=>this.parseEval(s)).join(", ")})`,$ifNull:n=>`ifnull(${n.map(s=>this.parseEval(s)).join(", ")})`,$add:n=>`(${n.map(s=>this.parseEval(s)).join(" + ")})`,$multiply:n=>`(${n.map(s=>this.parseEval(s)).join(" * ")})`,$subtract:this.binary("-"),$divide:this.binary("/"),$concat:n=>`concat(${n.map(s=>this.parseEval(s)).join(", ")})`,$or:n=>this.logicalOr(n.map(s=>this.parseEval(s))),$and:n=>this.logicalAnd(n.map(s=>this.parseEval(s))),$not:n=>this.logicalNot(this.parseEval(n)),$eq:this.binary("="),$ne:this.binary("!="),$gt:this.binary(">"),$gte:this.binary(">="),$lt:this.binary("<"),$lte:this.binary("<="),$sum:n=>`ifnull(sum(${this.parseAggr(n)}), 0)`,$avg:n=>`avg(${this.parseAggr(n)})`,$min:n=>`min(${this.parseAggr(n)})`,$max:n=>`max(${this.parseAggr(n)})`,$count:n=>`count(distinct ${this.parseAggr(n)})`}}createNullQuery(r,n){return`${r} is ${n?"not ":""}null`}createMemberQuery(r,n,s=""){return n.length?`${r}${s} in (${n.map(l=>this.escape(l)).join(", ")})`:s?"1":"0"}createRegExpQuery(r,n){return`${r} regexp ${this.escape(typeof n=="string"?n:n.source)}`}createElementQuery(r,n){return`find_in_set(${this.escape(n)}, ${r})`}comparator(r){return(n,s)=>`${n} ${r} ${this.escape(s)}`}binary(r){return([n,s])=>`(${this.parseEval(n)} ${r} ${this.parseEval(s)})`}logicalAnd(r){return r.length?r.includes("0")?"0":r.join(" AND "):"1"}logicalOr(r){return r.length?r.includes("1")?"1":`(${r.join(" OR ")})`:"0"}logicalNot(r){return`NOT(${r})`}parseFieldQuery(r,n){let s=[];if(Array.isArray(n))s.push(this.createMemberQuery(r,n));else if(n instanceof RegExp)s.push(this.createRegExpQuery(r,n));else if(typeof n=="string"||typeof n=="number"||n instanceof Date)s.push(this.createEqualQuery(r,n));else if((0,Sn.isNullable)(n))s.push(this.createNullQuery(r,!1));else for(let l in n)l in this.queryOperators&&s.push(this.queryOperators[l](r,n[l]));return this.logicalAnd(s)}parseQuery(r){let n=[];for(let s in r)s==="$not"?n.push(this.logicalNot(this.parseQuery(r.$not))):s==="$and"?n.push(this.logicalAnd(r.$and.map(this.parseQuery.bind(this)))):s==="$or"?n.push(this.logicalOr(r.$or.map(this.parseQuery.bind(this)))):s==="$expr"?n.push(this.parseEval(r.$expr)):n.push(this.parseFieldQuery(te(s),r[s]));return this.logicalAnd(n)}parseEvalExpr(r){for(let n in r)if(n in this.evalOperators)return this.evalOperators[n](r[n]);return this.escape(r)}parseAggr(r){return typeof r=="string"?this.getRecursive(r):this.parseEvalExpr(r)}transformKey(r,n,s){if(r in n||!r.includes("."))return s+te(r);let l=Object.keys(n).find(o=>r.startsWith(o+"."))||r.split(".")[0],c=r.slice(l.length+1).split(".");return`json_unquote(json_extract(${te(s+l)}, '$${c.map(o=>`."${o}"`).join("")}'))`}getRecursive(r){var n,s,l,c;if(typeof r=="string")return this.getRecursive(["_",r]);let[o,y]=r,v=((s=(n=this.tables)==null?void 0:n[o])==null?void 0:s.fields)||{};if((l=v[y])!=null&&l.expr)return this.parseEvalExpr((c=v[y])==null?void 0:c.expr);let I=!this.tables||o==="_"||y in v?"":`${te(o)}.`;return this.transformKey(y,v,I)}parseEval(r){return typeof r=="string"||typeof r=="number"||typeof r=="boolean"||r instanceof Date?this.escape(r):this.parseEvalExpr(r)}suffix(r){let{limit:n,offset:s,sort:l,group:c,having:o}=r,y="";if(c.length){y+=` GROUP BY ${c.map(te).join(", ")}`;let v=this.parseEval(o);v!=="1"&&(y+=` HAVING ${v}`)}return l.length&&(y+=" ORDER BY "+l.map(([v,I])=>`${this.parseEval(v)} ${I.toUpperCase()}`).join(", ")),n<1/0&&(y+=" LIMIT "+n),s>0&&(y+=" OFFSET "+s),y}get(r,n=!1){var s;let{args:l,table:c,query:o,ref:y,model:v}=r,I=this.parseQuery(o);if(I==="0")return;let O=(s=l[0].fields)!=null?s:Object.fromEntries(Object.entries(v.fields).filter(([,Q])=>!Q.deprecated).map(([Q])=>[Q,{$:[y,Q]}])),M=Object.entries(O).map(([Q,F])=>(Q=te(Q),F=this.parseEval(F),Q===F?Q:`${F} AS ${Q}`)).join(", "),b;if(typeof c=="string")b=te(c);else if(c instanceof ls.Selection){if(b=this.get(c,!0),!b)return}else{b=Object.entries(c).map(([F,K])=>typeof K!="string"?`${this.get(K,!0)} AS ${te(F)}`:F===K?te(K):`${te(K)} AS ${te(F)}`).join(" JOIN ");let Q=this.parseEval(l[0].having);Q!=="1"&&(b+=` ON ${Q}`)}let k=this.suffix(l[0]);if(I!=="1"&&(k=` WHERE ${I}`+k),(!b.includes(" ")||b.startsWith("("))&&(k=` ${y}`+k),n&&!l[0].fields&&!k)return b;let Y=`SELECT ${M} FROM ${b}${k}`;return n?`(${Y})`:Y}define(r){r.types.forEach(n=>this.types[n]=r)}dump(r,n){n=r.format(n);let s={};for(let l in n)s[l]=this.stringify(n[l],r.fields[l]);return s}load(r,n){let s={};for(let l in n){if(!(l in r.fields))continue;let{type:c,initial:o}=r.fields[l],y=this.types[c];s[l]=y?y.load(n[l],o):n[l]}return r.parse(s)}escape(r,n){if(r=this.stringify(r,n),(0,Sn.isNullable)(r))return"NULL";switch(typeof r){case"boolean":case"number":return r+"";case"object":return this.quote(JSON.stringify(r));default:return this.quote(r)}}stringify(r,n){let s=this.types[n?.type];return s?s.dump(r):r}quote(r){var n;(n=this.escapeRegExp)!=null||(this.escapeRegExp=new RegExp(`[${Object.values(this.escapeMap).join("")}]`,"g"));let s=this.escapeRegExp.lastIndex=0,l="",c;for(;c=this.escapeRegExp.exec(r);)l+=r.slice(s,c.index)+this.escapeMap[c[0]],s=this.escapeRegExp.lastIndex;return s===0?"'"+r+"'":s<r.length?"'"+l+r.slice(s)+"'":"'"+l+"'"}};Tn(kn,"Builder")});var Pe={};import*as Cs from"https://registry.koishi.chat/modules/fsa-browserify/index.js";var gr=fr(()=>{U();Oe(Pe,Cs)});import fs from"https://registry.koishi.chat/modules/path-browserify/index.js";var Er=Te((Ks,Ln)=>{U();Ln.exports=fs});import cs from"https://registry.koishi.chat/modules/crypto-browserify/index.js";var Fn=Te((Vs,Qn)=>{U();Qn.exports=cs});var Hn=Te((Tt,Le)=>{U();var It=void 0,St=function(r){return It||(It=new Promise(function(n,s){var l=typeof r<"u"?r:{},c=l.onAbort;l.onAbort=function(e){s(new Error(e)),c&&c(e)},l.postRun=l.postRun||[],l.postRun.push(function(){n(l)}),Le=void 0;var o;o||(o=typeof l<"u"?l:{}),o.onRuntimeInitialized=function(){function e(f,d){switch(typeof d){case"boolean":Hi(f,d?1:0);break;case"number":Li(f,d);break;case"string":Qi(f,d,-1,-1);break;case"object":if(d===null)gn(f);else if(d.length!=null){var _=ur(d);Fi(f,_,d.length,-1),gt(_)}else $t(f,"Wrong API use : tried to return a value of an unknown type ("+d+").",-1);break;default:gn(f)}}function t(f,d){for(var _=[],g=0;g<f;g+=1){var q=me(d+4*g,"i32"),T=Ti(q);if(T===1||T===2)q=Pi(q);else if(T===3)q=ki(q);else if(T===4){T=q,q=Ni(T),T=Di(T);for(var ce=new Uint8Array(q),Z=0;Z<q;Z+=1)ce[Z]=z[T+Z];q=ce}else q=null;_.push(q)}return _}function i(f,d){this.La=f,this.db=d,this.Ja=1,this.fb=[]}function a(f,d){if(this.db=d,d=He(f)+1,this.Ya=wt(d),this.Ya===null)throw Error("Unable to allocate memory for the SQL string");je(f,le,this.Ya,d),this.eb=this.Ya,this.Ua=this.ib=null}function u(f){if(this.filename="dbfile_"+(4294967295*Math.random()>>>0),f!=null){var d=this.filename,_="/",g=d;if(_&&(_=typeof _=="string"?_:Ye(_),g=d?de(_+"/"+d):_),d=un(!0,!0),g=pt(g,(d!==void 0?d:438)&4095|32768,0),f){if(typeof f=="string"){_=Array(f.length);for(var q=0,T=f.length;q<T;++q)_[q]=f.charCodeAt(q);f=_}dt(g,d|146),_=Ue(g,577),sn(_,f,0,f.length,0),er(_),dt(g,d)}}this.handleError(E(this.filename,h)),this.db=me(h,"i32"),Gi(this.db),this.Za={},this.Na={}}var h=ye(4),p=o.cwrap,E=p("sqlite3_open","number",["string","number"]),S=p("sqlite3_close_v2","number",["number"]),R=p("sqlite3_exec","number",["number","string","number","number","number"]),G=p("sqlite3_changes","number",["number"]),ve=p("sqlite3_prepare_v2","number",["number","string","number","number","number"]),yn=p("sqlite3_sql","string",["number"]),yi=p("sqlite3_normalized_sql","string",["number"]),vn=p("sqlite3_prepare_v2","number",["number","number","number","number","number"]),vi=p("sqlite3_bind_text","number",["number","number","number","number","number"]),_n=p("sqlite3_bind_blob","number",["number","number","number","number","number"]),_i=p("sqlite3_bind_double","number",["number","number","number"]),bi=p("sqlite3_bind_int","number",["number","number","number"]),wi=p("sqlite3_bind_parameter_index","number",["number","string"]),gi=p("sqlite3_step","number",["number"]),Ei=p("sqlite3_errmsg","string",["number"]),$i=p("sqlite3_column_count","number",["number"]),Oi=p("sqlite3_data_count","number",["number"]),xi=p("sqlite3_column_double","number",["number","number"]),bn=p("sqlite3_column_text","string",["number","number"]),Ai=p("sqlite3_column_blob","number",["number","number"]),qi=p("sqlite3_column_bytes","number",["number","number"]),ji=p("sqlite3_column_type","number",["number","number"]),Mi=p("sqlite3_column_name","string",["number","number"]),Ri=p("sqlite3_reset","number",["number"]),Ii=p("sqlite3_clear_bindings","number",["number"]),Si=p("sqlite3_finalize","number",["number"]),wn=p("sqlite3_create_function_v2","number","number string number number number number number number number".split(" ")),Ti=p("sqlite3_value_type","number",["number"]),Ni=p("sqlite3_value_bytes","number",["number"]),ki=p("sqlite3_value_text","string",["number"]),Di=p("sqlite3_value_blob","number",["number"]),Pi=p("sqlite3_value_double","number",["number"]),Li=p("sqlite3_result_double","",["number","number"]),gn=p("sqlite3_result_null","",["number"]),Qi=p("sqlite3_result_text","",["number","string","number","number"]),Fi=p("sqlite3_result_blob","",["number","number","number","number"]),Hi=p("sqlite3_result_int","",["number","number"]),$t=p("sqlite3_result_error","",["number","string","number"]),En=p("sqlite3_aggregate_context","number",["number","number"]),Gi=p("RegisterExtensionFunctions","number",["number"]);i.prototype.bind=function(f){if(!this.La)throw"Statement closed";return this.reset(),Array.isArray(f)?this.xb(f):f!=null&&typeof f=="object"?this.yb(f):!0},i.prototype.step=function(){if(!this.La)throw"Statement closed";this.Ja=1;var f=gi(this.La);switch(f){case 100:return!0;case 101:return!1;default:throw this.db.handleError(f)}},i.prototype.sb=function(f){return f==null&&(f=this.Ja,this.Ja+=1),xi(this.La,f)},i.prototype.Cb=function(f){if(f==null&&(f=this.Ja,this.Ja+=1),f=bn(this.La,f),typeof BigInt!="function")throw Error("BigInt is not supported");return BigInt(f)},i.prototype.Db=function(f){return f==null&&(f=this.Ja,this.Ja+=1),bn(this.La,f)},i.prototype.getBlob=function(f){f==null&&(f=this.Ja,this.Ja+=1);var d=qi(this.La,f);f=Ai(this.La,f);for(var _=new Uint8Array(d),g=0;g<d;g+=1)_[g]=z[f+g];return _},i.prototype.get=function(f,d){d=d||{},f!=null&&this.bind(f)&&this.step(),f=[];for(var _=Oi(this.La),g=0;g<_;g+=1)switch(ji(this.La,g)){case 1:var q=d.useBigInt?this.Cb(g):this.sb(g);f.push(q);break;case 2:f.push(this.sb(g));break;case 3:f.push(this.Db(g));break;case 4:f.push(this.getBlob(g));break;default:f.push(null)}return f},i.prototype.getColumnNames=function(){for(var f=[],d=$i(this.La),_=0;_<d;_+=1)f.push(Mi(this.La,_));return f},i.prototype.getAsObject=function(f,d){f=this.get(f,d),d=this.getColumnNames();for(var _={},g=0;g<d.length;g+=1)_[d[g]]=f[g];return _},i.prototype.getSQL=function(){return yn(this.La)},i.prototype.getNormalizedSQL=function(){return yi(this.La)},i.prototype.run=function(f){return f!=null&&this.bind(f),this.step(),this.reset()},i.prototype.nb=function(f,d){d==null&&(d=this.Ja,this.Ja+=1),f=Qr(f);var _=ur(f);this.fb.push(_),this.db.handleError(vi(this.La,d,_,f.length-1,0))},i.prototype.wb=function(f,d){d==null&&(d=this.Ja,this.Ja+=1);var _=ur(f);this.fb.push(_),this.db.handleError(_n(this.La,d,_,f.length,0))},i.prototype.mb=function(f,d){d==null&&(d=this.Ja,this.Ja+=1),this.db.handleError((f===(f|0)?bi:_i)(this.La,d,f))},i.prototype.zb=function(f){f==null&&(f=this.Ja,this.Ja+=1),_n(this.La,f,0,0,0)},i.prototype.ob=function(f,d){switch(d==null&&(d=this.Ja,this.Ja+=1),typeof f){case"string":this.nb(f,d);return;case"number":this.mb(f,d);return;case"bigint":this.nb(f.toString(),d);return;case"boolean":this.mb(f+0,d);return;case"object":if(f===null){this.zb(d);return}if(f.length!=null){this.wb(f,d);return}}throw"Wrong API use : tried to bind a value of an unknown type ("+f+")."},i.prototype.yb=function(f){var d=this;return Object.keys(f).forEach(function(_){var g=wi(d.La,_);g!==0&&d.ob(f[_],g)}),!0},i.prototype.xb=function(f){for(var d=0;d<f.length;d+=1)this.ob(f[d],d+1);return!0},i.prototype.reset=function(){return this.freemem(),Ii(this.La)===0&&Ri(this.La)===0},i.prototype.freemem=function(){for(var f;(f=this.fb.pop())!==void 0;)gt(f)},i.prototype.free=function(){this.freemem();var f=Si(this.La)===0;return delete this.db.Za[this.La],this.La=0,f},a.prototype.next=function(){if(this.Ya===null)return{done:!0};if(this.Ua!==null&&(this.Ua.free(),this.Ua=null),!this.db.db)throw this.gb(),Error("Database closed");var f=tt(),d=ye(4);Je(h),Je(d);try{this.db.handleError(vn(this.db.db,this.eb,-1,h,d)),this.eb=me(d,"i32");var _=me(h,"i32");return _===0?(this.gb(),{done:!0}):(this.Ua=new i(_,this.db),this.db.Za[_]=this.Ua,{value:this.Ua,done:!1})}catch(g){throw this.ib=C(this.eb),this.gb(),g}finally{rt(f)}},a.prototype.gb=function(){gt(this.Ya),this.Ya=null},a.prototype.getRemainingSQL=function(){return this.ib!==null?this.ib:C(this.eb)},typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"&&(a.prototype[Symbol.iterator]=function(){return this}),u.prototype.run=function(f,d){if(!this.db)throw"Database closed";if(d){f=this.prepare(f,d);try{f.step()}finally{f.free()}}else this.handleError(R(this.db,f,0,0,h));return this},u.prototype.exec=function(f,d,_){if(!this.db)throw"Database closed";var g=tt(),q=null;try{var T=He(f)+1,ce=ye(T);je(f,z,ce,T);var Z=ce,ie=ye(4);for(f=[];me(Z,"i8")!==0;){Je(h),Je(ie),this.handleError(vn(this.db,Z,-1,h,ie));var se=me(h,"i32");if(Z=me(ie,"i32"),se!==0){for(T=null,q=new i(se,this),d!=null&&q.bind(d);q.step();)T===null&&(T={columns:q.getColumnNames(),values:[]},f.push(T)),T.values.push(q.get(null,_));q.free()}}return f}catch(nt){throw q&&q.free(),nt}finally{rt(g)}},u.prototype.each=function(f,d,_,g,q){typeof d=="function"&&(g=_,_=d,d=void 0),f=this.prepare(f,d);try{for(;f.step();)_(f.getAsObject(null,q))}finally{f.free()}if(typeof g=="function")return g()},u.prototype.prepare=function(f,d){if(Je(h),this.handleError(ve(this.db,f,-1,h,0)),f=me(h,"i32"),f===0)throw"Nothing to prepare";var _=new i(f,this);return d!=null&&_.bind(d),this.Za[f]=_},u.prototype.iterateStatements=function(f){return new a(f,this)},u.prototype.export=function(){Object.values(this.Za).forEach(function(d){d.free()}),Object.values(this.Na).forEach(et),this.Na={},this.handleError(S(this.db));var f=fi(this.filename);return this.handleError(E(this.filename,h)),this.db=me(h,"i32"),f},u.prototype.close=function(){this.db!==null&&(Object.values(this.Za).forEach(function(f){f.free()}),Object.values(this.Na).forEach(et),this.Na={},this.handleError(S(this.db)),Xr("/"+this.filename),this.db=null)},u.prototype.handleError=function(f){if(f===0)return null;throw f=Ei(this.db),Error(f)},u.prototype.getRowsModified=function(){return G(this.db)},u.prototype.create_function=function(f,d){Object.prototype.hasOwnProperty.call(this.Na,f)&&(et(this.Na[f]),delete this.Na[f]);var _=ar(function(g,q,T){q=t(q,T);try{var ce=d.apply(null,q)}catch(Z){$t(g,Z,-1);return}e(g,ce)},"viii");return this.Na[f]=_,this.handleError(wn(this.db,f,d.length,1,0,_,0,0,0)),this},u.prototype.create_aggregate=function(f,d){var _=d.init||function(){return null},g=d.finalize||function(ie){return ie},q=d.step;if(!q)throw"An aggregate function must have a step function in "+f;var T={};Object.hasOwnProperty.call(this.Na,f)&&(et(this.Na[f]),delete this.Na[f]),d=f+"__finalize",Object.hasOwnProperty.call(this.Na,d)&&(et(this.Na[d]),delete this.Na[d]);var ce=ar(function(ie,se,nt){var Se=En(ie,1);Object.hasOwnProperty.call(T,Se)||(T[Se]=_()),se=t(se,nt),se=[T[Se]].concat(se);try{T[Se]=q.apply(null,se)}catch(Ui){delete T[Se],$t(ie,Ui,-1)}},"viii"),Z=ar(function(ie){var se=En(ie,1);try{var nt=g(T[se])}catch(Se){delete T[se],$t(ie,Se,-1);return}e(ie,nt),delete T[se]},"vi");return this.Na[f]=ce,this.Na[d]=Z,this.handleError(wn(this.db,f,q.length-1,1,0,0,ce,Z,0)),this},o.Database=u};var y=Object.assign({},o),v="./this.program",I=typeof window=="object",O=typeof importScripts=="function",M=typeof B=="object"&&typeof B.versions=="object"&&typeof B.versions.node=="string",b="",k,Y,Q,F,K,Ht;M?(b=O?Er().dirname(b)+"/":import.meta.url+"/",Ht=()=>{K||(F=(gr(),_e(Pe)),K=Er())},k=function(e,t){return Ht(),e=K.normalize(e),F.readFileSync(e,t?void 0:"utf8")},Q=e=>(e=k(e,!0),e.buffer||(e=new Uint8Array(e)),e),Y=(e,t,i)=>{Ht(),e=K.normalize(e),F.readFile(e,function(a,u){a?i(a):t(u.buffer)})},1<B.argv.length&&(v=B.argv[1].replace(/\\/g,"/")),B.argv.slice(2),typeof Le<"u"&&(Le.exports=o),o.inspect=function(){return"[Emscripten Module object]"}):(I||O)&&(O?b=self.location.href:typeof document<"u"&&document.currentScript&&(b=document.currentScript.src),b=b.indexOf("blob:")!==0?b.substr(0,b.replace(/[?#].*/,"").lastIndexOf("/")+1):"",k=e=>{var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(null),t.responseText},O&&(Q=e=>{var t=new XMLHttpRequest;return t.open("GET",e,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)}),Y=(e,t,i)=>{var a=new XMLHttpRequest;a.open("GET",e,!0),a.responseType="arraybuffer",a.onload=()=>{a.status==200||a.status==0&&a.response?t(a.response):i()},a.onerror=i,a.send(null)});var Mr=o.print||void 0,qe=o.printErr||void 0;Object.assign(o,y),y=null,o.thisProgram&&(v=o.thisProgram);var Be;o.wasmBinary&&(Be=o.wasmBinary);var As=o.noExitRuntime||!0;typeof WebAssembly!="object"&&we("no native wasm support detected");var Gt,Rr=!1,Ir=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0;function Fe(e,t,i){var a=t+i;for(i=t;e[i]&&!(i>=a);)++i;if(16<i-t&&e.buffer&&Ir)return Ir.decode(e.subarray(t,i));for(a="";t<i;){var u=e[t++];if(u&128){var h=e[t++]&63;if((u&224)==192)a+=String.fromCharCode((u&31)<<6|h);else{var p=e[t++]&63;u=(u&240)==224?(u&15)<<12|h<<6|p:(u&7)<<18|h<<12|p<<6|e[t++]&63,65536>u?a+=String.fromCharCode(u):(u-=65536,a+=String.fromCharCode(55296|u>>10,56320|u&1023))}}else a+=String.fromCharCode(u)}return a}function C(e,t){return e?Fe(le,e,t):""}function je(e,t,i,a){if(!(0<a))return 0;var u=i;a=i+a-1;for(var h=0;h<e.length;++h){var p=e.charCodeAt(h);if(55296<=p&&57343>=p){var E=e.charCodeAt(++h);p=65536+((p&1023)<<10)|E&1023}if(127>=p){if(i>=a)break;t[i++]=p}else{if(2047>=p){if(i+1>=a)break;t[i++]=192|p>>6}else{if(65535>=p){if(i+2>=a)break;t[i++]=224|p>>12}else{if(i+3>=a)break;t[i++]=240|p>>18,t[i++]=128|p>>12&63}t[i++]=128|p>>6&63}t[i++]=128|p&63}}return t[i]=0,i-u}function He(e){for(var t=0,i=0;i<e.length;++i){var a=e.charCodeAt(i);127>=a?t++:2047>=a?t+=2:55296<=a&&57343>=a?(t+=4,++i):t+=3}return t}var Ut,z,le,ft,w,J,Wt,zt;function Sr(){var e=Gt.buffer;Ut=e,o.HEAP8=z=new Int8Array(e),o.HEAP16=ft=new Int16Array(e),o.HEAP32=w=new Int32Array(e),o.HEAPU8=le=new Uint8Array(e),o.HEAPU16=new Uint16Array(e),o.HEAPU32=J=new Uint32Array(e),o.HEAPF32=Wt=new Float32Array(e),o.HEAPF64=zt=new Float64Array(e)}var be,Tr=[],Nr=[],kr=[];function Zn(){var e=o.preRun.shift();Tr.unshift(e)}var Me=0,Ct=null,Ke=null;function we(e){throw o.onAbort&&o.onAbort(e),e="Aborted("+e+")",qe(e),Rr=!0,new WebAssembly.RuntimeError(e+". Build with -sASSERTIONS for more info.")}function Dr(){return ne.startsWith("data:application/octet-stream;base64,")}var ne;if(ne="sql-wasm.wasm",!Dr()){var Pr=ne;ne=o.locateFile?o.locateFile(Pr,b):b+Pr}function Lr(){var e=ne;try{if(e==ne&&Be)return new Uint8Array(Be);if(Q)return Q(e);throw"both async and sync fetching of the wasm failed"}catch(t){we(t)}}function ei(){if(!Be&&(I||O)){if(typeof fetch=="function"&&!ne.startsWith("file://"))return fetch(ne,{credentials:"same-origin"}).then(function(e){if(!e.ok)throw"failed to load wasm binary file at '"+ne+"'";return e.arrayBuffer()}).catch(function(){return Lr()});if(Y)return new Promise(function(e,t){Y(ne,function(i){e(new Uint8Array(i))},t)})}return Promise.resolve().then(function(){return Lr()})}var x,H;function Bt(e){for(;0<e.length;)e.shift()(o)}function me(e,t="i8"){switch(t.endsWith("*")&&(t="*"),t){case"i1":return z[e>>0];case"i8":return z[e>>0];case"i16":return ft[e>>1];case"i32":return w[e>>2];case"i64":return w[e>>2];case"float":return Wt[e>>2];case"double":return zt[e>>3];case"*":return J[e>>2];default:we("invalid type for getValue: "+t)}return null}function Je(e){var t="i32";switch(t.endsWith("*")&&(t="*"),t){case"i1":z[e>>0]=0;break;case"i8":z[e>>0]=0;break;case"i16":ft[e>>1]=0;break;case"i32":w[e>>2]=0;break;case"i64":H=[0,(x=0,1<=+Math.abs(x)?0<x?(Math.min(+Math.floor(x/4294967296),4294967295)|0)>>>0:~~+Math.ceil((x-+(~~x>>>0))/4294967296)>>>0:0)],w[e>>2]=H[0],w[e+4>>2]=H[1];break;case"float":Wt[e>>2]=0;break;case"double":zt[e>>3]=0;break;case"*":J[e>>2]=0;break;default:we("invalid type for setValue: "+t)}}var Kt=(e,t)=>{for(var i=0,a=e.length-1;0<=a;a--){var u=e[a];u==="."?e.splice(a,1):u===".."?(e.splice(a,1),i++):i&&(e.splice(a,1),i--)}if(t)for(;i;i--)e.unshift("..");return e},de=e=>{var t=e.charAt(0)==="/",i=e.substr(-1)==="/";return(e=Kt(e.split("/").filter(a=>!!a),!t).join("/"))||t||(e="."),e&&i&&(e+="/"),(t?"/":"")+e},ti=e=>{var t=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/.exec(e).slice(1);return e=t[0],t=t[1],!e&&!t?".":(t&&(t=t.substr(0,t.length-1)),e+t)},ct=e=>{if(e==="/")return"/";e=de(e),e=e.replace(/\/$/,"");var t=e.lastIndexOf("/");return t===-1?e:e.substr(t+1)};function ri(){if(typeof crypto=="object"&&typeof crypto.getRandomValues=="function"){var e=new Uint8Array(1);return()=>(crypto.getRandomValues(e),e[0])}if(M)try{var t=Fn();return()=>t.randomBytes(1)[0]}catch{}return()=>we("randomDevice")}function ht(){for(var e="",t=!1,i=arguments.length-1;-1<=i&&!t;i--){if(t=0<=i?arguments[i]:"/",typeof t!="string")throw new TypeError("Arguments to path.resolve must be strings");if(!t)return"";e=t+"/"+e,t=t.charAt(0)==="/"}return e=Kt(e.split("/").filter(a=>!!a),!t).join("/"),(t?"/":"")+e||"."}function Qr(e,t){var i=Array(He(e)+1);return e=je(e,i,0,i.length),t&&(i.length=e),i}var Fr=[];function Hr(e,t){Fr[e]={input:[],output:[],Xa:t},Xt(e,ni)}var ni={open:function(e){var t=Fr[e.node.rdev];if(!t)throw new m(43);e.tty=t,e.seekable=!1},close:function(e){e.tty.Xa.flush(e.tty)},flush:function(e){e.tty.Xa.flush(e.tty)},read:function(e,t,i,a){if(!e.tty||!e.tty.Xa.tb)throw new m(60);for(var u=0,h=0;h<a;h++){try{var p=e.tty.Xa.tb(e.tty)}catch{throw new m(29)}if(p===void 0&&u===0)throw new m(6);if(p==null)break;u++,t[i+h]=p}return u&&(e.node.timestamp=Date.now()),u},write:function(e,t,i,a){if(!e.tty||!e.tty.Xa.jb)throw new m(60);try{for(var u=0;u<a;u++)e.tty.Xa.jb(e.tty,t[i+u])}catch{throw new m(29)}return a&&(e.node.timestamp=Date.now()),u}},ii={tb:function(e){if(!e.input.length){var t=null;if(M){var i=ue.alloc(256),a=0;try{a=F.readSync(B.stdin.fd,i,0,256,-1)}catch(u){if(u.toString().includes("EOF"))a=0;else throw u}0<a?t=i.slice(0,a).toString("utf-8"):t=null}else typeof window<"u"&&typeof window.prompt=="function"?(t=window.prompt("Input: "),t!==null&&(t+=`
`)):typeof readline=="function"&&(t=readline(),t!==null&&(t+=`
`));if(!t)return null;e.input=Qr(t,!0)}return e.input.shift()},jb:function(e,t){t===null||t===10?(Mr(Fe(e.output,0)),e.output=[]):t!=0&&e.output.push(t)},flush:function(e){e.output&&0<e.output.length&&(Mr(Fe(e.output,0)),e.output=[])}},si={jb:function(e,t){t===null||t===10?(qe(Fe(e.output,0)),e.output=[]):t!=0&&e.output.push(t)},flush:function(e){e.output&&0<e.output.length&&(qe(Fe(e.output,0)),e.output=[])}},A={Qa:null,Ra:function(){return A.createNode(null,"/",16895,0)},createNode:function(e,t,i,a){if((i&61440)===24576||(i&61440)===4096)throw new m(63);return A.Qa||(A.Qa={dir:{node:{Pa:A.Ga.Pa,Oa:A.Ga.Oa,lookup:A.Ga.lookup,ab:A.Ga.ab,rename:A.Ga.rename,unlink:A.Ga.unlink,rmdir:A.Ga.rmdir,readdir:A.Ga.readdir,symlink:A.Ga.symlink},stream:{Ta:A.Ha.Ta}},file:{node:{Pa:A.Ga.Pa,Oa:A.Ga.Oa},stream:{Ta:A.Ha.Ta,read:A.Ha.read,write:A.Ha.write,lb:A.Ha.lb,bb:A.Ha.bb,cb:A.Ha.cb}},link:{node:{Pa:A.Ga.Pa,Oa:A.Ga.Oa,readlink:A.Ga.readlink},stream:{}},pb:{node:{Pa:A.Ga.Pa,Oa:A.Ga.Oa},stream:li}}),i=zr(e,t,i,a),(i.mode&61440)===16384?(i.Ga=A.Qa.dir.node,i.Ha=A.Qa.dir.stream,i.Ia={}):(i.mode&61440)===32768?(i.Ga=A.Qa.file.node,i.Ha=A.Qa.file.stream,i.Ma=0,i.Ia=null):(i.mode&61440)===40960?(i.Ga=A.Qa.link.node,i.Ha=A.Qa.link.stream):(i.mode&61440)===8192&&(i.Ga=A.Qa.pb.node,i.Ha=A.Qa.pb.stream),i.timestamp=Date.now(),e&&(e.Ia[t]=i,e.timestamp=i.timestamp),i},Jb:function(e){return e.Ia?e.Ia.subarray?e.Ia.subarray(0,e.Ma):new Uint8Array(e.Ia):new Uint8Array(0)},qb:function(e,t){var i=e.Ia?e.Ia.length:0;i>=t||(t=Math.max(t,i*(1048576>i?2:1.125)>>>0),i!=0&&(t=Math.max(t,256)),i=e.Ia,e.Ia=new Uint8Array(t),0<e.Ma&&e.Ia.set(i.subarray(0,e.Ma),0))},Gb:function(e,t){if(e.Ma!=t)if(t==0)e.Ia=null,e.Ma=0;else{var i=e.Ia;e.Ia=new Uint8Array(t),i&&e.Ia.set(i.subarray(0,Math.min(t,e.Ma))),e.Ma=t}},Ga:{Pa:function(e){var t={};return t.dev=(e.mode&61440)===8192?e.id:1,t.ino=e.id,t.mode=e.mode,t.nlink=1,t.uid=0,t.gid=0,t.rdev=e.rdev,(e.mode&61440)===16384?t.size=4096:(e.mode&61440)===32768?t.size=e.Ma:(e.mode&61440)===40960?t.size=e.link.length:t.size=0,t.atime=new Date(e.timestamp),t.mtime=new Date(e.timestamp),t.ctime=new Date(e.timestamp),t.Ab=4096,t.blocks=Math.ceil(t.size/t.Ab),t},Oa:function(e,t){t.mode!==void 0&&(e.mode=t.mode),t.timestamp!==void 0&&(e.timestamp=t.timestamp),t.size!==void 0&&A.Gb(e,t.size)},lookup:function(){throw Yt[44]},ab:function(e,t,i,a){return A.createNode(e,t,i,a)},rename:function(e,t,i){if((e.mode&61440)===16384){try{var a=Re(t,i)}catch{}if(a)for(var u in a.Ia)throw new m(55)}delete e.parent.Ia[e.name],e.parent.timestamp=Date.now(),e.name=i,t.Ia[i]=e,t.timestamp=e.parent.timestamp,e.parent=t},unlink:function(e,t){delete e.Ia[t],e.timestamp=Date.now()},rmdir:function(e,t){var i=Re(e,t),a;for(a in i.Ia)throw new m(55);delete e.Ia[t],e.timestamp=Date.now()},readdir:function(e){var t=[".",".."],i;for(i in e.Ia)e.Ia.hasOwnProperty(i)&&t.push(i);return t},symlink:function(e,t,i){return e=A.createNode(e,t,41471,0),e.link=i,e},readlink:function(e){if((e.mode&61440)!==40960)throw new m(28);return e.link}},Ha:{read:function(e,t,i,a,u){var h=e.node.Ia;if(u>=e.node.Ma)return 0;if(e=Math.min(e.node.Ma-u,a),8<e&&h.subarray)t.set(h.subarray(u,u+e),i);else for(a=0;a<e;a++)t[i+a]=h[u+a];return e},write:function(e,t,i,a,u,h){if(t.buffer===z.buffer&&(h=!1),!a)return 0;if(e=e.node,e.timestamp=Date.now(),t.subarray&&(!e.Ia||e.Ia.subarray)){if(h)return e.Ia=t.subarray(i,i+a),e.Ma=a;if(e.Ma===0&&u===0)return e.Ia=t.slice(i,i+a),e.Ma=a;if(u+a<=e.Ma)return e.Ia.set(t.subarray(i,i+a),u),a}if(A.qb(e,u+a),e.Ia.subarray&&t.subarray)e.Ia.set(t.subarray(i,i+a),u);else for(h=0;h<a;h++)e.Ia[u+h]=t[i+h];return e.Ma=Math.max(e.Ma,u+a),a},Ta:function(e,t,i){if(i===1?t+=e.position:i===2&&(e.node.mode&61440)===32768&&(t+=e.node.Ma),0>t)throw new m(28);return t},lb:function(e,t,i){A.qb(e.node,t+i),e.node.Ma=Math.max(e.node.Ma,t+i)},bb:function(e,t,i,a,u){if((e.node.mode&61440)!==32768)throw new m(43);if(e=e.node.Ia,u&2||e.buffer!==Ut){if((0<i||i+t<e.length)&&(e.subarray?e=e.subarray(i,i+t):e=Array.prototype.slice.call(e,i,i+t)),i=!0,t=65536*Math.ceil(t/65536),(u=mn(65536,t))?(le.fill(0,u,u+t),t=u):t=0,!t)throw new m(48);z.set(e,t)}else i=!1,t=e.byteOffset;return{Fb:t,vb:i}},cb:function(e,t,i,a,u){if((e.node.mode&61440)!==32768)throw new m(43);return u&2||A.Ha.write(e,t,0,a,i,!1),0}}},Jt=null,Gr={},ae=[],oi=1,ge=null,Ur=!0,m=null,Yt={},V=(e,t={})=>{if(e=ht("/",e),!e)return{path:"",node:null};if(t=Object.assign({rb:!0,kb:0},t),8<t.kb)throw new m(32);e=Kt(e.split("/").filter(p=>!!p),!1);for(var i=Jt,a="/",u=0;u<e.length;u++){var h=u===e.length-1;if(h&&t.parent)break;if(i=Re(i,e[u]),a=de(a+"/"+e[u]),i.Va&&(!h||h&&t.rb)&&(i=i.Va.root),!h||t.Sa){for(h=0;(i.mode&61440)===40960;)if(i=Zr(a),a=ht(ti(a),i),i=V(a,{kb:t.kb+1}).node,40<h++)throw new m(32)}}return{path:a,node:i}},Ye=e=>{for(var t;;){if(e===e.parent)return e=e.Ra.ub,t?e[e.length-1]!=="/"?e+"/"+t:e+t:e;t=t?e.name+"/"+t:e.name,e=e.parent}},Vt=(e,t)=>{for(var i=0,a=0;a<t.length;a++)i=(i<<5)-i+t.charCodeAt(a)|0;return(e+i>>>0)%ge.length},Wr=e=>{var t=Vt(e.parent.id,e.name);if(ge[t]===e)ge[t]=e.Wa;else for(t=ge[t];t;){if(t.Wa===e){t.Wa=e.Wa;break}t=t.Wa}},Re=(e,t)=>{var i;if(i=(i=Ge(e,"x"))?i:e.Ga.lookup?0:2)throw new m(i,e);for(i=ge[Vt(e.id,t)];i;i=i.Wa){var a=i.name;if(i.parent.id===e.id&&a===t)return i}return e.Ga.lookup(e,t)},zr=(e,t,i,a)=>(e=new hn(e,t,i,a),t=Vt(e.parent.id,e.name),e.Wa=ge[t],ge[t]=e),ai={r:0,"r+":2,w:577,"w+":578,a:1089,"a+":1090},Cr=e=>{var t=["r","w","rw"][e&3];return e&512&&(t+="w"),t},Ge=(e,t)=>{if(Ur)return 0;if(!t.includes("r")||e.mode&292){if(t.includes("w")&&!(e.mode&146)||t.includes("x")&&!(e.mode&73))return 2}else return 2;return 0},Br=(e,t)=>{try{return Re(e,t),20}catch{}return Ge(e,"wx")},Kr=(e,t,i)=>{try{var a=Re(e,t)}catch(u){return u.Ka}if(e=Ge(e,"wx"))return e;if(i){if((a.mode&61440)!==16384)return 54;if(a===a.parent||Ye(a)==="/")return 10}else if((a.mode&61440)===16384)return 31;return 0},ui=(e=0)=>{for(;4096>=e;e++)if(!ae[e])return e;throw new m(33)},Jr=(e,t)=>(Ze||(Ze=function(){this.$a={}},Ze.prototype={},Object.defineProperties(Ze.prototype,{object:{get:function(){return this.node},set:function(i){this.node=i}},flags:{get:function(){return this.$a.flags},set:function(i){this.$a.flags=i}},position:{get:function(){return this.$a.position},set:function(i){this.$a.position=i}}})),e=Object.assign(new Ze,e),t=ui(t),e.fd=t,ae[t]=e),li={open:e=>{e.Ha=Gr[e.node.rdev].Ha,e.Ha.open&&e.Ha.open(e)},Ta:()=>{throw new m(70)}},Xt=(e,t)=>{Gr[e]={Ha:t}},Yr=(e,t)=>{var i=t==="/",a=!t;if(i&&Jt)throw new m(10);if(!i&&!a){var u=V(t,{rb:!1});if(t=u.path,u=u.node,u.Va)throw new m(10);if((u.mode&61440)!==16384)throw new m(54)}t={type:e,Kb:{},ub:t,Eb:[]},e=e.Ra(t),e.Ra=t,t.root=e,i?Jt=e:u&&(u.Va=t,u.Ra&&u.Ra.Eb.push(t))},pt=(e,t,i)=>{var a=V(e,{parent:!0}).node;if(e=ct(e),!e||e==="."||e==="..")throw new m(28);var u=Br(a,e);if(u)throw new m(u);if(!a.Ga.ab)throw new m(63);return a.Ga.ab(a,e,t,i)},fe=(e,t)=>pt(e,(t!==void 0?t:511)&1023|16384,0),mt=(e,t,i)=>{typeof i>"u"&&(i=t,t=438),pt(e,t|8192,i)},Zt=(e,t)=>{if(!ht(e))throw new m(44);var i=V(t,{parent:!0}).node;if(!i)throw new m(44);t=ct(t);var a=Br(i,t);if(a)throw new m(a);if(!i.Ga.symlink)throw new m(63);i.Ga.symlink(i,t,e)},Vr=e=>{var t=V(e,{parent:!0}).node;e=ct(e);var i=Re(t,e),a=Kr(t,e,!0);if(a)throw new m(a);if(!t.Ga.rmdir)throw new m(63);if(i.Va)throw new m(10);t.Ga.rmdir(t,e),Wr(i)},Xr=e=>{var t=V(e,{parent:!0}).node;if(!t)throw new m(44);e=ct(e);var i=Re(t,e),a=Kr(t,e,!1);if(a)throw new m(a);if(!t.Ga.unlink)throw new m(63);if(i.Va)throw new m(10);t.Ga.unlink(t,e),Wr(i)},Zr=e=>{if(e=V(e).node,!e)throw new m(44);if(!e.Ga.readlink)throw new m(28);return ht(Ye(e.parent),e.Ga.readlink(e))},Ve=(e,t)=>{if(e=V(e,{Sa:!t}).node,!e)throw new m(44);if(!e.Ga.Pa)throw new m(63);return e.Ga.Pa(e)},en=e=>Ve(e,!0),dt=(e,t)=>{if(e=typeof e=="string"?V(e,{Sa:!0}).node:e,!e.Ga.Oa)throw new m(63);e.Ga.Oa(e,{mode:t&4095|e.mode&-4096,timestamp:Date.now()})},tn=(e,t)=>{if(0>t)throw new m(28);if(e=typeof e=="string"?V(e,{Sa:!0}).node:e,!e.Ga.Oa)throw new m(63);if((e.mode&61440)===16384)throw new m(31);if((e.mode&61440)!==32768)throw new m(28);var i=Ge(e,"w");if(i)throw new m(i);e.Ga.Oa(e,{size:t,timestamp:Date.now()})},Ue=(e,t,i)=>{if(e==="")throw new m(44);if(typeof t=="string"){var a=ai[t];if(typeof a>"u")throw Error("Unknown file open mode: "+t);t=a}if(i=t&64?(typeof i>"u"?438:i)&4095|32768:0,typeof e=="object")var u=e;else{e=de(e);try{u=V(e,{Sa:!(t&131072)}).node}catch{}}if(a=!1,t&64)if(u){if(t&128)throw new m(20)}else u=pt(e,i,0),a=!0;if(!u)throw new m(44);if((u.mode&61440)===8192&&(t&=-513),t&65536&&(u.mode&61440)!==16384)throw new m(54);if(!a&&(i=u?(u.mode&61440)===40960?32:(u.mode&61440)===16384&&(Cr(t)!=="r"||t&512)?31:Ge(u,Cr(t)):44))throw new m(i);return t&512&&!a&&tn(u,0),t&=-131713,u=Jr({node:u,path:Ye(u),flags:t,seekable:!0,position:0,Ha:u.Ha,Ib:[],error:!1}),u.Ha.open&&u.Ha.open(u),!o.logReadFiles||t&1||(yt||(yt={}),e in yt||(yt[e]=1)),u},er=e=>{if(e.fd===null)throw new m(8);e.hb&&(e.hb=null);try{e.Ha.close&&e.Ha.close(e)}catch(t){throw t}finally{ae[e.fd]=null}e.fd=null},rn=(e,t,i)=>{if(e.fd===null)throw new m(8);if(!e.seekable||!e.Ha.Ta)throw new m(70);if(i!=0&&i!=1&&i!=2)throw new m(28);e.position=e.Ha.Ta(e,t,i),e.Ib=[]},nn=(e,t,i,a,u)=>{if(0>a||0>u)throw new m(28);if(e.fd===null)throw new m(8);if((e.flags&2097155)===1)throw new m(8);if((e.node.mode&61440)===16384)throw new m(31);if(!e.Ha.read)throw new m(28);var h=typeof u<"u";if(!h)u=e.position;else if(!e.seekable)throw new m(70);return t=e.Ha.read(e,t,i,a,u),h||(e.position+=t),t},sn=(e,t,i,a,u)=>{if(0>a||0>u)throw new m(28);if(e.fd===null)throw new m(8);if(!(e.flags&2097155))throw new m(8);if((e.node.mode&61440)===16384)throw new m(31);if(!e.Ha.write)throw new m(28);e.seekable&&e.flags&1024&&rn(e,0,2);var h=typeof u<"u";if(!h)u=e.position;else if(!e.seekable)throw new m(70);return t=e.Ha.write(e,t,i,a,u,void 0),h||(e.position+=t),t},fi=e=>{var t="binary";if(t!=="utf8"&&t!=="binary")throw Error('Invalid encoding type "'+t+'"');var i,a=Ue(e,a||0);e=Ve(e).size;var u=new Uint8Array(e);return nn(a,u,0,e,0),t==="utf8"?i=Fe(u,0):t==="binary"&&(i=u),er(a),i},on=()=>{m||(m=function(e,t){this.node=t,this.Hb=function(i){this.Ka=i},this.Hb(e),this.message="FS error"},m.prototype=Error(),m.prototype.constructor=m,[44].forEach(e=>{Yt[e]=new m(e),Yt[e].stack="<generic error, no stack>"}))},an,un=(e,t)=>{var i=0;return e&&(i|=365),t&&(i|=146),i},Xe=(e,t,i)=>{e=de("/dev/"+e);var a=un(!!t,!!i);tr||(tr=64);var u=tr++<<8|0;Xt(u,{open:h=>{h.seekable=!1},close:()=>{i&&i.buffer&&i.buffer.length&&i(10)},read:(h,p,E,S)=>{for(var R=0,G=0;G<S;G++){try{var ve=t()}catch{throw new m(29)}if(ve===void 0&&R===0)throw new m(6);if(ve==null)break;R++,p[E+G]=ve}return R&&(h.node.timestamp=Date.now()),R},write:(h,p,E,S)=>{for(var R=0;R<S;R++)try{i(p[E+R])}catch{throw new m(29)}return S&&(h.node.timestamp=Date.now()),R}}),mt(e,a,u)},tr,P={},Ze,yt;function Ie(e,t,i){if(t.charAt(0)==="/")return t;if(e===-100)e="/";else{if(e=ae[e],!e)throw new m(8);e=e.path}if(t.length==0){if(!i)throw new m(44);return e}return de(e+"/"+t)}function vt(e,t,i){try{var a=e(t)}catch(u){if(u&&u.node&&de(t)!==de(Ye(u.node)))return-54;throw u}return w[i>>2]=a.dev,w[i+4>>2]=0,w[i+8>>2]=a.ino,w[i+12>>2]=a.mode,w[i+16>>2]=a.nlink,w[i+20>>2]=a.uid,w[i+24>>2]=a.gid,w[i+28>>2]=a.rdev,w[i+32>>2]=0,H=[a.size>>>0,(x=a.size,1<=+Math.abs(x)?0<x?(Math.min(+Math.floor(x/4294967296),4294967295)|0)>>>0:~~+Math.ceil((x-+(~~x>>>0))/4294967296)>>>0:0)],w[i+40>>2]=H[0],w[i+44>>2]=H[1],w[i+48>>2]=4096,w[i+52>>2]=a.blocks,H=[Math.floor(a.atime.getTime()/1e3)>>>0,(x=Math.floor(a.atime.getTime()/1e3),1<=+Math.abs(x)?0<x?(Math.min(+Math.floor(x/4294967296),4294967295)|0)>>>0:~~+Math.ceil((x-+(~~x>>>0))/4294967296)>>>0:0)],w[i+56>>2]=H[0],w[i+60>>2]=H[1],w[i+64>>2]=0,H=[Math.floor(a.mtime.getTime()/1e3)>>>0,(x=Math.floor(a.mtime.getTime()/1e3),1<=+Math.abs(x)?0<x?(Math.min(+Math.floor(x/4294967296),4294967295)|0)>>>0:~~+Math.ceil((x-+(~~x>>>0))/4294967296)>>>0:0)],w[i+72>>2]=H[0],w[i+76>>2]=H[1],w[i+80>>2]=0,H=[Math.floor(a.ctime.getTime()/1e3)>>>0,(x=Math.floor(a.ctime.getTime()/1e3),1<=+Math.abs(x)?0<x?(Math.min(+Math.floor(x/4294967296),4294967295)|0)>>>0:~~+Math.ceil((x-+(~~x>>>0))/4294967296)>>>0:0)],w[i+88>>2]=H[0],w[i+92>>2]=H[1],w[i+96>>2]=0,H=[a.ino>>>0,(x=a.ino,1<=+Math.abs(x)?0<x?(Math.min(+Math.floor(x/4294967296),4294967295)|0)>>>0:~~+Math.ceil((x-+(~~x>>>0))/4294967296)>>>0:0)],w[i+104>>2]=H[0],w[i+108>>2]=H[1],0}var _t=void 0;function bt(){return _t+=4,w[_t-4>>2]}function Ee(e){if(e=ae[e],!e)throw new m(8);return e}function rr(e){return J[e>>2]+4294967296*w[e+4>>2]}function ln(e){var t=He(e)+1,i=wt(t);return i&&je(e,z,i,t),i}function ci(e,t,i){function a(S){return(S=S.toTimeString().match(/\(([A-Za-z ]+)\)$/))?S[1]:"GMT"}var u=new Date().getFullYear(),h=new Date(u,0,1),p=new Date(u,6,1);u=h.getTimezoneOffset();var E=p.getTimezoneOffset();w[e>>2]=60*Math.max(u,E),w[t>>2]=+(u!=E),e=a(h),t=a(p),e=ln(e),t=ln(t),E<u?(J[i>>2]=e,J[i+4>>2]=t):(J[i>>2]=t,J[i+4>>2]=e)}function nr(e,t,i){nr.Bb||(nr.Bb=!0,ci(e,t,i))}var fn;fn=M?()=>{var e=B.hrtime();return 1e3*e[0]+e[1]/1e6}:()=>performance.now();var ir={};function cn(){if(!sr){var e={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:(typeof navigator=="object"&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:v||"./this.program"},t;for(t in ir)ir[t]===void 0?delete e[t]:e[t]=ir[t];var i=[];for(t in e)i.push(t+"="+e[t]);sr=i}return sr}var sr,$e=void 0,or=[];function ar(e,t){if(!$e){$e=new WeakMap;var i=be.length;if($e)for(var a=0;a<0+i;a++){var u=be.get(a);u&&$e.set(u,a)}}if($e.has(e))return $e.get(e);if(or.length)i=or.pop();else{try{be.grow(1)}catch(E){throw E instanceof RangeError?"Unable to grow wasm table. Set ALLOW_TABLE_GROWTH.":E}i=be.length-1}try{be.set(i,e)}catch(E){if(!(E instanceof TypeError))throw E;if(typeof WebAssembly.Function=="function"){a=WebAssembly.Function,u={i:"i32",j:"i64",f:"f32",d:"f64",p:"i32"};for(var h={parameters:[],results:t[0]=="v"?[]:[u[t[0]]]},p=1;p<t.length;++p)h.parameters.push(u[t[p]]);t=new a(h,e)}else{for(a=[1,96],u=t.slice(0,1),t=t.slice(1),h={i:127,p:127,j:126,f:125,d:124},p=t.length,128>p?a.push(p):a.push(p%128|128,p>>7),p=0;p<t.length;++p)a.push(h[t[p]]);u=="v"?a.push(0):a.push(1,h[u]),t=[0,97,115,109,1,0,0,0,1],u=a.length,128>u?t.push(u):t.push(u%128|128,u>>7),t.push.apply(t,a),t.push(2,7,1,1,101,1,102,0,0,7,5,1,1,102,0,0),t=new WebAssembly.Module(new Uint8Array(t)),t=new WebAssembly.Instance(t,{e:{f:e}}).exports.f}be.set(i,t)}return $e.set(e,i),i}function et(e){$e.delete(be.get(e)),or.push(e)}var hi=0,pi=1;function ur(e){var t=hi==pi?ye(e.length):wt(e.length);return e.subarray||e.slice||(e=new Uint8Array(e)),le.set(e,t),t}function mi(e,t,i,a){var u={string:R=>{var G=0;if(R!=null&&R!==0){var ve=(R.length<<2)+1;G=ye(ve),je(R,le,G,ve)}return G},array:R=>{var G=ye(R.length);return z.set(R,G),G}};e=o["_"+e];var h=[],p=0;if(a)for(var E=0;E<a.length;E++){var S=u[i[E]];S?(p===0&&(p=tt()),h[E]=S(a[E])):h[E]=a[E]}return i=e.apply(null,h),i=function(R){return p!==0&&rt(p),t==="string"?C(R):t==="boolean"?!!R:R}(i)}function hn(e,t,i,a){e||(e=this),this.parent=e,this.Ra=e.Ra,this.Va=null,this.id=oi++,this.name=t,this.mode=i,this.Ga={},this.Ha={},this.rdev=a}Object.defineProperties(hn.prototype,{read:{get:function(){return(this.mode&365)===365},set:function(e){e?this.mode|=365:this.mode&=-366}},write:{get:function(){return(this.mode&146)===146},set:function(e){e?this.mode|=146:this.mode&=-147}}}),on(),ge=Array(4096),Yr(A,"/"),fe("/tmp"),fe("/home"),fe("/home/web_user"),(()=>{fe("/dev"),Xt(259,{read:()=>0,write:(t,i,a,u)=>u}),mt("/dev/null",259),Hr(1280,ii),Hr(1536,si),mt("/dev/tty",1280),mt("/dev/tty1",1536);var e=ri();Xe("random",e),Xe("urandom",e),fe("/dev/shm"),fe("/dev/shm/tmp")})(),(()=>{fe("/proc");var e=fe("/proc/self");fe("/proc/self/fd"),Yr({Ra:()=>{var t=zr(e,"fd",16895,73);return t.Ga={lookup:(i,a)=>{var u=ae[+a];if(!u)throw new m(8);return i={parent:null,Ra:{ub:"fake"},Ga:{readlink:()=>u.path}},i.parent=i}},t}},"/proc/self/fd")})();var di={a:function(e,t,i,a){we("Assertion failed: "+C(e)+", at: "+[t?C(t):"unknown filename",i,a?C(a):"unknown function"])},h:function(e,t){try{return e=C(e),dt(e,t),0}catch(i){if(typeof P>"u"||!(i instanceof m))throw i;return-i.Ka}},H:function(e,t,i){try{if(t=C(t),t=Ie(e,t),i&-8)return-28;var a=V(t,{Sa:!0}).node;return a?(e="",i&4&&(e+="r"),i&2&&(e+="w"),i&1&&(e+="x"),e&&Ge(a,e)?-2:0):-44}catch(u){if(typeof P>"u"||!(u instanceof m))throw u;return-u.Ka}},i:function(e,t){try{var i=ae[e];if(!i)throw new m(8);return dt(i.node,t),0}catch(a){if(typeof P>"u"||!(a instanceof m))throw a;return-a.Ka}},g:function(e){try{var t=ae[e];if(!t)throw new m(8);var i=t.node,a=typeof i=="string"?V(i,{Sa:!0}).node:i;if(!a.Ga.Oa)throw new m(63);return a.Ga.Oa(a,{timestamp:Date.now()}),0}catch(u){if(typeof P>"u"||!(u instanceof m))throw u;return-u.Ka}},b:function(e,t,i){_t=i;try{var a=Ee(e);switch(t){case 0:var u=bt();return 0>u?-28:Jr(a,u).fd;case 1:case 2:return 0;case 3:return a.flags;case 4:return u=bt(),a.flags|=u,0;case 5:return u=bt(),ft[u+0>>1]=2,0;case 6:case 7:return 0;case 16:case 8:return-28;case 9:return w[pn()>>2]=28,-1;default:return-28}}catch(h){if(typeof P>"u"||!(h instanceof m))throw h;return-h.Ka}},G:function(e,t){try{var i=Ee(e);return vt(Ve,i.path,t)}catch(a){if(typeof P>"u"||!(a instanceof m))throw a;return-a.Ka}},l:function(e,t,i){try{if(t=i+2097152>>>0<4194305-!!t?(t>>>0)+4294967296*i:NaN,isNaN(t))return-61;var a=ae[e];if(!a)throw new m(8);if(!(a.flags&2097155))throw new m(28);return tn(a.node,t),0}catch(u){if(typeof P>"u"||!(u instanceof m))throw u;return-u.Ka}},B:function(e,t){try{if(t===0)return-28;var i=He("/")+1;return t<i?-68:(je("/",le,e,t),i)}catch(a){if(typeof P>"u"||!(a instanceof m))throw a;return-a.Ka}},E:function(e,t){try{return e=C(e),vt(en,e,t)}catch(i){if(typeof P>"u"||!(i instanceof m))throw i;return-i.Ka}},y:function(e,t,i){try{return t=C(t),t=Ie(e,t),t=de(t),t[t.length-1]==="/"&&(t=t.substr(0,t.length-1)),fe(t,i),0}catch(a){if(typeof P>"u"||!(a instanceof m))throw a;return-a.Ka}},D:function(e,t,i,a){try{t=C(t);var u=a&256;return t=Ie(e,t,a&4096),vt(u?en:Ve,t,i)}catch(h){if(typeof P>"u"||!(h instanceof m))throw h;return-h.Ka}},v:function(e,t,i,a){_t=a;try{t=C(t),t=Ie(e,t);var u=a?bt():0;return Ue(t,i,u).fd}catch(h){if(typeof P>"u"||!(h instanceof m))throw h;return-h.Ka}},t:function(e,t,i,a){try{if(t=C(t),t=Ie(e,t),0>=a)return-28;var u=Zr(t),h=Math.min(a,He(u)),p=z[i+h];return je(u,le,i,a+1),z[i+h]=p,h}catch(E){if(typeof P>"u"||!(E instanceof m))throw E;return-E.Ka}},s:function(e){try{return e=C(e),Vr(e),0}catch(t){if(typeof P>"u"||!(t instanceof m))throw t;return-t.Ka}},F:function(e,t){try{return e=C(e),vt(Ve,e,t)}catch(i){if(typeof P>"u"||!(i instanceof m))throw i;return-i.Ka}},p:function(e,t,i){try{return t=C(t),t=Ie(e,t),i===0?Xr(t):i===512?Vr(t):we("Invalid flags passed to unlinkat"),0}catch(a){if(typeof P>"u"||!(a instanceof m))throw a;return-a.Ka}},o:function(e,t,i){try{if(t=C(t),t=Ie(e,t,!0),i){var a=rr(i),u=w[i+8>>2];h=1e3*a+u/1e6,i+=16,a=rr(i),u=w[i+8>>2],p=1e3*a+u/1e6}else var h=Date.now(),p=h;e=h;var E=V(t,{Sa:!0}).node;return E.Ga.Oa(E,{timestamp:Math.max(e,p)}),0}catch(S){if(typeof P>"u"||!(S instanceof m))throw S;return-S.Ka}},e:function(){return Date.now()},j:function(e,t){e=new Date(1e3*rr(e)),w[t>>2]=e.getSeconds(),w[t+4>>2]=e.getMinutes(),w[t+8>>2]=e.getHours(),w[t+12>>2]=e.getDate(),w[t+16>>2]=e.getMonth(),w[t+20>>2]=e.getFullYear()-1900,w[t+24>>2]=e.getDay();var i=new Date(e.getFullYear(),0,1);w[t+28>>2]=(e.getTime()-i.getTime())/864e5|0,w[t+36>>2]=-(60*e.getTimezoneOffset());var a=new Date(e.getFullYear(),6,1).getTimezoneOffset();i=i.getTimezoneOffset(),w[t+32>>2]=(a!=i&&e.getTimezoneOffset()==Math.min(i,a))|0},w:function(e,t,i,a,u,h){try{var p=ae[a];if(!p)return-8;if(t&2&&!(i&2)&&(p.flags&2097155)!==2)throw new m(2);if((p.flags&2097155)===1)throw new m(2);if(!p.Ha.bb)throw new m(43);var E=p.Ha.bb(p,e,u,t,i),S=E.Fb;return w[h>>2]=E.vb,S}catch(R){if(typeof P>"u"||!(R instanceof m))throw R;return-R.Ka}},x:function(e,t,i,a,u,h){try{var p=ae[u];if(p&&i&2){var E=le.slice(e,e+t);p&&p.Ha.cb&&p.Ha.cb(p,E,h,t,a)}}catch(S){if(typeof P>"u"||!(S instanceof m))throw S;return-S.Ka}},n:nr,q:function(){return 2147483648},d:fn,c:function(e){var t=le.length;if(e>>>=0,2147483648<e)return!1;for(var i=1;4>=i;i*=2){var a=t*(1+.2/i);a=Math.min(a,e+100663296);var u=Math;a=Math.max(e,a),u=u.min.call(u,2147483648,a+(65536-a%65536)%65536);e:{try{Gt.grow(u-Ut.byteLength+65535>>>16),Sr();var h=1;break e}catch{}h=void 0}if(h)return!0}return!1},z:function(e,t){var i=0;return cn().forEach(function(a,u){var h=t+i;for(u=J[e+4*u>>2]=h,h=0;h<a.length;++h)z[u++>>0]=a.charCodeAt(h);z[u>>0]=0,i+=a.length+1}),0},A:function(e,t){var i=cn();J[e>>2]=i.length;var a=0;return i.forEach(function(u){a+=u.length+1}),J[t>>2]=a,0},f:function(e){try{var t=Ee(e);return er(t),0}catch(i){if(typeof P>"u"||!(i instanceof m))throw i;return i.Ka}},m:function(e,t){try{var i=Ee(e);return z[t>>0]=i.tty?2:(i.mode&61440)===16384?3:(i.mode&61440)===40960?7:4,0}catch(a){if(typeof P>"u"||!(a instanceof m))throw a;return a.Ka}},u:function(e,t,i,a){try{e:{var u=Ee(e);e=t;for(var h=t=0;h<i;h++){var p=J[e>>2],E=J[e+4>>2];e+=8;var S=nn(u,z,p,E);if(0>S){var R=-1;break e}if(t+=S,S<E)break}R=t}return w[a>>2]=R,0}catch(G){if(typeof P>"u"||!(G instanceof m))throw G;return G.Ka}},k:function(e,t,i,a,u){try{if(t=i+2097152>>>0<4194305-!!t?(t>>>0)+4294967296*i:NaN,isNaN(t))return 61;var h=Ee(e);return rn(h,t,a),H=[h.position>>>0,(x=h.position,1<=+Math.abs(x)?0<x?(Math.min(+Math.floor(x/4294967296),4294967295)|0)>>>0:~~+Math.ceil((x-+(~~x>>>0))/4294967296)>>>0:0)],w[u>>2]=H[0],w[u+4>>2]=H[1],h.hb&&t===0&&a===0&&(h.hb=null),0}catch(p){if(typeof P>"u"||!(p instanceof m))throw p;return p.Ka}},C:function(e){try{var t=Ee(e);return t.Ha&&t.Ha.fsync?-t.Ha.fsync(t):0}catch(i){if(typeof P>"u"||!(i instanceof m))throw i;return i.Ka}},r:function(e,t,i,a){try{e:{var u=Ee(e);e=t;for(var h=t=0;h<i;h++){var p=J[e>>2],E=J[e+4>>2];e+=8;var S=sn(u,z,p,E);if(0>S){var R=-1;break e}t+=S}R=t}return J[a>>2]=R,0}catch(G){if(typeof P>"u"||!(G instanceof m))throw G;return G.Ka}}};(function(){function e(u){o.asm=u.exports,Gt=o.asm.I,Sr(),be=o.asm.Aa,Nr.unshift(o.asm.J),Me--,o.monitorRunDependencies&&o.monitorRunDependencies(Me),Me==0&&(Ct!==null&&(clearInterval(Ct),Ct=null),Ke&&(u=Ke,Ke=null,u()))}function t(u){e(u.instance)}function i(u){return ei().then(function(h){return WebAssembly.instantiate(h,a)}).then(function(h){return h}).then(u,function(h){qe("failed to asynchronously prepare wasm: "+h),we(h)})}var a={a:di};if(Me++,o.monitorRunDependencies&&o.monitorRunDependencies(Me),o.instantiateWasm)try{return o.instantiateWasm(a,e)}catch(u){return qe("Module.instantiateWasm callback failed with error: "+u),!1}return function(){return Be||typeof WebAssembly.instantiateStreaming!="function"||Dr()||ne.startsWith("file://")||M||typeof fetch!="function"?i(t):fetch(ne,{credentials:"same-origin"}).then(function(u){return WebAssembly.instantiateStreaming(u,a).then(t,function(h){return qe("wasm streaming compile failed: "+h),qe("falling back to ArrayBuffer instantiation"),i(t)})})}(),{}})(),o.___wasm_call_ctors=function(){return(o.___wasm_call_ctors=o.asm.J).apply(null,arguments)},o._sqlite3_free=function(){return(o._sqlite3_free=o.asm.K).apply(null,arguments)},o._sqlite3_value_double=function(){return(o._sqlite3_value_double=o.asm.L).apply(null,arguments)},o._sqlite3_value_text=function(){return(o._sqlite3_value_text=o.asm.M).apply(null,arguments)};var pn=o.___errno_location=function(){return(pn=o.___errno_location=o.asm.N).apply(null,arguments)};o._sqlite3_prepare_v2=function(){return(o._sqlite3_prepare_v2=o.asm.O).apply(null,arguments)},o._sqlite3_step=function(){return(o._sqlite3_step=o.asm.P).apply(null,arguments)},o._sqlite3_finalize=function(){return(o._sqlite3_finalize=o.asm.Q).apply(null,arguments)},o._sqlite3_reset=function(){return(o._sqlite3_reset=o.asm.R).apply(null,arguments)},o._sqlite3_value_int=function(){return(o._sqlite3_value_int=o.asm.S).apply(null,arguments)},o._sqlite3_clear_bindings=function(){return(o._sqlite3_clear_bindings=o.asm.T).apply(null,arguments)},o._sqlite3_value_blob=function(){return(o._sqlite3_value_blob=o.asm.U).apply(null,arguments)},o._sqlite3_value_bytes=function(){return(o._sqlite3_value_bytes=o.asm.V).apply(null,arguments)},o._sqlite3_value_type=function(){return(o._sqlite3_value_type=o.asm.W).apply(null,arguments)},o._sqlite3_result_blob=function(){return(o._sqlite3_result_blob=o.asm.X).apply(null,arguments)},o._sqlite3_result_double=function(){return(o._sqlite3_result_double=o.asm.Y).apply(null,arguments)},o._sqlite3_result_error=function(){return(o._sqlite3_result_error=o.asm.Z).apply(null,arguments)},o._sqlite3_result_int=function(){return(o._sqlite3_result_int=o.asm._).apply(null,arguments)},o._sqlite3_result_int64=function(){return(o._sqlite3_result_int64=o.asm.$).apply(null,arguments)},o._sqlite3_result_null=function(){return(o._sqlite3_result_null=o.asm.aa).apply(null,arguments)},o._sqlite3_result_text=function(){return(o._sqlite3_result_text=o.asm.ba).apply(null,arguments)},o._sqlite3_sql=function(){return(o._sqlite3_sql=o.asm.ca).apply(null,arguments)},o._sqlite3_aggregate_context=function(){return(o._sqlite3_aggregate_context=o.asm.da).apply(null,arguments)},o._sqlite3_column_count=function(){return(o._sqlite3_column_count=o.asm.ea).apply(null,arguments)},o._sqlite3_data_count=function(){return(o._sqlite3_data_count=o.asm.fa).apply(null,arguments)},o._sqlite3_column_blob=function(){return(o._sqlite3_column_blob=o.asm.ga).apply(null,arguments)},o._sqlite3_column_bytes=function(){return(o._sqlite3_column_bytes=o.asm.ha).apply(null,arguments)},o._sqlite3_column_double=function(){return(o._sqlite3_column_double=o.asm.ia).apply(null,arguments)},o._sqlite3_column_text=function(){return(o._sqlite3_column_text=o.asm.ja).apply(null,arguments)},o._sqlite3_column_type=function(){return(o._sqlite3_column_type=o.asm.ka).apply(null,arguments)},o._sqlite3_column_name=function(){return(o._sqlite3_column_name=o.asm.la).apply(null,arguments)},o._sqlite3_bind_blob=function(){return(o._sqlite3_bind_blob=o.asm.ma).apply(null,arguments)},o._sqlite3_bind_double=function(){return(o._sqlite3_bind_double=o.asm.na).apply(null,arguments)},o._sqlite3_bind_int=function(){return(o._sqlite3_bind_int=o.asm.oa).apply(null,arguments)},o._sqlite3_bind_text=function(){return(o._sqlite3_bind_text=o.asm.pa).apply(null,arguments)},o._sqlite3_bind_parameter_index=function(){return(o._sqlite3_bind_parameter_index=o.asm.qa).apply(null,arguments)},o._sqlite3_normalized_sql=function(){return(o._sqlite3_normalized_sql=o.asm.ra).apply(null,arguments)},o._sqlite3_errmsg=function(){return(o._sqlite3_errmsg=o.asm.sa).apply(null,arguments)},o._sqlite3_exec=function(){return(o._sqlite3_exec=o.asm.ta).apply(null,arguments)},o._sqlite3_changes=function(){return(o._sqlite3_changes=o.asm.ua).apply(null,arguments)},o._sqlite3_close_v2=function(){return(o._sqlite3_close_v2=o.asm.va).apply(null,arguments)},o._sqlite3_create_function_v2=function(){return(o._sqlite3_create_function_v2=o.asm.wa).apply(null,arguments)},o._sqlite3_open=function(){return(o._sqlite3_open=o.asm.xa).apply(null,arguments)};var wt=o._malloc=function(){return(wt=o._malloc=o.asm.ya).apply(null,arguments)},gt=o._free=function(){return(gt=o._free=o.asm.za).apply(null,arguments)};o._RegisterExtensionFunctions=function(){return(o._RegisterExtensionFunctions=o.asm.Ba).apply(null,arguments)};var mn=o._emscripten_builtin_memalign=function(){return(mn=o._emscripten_builtin_memalign=o.asm.Ca).apply(null,arguments)},tt=o.stackSave=function(){return(tt=o.stackSave=o.asm.Da).apply(null,arguments)},rt=o.stackRestore=function(){return(rt=o.stackRestore=o.asm.Ea).apply(null,arguments)},ye=o.stackAlloc=function(){return(ye=o.stackAlloc=o.asm.Fa).apply(null,arguments)};o.UTF8ToString=C,o.stackSave=tt,o.stackRestore=rt,o.stackAlloc=ye,o.cwrap=function(e,t,i,a){i=i||[];var u=i.every(h=>h==="number");return t!=="string"&&u&&!a?o["_"+e]:function(){return mi(e,t,i,arguments)}};var Et;Ke=function e(){Et||dn(),Et||(Ke=e)};function dn(){function e(){if(!Et&&(Et=!0,o.calledRun=!0,!Rr)){if(o.noFSInit||an||(an=!0,on(),o.stdin=o.stdin,o.stdout=o.stdout,o.stderr=o.stderr,o.stdin?Xe("stdin",o.stdin):Zt("/dev/tty","/dev/stdin"),o.stdout?Xe("stdout",null,o.stdout):Zt("/dev/tty","/dev/stdout"),o.stderr?Xe("stderr",null,o.stderr):Zt("/dev/tty1","/dev/stderr"),Ue("/dev/stdin",0),Ue("/dev/stdout",1),Ue("/dev/stderr",1)),Ur=!1,Bt(Nr),o.onRuntimeInitialized&&o.onRuntimeInitialized(),o.postRun)for(typeof o.postRun=="function"&&(o.postRun=[o.postRun]);o.postRun.length;){var t=o.postRun.shift();kr.unshift(t)}Bt(kr)}}if(!(0<Me)){if(o.preRun)for(typeof o.preRun=="function"&&(o.preRun=[o.preRun]);o.preRun.length;)Zn();Bt(Tr),0<Me||(o.setStatus?(o.setStatus("Running..."),setTimeout(function(){setTimeout(function(){o.setStatus("")},1),e()},1)):e())}}if(o.preInit)for(typeof o.preInit=="function"&&(o.preInit=[o.preInit]);0<o.preInit.length;)o.preInit.pop()();return dn(),l}),It)};typeof Tt=="object"&&typeof Le=="object"?(Le.exports=St,Le.exports.default=St):typeof define=="function"&&define.amd?define([],function(){return St}):typeof Tt=="object"&&(Tt.Module=St)});import hs from"https://registry.koishi.chat/modules/reggol/index.js";var Un=Te((to,Gn)=>{U();Gn.exports=hs});var Yn=Te((io,Jn)=>{"use strict";U();var ps=Object.create,ut=Object.defineProperty,ms=Object.getOwnPropertyDescriptor,ds=Object.getOwnPropertyNames,ys=Object.getPrototypeOf,vs=Object.prototype.hasOwnProperty,pe=(r,n)=>ut(r,"name",{value:n,configurable:!0}),_s=(r,n)=>{for(var s in n)ut(r,s,{get:n[s],enumerable:!0})},Wn=(r,n,s,l)=>{if(n&&typeof n=="object"||typeof n=="function")for(let c of ds(n))!vs.call(r,c)&&c!==s&&ut(r,c,{get:()=>n[c],enumerable:!(l=ms(n,c))||l.enumerable});return r},zn=(r,n,s)=>(s=r!=null?ps(ys(r)):{},Wn(n||!r||!r.__esModule?ut(s,"default",{value:r,enumerable:!0}):s,r)),bs=r=>Wn(ut({},"__esModule",{value:!0}),r),ws=(r,n,s)=>{if(!n.has(r))throw TypeError("Cannot "+s)},Qe=(r,n,s)=>{if(n.has(r))throw TypeError("Cannot add the same private member more than once");n instanceof WeakSet?n.add(r):n.set(r,s)},D=(r,n,s)=>(ws(r,n,"access private method"),s),Cn={};_s(Cn,{SQLiteDriver:()=>jr,default:()=>$s});Jn.exports=bs(Cn);var Ae=(xe(),_e(oe)),$r=wr(),W=Pn(),Bn=(gr(),_e(Pe)),gs=zn(Hn()),Es=zn(Un()),Ce=new Es.default("sqlite");function Kn({type:r}){switch(r){case"boolean":case"integer":case"unsigned":case"date":case"time":case"timestamp":return"INTEGER";case"float":case"double":case"decimal":return"REAL";case"char":case"string":case"text":case"list":case"json":return"TEXT"}}pe(Kn,"getTypeDef");var Nt=class extends W.Builder{constructor(r){super(r),this.escapeMap={"'":"''"},this.evalOperators.$if=n=>`iif(${n.map(s=>this.parseEval(s)).join(", ")})`,this.define({types:["boolean"],dump:n=>+n,load:n=>!!n}),this.define({types:["json"],dump:n=>JSON.stringify(n),load:(n,s)=>n?JSON.parse(n):s}),this.define({types:["list"],dump:n=>Array.isArray(n)?n.join(","):n,load:n=>n?n.split(","):[]}),this.define({types:["date","time","timestamp"],dump:n=>n===null?null:+n,load:n=>n===null?null:new Date(n)})}escape(r,n){return r instanceof Date&&(r=+r),super.escape(r,n)}createElementQuery(r,n){return`(',' || ${r} || ',') LIKE ${this.escape("%,"+n+",%")}`}};pe(Nt,"SQLiteBuilder");var at,Lt,lt,Ft,kt,Or,Qt,qr,X,re,Dt,xr,Pt,Ar,jr=class extends $r.Driver{constructor(r,n){super(r),this.config=n,Qe(this,at),Qe(this,lt),Qe(this,kt),Qe(this,Qt),Qe(this,X),Qe(this,Dt),Qe(this,Pt),this.sql=new Nt}async prepare(r,n){let s=D(this,kt,Or).call(this,`PRAGMA table_info(${(0,W.escapeId)(r)})`),l=this.model(r),c=[],o=[],y=[],v={},I=!1;for(let O in l.fields){if(l.fields[O].deprecated){n?.includes(O)&&(I=!0);continue}let M=[O,...l.fields[O].legacy||[]],b=s.find(({name:K})=>M.includes(K)),{initial:k,nullable:Y=!0}=l.fields[O],Q=Kn(l.fields[O]),F=`${(0,W.escapeId)(O)} ${Q}`;O===l.primary&&l.autoInc?F+=" NOT NULL PRIMARY KEY AUTOINCREMENT":(F+=(Y?" ":" NOT ")+"NULL",(0,Ae.isNullable)(k)||(F+=" DEFAULT "+this.sql.escape(this.sql.dump(l,{[O]:k})[O]))),c.push(F),b?(v[b.name]=O,I||(I=b.name!==O||b.type!==Q)):y.push("ADD "+F)}if(l.primary&&!l.autoInc&&o.push(`PRIMARY KEY (${D(this,at,Lt).call(this,(0,Ae.makeArray)(l.primary))})`),l.unique&&o.push(...l.unique.map(O=>`UNIQUE (${D(this,at,Lt).call(this,(0,Ae.makeArray)(O))})`)),l.foreign&&o.push(...Object.entries(l.foreign).map(([O,M])=>{let[b,k]=M;return`FOREIGN KEY (\`${O}\`) REFERENCES ${(0,W.escapeId)(b)} (\`${k}\`)`})),!s.length)Ce.info("auto creating table %c",r),D(this,X,re).call(this,`CREATE TABLE ${(0,W.escapeId)(r)} (${[...c,...o].join(", ")})`);else if(I){for(let{name:b,type:k,notnull:Y,pk:Q,dflt_value:F}of s){if(v[b]||n?.includes(b))continue;let K=`${(0,W.escapeId)(b)} ${k}`;K+=(Y?" NOT ":" ")+"NULL",Q&&(K+=" PRIMARY KEY"),F!==null&&(K+=" DEFAULT "+this.sql.escape(F)),c.push(K),v[b]=b}let O=r+"_temp",M=Object.keys(v).map(W.escapeId).join(", ");Ce.info("auto migrating table %c",r),D(this,X,re).call(this,`CREATE TABLE ${(0,W.escapeId)(O)} (${[...c,...o].join(", ")})`);try{D(this,X,re).call(this,`INSERT INTO ${(0,W.escapeId)(O)} SELECT ${M} FROM ${(0,W.escapeId)(r)}`),D(this,X,re).call(this,`DROP TABLE ${(0,W.escapeId)(r)}`)}catch(b){throw D(this,X,re).call(this,`DROP TABLE ${(0,W.escapeId)(O)}`),b}D(this,X,re).call(this,`ALTER TABLE ${(0,W.escapeId)(O)} RENAME TO ${(0,W.escapeId)(r)}`)}else if(y.length){Ce.info("auto updating table %c",r);for(let O of y)D(this,X,re).call(this,`ALTER TABLE ${(0,W.escapeId)(r)} ${O}`)}n||(n=[],this.migrate(r,{error:Ce.warn,before:O=>O.every(M=>s.some(({name:b})=>b===M)),after:O=>n.push(...O),finalize:()=>{n.length&&this.prepare(r,n)}}))}init(r){this.db=new this.sqlite.Database(r),this.db.create_function("regexp",(n,s)=>+new RegExp(n).test(s))}async load(){return this.config.path===":memory:"?null:Bn.promises.readFile(this.config.path).catch(()=>null)}async start(){let[r,n]=await Promise.all([(0,gs.default)({locateFile:s=>"https://registry.koishi.chat/modules/@koishijs/plugin-database-sqlite/"+s}),this.load()]);this.sqlite=r,this.init(n)}async stop(){var r;(r=this.db)==null||r.close()}async drop(r){if(r)return D(this,X,re).call(this,`DROP TABLE ${(0,W.escapeId)(r)}`);let n=Object.keys(this.database.tables);for(let s of n)D(this,X,re).call(this,`DROP TABLE ${(0,W.escapeId)(s)}`)}async stats(){let r=this.db.export();return this.init(r),{size:r.byteLength}}async remove(r){let{query:n,table:s}=r,l=this.sql.parseQuery(n);l!=="0"&&D(this,X,re).call(this,`DELETE FROM ${(0,W.escapeId)(s)} WHERE ${l}`)}async get(r){let{model:n,tables:s}=r,l=new Nt(s),c=l.get(r);return c?D(this,kt,Or).call(this,c).map(y=>l.load(n,y)):[]}async eval(r,n){let s=new Nt(r.tables),l=s.parseEval(n),c=s.get(r.table,!0),{value:o}=D(this,Qt,qr).call(this,`SELECT ${l} AS value FROM ${c} ${r.ref}`);return o}async set(r,n){let{model:s,table:l,query:c}=r,{primary:o,fields:y}=s,v=[...new Set(Object.keys(n).map(M=>Object.keys(y).find(b=>b===M||M.startsWith(b+"."))))],I=(0,Ae.makeArray)(o),O=await this.database.get(l,c,(0,Ae.union)(I,v));for(let M of O)D(this,Dt,xr).call(this,r,I,v,n,M)}async create(r,n){let{model:s,table:l}=r;n=s.create(n);let{id:c}=D(this,Pt,Ar).call(this,l,n),{autoInc:o,primary:y}=s;return!o||Array.isArray(y)?n:{...n,[y]:c}}async upsert(r,n,s){if(!n.length)return;let{model:l,table:c,ref:o}=r,y=[...new Set(Object.keys(Object.assign({},...n)).map(M=>Object.keys(l.fields).find(b=>b===M||M.startsWith(b+"."))))],v=(0,Ae.union)(s,y),I=(0,Ae.difference)(y,s),O=await this.database.get(c,{$or:n.map(M=>Object.fromEntries(s.map(b=>[b,M[b]])))},v);for(let M of n){let b=O.find(k=>s.every(Y=>(0,Ae.deepEqual)(k[Y],M[Y],!0)));b?D(this,Dt,xr).call(this,r,s,I,M,b):D(this,Pt,Ar).call(this,c,(0,$r.executeUpdate)(l.create(),M,o))}}};pe(jr,"SQLiteDriver");at=new WeakSet;Lt=pe(function(r){return r?.length?r.map(n=>`\`${n}\``).join(", "):"*"},"#joinKeys");lt=new WeakSet;Ft=pe(function(r,n,s){try{let l=this.db.prepare(r),c=s(l);return l.free(),Ce.debug("> %s",r),c}catch(l){throw Ce.warn("> %s",r),l}},"#exec");kt=new WeakSet;Or=pe(function(r,n=[]){return D(this,lt,Ft).call(this,r,n,s=>{s.bind(n);let l=[];for(;s.step();)l.push(s.getAsObject());return l})},"#all");Qt=new WeakSet;qr=pe(function(r,n=[]){return D(this,lt,Ft).call(this,r,n,s=>s.getAsObject(n))},"#get");X=new WeakSet;re=pe(function(r,n=[],s){D(this,lt,Ft).call(this,r,n,c=>c.run(n));let l=s?.();if(this.config.path){let c=this.db.export(),o=this.writeTask=setTimeout(()=>{this.writeTask===o&&Bn.promises.writeFile(this.config.path,c)},0);this.init(c)}return l},"#run");Dt=new WeakSet;xr=pe(function(r,n,s,l,c){let{ref:o,table:y}=r,v=this.model(y),I=this.sql.dump(v,(0,$r.executeUpdate)(c,l,o)),O=s.map(k=>`${(0,W.escapeId)(k)} = ${this.sql.escape(I[k])}`).join(","),M=Object.fromEntries(n.map(k=>[k,I[k]])),b=this.sql.parseQuery(M);D(this,X,re).call(this,`UPDATE ${(0,W.escapeId)(y)} SET ${O} WHERE ${b}`)},"#update");Pt=new WeakSet;Ar=pe(function(r,n){let s=this.model(r);n=this.sql.dump(s,n);let l=Object.keys(n),c=`INSERT INTO ${(0,W.escapeId)(r)} (${D(this,at,Lt).call(this,l)}) VALUES (${l.map(o=>this.sql.escape(n[o])).join(", ")})`;return D(this,X,re).call(this,c,[],()=>D(this,Qt,qr).call(this,"SELECT last_insert_rowid() AS id"))},"#create");var $s=jr});U();var Xn=Ji(Yn(),1);import{defineDriver as Os,Schema as Vn}from"https://registry.koishi.chat/modules/koishi/index.js";import xs from"https://registry.koishi.chat/modules/path-browserify/index.js";var co=Os(Xn.SQLiteDriver,Vn.object({path:Vn.string().description("数据库路径").default(".koishi.db")}),(r,n)=>{n.path!==":memory:"&&(n.path=xs.resolve(r.baseDir,n.path))});export{co as default};
