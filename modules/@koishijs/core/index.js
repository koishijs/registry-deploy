import{Buffer as pe}from"https://registry.koishi.chat/modules/buffer/index.js";import me from"https://registry.koishi.chat/modules/process/index.js";var _t="4.12.0";export*from"https://registry.koishi.chat/modules/@koishijs/utils/index.js";import{makeArray as Be,valueMap as vt}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{defineProperty as $t,isNullable as ye}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{clone as Ct,isNullable as Ke,makeArray as Ve}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{defineProperty as ge,valueMap as Ot}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{isNullable as xe}from"https://registry.koishi.chat/modules/cosmokit/index.js";var xt=Object.defineProperty,S=(e,t)=>xt(e,"name",{value:t,configurable:!0});function ve(e){return typeof e=="string"||typeof e=="number"||typeof e=="boolean"||e instanceof Date}S(ve,"isComparable");var Qe="abcdefghijklmnopqrstuvwxyz";function Ge(){return Array(8).fill(0).map(()=>Qe[Math.floor(Math.random()*Qe.length)]).join("")}S(Ge,"randomId");function $e(e){return e instanceof RegExp?e:new RegExp(e)}S($e,"makeRegExp");function ce(e){return e&&Object.keys(e).some(t=>t.startsWith("$"))}S(ce,"isEvalExpr");var kt=Symbol("expr"),bi=Symbol("type"),_=S((e,t)=>$t({["$"+e]:t},kt,!0),"Eval"),K={};K.$=le;function V(e,t){return K[`$${e}`]=t,i=>_(e,i)}S(V,"unary");function D(e,t){return K[`$${e}`]=t,(...i)=>_(e,i)}S(D,"multary");function X(e,t){return K[`$${e}`]=(i,n)=>{let r=$(n,i[0]),s=$(n,i[1]);return ye(r)||ye(s)?!0:t(r.valueOf(),s.valueOf())},(...i)=>_(e,i)}S(X,"comparator");_.switch=(e,t)=>_("switch",{branches:e,default:t});K.$switch=(e,t)=>{for(let i of e.branches)if($(t,i.case))return $(t,i.then);return $(t,e.default)};_.if=D("if",([e,t,i],n)=>$(n,e)?$(n,t):$(n,i));_.ifNull=D("ifNull",([e,t],i)=>$(i,e)??$(i,t));_.add=D("add",(e,t)=>e.reduce((i,n)=>i+$(t,n),0));_.multiply=D("multiply",(e,t)=>e.reduce((i,n)=>i*$(t,n),1));_.subtract=D("subtract",([e,t],i)=>$(i,e)-$(i,t));_.divide=D("divide",([e,t],i)=>$(i,e)/$(i,t));_.eq=X("eq",(e,t)=>e===t);_.ne=X("ne",(e,t)=>e!==t);_.gt=X("gt",(e,t)=>e>t);_.gte=X("gte",(e,t)=>e>=t);_.lt=X("lt",(e,t)=>e<t);_.lte=X("lte",(e,t)=>e<=t);_.in=D("in",([e,t],i)=>t.includes($(i,e)));_.nin=D("nin",([e,t],i)=>!t.includes($(i,e)));_.concat=D("concat",(e,t)=>e.map(i=>$(t,i)).join(""));_.regex=D("regex",([e,t],i)=>$e($(i,t)).test($(i,e)));_.and=D("and",(e,t)=>e.every(i=>$(t,i)));_.or=D("or",(e,t)=>e.some(i=>$(t,i)));_.not=V("not",(e,t)=>!$(t,e));_.sum=V("sum",(e,t)=>t.reduce((i,n)=>i+Y(e,n),0));_.avg=V("avg",(e,t)=>t.reduce((i,n)=>i+Y(e,n),0)/t.length);_.max=V("max",(e,t)=>Math.max(...t.map(i=>Y(e,i))));_.min=V("min",(e,t)=>Math.min(...t.map(i=>Y(e,i))));_.count=V("count",(e,t)=>new Set(t.map(i=>Y(e,i))).size);function le(e,t){if(typeof e=="string")return le(["_",e],t);let[i,n]=e,r=t[i];if(!r)return r;if(n in r)return r[n];let s=Object.keys(r).find(a=>n.startsWith(a+"."))||n.split(".",1)[0],o=n.slice(s.length+1).split(".").filter(Boolean);o.unshift(s);for(let a of o)if(r=r[a],!r)return r;return r}S(le,"getRecursive");function ke(e,t){for(let i in e)if(i in K)return K[i](e[i],t);return e}S(ke,"executeEvalExpr");function Y(e,t){return typeof e=="string"?le(e,t):ke(e,t)}S(Y,"executeAggr");function $(e,t){return ve(t)||ye(t)?t:ke(t,e)}S($,"executeEval");function Et(e,t,i){for(let n in t){let r=e,s=n.split("."),o=s.pop();for(let a of s)r=r[a]||={};r[o]=$({[i]:e,_:e},t[n])}return e}S(Et,"executeUpdate");var be;(e=>{e.number=["integer","unsigned","float","double","decimal"],e.string=["char","string","text"],e.boolean=["boolean"],e.date=["timestamp","date","time"],e.object=["list","json"];let t=/^(\w+)(?:\((.+)\))?$/;function i(n){if(typeof n=="function")return{type:"expr",expr:n};if(typeof n!="string")return{initial:null,...n};let r=t.exec(n);if(!r)throw new TypeError("invalid field definition");let s=r[1],o=(r[2]||"").split(","),a={type:s};return a.initial===void 0&&(e.number.includes(a.type)&&(a.initial=0),e.string.includes(a.type)&&(a.initial=""),a.type==="list"&&(a.initial=[]),a.type==="json"&&(a.initial={})),s==="decimal"?(a.precision=+o[0],a.scale=+o[1]):o[0]&&(a.length=+o[0]),a}e.parse=i,S(i,"parse")})(be||(be={}));var ae=class{constructor(e){this.name=e,this.autoInc=!1,this.primary="id",this.unique=[],this.foreign={}}fields={};migrations=new Map;extend(e={},t={}){let{primary:i,autoInc:n,unique:r=[],foreign:s,callback:o}=t;this.primary=i||this.primary,this.autoInc=n||this.autoInc,this.unique.push(...r),Object.assign(this.foreign,s),o&&this.migrations.set(o,Object.keys(e));for(let a in e)this.fields[a]=be.parse(e[a]),this.fields[a].deprecated=!!o;this.checkIndex(this.primary),this.unique.forEach(a=>this.checkIndex(a))}checkIndex(e){for(let t of Ve(e))if(!this.fields[t])throw new TypeError(`missing field definition for index key "${t}"`)}resolveValue(e,t){if(Ke(t))return t;if(this.fields[e]?.type==="time"){let i=new Date(0);return i.setHours(t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()),i}return t}format(e,t=!0,i="",n={}){let r=Object.keys(this.fields);return Object.entries(e).map(([s,o])=>{if(s=i+s,r.includes(s))n[s]=o;else if(!o||typeof o!="object"||ce(o)){if(r.find(u=>s.startsWith(u+".")))n[s]=o;else if(t)throw new TypeError(`unknown field "${s}" in model ${this.name}`)}else this.format(o,t,s+".",n)}),n}parse(e){let t={};for(let i in e){let n=t,r=i.split(".").reverse(),s="";for(let o=r.length-1;o>0;o--){let a=r[o];s+=a+".",n=n[a]??={}}if(i in e){let o=this.resolveValue(i,e[i]);n[r[0]]=o}}return t}create(e){let t={},i=Ve(this.primary);for(let n in this.fields){let{initial:r,deprecated:s}=this.fields[n];s||!i.includes(n)&&!Ke(r)&&(t[n]=Ct(r))}return this.parse({...t,...e})}};S(ae,"Model");var we=S((e,t={},i="")=>new Proxy(t,{get(n,r){return typeof r=="symbol"||r in n||r.startsWith("$")?Reflect.get(n,r):we(e,_("",[e,`${i}${r}`]),`${i}${r}.`)}}),"createRow"),_e=class{row;model;driver;constructor(e,t){Object.assign(this,t);let i={};if(typeof t.table!="string"&&!(t.table instanceof W))for(let n in t.table)i[n]=we(n);ge(this,"driver",e),ge(this,"row",we(this.ref,i)),ge(this,"model",e.model(this.table))}resolveQuery(e={}){if(typeof e=="function")return{$expr:e(this.row)};if(Array.isArray(e)||e instanceof RegExp||["string","number"].includes(typeof e)){let{primary:t}=this.model;if(Array.isArray(t))throw new TypeError("invalid shorthand for composite primary key");return{[t]:e}}return e}resolveField(e){if(typeof e=="string")return this.row[e];if(typeof e=="function")return e(this.row);throw new TypeError("invalid field definition")}resolveFields(e){if(typeof e=="string"&&(e=[e]),Array.isArray(e)){let t=Object.keys(this.model.fields),i=e.flatMap(n=>this.model.fields[n]?n:t.filter(r=>r.startsWith(n+".")));return Object.fromEntries(i.map(n=>[n,this.row[n]]))}else return Ot(e,t=>this.resolveField(t))}async execute(){return await this.driver.database.prepared(),this.driver[this.type](this,...this.args)}};S(_e,"Executable");var W=class extends _e{tables={};constructor(e,t,i){super(e,{type:"get",ref:Ge(),table:t,query:null,args:[{sort:[],limit:1/0,offset:0,group:[],having:_.and(),optional:{}}]}),this.tables[this.ref]=this.model,this.query=this.resolveQuery(i),typeof t!="string"&&Object.assign(this.tables,t.tables)}where(e){return this.query.$and||=[],this.query.$and.push(this.resolveQuery(e)),this}limit(...e){return e.length>1&&this.offset(e.shift()),this.args[0].limit=e[0],this}offset(e){return this.args[0].offset=e,this}orderBy(e,t="asc"){return this.args[0].sort.push([this.resolveField(e),t]),this}groupBy(e,...t){this.args[0].fields=this.resolveFields(e),this.args[0].group=Object.keys(this.args[0].fields);let i=typeof t[0]=="function"?void 0:t.shift();return Object.assign(this.args[0].fields,this.resolveFields(i||{})),t[0]&&this.having(t[0]),new W(this.driver,this)}having(e){return this.args[0].having.$and.push(this.resolveField(e)),this}project(e){return this.args[0].fields=this.resolveFields(e),new W(this.driver,this)}_action(e,...t){return new _e(this.driver,{...this,type:e,args:t})}evaluate(e){return new W(this.driver,this)._action("eval",this.resolveField(e))}execute(e){if(typeof e=="function")return this.evaluate(e).execute();if(Array.isArray(e)?e={fields:e}:e||(e={}),e.fields&&this.project(e.fields),e.limit!==void 0&&this.limit(e.limit),e.offset!==void 0&&this.offset(e.offset),e.sort)for(let t in e.sort)this.orderBy(t,e.sort[t]);return super.execute()}};S(W,"Selection");function St(e,t,i){let{limit:n,offset:r,sort:s}=t;return e.sort((o,a)=>{for(let[u,d]of s){let y=d==="asc"?1:-1,x=$({[i]:o,_:o},u),C=$({[i]:a,_:a},u);if(x<C)return-y;if(x>C)return y}return 0}),e.slice(r,r+n)}S(St,"executeSort");var ue=class{tables=Object.create(null);drivers=Object.create(null);migrating=!1;prepareTasks=Object.create(null);migrateTasks=Object.create(null);stashed=new Set;refresh(){for(let e in this.tables)this.prepareTasks[e]=this.prepare(e)}async prepared(){await Promise.all(Object.values(this.prepareTasks)),this.migrating||await Promise.all(Object.values(this.migrateTasks))}getDriver(e){let t=Object.values(this.drivers)[0];return t&&(t.database=this),t}async prepare(e){this.stashed.add(e),await this.prepareTasks[e],await Promise.resolve(),this.stashed.delete(e)&&await this.getDriver(e)?.prepare(e)}extend(e,t,i={}){let n=this.tables[e];n||(n=this.tables[e]=new ae(e)),n.extend(t,i),this.prepareTasks[e]=this.prepare(e)}migrate(e,t,i){this.extend(e,t,{callback:i})}select(e,t){return new W(this.getDriver(e),e,t)}join(e,t,i){if(Array.isArray(e)){let n=new W(this.getDriver(e[0]),Object.fromEntries(e.map(r=>[r,r])));return typeof t=="function"&&(n.args[0].having=_.and(t(...e.map(r=>n.row[r])))),n.args[0].optional=Object.fromEntries(e.map((r,s)=>[r,i?.[s]])),n}else{let n=new W(this.getDriver(e[0]),e);return typeof t=="function"&&(n.args[0].having=_.and(t(n.row))),n.args[0].optional=i,n}}async get(e,t,i){return this.select(e,t).execute(i)}async eval(e,t,i){return this.select(e,i).execute(typeof t=="function"?t:()=>t)}async set(e,t,i){let n=this.select(e,t);if(typeof i=="function"&&(i=i(n.row)),Be(n.model.primary).some(s=>s in i))throw new TypeError("cannot modify primary key");await n._action("set",n.model.format(i)).execute()}async remove(e,t){await this.select(e,t)._action("remove").execute()}async create(e,t){let i=this.select(e);return i._action("create",i.model.create(t)).execute()}async upsert(e,t,i){let n=this.select(e);typeof t=="function"&&(t=t(n.row)),t=t.map(r=>n.model.format(r)),i=Be(i||n.model.primary),await n._action("upsert",t,i).execute()}async stopAll(){let e=Object.values(this.drivers);this.drivers=Object.create(null),await Promise.all(e.map(t=>t.stop()))}async drop(e){await this.getDriver(e).drop(e)}async dropAll(){await Promise.all(Object.values(this.drivers).map(e=>e.drop()))}async stats(){let e={size:0,tables:{}};return await Promise.all(Object.values(this.drivers).map(async t=>{let{size:i=0,tables:n}=await t.stats();e.size+=i,Object.assign(e.tables,n)})),e}};S(ue,"Database");var jt=class{constructor(e){this.database=e}model(e){if(typeof e=="string"){let i=this.database.tables[e];if(i)return i;throw new TypeError(`unknown table name "${e}"`)}if(e instanceof W){if(!e.args[0].fields)return e.model;let i=new ae("temp");return i.fields=vt(e.args[0].fields,(n,r)=>({type:"expr"})),i}let t=new ae("temp");for(let i in e){let n=this.model(e[i]);for(let r in n.fields)t.fields[`${i}.${r}`]={type:"expr",expr:{$:[i,r]}}}return t}async migrate(e,t){let i=Object.create(this.database),n=this.model(e);i.migrating=!0,this.database.migrating&&await i.migrateTasks[e],i.migrateTasks[e]=Promise.resolve(i.migrateTasks[e]).then(()=>Promise.all([...n.migrations].map(async([r,s])=>{try{if(!t.before(s))return;await r(i),t.after(s)}catch(o){t.error(o)}}))).then(t.finalize).catch(t.error)}};S(jt,"Driver");var Je=class extends Error{constructor(e,t){super(t||e.replace("-"," ")),this.code=e}name="RuntimeError";static check(e,t){return e instanceof Je?!t||e.message===t:!1}};S(Je,"RuntimeError");var Xe={$or:(e,t)=>e.reduce((i,n)=>i||J(n,t),!1),$and:(e,t)=>e.reduce((i,n)=>i&&J(n,t),!0),$not:(e,t)=>!J(e,t),$exists:(e,t)=>e!==xe(t),$eq:(e,t)=>t.valueOf()===e.valueOf(),$ne:(e,t)=>t.valueOf()!==e.valueOf(),$gt:(e,t)=>t.valueOf()>e.valueOf(),$gte:(e,t)=>t.valueOf()>=e.valueOf(),$lt:(e,t)=>t.valueOf()<e.valueOf(),$lte:(e,t)=>t.valueOf()<=e.valueOf(),$in:(e,t)=>e.includes(t),$nin:(e,t)=>!e.includes(t),$regex:(e,t)=>$e(e).test(t),$regexFor:(e,t)=>new RegExp(t,"i").test(e),$bitsAllSet:(e,t)=>(e&t)===e,$bitsAllClear:(e,t)=>(e&t)===0,$bitsAnySet:(e,t)=>(e&t)!==0,$bitsAnyClear:(e,t)=>(e&t)!==e,$el:(e,t)=>t.some(i=>J(e,i)),$size:(e,t)=>t.length===e};function J(e,t){if(Array.isArray(e))return e.includes(t);if(e instanceof RegExp)return e.test(t);if(ve(e))return t.valueOf()===e.valueOf();if(xe(e))return xe(t);for(let i in e)if(i in Xe&&!Xe[i](e[i],t))return!1;return!0}S(J,"executeFieldQuery");function oe(e,t,i){return Object.entries(t).every(([r,s])=>{if(r==="$and")return s.reduce((o,a)=>o&&oe(e,a,i),!0);if(r==="$or")return s.reduce((o,a)=>o||oe(e,a,i),!1);if(r==="$not")return!oe(e,s,i);if(r==="$expr")return $({[i]:e,_:e},s);try{return J(s,e[r])}catch{return!1}})}S(oe,"executeQuery");export*from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import{sleep as Mt}from"https://registry.koishi.chat/modules/@koishijs/utils/index.js";import{defineProperty as Pt}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{Bot as Re}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import{defineProperty as Ne,Time as Ee}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{Context as G,Schema as j}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import*as ht from"https://registry.koishi.chat/modules/cordis/index.js";import{resolveConfig as Ri}from"https://registry.koishi.chat/modules/cordis/index.js";import{defineProperty as Ft}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{Context as We}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import{defineProperty as Dt}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{Context as ze,Schema as ie}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import{Random as qt}from"https://registry.koishi.chat/modules/@koishijs/utils/index.js";var L=new Uint32Array(65536),At=(e,t)=>{let i=e.length,n=t.length,r=1<<i-1,s=-1,o=0,a=i,u=i;for(;u--;)L[e.charCodeAt(u)]|=1<<u;for(u=0;u<n;u++){let d=L[t.charCodeAt(u)],y=d|o;d|=(d&s)+s^s,o|=~(d|s),s&=d,o&r&&a++,s&r&&a--,o=o<<1|1,s=s<<1|~(y|o),o&=y}for(u=i;u--;)L[e.charCodeAt(u)]=0;return a},It=(e,t)=>{let i=t.length,n=e.length,r=[],s=[],o=Math.ceil(i/32),a=Math.ceil(n/32);for(let m=0;m<o;m++)s[m]=-1,r[m]=0;let u=0;for(;u<a-1;u++){let m=0,w=-1,z=u*32,q=Math.min(32,n)+z;for(let l=z;l<q;l++)L[e.charCodeAt(l)]|=1<<l;for(let l=0;l<i;l++){let c=L[t.charCodeAt(l)],h=s[l/32|0]>>>l&1,f=r[l/32|0]>>>l&1,p=c|m,k=((c|f)&w)+w^w|c|f,g=m|~(k|w),v=w&k;g>>>31^h&&(s[l/32|0]^=1<<l),v>>>31^f&&(r[l/32|0]^=1<<l),g=g<<1|h,v=v<<1|f,w=v|~(p|g),m=g&p}for(let l=z;l<q;l++)L[e.charCodeAt(l)]=0}let d=0,y=-1,x=u*32,C=Math.min(32,n-x)+x;for(let m=x;m<C;m++)L[e.charCodeAt(m)]|=1<<m;let O=n;for(let m=0;m<i;m++){let w=L[t.charCodeAt(m)],z=s[m/32|0]>>>m&1,q=r[m/32|0]>>>m&1,l=w|d,c=((w|q)&y)+y^y|w|q,h=d|~(c|y),f=y&c;O+=h>>>n-1&1,O-=f>>>n-1&1,h>>>31^z&&(s[m/32|0]^=1<<m),f>>>31^q&&(r[m/32|0]^=1<<m),h=h<<1|z,f=f<<1|q,y=f|~(l|h),d=h&l}for(let m=x;m<C;m++)L[e.charCodeAt(m)]=0;return O},Ye=(e,t)=>{if(e.length<t.length){let i=t;t=e,e=i}return t.length===0?e.length:e.length<=32?At(e,t):It(e,t)};import{isNullable as Rt}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{Context as ft,h as Nt,Logger as Wt}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import{remove as Kt}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{Context as Vt}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import{extend as Xt}from"https://registry.koishi.chat/modules/@koishijs/utils/index.js";import{coerce as Gt,makeArray as Jt,Random as Yt}from"https://registry.koishi.chat/modules/@koishijs/utils/index.js";import{defineProperty as et,Time as Ce}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{Context as Fe,h as Oe}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import{remove as Zt}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{Context as pt,Schema as ei}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import{extend as ti,observe as Se}from"https://registry.koishi.chat/modules/@koishijs/utils/index.js";import{defineProperty as Z,isNullable as it,makeArray as ii}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{Context as ni,h as nt,Logger as ri,Session as gt}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import{defineProperty as rt}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{Context as fe,h as si,Schema as je}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import{camelize as oi,isNullable as st,remove as ee}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{coerce as ai}from"https://registry.koishi.chat/modules/@koishijs/utils/index.js";import{Context as ci,Logger as li,Schema as H}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";import{camelCase as ot,paramCase as at,Time as ui}from"https://registry.koishi.chat/modules/cosmokit/index.js";import{escapeRegExp as ct}from"https://registry.koishi.chat/modules/@koishijs/utils/index.js";import{h as te}from"https://registry.koishi.chat/modules/@satorijs/core/index.js";var ut=Object.defineProperty,Tt=(e,t,i)=>t in e?ut(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,b=(e,t)=>ut(e,"name",{value:t,configurable:!0}),B=(e,t,i)=>(Tt(e,typeof t!="symbol"?t+"":t,i),i);Pt(Re,"filter",!1);Re.prototype.getGuildMemberMap=b(async function(t){let i=await this.getGuildMemberList(t);return Object.fromEntries(i.map(n=>[n.userId,n.nickname||n.username]))},"getGuildMemberMap");Re.prototype.broadcast=b(async function(t,i,n=this.ctx.root.config.delay.broadcast){let r=[];for(let s=0;s<t.length;s++){s&&n&&await Mt(n);try{let o=t[s];r.push(...typeof o=="string"?await this.sendMessage(o,i):Array.isArray(o)?await this.sendMessage(o[0],i,o[1]):await this.sendMessage(o.channelId,i,o.guildId,{session:o}))}catch(o){this.ctx.logger("bot").warn(o)}}return r},"broadcast");var Ni=ht.Service;Ne(G.Config,"Basic",j.object({locale:j.string().default("zh").description("默认使用的语言。"),prefix:j.union([j.array(String).role("table"),j.transform(String,e=>[e]),j.any().hidden()]).role("computed").default([""]).description("指令前缀字符构成的数组。将被用于指令的匹配。"),nickname:j.union([j.array(String).role("table"),j.transform(String,e=>[e])]).description("机器人昵称构成的数组。将被用于指令的匹配。"),autoAssign:j.union([Boolean,Function]).default(!0).description("当获取不到频道数据时，是否使用接受者作为代理者。"),autoAuthorize:j.union([j.natural(),Function]).default(1).description("当获取不到用户数据时默认使用的权限等级。"),minSimilarity:j.percent().default(1).description("用于模糊匹配的相似系数，应该是一个 0 到 1 之间的数值。数值越高，模糊匹配越严格。设置为 1 可以完全禁用模糊匹配。")}).description("基础设置"));Ne(G.Config,"Message",j.object({delay:j.object({character:j.natural().role("ms").default(0).description("调用 `session.sendQueued()` 时消息间发送的最小延迟，按前一条消息的字数计算。"),message:j.natural().role("ms").default(.1*Ee.second).description("调用 `session.sendQueued()` 时消息间发送的最小延迟，按固定值计算。"),cancel:j.natural().role("ms").default(0).description("调用 `session.cancelQueued()` 时默认的延迟。"),broadcast:j.natural().role("ms").default(.5*Ee.second).description("调用 `bot.broadcast()` 时默认的延迟。"),prompt:j.natural().role("ms").default(Ee.minute).description("调用 `session.prompt()` 时默认的等待时间。")})}).description("消息设置"));Ne(G.Config,"Advanced",j.object({maxListeners:j.natural().default(64).description("每种监听器的最大数量。如果超过这个数量，Koishi 会认定为发生了内存泄漏，将产生一个警告。")}).description("高级设置"));G.Config.list.push(G.Config.Basic,G.Config.Message,G.Config.Advanced);function zt(e){return e}b(zt,"defineConfig");var Me;(e=>{let t;(i=>{i[i.ignore=1]="ignore"})(t=e.Flag||(e.Flag={})),e.fields=[]})(Me||(Me={}));var Pe;(e=>{let t;(i=>{i[i.ignore=1]="ignore",i[i.silent=4]="silent"})(t=e.Flag||(e.Flag={})),e.fields=[]})(Pe||(Pe={}));var de=class extends ue{constructor(e){super(),this.app=e,Ft(this,We.current,e),this.extend("user",{id:"unsigned(20)",name:{type:"string",length:63},flag:"unsigned(20)",authority:"unsigned(4)",locale:"string(63)"},{autoInc:!0}),this.extend("binding",{aid:"unsigned(20)",bid:"unsigned(20)",pid:"string(63)",platform:"string(63)"},{primary:["pid","platform"]}),this.extend("channel",{id:"string(63)",platform:"string(63)",flag:"unsigned(20)",assignee:"string(63)",guildId:"string(63)",locale:"string(63)"},{primary:["id","platform"]}),e.on("bot-added",({platform:t})=>{t in this.tables.user.fields||this.migrate("user",{[t]:"string(63)"},async i=>{let n=await i.get("user",{[t]:{$exists:!0}},["id",t]);await i.upsert("binding",n.map(r=>({aid:r.id,bid:r.id,pid:r[t],platform:t})))})})}async getUser(e,t,i){let[n]=await this.get("binding",{platform:e,pid:t},["aid"]);if(!n)return;let[r]=await this.get("user",{id:n.aid},i);return r}async setUser(e,t,i){let[n]=await this.get("binding",{platform:e,pid:t},["aid"]);if(n)return this.set("user",n.aid,i)}async createUser(e,t,i){let n=await this.create("user",i);return await this.create("binding",{aid:n.id,bid:n.id,pid:t,platform:e}),n}async getChannel(e,t,i){let n=await this.get("channel",{platform:e,id:t},i);return Array.isArray(t)?n:(n[0]&&Object.assign(n[0],{platform:e,id:t}),n[0])}getSelfIds(e,t){if(e)return t||=this.app.bots.filter(n=>n.platform===e).map(n=>n.selfId),{[e]:t};let i={};for(let n of this.app.bots)(i[n.platform]||=[]).push(n.selfId);return i}async getAssignedChannels(e,t=this.getSelfIds()){return this.get("channel",{$or:Object.entries(t).map(([i,n])=>({platform:i,assignee:n}))},e)}setChannel(e,t,i){return this.set("channel",{platform:e,id:t},i)}createChannel(e,t,i){return this.create("channel",{platform:e,id:t,...i})}async broadcast(...e){let t;Array.isArray(e[0])&&(t=e.shift());let[i,n]=e;if(!i)return[];let r=await this.getAssignedChannels(["id","assignee","flag","platform","guildId","locale"]),s={};for(let o of r){let{platform:a,id:u,assignee:d,flag:y}=o;t&&!t.includes(`${a}:${u}`)||!n&&y&4||((s[a]||={})[d]||=[]).push(o)}return(await Promise.all(this.app.bots.map(o=>{let a=s[o.platform]?.[o.selfId];if(!a)return Promise.resolve([]);let u=a.map(({id:d,guildId:y,locale:x})=>o.session({type:"message",subtype:"group",channelId:d,guildId:y,locale:x}));return o.broadcast(u,i)}))).flat(1)}};b(de,"DatabaseService");B(de,"methods",["getSelfIds","broadcast"]);de.prototype.extend=b(function(t,i,n){ue.prototype.extend.call(this,t,i,{...n}),this.app.emit("model",t)},"extend");We.service("database");We.service("model",de);var Ui=b((e,t,i)=>({name:e.name,reusable:!0,Config:t,filter:!1,apply(n,r){r={...r},i?.(n,r);let s=new e(n.model,r),o=n.mapping.database||"default";n.on("ready",async()=>{await s.start(),n.model.drivers[o]=s,n.model.refresh();let a=Object.create(n.model);n.database=a}),n.on("dispose",async()=>{n.database=null,delete n.model.drivers[o],await s.stop()})}}),"defineDriver");ie.filter=b(function(){return ie.any().role("filter")},"filter");ie.computed=b(function(t,i={}){return ie.union([t,ie.any().hidden()]).role("computed",i)},"computed");function Q(e,t,...i){return e.intersect(n=>i.length?i.includes(n[t]):!!n[t])}b(Q,"property");var Le=class{constructor(e){this.app=e,Dt(this,ze.current,e),e.filter=()=>!0,e.on("internal/runtime",t=>{t.uid&&(t.ctx.filter=i=>t.children.some(n=>n.ctx.filter(i)))})}get caller(){return this[ze.current]}any(){return this.caller.extend({filter:()=>!0})}never(){return this.caller.extend({filter:()=>!1})}union(e){let t=this.caller,i=typeof e=="function"?e:e.filter;return this.caller.extend({filter:n=>t.filter(n)||i(n)})}intersect(e){let t=this.caller,i=typeof e=="function"?e:e.filter;return this.caller.extend({filter:n=>t.filter(n)&&i(n)})}exclude(e){let t=this.caller,i=typeof e=="function"?e:e.filter;return this.caller.extend({filter:n=>t.filter(n)&&!i(n)})}user(...e){return Q(this.caller,"userId",...e)}self(...e){return Q(this.caller,"selfId",...e)}guild(...e){return Q(this.caller,"guildId",...e)}channel(...e){return Q(this.caller,"channelId",...e)}platform(...e){return Q(this.caller,"platform",...e)}private(...e){return Q(this.caller.exclude(Q(this.caller,"guildId")),"userId",...e)}};b(Le,"FilterService");B(Le,"methods",["any","never","union","intersect","exclude","user","self","guild","channel","platform","private"]);ze.service("$filter",Le);var Lt={general:{$:"通用设置",name:"中文",paren:"（{0}）",quote:"“{0}”",comma:"，",and:"和",or:"或",day:"天",hour:"小时",minute:"分钟",second:"秒"},internal:{$:"核心文本","error-encountered":"发生未知错误。","low-authority":"权限不足。","insufficient-arguments":"缺少参数，输入帮助以查看用法。","redunant-arguments":"存在多余参数，输入帮助以查看用法。","invalid-argument":"参数 {0} 输入无效，{1}","unknown-option":"存在未知选项 {0}，输入帮助以查看用法。","invalid-option":"选项 {0} 输入无效，{1}","check-syntax":"输入帮助以查看用法。","invalid-number":"请提供一个数字。","invalid-integer":"请提供一个整数。","invalid-posint":"请提供一个正整数。","invalid-natural":"请提供一个非负整数。","invalid-date":"请输入合法的时间。","invalid-user":"请指定正确的用户。","invalid-channel":"请指定正确的频道。","suggest-hint":"您要找的是不是{0}？","suggest-command":"发送句号以使用推测的指令。"},commands:{$:"指令系统"}},Ht={general:{name:"English",paren:" ({0}) ",quote:'"{0}"',comma:", ",and:"and",or:"or",day:"day",hour:"hour",minute:"minute",second:"second"},internal:{"error-encountered":"An unknown error has occurred.","low-authority":"Low authority.","insufficient-arguments":"Insufficient arguments, type help to see usage.","redunant-arguments":"Redunant arguments, type help to see usage.","invalid-argument":"Invalid argument {0}, {1}","unknown-option":"Unknown option {0}, type help to see usage.","invalid-option":"Invalid option {0}, {1}","check-syntax":"Type help to see usage.","invalid-number":"Expect a number.","invalid-integer":"Expect an integer.","invalid-posint":"Expect a positive integer.","invalid-natural":"Expect a non-negative integer.","invalid-date":"Expect a valid date.","invalid-user":"Expect a valid user.","invalid-channel":"Expect a valid channel.","suggest-hint":"Do you mean {0}?","suggest-command":"Send a period to apply the suggestion."}},Ut={general:{name:"日本語",paren:"（{0}）",quote:"「{0}」",comma:"、",and:"と",or:"や",day:"日",hour:"時間",minute:"分",second:"秒"},internal:{"error-encountered":"不明なエラーが発生しました。","low-authority":"実行できる権限が付与されていません","insufficient-arguments":"パラメータが不足しています、「help」を送信して使い方を確認してください。","redunant-arguments":"パラメータ数が多すぎます、「help」を送信して使い方を確認してください。","invalid-argument":"無効なパラメータ「{0}」、{1}","unknown-option":"未知なオプション「{0}」、「help」を送信して使い方を確認してください。","invalid-option":"無効なオプション「{0}」、{1}","check-syntax":"「help」を送信して使い方を検索してください。","invalid-number":"数字を指定してください。","invalid-integer":"整数を指定してください。","invalid-posint":"正の整数を指定してください。","invalid-natural":"自然数を指定してください。","invalid-date":"日付を指定してください。","invalid-user":"ユーザー名を指定してください。","invalid-channel":"チャンネル名を指定してください。","suggest-hint":"「{0}」を実行したいですか？","suggest-command":"句点を送信してコマンドを実行します。"}},Bt={general:{name:"francais",paren:" ({0}) ",quote:'"{0}"',comma:", ",and:"et",or:"ou",day:"jour",hour:"heure",minute:"minute",second:"seconde"},internal:{"error-encountered":"Une erreur inconnue s'est produite.","low-authority":"Droits insuffisants.","insufficient-arguments":`Arguments insuffisants, tapez "help" pour afficher l'aide`,"redunant-arguments":`Arguments redondants, tapez "help" pour afficher l'aide`,"invalid-argument":"Arguments {0} invalides, {1}","unknown-option":`Option {0} inconnue, tapez "help" pour afficher l'aide`,"invalid-option":"Option {0} invalide, {1}","check-syntax":`Tapez "help" pour afficher l'aide`,"invalid-number":"Entrez un nombre.","invalid-integer":"Entrez un entier.","invalid-posint":"Entrez un entier positif.","invalid-natural":"Entrez un entier non négatif.","invalid-date":"Entrez une date valide.","invalid-user":"Entrez un nom d'utilisateur valide.","invalid-channel":"Entrez un nom de canal valide.","suggest-hint":"Voulez-vous dire {0} ?","suggest-command":"Tapez un point pour appliquer la suggestion."}},Qt={general:{name:"中文",paren:"（{0}）",quote:"「{0}」",comma:"，",and:"和",or:"或",day:"天",hour:"小時",minute:"分鐘",second:"秒"},internal:{"error-encountered":"出現未知錯誤。","low-authority":"權限不足。","insufficient-arguments":"參數個數不足，輸入「help」檢視用法。","redunant-arguments":"參數個數冗餘，輸入「help」檢視用法。","invalid-argument":"參數 {0} 無效，{1}","unknown-option":"存在未知選項 {0}，輸入「help」檢視用法。","invalid-option":"選項 {0} 無效，{1}","check-syntax":"輸入「help」檢視用法。","invalid-number":"請輸入有效數字。","invalid-integer":"請輸入有效整數。","invalid-posint":"請輸入有效正整數。","invalid-natural":"請輸入有效非負整數。","invalid-date":"請輸入有效時間。","invalid-user":"請指定有效用戶。","invalid-channel":"請指定有效頻道。","suggest-hint":"你想輸入的是{0}嗎？","suggest-command":"發送句號可使用推測的指令。"}},he=new Wt("i18n"),Ze=Symbol("template"),dt=class{constructor(e){this.ctx=e,this.define("",{"":""}),this.define("zh",Lt),this.define("en",Ht),this.define("ja",Ut),this.define("fr",Bt),this.define("zh-TW",Qt),this.registerBuiltins()}_data={};_presets={};compare(e,t,i={}){let n=1-Ye(e,t)/e.length,r=i.minSimilarity??this.ctx.root.config.minSimilarity;return n>=r?n:0}*set(e,t,i){if(t.includes("@")||typeof i=="string"){let n=this._data[e],[r,s]=t.slice(0,-1).split("@");s&&(i[Ze]=s,he.warn("preset is deprecated and will be removed in the future")),!Rt(n[r])&&!e.startsWith("$")&&n[r]!==i&&he.warn("override",e,r),n[r]=i,yield r}else for(let n in i)yield*this.set(e,t+n+".",i[n])}define(e,...t){let i=this._data[e]||={},n=[...typeof t[0]=="string"?this.set(e,t[0]+".",t[1]):this.set(e,"",t[0])];this.ctx.emit("internal/i18n"),this[ft.current]?.on("dispose",()=>{for(let r of n)delete i[r];this.ctx.emit("internal/i18n")})}formatter(e,t){he.warn("formatter is deprecated and will be removed in the future")}preset(e,t){this._presets[e]=t}find(e,t,i={}){if(!t)return[];let n=[];e=e.replace(/\(([^)]+)\)/g,(o,a)=>(n.push(a),"([^.]+)"));let r=new RegExp(`^${e}$`),s=[];for(let o in this._data)for(let a in this._data[o]){let u=r.exec(a);if(!u)continue;let d=this._data[o][a];if(typeof d!="string")continue;let y=this.compare(d,t,i);if(!y)continue;let x={};for(let C=0;C<n.length;C++)x[n[C]]=u[C+1];s.push({locale:o,data:x,similarity:y})}return s}render(e,t,i){if(e!==void 0){if(typeof e!="string"){let n=e[Ze],r=this._presets[n];if(!r)throw new Error(`Preset "${n}" not found`);return r(e,t,i)}return Nt.parse(e,t).join("")}}text(e,t,i){let n=new Set;for(let r of e)r&&n.add(r);for(let r in this._data)r.startsWith("$")||n.add(r);for(let r of t)for(let s of n)for(let o of["$"+s,s]){let a=this._data[o]?.[r];if(a!==void 0)return this.render(a,i,s)}return he.warn("missing",t[0]),t[0]}registerBuiltins(){this.preset("plural",(e,t,i)=>{let n=t.length in e?t.length:e.length-1;return this.render(e[n],t,i)}),this.preset("random",(e,t,i)=>this.render(qt.pick(e),t,i)),this.preset("list",(e,t,i)=>{let n=Object.entries(t).map(([r,s])=>this.render(e.item,{key:r,value:s},i));return n.unshift(this.render(e.header,t,i)),n.push(this.render(e.footer,t,i)),n.join(`
`).trim()})}};b(dt,"I18n");ft.service("i18n",dt);Xt(Vt.prototype,{get app(){return this.root},get options(){return this.root.config},async waterfall(...e){let t=typeof e[0]=="object"?e.shift():null,i=e.shift();for(let n of this.lifecycle.getHooks(i,t)){let r=await n.apply(t,e);e[0]=r}return e[0]},chain(...e){let t=typeof e[0]=="object"?e.shift():null,i=e.shift();for(let n of this.lifecycle.getHooks(i,t)){let r=n.apply(t,e);e[0]=r}return e[0]},before(e,t,i=!1){let n=e.split("/");return n[n.length-1]="before-"+n[n.length-1],this.on(n.join("/"),t,!i)},createTimerDispose(e){let t=b(()=>{if(clearTimeout(e),!!this.state)return Kt(this.state.disposables,t)},"dispose");return this.state.disposables.push(t),t},setTimeout(e,t,...i){let n=this.createTimerDispose(setTimeout(()=>{n(),e()},t,...i));return n},setInterval(e,t,...i){return this.createTimerDispose(setInterval(e,t,...i))}});var He=class extends Error{constructor(e,t){super(Jt(e)[0]),this.path=e,this.param=t}};b(He,"SessionError");var U;(e=>{e.MAX_DEPTH=64;async function t(i,n){return typeof i=="function"?i(n):i}e.compose=t,b(t,"compose")})(U||(U={}));var Ue=class{constructor(e,t){this.ctx=e,this.config=t,et(this,Fe.current,e),this.middleware(this._process.bind(this),!0),e.on("message",this._handleMessage.bind(this)),e.before("attach-user",(n,r)=>{n.collect("user",n.argv,r)}),e.before("attach-channel",(n,r)=>{n.collect("channel",n.argv,r)}),e.component("execute",async(n,r,s)=>s.execute(r.join(""),!0),{session:!0}),e.component("prompt",async(n,r,s)=>(await s.send(r),s.prompt()),{session:!0}),e.component("i18n",async(n,r,s)=>s.text(n.path,r),{session:!0}),e.component("random",async(n,r)=>Yt.pick(r)),e.component("plural",async(n,r)=>{let s=n.count in r?n.count:r.length-1;return r[s]});let i=["day","hour","minute","second"];e.component("i18n:time",(n,r,s)=>{let o=+n.value;for(let a=0;a<3;a++){let u=Ce[i[a]],d=Ce[i[a+1]];if(o>=u-d/2){o+=d/2;let y=Math.floor(o/u)+" "+s.text("general."+i[a]);return o%u>d&&(y+=` ${Math.floor(o%u/d)} `+s.text("general."+i[a+1])),y}}return Math.round(o/Ce.second)+" "+s.text("general.second")},{session:!0}),e.before("attach",n=>{for(let r of this._matchers)if(this._executeMatcher(n,r),n.response)return})}_hooks=[];_sessions=Object.create(null);_userCache=new De;_channelCache=new De;_matchers=new Set;get caller(){return this[Fe.current]}middleware(e,t=!1){return this.caller.lifecycle.register("middleware",this._hooks,e,t)}match(e,t,i){let n={...i,context:this.caller,pattern:e,response:t};return this._matchers.add(n),this.caller.collect("shortcut",()=>this._matchers.delete(n))}_executeMatcher(e,t){let{parsed:i,quote:n}=e,{appel:r,context:s,i18n:o,regex:a,fuzzy:u,pattern:d,response:y}=t;if((r||i.hasMention)&&!i.appel||!s.filter(e))return;let x=i.content;n&&(x+=" "+n.content);let C=null,O=b(m=>{if(m)if(typeof m=="string"){if(!u&&x!==m||!x.startsWith(m))return;C=[x,x.slice(m.length)],u&&!i.appel&&C[1].match(/^\S/)&&(C=null)}else C=m.exec(x)},"match");if(!o)O(d);else for(let m in this.ctx.i18n._data){let z=this.ctx.i18n._data[m][d];if(z){if(a){let q=u?`(?:${i.appel?"":"\\s+"}([\\s\\S]*))?`:"";z=new RegExp(`^(?:${z})${q}$`)}if(O(z),!!C){e.locale=m;break}}}C&&(e.response=async()=>{let m=await e.resolve(y,C);return Oe.normalize(m,C.map(w=>w?Oe.parse(w):""))})}_stripNickname(e,t){t.startsWith("@")&&(t=t.slice(1));for(let i of e.resolve(this.config.nickname)??[]){if(!t.startsWith(i))continue;let n=t.slice(i.length),r=/^([,，]\s*|\s+)/.exec(n);if(r)return n.slice(r[0].length)}}async _process(e,t){let i=!1,n=!1,r=e.content.trim();e.elements??=Oe.parse(r);let s=!1,o=e.elements.slice();for(;o[0]?.type==="at";){let{attrs:a}=o.shift();a.id===e.selfId&&(i=n=!0),(!e.quote||e.quote.userId!==a.id)&&(s=!0),r=o.join("").trimStart(),o[0]?.type==="text"&&!o[0].attrs.content.trim()&&o.shift()}if(!s){let a=this._stripNickname(e,r);a&&(n=!0,r=a)}if(et(e,"parsed",{hasMention:s,content:r,appel:n,prefix:null}),this.ctx.emit(e,"before-attach",e),this.ctx.database){if(e.subtype==="group"){let d=new Set(["flag","assignee","guildId","locale"]);this.ctx.emit("before-attach-channel",e,d);let y=await e.observeChannel(d);if(y.guildId=e.guildId,await this.ctx.serial(e,"attach-channel",e)||y.flag&Pe.Flag.ignore||y.assignee!==e.selfId&&!i)return}let a=new Set(["flag","authority","locale"]);this.ctx.emit("before-attach-user",e,a);let u=await e.observeUser(a);if(await this.ctx.serial(e,"attach-user",e)||u.flag&Me.Flag.ignore)return}return this.ctx.emit(e,"attach",e),e.response?e.response():t()}async _handleMessage(e){if(e.selfId===e.userId)return;this._sessions[e.id]=e;let t=this._hooks.filter(([r])=>r.filter(e)).map(([,r])=>r.bind(null,e)),i=0,n=b(async r=>{try{if(!this._sessions[e.id])throw new Error("isolated next function detected");if(r!==void 0&&(t.push(s=>U.compose(r,s)),t.length>U.MAX_DEPTH))throw new Error(`middleware stack exceeded ${U.MAX_DEPTH}`);return await t[i++]?.(n)}catch(s){if(s instanceof He)return e.text(s.path,s.param);let o=Gt(s);this.ctx.logger("session").warn(`${e.content}
${o}`)}},"next");try{let r=await n();r&&await e.send(r)}finally{delete this._sessions[e.id],this._userCache.delete(e.id),this._channelCache.delete(e.id),await e.user?.$update(),await e.channel?.$update(),await e.guild?.$update(),this.ctx.emit(e,"middleware",e)}}};b(Ue,"Processor");B(Ue,"methods",["middleware","match"]);Fe.service("$internal",Ue);var De=class{#e=Object.create(null);get(e,t){let i=this.#e[t];if(i)return i.refs.add(e),i.value}set(e,t,i){let n=this.#e[t];n?n.value=i:n=this.#e[t]={value:i,key:t,refs:new Set},n.refs.add(e)}delete(e){for(let t in this.#e){let{refs:i}=this.#e[t];i.delete(e),i.size||delete this.#e[t]}}};b(De,"SharedCache");var tt=Symbol("schema-order"),mt=class{constructor(e){this.ctx=e}_data=Object.create(null);extend(e,t,i=0){let n=this.get(e),r=n.list.findIndex(s=>s[tt]<i);t[tt]=i,r>=0?n.list.splice(r,0,t):n.list.push(t),this.ctx.emit("internal/schema",e),this[pt.current]?.on("dispose",()=>{Zt(n.list,t),this.ctx.emit("internal/schema",e)})}get(e){return this._data[e]||=ei.intersect([])}};b(mt,"SchemaService");pt.service("schema",mt);var Ae=`"'“‘`,Ie=`"'”’`,ne;(e=>{let t={};function i(l,c,h){t[l]={terminator:c,parse:h}}e.interpolate=i,b(i,"interpolate"),i("$(",")");let n;(l=>{l.unescape=b(c=>c.replace(/@__KOISHI_SPACE__@/g," ").replace(/@__KOISHI_NEWLINE__@/g,`
`).replace(/@__KOISHI_RETURN__@/g,"\r").replace(/@__KOISHI_TAB__@/g,"	"),"unescape"),l.escape=b(c=>c.replace(/ /g,"@__KOISHI_SPACE__@").replace(/\n/g,"@__KOISHI_NEWLINE__@").replace(/\r/g,"@__KOISHI_RETURN__@").replace(/\t/g,"@__KOISHI_TAB__@"),"escape")})(n=e.whitespace||(e.whitespace={}));class r{bracs;constructor(){this.bracs=Object.create(t)}interpolate(c,h,f){this.bracs[c]={terminator:h,parse:f}}parseToken(c,h="$"){let f={inters:[]},p=Ae.indexOf(c[0]),k=Ie[p],g="";k&&(c=c.slice(1),h=`${k}(?=${h})|$`),h+=`|${Object.keys({...this.bracs,...t}).map(ct).join("|")}`;let v=new RegExp(h);for(;;){let A=v.exec(c);if(g+=n.unescape(c.slice(0,A.index)),A[0]in this.bracs){c=c.slice(A.index+A[0].length).trimStart();let{parse:I,terminator:T}=this.bracs[A[0]],F=I?.(c)||this.parse(c,T);c=F.rest,f.inters.push({...F,pos:g.length,initiator:A[0]})}else{let I=A[0]===k,T=c.slice(A.index+ +I);return f.rest=T.trimStart(),f.quoted=I,f.terminator=A[0],I?f.terminator+=T.slice(0,-f.rest.length):k&&(g=Ae[p]+g,f.inters.forEach(F=>F.pos+=1)),f.content=g,k==="'"&&e.revert(f),f}}}parse(c,h=""){let f=[];c=te.parse(c).map(v=>v.type==="text"?v.toString():n.escape(v.toString())).join("");let p=c,k="",g=`\\s+|[${ct(h)}]|$`;for(;p&&!(h&&p.startsWith(h));){let v=this.parseToken(p,g);f.push(v),p=v.rest,k=v.terminator,delete v.rest}return p.startsWith(h)&&(p=p.slice(1)),c=c.slice(0,-(p+k).length),p=n.unescape(p),c=n.unescape(c),{tokens:f,rest:p,source:c}}stringify(c){let h=c.tokens.reduce((f,p)=>(p.quoted&&(f+=Ae[Ie.indexOf(p.terminator[0])]||""),f+p.content+p.terminator),"");return c.rest&&!Ie.includes(h[h.length-1])||c.initiator?h.slice(0,-1):h}}b(r,"Tokenizer"),e.Tokenizer=r;let s=new r;function o(l,c=""){return s.parse(l,c)}e.parse=o,b(o,"parse");function a(l){return s.stringify(l)}e.stringify=a,b(a,"stringify");function u(l){for(;l.inters.length;){let{pos:c,source:h,initiator:f}=l.inters.pop();l.content=l.content.slice(0,c)+f+h+t[f].terminator+l.content.slice(c)}}e.revert=u,b(u,"revert");function d(l){return typeof l=="string"?C[l]||{}:{}}b(d,"resolveConfig");let y=Array.isArray;function x(l){return typeof l=="function"?l:l instanceof RegExp?c=>{if(l.test(c))return c;throw new Error}:y(l)?c=>{if(l.includes(c))return c;throw new Error}:C[l]?.transform}b(x,"resolveType");let C={};function O(l,c,h){C[l]={...h,transform:c}}e.createDomain=O,b(O,"createDomain"),O("string",l=>l),O("text",l=>l,{greedy:!0}),O("rawtext",l=>te("",te.parse(l)).toString(!0),{greedy:!0}),O("boolean",()=>!0),O("number",(l,c)=>{let h=+l;if(Number.isFinite(h))return h;throw new Error("internal.invalid-number")}),O("integer",(l,c)=>{let h=+l;if(h*0===0&&Math.floor(h)===h)return h;throw new Error("internal.invalid-integer")}),O("posint",(l,c)=>{let h=+l;if(h*0===0&&Math.floor(h)===h&&h>0)return h;throw new Error("internal.invalid-posint")}),O("natural",(l,c)=>{let h=+l;if(h*0===0&&Math.floor(h)===h&&h>=0)return h;throw new Error("internal.invalid-natural")}),O("date",(l,c)=>{let h=ui.parseDate(l);if(+h)return h;throw new Error("internal.invalid-date")}),O("user",(l,c)=>{if(l.startsWith("@"))return l=l.slice(1),l.includes(":")?l:`${c.platform}:${l}`;let h=te.from(l);if(h&&h.type==="at")return`${c.platform}:${h.data.id}`;throw new Error("internal.invalid-user")}),O("channel",(l,c)=>{if(l.startsWith("#"))return l=l.slice(1),l.includes(":")?l:`${c.platform}:${l}`;let h=te.from(l);if(h&&h.type==="sharp")return`${c.platform}:${h.data.id}`;throw new Error("internal.invalid-channel")});let m=/<[^>]+>|\[[^\]]+\]/g;function w(l){let c,h=[];for(;c=m.exec(l);){let f=c[0].slice(1,-1),p=!1;f.startsWith("...")&&(f=f.slice(3),p=!0);let[k,g]=f.split(":"),v=g?g.trim():void 0;h.push({name:k,variadic:p,type:v,required:c[0][0]==="<"})}return h.stripped=l.replace(/:[\w-]+(?=[>\]])/g,f=>C[f.slice(1)]?.greedy?"...":"").trimEnd(),h}b(w,"parseDecl");function z(l,c,h,f,p={}){let{name:k,type:g}=p,v=x(g);if(v)try{return v(l,f.session)}catch(I){if(!f.session)f.error=`internal.invalid-${h}`;else{let T=f.session.text(I.message||"internal.check-syntax");f.error=f.session.text(`internal.invalid-${h}`,[k,T])}return}if(l===""&&!c)return!0;if(c)return l;let A=+l;return A*0===0?A:l}e.parseValue=z,b(z,"parseValue");class q{constructor(c,h,f){if(this.name=c,this.ctx=f,!c)throw new Error("expect a command name");let p=this._arguments=w(h);this.declaration=p.stripped}declaration;_arguments;_options={};_namedOptions={};_symbolicOptions={};_createOption(c,h,f){let p=/^((?:-[\w-]*|[^,\s\w\x80-\uffff]+)(?:,\s*(?:-[\w-]*|[^,\s\w\x80-\uffff]+))*(?=\s|$))?((?:\s*\[[^\]]+?\]|\s*<[^>]+?>)*)(.*)$/.exec(h),k=at(c),g=p[1]||"--"+k,v=p[2]||"",A=p[3].trim(),I=f.aliases??[],T=f.symbols??[];for(let N of g.trim().split(",")){N=N.trimStart();let se=N.replace(/^-+/,"");!se||!N.startsWith("-")?T.push(te.escape(N)):I.push(se)}!("value"in f)&&!I.includes(k)&&(g+=", --"+k);let F=w(v.trimStart());F.stripped&&(g+=" "+F.stripped);let E=this._options[c]||={...R.defaultOptionConfig,...F[0],...f,name:c,values:{},valuesSyntax:{},variants:{},syntax:g},M=`commands.${this.name}.options.${c}`,P=typeof E.fallback;"value"in f?(M+="."+f.value,E.variants[f.value]={...f,syntax:g},E.valuesSyntax[f.value]=g,I.forEach(N=>E.values[N]=f.value)):v.trim()?!E.type&&(P==="string"||P==="number")&&(E.type=P):E.type="boolean",A&&this.ctx.i18n.define("",M,A),this._assignOption(E,I,this._namedOptions),this._assignOption(E,T,this._symbolicOptions),this._namedOptions[k]||(this._namedOptions[k]=E)}_assignOption(c,h,f){for(let p of h){if(p in f)throw new Error(`duplicate option name "${p}" for command "${this.name}"`);f[p]=c}}removeOption(c){if(!this._options[c])return!1;let h=this._options[c];delete this._options[c];for(let f in this._namedOptions)this._namedOptions[f]===h&&delete this._namedOptions[f];for(let f in this._symbolicOptions)this._symbolicOptions[f]===h&&delete this._symbolicOptions[f];return!0}parse(c,h,f=[],p={}){for(typeof c=="string"&&(c=e.parse(c,h)),!c.source&&c.tokens&&(c.source=this.name+" "+e.stringify(c));!c.error&&c.tokens?.length;){let k=c.tokens[0],{content:g,quoted:v}=k,A=this._arguments[f.length];if(g[0]!=="-"&&d(A?.type).greedy){f.push(e.parseValue(e.stringify(c),!0,"argument",c,A));break}c.tokens.shift();let I,T,F;if(!v&&(I=this._symbolicOptions[g]))T=[at(I.name)];else{if(g[0]!=="-"||v){f.push(e.parseValue(g,v,"argument",c,A||{type:"string"}));continue}let E=0,M;for(;E<g.length&&g.charCodeAt(E)===45;++E);if(g.slice(E,E+3)==="no-"&&!this._namedOptions[g.slice(E)]){M=g.slice(E+3),p[ot(M)]=!1;continue}let P=E+1;for(;P<g.length&&g.charCodeAt(P)!==61;P++);M=g.slice(E,P),T=E>1?[M]:M,F=g.slice(++P),I=this._namedOptions[T[T.length-1]]}if(v=!1,!F){let{type:E}=I||{};if(d(E).greedy)F=e.stringify(c),v=!0,c.tokens=[];else if(E!=="boolean"&&c.tokens.length&&(E||c.tokens[0]?.content!=="-")){let M=c.tokens.shift();F=M.content,v=M.quoted}}for(let E=0;E<T.length;E++){let M=T[E],P=this._namedOptions[M],N=P?P.name:ot(M);if(P&&M in P.values)p[N]=P.values[M];else{let se=E+1<T.length?"":F;p[N]=e.parseValue(se,v,"option",c,P)}if(c.error)break}}for(let{name:k,fallback:g}of Object.values(this._options))g!==void 0&&!(k in p)&&(p[k]=g);return delete c.tokens,{...c,options:p,args:f,error:c.error||"",command:this}}stringifyArg(c){return c=""+c,c.includes(" ")?`"${c}"`:c}stringify(c,h){let f=this.name;for(let p in h){let k=h[p];k===!0?f+=` --${p}`:k===!1?f+=` --no-${p}`:f+=` --${p} ${this.stringifyArg(k)}`}for(let p of c)f+=" "+this.stringifyArg(p);return f}}b(q,"CommandBase"),e.CommandBase=q})(ne||(ne={}));var Te=new li("command"),yt=class extends ne.CommandBase{config;children=[];parent=null;_aliases=[];_examples=[];_usage;_disposed;_disposables=[];_userFields=[["locale"]];_channelFields=[["locale"]];_actions=[];_checkers=[async e=>this.ctx.serial(e.session,"command/before-execute",e)];static userFields(e){return this._userFields.push(e),this}static channelFields(e){return this._channelFields.push(e),this}constructor(e,t,i){super(e,t,i),this.config={...yt.defaultConfig},this._registerAlias(e),i.$commander._commandList.push(this)}get caller(){return this[ci.current]||this.ctx}get displayName(){return this._aliases[0]}set displayName(e){this._registerAlias(e,!0)}_registerAlias(e,t=!1){if(e=e.toLowerCase(),e.startsWith(".")&&(e=this.parent.name+e),this._aliases.includes(e)){t&&(ee(this._aliases,e),this._aliases.unshift(e));return}else t?this._aliases.unshift(e):this._aliases.push(e);let n=this.ctx.$commander.get(e);if(!n)this.ctx.$commander.set(e,this);else if(n!==this)throw new Error(`duplicate command names: "${e}"`);let r=this.caller.collect("command.alias",()=>(ee(this._aliases,e),this.ctx.$commander.delete(e)));this._disposables.push(r)}[Symbol.for("nodejs.util.inspect.custom")](){return`Command <${this.name}>`}userFields(e){return this._userFields.push(e),this}channelFields(e){return this._channelFields.push(e),this}alias(...e){if(this._disposed)return this;for(let t of e)this._registerAlias(t);return this}_escape(e){return typeof e!="string"?e:e.replace(/\$\$/g,"@@__PLACEHOLDER__@@").replace(/\$\d/g,t=>`{${t[1]}}`).replace(/@@__PLACEHOLDER__@@/g,"$")}shortcut(e,t={}){if(this._disposed)return this;let i=this.displayName;for(let s in t.options||{}){i+=` --${oi(s)}`;let o=t.options[s];o!==!0&&(i+=" "+this._escape(o))}for(let s of t.args||[])i+=" "+this._escape(s);t.fuzzy&&(i+=" {1}");let n=t.i18n;if(typeof e=="string")if(t.i18n)e=`commands.${this.name}.shortcuts.${e}`;else{t.i18n=!0;let s=`commands.${this.name}.shortcuts._${Math.random().toString(36).slice(2)}`;this.ctx.i18n.define("",s,e),e=s}let r=this.ctx.match(e,`<execute>${i}</execute>`,{appel:t.prefix,fuzzy:t.fuzzy,i18n:t.i18n,regex:n});return this._disposables.push(r),this}subcommand(e,...t){e=this.name+(e.charCodeAt(0)===46?"":"/")+e;let i=typeof t[0]=="string"?t.shift():"",n=t[0]||{};return this._disposed&&(n.patch=!0),this.ctx.command(e,i,n)}usage(e){return this._usage=e,this}example(e){return this._examples.push(e),this}option(e,...t){let i="";typeof t[0]=="string"&&(i=t.shift());let n=t[0];return this._createOption(e,i,n||{}),this.caller.collect("command.option",()=>this.removeOption(e)),this}match(e){let{authority:t=1/0}=e.user||{};return this.ctx.filter(e)&&e.resolve(this.config.authority)<=t}getConfig(e,t){let i=this.config[e];return typeof i=="function"?i(t):i}check(e,t=!1){return this.before(e,t)}before(e,t=!1){return t?this._checkers.push(e):this._checkers.unshift(e),this.caller.scope.disposables?.push(()=>ee(this._checkers,e)),this}action(e,t=!1){return t?this._actions.unshift(e):this._actions.push(e),this.caller.scope.disposables?.push(()=>ee(this._actions,e)),this}use(e,...t){return e(this,...t)}async execute(e,t=U.compose){e.command??=this,e.args??=[],e.options??={};let{args:i,options:n,error:r}=e;if(r)return r;Te.level>=3&&Te.debug(e.source||=this.stringify(i,n));for(let u of this._checkers){let d=await u.call(this,e,...i);if(typeof d=="string")return d}if(!this._actions.length)return"";let s=0,o=this._actions.map(u=>async()=>await u.call(this,e,...i));o.push(t);let a=o.length;e.next=async u=>{if(u!==void 0&&(o.push(d=>U.compose(u,d)),o.length>U.MAX_DEPTH))throw new Error(`middleware stack exceeded ${U.MAX_DEPTH}`);return o[s++]?.(e.next)};try{let u=await e.next();if(!st(u))return u}catch(u){if(s===a)throw u;if(u instanceof He)return e.session.text(u.path,u.param);let d=ai(u);if(Te.warn(`${e.source||=this.stringify(i,n)}
${d}`),this.ctx.emit(e.session,"command-error",e,u),typeof this.config.handleError=="function"){let y=await this.config.handleError(u,e);if(!st(y))return y}else if(this.config.handleError)return e.session.text("internal.error-encountered")}return""}dispose(){this._disposed=!0,this._disposables.splice(0).forEach(e=>e()),this.ctx.emit("command-removed",this);for(let e of this.children.slice())e.dispose();ee(this.ctx.$commander._commandList,this),this.parent&&ee(this.parent.children,this)}},R=yt;b(R,"Command");B(R,"defaultConfig",{authority:1,showWarning:!0,handleError:!0});B(R,"defaultOptionConfig",{authority:0});B(R,"_userFields",[]);B(R,"_channelFields",[]);(e=>{e.Config=H.object({authority:H.computed(H.natural()).description("指令的权限等级。").default(1),checkUnknown:H.boolean().description("是否检查未知选项。").default(!1).hidden(),checkArgCount:H.boolean().description("是否检查参数数量。").default(!1).hidden(),showWarning:H.boolean().description("是否显示警告。").default(!0).hidden(),handleError:H.union([H.boolean(),H.function()]).description("是否处理错误。").default(!0).hidden()})})(R||(R={}));function bt(e){e.on("command-added",t=>{t.userFields(({session:i,tokens:n,command:r,options:s={}},o)=>{if(!r)return;let a=i.resolve(r.config.authority)>0;for(let{name:u,authority:d}of Object.values(r._options))u in s?d>0&&(a=!0):n&&d>0&&(a=!0);a&&o.add("authority")})}),e.before("command/execute",t=>{let{session:i,options:n,command:r}=t;if(!i.user)return;function s(o,...a){return r.config.showWarning?i.text(o,a):""}if(b(s,"sendHint"),typeof i.user.authority=="number"&&i.resolve(r.config.authority)>i.user.authority)return s("internal.low-authority");for(let o of Object.values(r._options))if(o.name in n&&o.authority>i.user.authority)return s("internal.low-authority")},!0),e.before("command/execute",t=>{let{args:i,options:n,command:r,session:s}=t;function o(a,...u){return r.config.showWarning?s.text(a,u):""}if(b(o,"sendHint"),r.config.checkArgCount){if((r._arguments[i.length]||{}).required)return o("internal.insufficient-arguments");let u=r._arguments[r._arguments.length-1]||{};if(i.length>r._arguments.length&&u.type!=="text"&&!u.variadic)return o("internal.redunant-arguments")}if(r.config.checkUnknown){let a=Object.keys(n).filter(u=>!r._options[u]);if(a.length)return o("internal.unknown-option",a.join(", "))}},!0)}b(bt,"validate");var re=class extends Map{constructor(e,t={}){super(),this.ctx=e,this.config=t,rt(this,fe.current,e),e.plugin(bt),e.before("parse",(i,n)=>{let r=ne.parse(i);return n.quote&&r.tokens.push({content:n.quote.content,quoted:!0,inters:[],terminator:""}),r}),e.before("attach",i=>{let n=i.parsed.content;for(let r of this._resolvePrefixes(i))if(n.startsWith(r)){i.parsed.prefix=r,n=n.slice(r.length);break}rt(i,"argv",e.bail("before-parse",n,i)),i.argv.root=!0,i.argv.session=i}),e.middleware((i,n)=>i.resolveCommand(i.argv)?i.execute(i.argv,n):n()),e.middleware((i,n)=>{let{argv:r,quote:s,subtype:o,parsed:{prefix:a,appel:u}}=i;if(r.command||o!=="private"&&!a&&!u)return n();let d=i.parsed.content.slice((a??"").length),y=d.split(/\s/,1)[0].toLowerCase();return y?n(async x=>{let C=await i.suggest({actual:y,expect:this.available(i),suffix:i.text("internal.suggest-command")});if(!C)return x();let O=C+d.slice(y.length)+(s?" "+s.content:"");return i.execute(O,x)}):n()}),e.schema.extend("command",R.Config,1e3),e.schema.extend("command-option",je.object({authority:je.computed(je.natural()).description("选项的权限等级。").default(0)}),1e3)}_commandList=[];_commands=this;_shortcuts=[];_resolvePrefixes(e){let t=e.resolve(this.config.prefix);return(Array.isArray(t)?t:[t||""]).map(n=>si.escape(n))}available(e){return this._commandList.filter(t=>t.match(e)).flatMap(t=>t._aliases)}get caller(){return this[fe.current]}resolve(e){if(!e)return;let t=e.split("."),i=1,n=t[0],r;for(;(r=this.get(n))&&i<t.length;)n=r.name+"."+t[i++];return r}getCommand(e){return this.get(e)}command(e,...t){let i=typeof t[0]=="string"?t.shift():"",n=t[0],r=e.split(" ",1)[0].toLowerCase(),s=e.slice(r.length),o=r.split(/(?=[./])/g),a=this.caller,u,d,y=[];return o.forEach((x,C)=>{let O=x.charCodeAt(0),m=O===46?u.name+x:O===47?x.slice(1):x,w=this.get(m);if(w){if(u){if(w===u)throw new Error(`cannot set a command (${w.name}) as its own subcommand`);if(w.parent){if(w.parent!==u)throw new Error(`cannot create subcommand ${r}: ${w.parent.name}/${w.name} already exists`)}else w.parent=u,u.children.push(w)}return u=w}w=new R(m,C===o.length-1?s:"",a),a.i18n.define("",`commands.${w.name}.$`,""),a.i18n.define("",`commands.${w.name}.description`,i||""),y.push(w),d||(d=w),u&&(w.parent=u,w.config.authority=u.config.authority,u.children.push(w)),u=w}),Object.assign(u.config,n),y.forEach(x=>a.emit("command-added",x)),u[fe.current]=a,n?.patch?(d&&d.dispose(),u):(d&&a.state.disposables.unshift(()=>d.dispose()),u)}};b(re,"Commander");B(re,"key","$commander");B(re,"methods",["command"]);fe.service(re.key,re);var lt=new ri("session"),{initialize:hi}=gt.prototype;ti(gt.prototype,{[ni.filter](e){return e.filter(this)},initialize(){hi.call(this),Z(this,"scope",null),Z(this,"user",null),Z(this,"channel",null),Z(this,"guild",null),Z(this,"_queuedTasks",[]),Z(this,"_queuedTimeout",null)},get username(){let e=this.user&&this.user.name?this.user.name:this.author?this.author.nickname||this.author.username:this.userId;return this.app.chain("appellation",e,this)},async send(e,t={}){if(e)return t.session=this,this.bot.sendMessage(this.channelId,e,this.guildId,t).catch(i=>(lt.warn(i),[]))},cancelQueued(e=this.app.config.delay.cancel){clearTimeout(this._queuedTimeout),this._queuedTasks=[],this._queuedTimeout=setTimeout(()=>this._next(),e)},_next(){let e=this._queuedTasks.shift();if(!e){this._queuedTimeout=null;return}this.send(e.content).then(e.resolve,e.reject),this._queuedTimeout=setTimeout(()=>this._next(),e.delay)},async sendQueued(e,t){let i=nt.normalize(e).join("");if(i){if(it(t)){let{message:n,character:r}=this.app.config.delay;t=Math.max(n,r*i.length)}return new Promise((n,r)=>{this._queuedTasks.push({content:e,delay:t,resolve:n,reject:r}),this._queuedTimeout||this._next()})}},resolve(e,...t){return typeof e=="function"?Reflect.apply(e,null,[this,...t]):ce(e)?$({_:this},e):e},async getChannel(e=this.channelId,t=[]){let{app:i,platform:n,guildId:r}=this;if(!t.length)return{platform:n,id:e,guildId:r};let s=await i.database.getChannel(n,e,t);if(s)return s;let o=await this.resolve(i.config.autoAssign)?this.selfId:"";if(o)return i.database.createChannel(n,e,{assignee:o,guildId:r});{let a=i.model.tables.channel.create();return Object.assign(a,{platform:n,id:e,guildId:r,$detached:!0}),a}},async _observeChannelLike(e,t=[]){let i=new Set(t),{platform:n}=this,r=`${n}:${e}`,s=this.app.$internal._channelCache.get(this.id,r);if(s){for(let a in s)i.delete(a);if(!i.size)return s}let o=await this.getChannel(e,[...i]);return s=this.app.$internal._channelCache.get(this.id,r),s?s.$merge(o):(s=Se(o,a=>this.app.database.setChannel(n,e,a),`channel ${r}`),this.app.$internal._channelCache.set(this.id,r,s)),s},async observeChannel(e=[]){let t=[this._observeChannelLike(this.channelId,e)];this.channelId!==this.guildId&&t.push(this._observeChannelLike(this.guildId,e));let[i,n=i]=await Promise.all(t);return this.guild=n,this.channel=i,i},async getUser(e=this.userId,t=[]){let{app:i,platform:n}=this;if(!t.length)return{[n]:e};let r=await i.database.getUser(n,e,t);if(r)return r;let s=await this.resolve(i.config.autoAuthorize);if(s)return i.database.createUser(n,e,{authority:s});{let o=i.model.tables.user.create();return Object.assign(o,{[n]:e,authority:s,$detached:!0}),o}},async observeUser(e=[]){let t=new Set(e),{userId:i,platform:n}=this,r=this.app.$internal._userCache.get(this.id,this.uid);if(r){for(let o in r)t.delete(o);if(!t.size)return this.user=r}if(this.author?.anonymous){let o=this.app.model.tables.user.create();o[n]=i,o.authority=await this.resolve(this.app.config.autoAuthorize);let a=Se(o,()=>Promise.resolve());return this.user=a}let s=await this.getUser(i,[...t]);return r=this.app.$internal._userCache.get(this.id,this.uid),r?r.$merge(s):(r=Se(s,o=>this.app.database.setUser(this.platform,i,o),`user ${this.uid}`),this.app.$internal._userCache.set(this.id,this.uid,r)),this.user=r},async withScope(e,t){let i=this.scope;try{return this.scope=e,await t()}finally{this.scope=i}},text(e,t={}){let i=[this.app.config.locale];i.unshift(this.user?.locale),this.subtype==="group"&&(i.unshift(this.guild?.locale),i.unshift(this.channel?.locale)),i.unshift(this.locale);let n=ii(e).map(r=>r.startsWith(".")?this.scope?this.scope+r:(this.app.logger("i18n").warn(new Error("missing scope")),""):r);return this.app.i18n.text(i,n,t)},collect(e,t,i=new Set){let n=b(r=>{if(r.session=this,r.tokens)for(let{inters:s}of r.tokens)s.forEach(n);this.resolveCommand(r)&&(this.app.emit(r.session,`command/before-attach-${e}`,r,i),qe(r,R[`_${e}Fields`],i),qe(r,r.command[`_${e}Fields`],i))},"collect");return n(t),i},inferCommand(e){if(e.command)return e.command;if(e.name)return e.command=this.app.$commander.resolve(e.name);let{parsed:t,subtype:i}=this;if(e.root&&i!=="private"&&t.prefix===null&&!t.appel)return;let n=[];for(;e.tokens.length;){let{content:r}=e.tokens[0];n.push(r);let s=this.app.$commander.resolve(n.join("."));if(!s||(e.tokens.shift(),e.command=s,s._actions.length))break}return e.command},resolveCommand(e){if(this.inferCommand(e)){if(e.tokens?.every(t=>!t.inters.length)){let{options:t,args:i,error:n}=e.command.parse(e);e.options={...e.options,...t},e.args=[...e.args||[],...i],e.error=n}return e.command}},async execute(e,t){if(typeof e=="string"&&(e=ne.parse(e)),e.session=this,e.tokens){for(let r of e.tokens){let{inters:s}=r,o=[];for(let a=0;a<s.length;++a)o.push(await this.execute(s[a],!0));for(let a=s.length-1;a>=0;--a){let{pos:u}=s[a];r.content=r.content.slice(0,u)+o[a]+r.content.slice(u)}r.inters=[]}if(!this.resolveCommand(e))return""}else if(e.command||=this.app.$commander.get(e.name),!e.command)return lt.warn(new Error(`cannot find command ${e.name}`)),"";let{command:i}=e;if(!i.ctx.filter(this))return"";this.app.database&&(this.subtype==="group"&&await this.observeChannel(this.collect("channel",e)),await this.observeUser(this.collect("user",e)));let n=!0;return t===!0&&(n=!1,t=void 0),this.withScope(`commands.${i.name}.messages`,async()=>{let r=await i.execute(e,t);return n?(await this.send(r),""):typeof r=="string"?r:nt(null,r).toString()})},middleware(e){let t=this.fid;return this.app.middleware(async(i,n)=>t&&i.fid!==t?n():e(i,n),!0)},prompt(...e){let t=typeof e[0]=="function"?e.shift():n=>n.content,i=typeof e[0]=="number"?{timeout:e[0]}:e[0]??{};return new Promise(n=>{let r=this.middleware(async(o,a)=>{clearTimeout(s),r();let u=await t(o);if(n(u),it(u))return a()}),s=setTimeout(()=>{r(),n(void 0)},i.timeout??this.app.config.delay.prompt)})},async suggest(e){let{expect:t,prefix:i=""}=e;if(e.actual&&(t=t.filter(n=>n&&this.app.i18n.compare(n,e.actual,e))),!t.length){await this.send(i);return}if(i+=this.text("internal.suggest-hint",[t.map(n=>this.text("general.quote",[n])).join(this.text("general.or"))]),t.length>1){await this.send(i);return}return await this.send(i+e.suffix),this.prompt(n=>{let r=n.content.trim();if(!r||r==="."||r==="。")return t[0]},e)}});function qe(e,t,i){for(let n of t){if(typeof n=="function"){n(e,i);continue}for(let r of n)i.add(r)}return i}b(qe,"collectFields");export{_ as $,G as App,ne as Argv,Pe as Channel,R as Command,re as Commander,ue as Database,de as DatabaseService,jt as Driver,_ as Eval,be as Field,Le as FilterService,dt as I18n,ae as Model,U as Next,Ue as Processor,Je as RuntimeError,mt as SchemaService,W as Selection,Ni as Service,He as SessionError,De as SharedCache,Me as User,zt as defineConfig,Ui as defineDriver,$ as executeEval,oe as executeQuery,St as executeSort,Et as executeUpdate,ce as isEvalExpr,Ri as resolveConfig,_t as version};
