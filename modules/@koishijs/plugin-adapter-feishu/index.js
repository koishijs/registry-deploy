var oe=Object.create;var P=Object.defineProperty;var ce=Object.getOwnPropertyDescriptor;var pe=Object.getOwnPropertyNames;var le=Object.getPrototypeOf,he=Object.prototype.hasOwnProperty;var F=(e,t)=>()=>(e&&(t=e(e=0)),t);var C=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),ue=(e,t)=>{for(var s in t)P(e,s,{get:t[s],enumerable:!0})},M=(e,t,s,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of pe(t))!he.call(e,r)&&r!==s&&P(e,r,{get:()=>t[r],enumerable:!(i=ce(t,r))||i.enumerable});return e},p=(e,t,s)=>(M(e,t,"default"),s&&M(s,t,"default")),N=(e,t,s)=>(s=e!=null?oe(le(e)):{},M(t||!e||!e.__esModule?P(s,"default",{value:e,enumerable:!0}):s,e)),y=e=>M(P({},"__esModule",{value:!0}),e);import{Buffer as g}from"https://registry.koishi.chat/modules/buffer/index.js";import v from"https://registry.koishi.chat/modules/process/index.js";var l=F(()=>{});var f={};import*as xe from"https://registry.koishi.chat/modules/koishi/index.js";var k=F(()=>{l();p(f,xe)});import fe from"https://registry.koishi.chat/modules/crypto-browserify/index.js";var K=C((Fe,A)=>{l();A.exports=fe});var b={};import*as Be from"https://registry.koishi.chat/modules/fsa-browserify/index.js";var R=F(()=>{l();p(b,Be)});var U=C((De,H)=>{l();H.exports=typeof self=="object"?self.FormData:window.FormData});var G=C((Le,re)=>{l();var de=Object.create,$=Object.defineProperty,ge=Object.getOwnPropertyDescriptor,me=Object.getOwnPropertyNames,_e=Object.getPrototypeOf,ye=Object.prototype.hasOwnProperty,d=(e,t)=>$(e,"name",{value:t,configurable:!0}),J=(e,t)=>{for(var s in t)$(e,s,{get:t[s],enumerable:!0})},Q=(e,t,s,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of me(t))!ye.call(e,r)&&r!==s&&$(e,r,{get:()=>t[r],enumerable:!(i=ge(t,r))||i.enumerable});return e},D=(e,t,s)=>(s=e!=null?de(_e(e)):{},Q(t||!e||!e.__esModule?$(s,"default",{value:e,enumerable:!0}):s,e)),ve=e=>Q($({},"__esModule",{value:!0}),e),W={};J(W,{Feishu:()=>se,FeishuBot:()=>T,default:()=>Ie});re.exports=ve(W);var u=(k(),y(f)),S=(k(),y(f)),B=D(K()),w=(k(),y(f));function V(e,t){var s;let i;return"sender_id"in e?i=e.sender_id.open_id:i=e.id,(s=t.author)!=null||(t.author={userId:i}),t.author.userId=i,t.userId=i,t}d(V,"adaptSender");function X(e,t,s){var i,r;let a=JSON.parse(t.message.content),c=(0,w.trimSlash)((i=e.config.selfUrl)!=null?i:e.ctx.root.config.selfUrl)+e.config.path+"/assets",n=[];switch(t.message.message_type){case"text":{let E=a.text;if(!((r=t.message.mentions)!=null&&r.length)){n.push(E);break}E.split(" ").forEach(q=>{if(q.startsWith("@")){let L=t.message.mentions.find(ne=>ne.key===q);n.push(w.segment.at(L.id.open_id,{name:L.name}))}else n.push(q)});break}case"image":let o=`${c}/image/${t.message.message_id}/${a.image_key}?self_id=${e.selfId}`;n.push(w.segment.image(o));break;case"audio":let h=`${c}/file/${t.message.message_id}/${a.file_key}?self_id=${e.selfId}`;n.push(w.segment.audio(h));break;case"media":let O=`${c}/file/${t.message.message_id}/${a.file_key}?self_id=${e.selfId}`;n.push(w.segment.video(O,a.image_key));break;case"file":let j=`${c}/file/${t.message.message_id}/${a.file_key}?self_id=${e.selfId}`;n.push(w.segment.file(j));break}return s.timestamp=Number(t.message.create_time),s.messageId=t.message.message_id,s.channelId=t.message.chat_id,s.content=n.map(o=>o.toString()).join(" "),s.platform="feishu",s.selfId=e.selfId,s}d(X,"adaptMessage");function Y(e,t){let s=e.session();switch(s.selfId=e.selfId,t.type){case"im.message.receive_v1":s.type="message",s.subtype=t.event.message.chat_type,V(t.event.sender,s),X(e,t.event,s);break}return s}d(Y,"adaptSession");function Z(e){return e.startsWith("ou")?"open_id":e.startsWith("on")?"union_id":e.startsWith("oc")?"chat_id":e.includes("@")?"email":"user_id"}d(Z,"extractIdType");var ee=class{constructor(e){this.encryptKey=e;let t=B.default.createHash("sha256");t.update(e),this.key=t.digest()}decrypt(e){let t=g.from(e,"base64"),s=B.default.createDecipheriv("aes-256-cbc",this.key,t.slice(0,16)),i=s.update(t.slice(16).toString("hex"),"hex","utf8");return i+=s.final("utf8"),i}calculateSignature(e,t,s){let i=e+t+this.encryptKey+s;return B.default.createHash("sha256").update(i).digest("hex")}};d(ee,"Cipher");var x=new S.Logger("feishu"),I=class extends S.Adapter.Server{constructor(){super(...arguments),this.ciphers={}}fork(e,t){return super.fork(e,t),this._refreshCipher(),t.initialize()}async start(e){let{path:t="/feishu"}=e.config;e.ctx.router.post(t,s=>{this._refreshCipher();let i=s.get("X-Lark-Signature"),r=this.bots.filter(n=>n.config.verifySignature);if(i&&r.length&&!r.some(o=>{var h;let O=s.get("X-Lark-Request-Timestamp"),j=s.get("X-Lark-Request-Nonce"),E=s.request.rawBody;return((h=this.ciphers[o.config.appId])==null?void 0:h.calculateSignature(O,j,E))===i}))return s.status=403;let a=this._tryDecryptBody(s.request.body);if(a?.type==="url_verification"&&a?.challenge&&typeof a.challenge=="string"){s.response.body={challenge:a.challenge};return}let c=this.bots.filter(n=>n.config.verifyToken&&n.config.verificationToken);return c.length&&!c.some(o=>{var h;return((h=s.request.body)==null?void 0:h.token)===o.config.verificationToken})?s.status=403:(x.debug("received decryped event: %o",a),this.dispatchSession(a),s.status=200)}),e.ctx.router.get(t+"/assets/:type/:message_id/:key",async s=>{let i=s.params.type==="image"?"image":"file",r=s.params.key,a=s.params.message_id,c=s.request.query.self_id,n=this.bots.find(h=>h.selfId===c);if(!n)return s.status=404;let o=await n.http.axios(`/im/v1/messages/${a}/resources/${r}`,{method:"GET",params:{type:i},responseType:"stream"});s.status=200,s.response.headers["Content-Type"]=o.headers["content-type"],s.response.body=o.data})}async stop(){x.debug("http server stopped")}dispatchSession(e){let{header:t}=e,{app_id:s,event_type:i}=t;e.type=i;let r=this.bots.find(c=>c.selfId===s),a=Y(r,e);r.dispatch(a)}_tryDecryptBody(e){this._refreshCipher();let t=Object.values(this.ciphers);if(t.length&&typeof e.encrypt=="string"){for(let s of t)try{return JSON.parse(s.decrypt(e.encrypt))}catch{}x.warn("failed to decrypt message: %o",e)}return typeof e.encrypt=="string"&&!t.length&&x.warn("encryptKey is not set, but received encrypted message: %o",e),e}_refreshCipher(){let e=Object.keys(this.ciphers),t=this.bots.map(s=>s.config.appId);if(!(t.length===e.length&&t.every(s=>e.includes(s)))){this.ciphers={};for(let s of this.bots)this.ciphers[s.config.appId]=new ee(s.config.encryptKey)}}};d(I,"HttpServer");(e=>{e.Config=S.Schema.object({selfUrl:S.Schema.string().role("link").description("服务器暴露在公网的地址。缺省时将使用全局配置。"),verifyToken:S.Schema.boolean().description("是否验证令牌。"),verifySignature:S.Schema.boolean().description("是否验证签名。")})})(I||(I={}));var ke=(R(),y(b)),be=(k(),y(f)),we=D(U()),te=class extends be.Messenger{constructor(){super(...arguments),this.content=""}async post(e){var t,s;try{let i;this.quote?i=await((t=this.bot.internal)==null?void 0:t.replyMessage(this.quote,e)):(e.receive_id=this.channelId,i=await((s=this.bot.internal)==null?void 0:s.sendMessage(Z(this.channelId),e)));let r=this.bot.session();r.messageId=i.data.message_id,r.timestamp=Number(i.data.create_time)*1e3,r.userId=i.data.sender.id,r.app.emit(r,"send",r),this.results.push(r)}catch(i){this.errors.push(i)}}async flush(){if(this.content===""&&!this.addition&&!this.richText)return;let e;this.addition&&(e={...e,...this.addition.file}),this.richText&&(e={zh_cn:this.richText}),this.content&&(e={text:this.content}),await this.post({msg_type:this.richText?"post":this.addition?this.addition.type:"text",content:JSON.stringify(e)}),this.quote=void 0,this.content="",this.addition=void 0,this.richText=void 0}async sendFile(e,t){let s=new we.default,i=e==="image"?"image":"file",[r,a]=t.split("://"),c=r==="base64"?"unknown":new URL(t).pathname.split("/").pop();if(r==="file")s.append(i,(0,ke.createReadStream)(a));else if(r==="base64")s.append(i,g.from(a,"base64"));else{let n=await this.bot.assetsQuester.get(t,{responseType:"stream"});s.append(i,n)}if(e==="image"){s.append("image_type","message");let{data:n}=await this.bot.internal.uploadImage(s);return{type:"image",file:{image_key:n.image_key}}}else{let n="file";if(e==="audio")s.append("file_type","opus"),n="audio";else if(e==="video")s.append("file_type","mp4"),n="media";else{let h=c.split(".").pop();["xls","ppt","pdf"].includes(h)?s.append("file_type",h):s.append("file_type","stream")}s.append("file_name",c);let{data:o}=await this.bot.internal.uploadFile(s);return{type:n,file:{file_key:o.file_key}}}}async visit(e){var t;let{type:s,attrs:i,children:r}=e;switch(s){case"text":this.content+=i.content;break;case"at":{i.type==="all"?this.content+=`<at user_id="all">${(t=i.name)!=null?t:"所有人"}</at>`:this.content+=`<at user_id="${i.id}">${i.name}</at>`;break}case"a":await this.render(r),i.href&&(this.content+=` (${i.href})`);break;case"sharp":break;case"quote":await this.flush(),this.quote=i.id;break;case"image":case"video":case"audio":case"file":i.url&&(await this.flush(),this.addition=await this.sendFile(s,i.url));break;case"figure":case"message":await this.flush(),await this.render(r,!0);break;default:await this.render(r)}}};d(te,"FeishuMessenger");var se={};J(se,{Internal:()=>m});var Se=D(U()),ie=(k(),y(f)),Te=new ie.Logger("feishu"),m=class{constructor(e){this.http=e}processReponse(e){let{code:t,msg:s}=e;if(t===0)return e;throw Te.debug("response: %o",e),new Error(`HTTP response with non-zero status (${t}) with message "${s}"`)}static define(e){for(let t in e)for(let s in e[t]){let i=s;for(let r of(0,ie.makeArray)(e[t][i]))m.prototype[r]=async function(...a){let c=a.join(", "),n=t.replace(/\{([^}]+)\}/g,()=>{if(!a.length)throw new Error(`too few arguments for ${t}, received ${c}`);return a.shift()}),o={};if(a.length===1)i==="GET"||i==="DELETE"?o.params=a[0]:(i==="POST"&&a[0]instanceof Se.default&&(o.headers=a[0].getHeaders()),o.data=a[0]);else if(a.length===2&&i!=="GET"&&i!=="DELETE")o.data=a[0],o.params=a[1];else if(a.length>1)throw new Error(`too many arguments for ${t}, received ${c}`);return this.processReponse(await this.http(i,n,o))}}}};d(m,"Internal");m.define({"/auth/v3/app_access_token/internal":{POST:"getAppAccessToken"},"/auth/v3/tenant_access_token/internal":{POST:"getTenantAccessToken"}});m.define({"/im/v1/chats":{GET:"getCurrentUserGuilds"},"/im/v1/chats/{chat_id}":{GET:"getGuildInfo"},"/im/v1/chats/{chat_id}/members":{GET:"getGuildMembers"}});m.define({"/im/v1/images":{POST:"uploadImage"},"/im/v1/files":{POST:"uploadFile"}});m.define({"/im/v1/messages?receive_id_type={receive_id_type}":{POST:"sendMessage"},"/im/v1/messages/{message_id}/reply":{POST:"replyMessage"},"/im/v1/messages/{message_id}":{GET:"getMessage",DELETE:"deleteMessage"},"/im/v1/messages/{message_id}/read_users":{GET:"getMessageReadUsers"}});var z=new u.Logger("feishu"),T=class extends u.Bot{constructor(e,t){var s;super(e,t),!t.selfUrl&&!e.config.selfUrl&&z.warn("selfUrl is not set, some features may not work"),this.selfId=t.appId,this.http=e.http.extend({endpoint:(s=t.endpoint)!=null?s:"https://open.feishu.cn/open-apis/",headers:{"Content-Type":"application/json; charset=utf-8"}}),this.assetsQuester=u.Quester.create(),this.internal=new m(this.http),e.plugin(I,this)}async initialize(){await this.refreshToken(),this.online()}async refreshToken(){let{tenant_access_token:e}=await this.internal.getTenantAccessToken({app_id:this.config.appId,app_secret:this.config.appSecret});z.debug("refreshed token %s",e),this.token=e,this.online()}get token(){return this._token}set token(e){this._token=e,this.http.config.headers.Authorization=`Bearer ${e}`}async sendMessage(e,t,s,i){return new te(this,e,s,i).send(t)}async sendPrivateMessage(e,t,s){return this.sendMessage(e,t,null,s)}async deleteMessage(e,t){await this.internal.deleteMessage(t)}};d(T,"FeishuBot");(e=>{e.Config=u.Schema.intersect([u.Schema.object({path:u.Schema.string().role("url").description("要连接的服务器地址。").default("/feishu"),appId:u.Schema.string().required().description("机器人的应用 ID。"),appSecret:u.Schema.string().role("secret").required().description("机器人的应用密钥。"),encryptKey:u.Schema.string().role("secret").description("机器人的 Encrypt Key。"),verificationToken:u.Schema.string().description("事件推送的验证令牌。")}),u.Quester.Config,I.Config])})(T||(T={}));T.prototype.platform="feishu";var Ie=T});var _={};ue(_,{default:()=>$e});l();var ae=N(G(),1);p(_,N(G(),1));var $e=ae.FeishuBot;export{$e as default};
