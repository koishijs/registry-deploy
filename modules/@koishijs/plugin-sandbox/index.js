var I=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var U=Object.getOwnPropertyNames;var K=Object.prototype.hasOwnProperty;var m=(s,e)=>()=>(s&&(e=s(s=0)),e);var w=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports);var v=(s,e,r,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of U(e))!K.call(s,a)&&a!==r&&I(s,a,{get:()=>e[a],enumerable:!(t=E(e,a))||t.enumerable});return s},i=(s,e,r)=>(v(s,e,"default"),r&&v(r,e,"default"));var g=s=>v(I({},"__esModule",{value:!0}),s);import{Buffer as p}from"https://registry.koishi.chat/modules/buffer/index.js";import l from"https://registry.koishi.chat/modules/process/index.js";var n=m(()=>{});var d={};import*as se from"https://registry.koishi.chat/modules/koishi/index.js";var y=m(()=>{n();i(d,se)});var c={};import*as te from"https://registry.koishi.chat/modules/@koishijs/plugin-console/index.js";var O=m(()=>{n();i(c,te)});import A from"https://registry.koishi.chat/modules/path-browserify/index.js";var S=w((ne,P)=>{n();P.exports=A});var Q=w((de,C)=>{n();var h=Object.defineProperty,H=Object.getOwnPropertyDescriptor,$=Object.getOwnPropertyNames,q=Object.prototype.hasOwnProperty,b=(s,e)=>h(s,"name",{value:e,configurable:!0}),D=(s,e)=>{for(var r in e)h(s,r,{get:e[r],enumerable:!0})},L=(s,e,r,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of $(e))!q.call(s,a)&&a!==r&&h(s,a,{get:()=>e[a],enumerable:!(t=H(e,a))||t.enumerable});return s},N=s=>L(h({},"__esModule",{value:!0}),s),k={};D(k,{Config:()=>F,UserProvider:()=>f,apply:()=>B,filter:()=>J,name:()=>V,using:()=>W});C.exports=N(k);var j=(y(),g(d)),R=(O(),g(c)),oe=S(),o=(y(),g(d)),x=class extends o.Messenger{constructor(){super(...arguments),this.buffer="",this.rules=Object.fromEntries(["image","audio","video","file"].map(s=>[s,async e=>e.url.startsWith("file:")&&this.bot.ctx.assets?(0,o.h)(s,{...e,url:await this.bot.ctx.assets.upload(e.url,e.url)}):(0,o.h)(s,e)]))}async flush(){if(!this.buffer.trim())return;let s=await o.h.transformAsync(this.buffer.trim(),this.rules),e=this.bot.session(this.session);e.messageId=o.Random.id(),e.app.console.broadcast("sandbox",{content:s,user:"Koishi",channel:e.channelId,id:e.messageId}),this.results.push(e),this.buffer=""}async visit(s){let{type:e,children:r}=s;e==="message"||e==="figure"?(await this.flush(),await this.render(r),await this.flush()):this.buffer+=s.toString()}};b(x,"SandboxMessenger");var M=class extends o.Bot{constructor(s){super(s,{platform:"sandbox",selfId:"koishi"}),this.ctx=s,this.username="koishi",this.hidden=!0,this.internal={};let e=this;s.console.addListener("sandbox/message",async function(r,t,a){let u=o.Random.id();s.console.broadcast("sandbox",{id:u,content:a,user:r,channel:t});let _=e.session({userId:r,content:a,messageId:u,channelId:t,guildId:t==="@"+r?void 0:t,type:"message",subtype:t==="@"+r?"private":"group",author:{userId:r,username:r}});(0,o.defineProperty)(_,"client",this),e.dispatch(_)},{authority:4})}async sendMessage(s,e,r,t){return new x(this,s,r,t).send(e)}async sendPrivateMessage(s,e,r){return new x(this,"@"+s,void 0,r).send(e)}async deleteMessage(s,e){this.ctx.console.broadcast("sandbox/delete",{id:e,channel:s})}async getGuildMemberList(s){return z.map(e=>({nickname:e,userId:e}))}};b(M,"SandboxBot");var z=["Alice","Bob","Carol","Dave","Eve","Frank","Grace","Hank","Ivy","Jack","Kathy","Lily","Mandy","Nancy","Oscar","Peggy","Quinn","Randy","Sandy","Toby","Uma","Vicky","Wendy","Xander","Yvonne","Zoe"],G={commands:{clear:{description:"清空聊天记录"}}},f=class extends R.DataService{constructor(s,e){super(s,"sandbox",{authority:4}),this.config=e,s.console.addListener("sandbox/user",async(r,t)=>{let a=await this.get();if(a[r]){if(!t)return delete a[r],this.ctx.$internal._userCache.set("sandbox","sandbox:"+r,null),this.ctx.database.remove("user",{sandbox:r})}else{if(!t)return;let u=await this.ctx.database.createUser("sandbox",r,{authority:1,...t});return this.observe(u,a)}return Object.assign(a[r],t),a[r].$update()},{authority:4})}observe(s,e){let r="sandbox:"+s.sandbox;e[s.sandbox]=(0,j.observe)(s,async t=>{await this.ctx.database.setUser("sandbox",s.sandbox,t),this.refresh()}),this.ctx.$internal._userCache.set("sandbox",r,e[s.sandbox])}async prepare(){let s=await this.ctx.database.get("binding",{platform:"sandbox"},["aid"]),e=await this.ctx.database.get("user",s.map(({aid:t})=>t)),r={};for(let t of e)this.observe(t,r);return r}stop(){this.ctx.$internal._userCache.delete("sandbox")}async get(){return this.task||(this.task=this.prepare())}};b(f,"UserProvider");f.using=["database"];var J=!1,V="sandbox",W=["console"],F=j.Schema.object({});function B(s,e){s.plugin(M),s.plugin(f),s.console.addEntry(["https://registry.koishi.chat/modules/@koishijs/plugin-sandbox/dist/index.js","https://registry.koishi.chat/modules/@koishijs/plugin-sandbox/dist/style.css"]),s.i18n.define("zh",G),s.platform("sandbox").command("clear").action(({session:r})=>{r.client.send({type:"sandbox/clear"})})}b(B,"apply")});export default Q();
