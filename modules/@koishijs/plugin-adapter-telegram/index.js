var re=Object.create;var F=Object.defineProperty;var se=Object.getOwnPropertyDescriptor;var ne=Object.getOwnPropertyNames;var oe=Object.getPrototypeOf,le=Object.prototype.hasOwnProperty;var D=(e,t)=>()=>(e&&(t=e(e=0)),t);var U=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),de=(e,t)=>{for(var a in t)F(e,a,{get:t[a],enumerable:!0})},$=(e,t,a,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of ne(t))!le.call(e,s)&&s!==a&&F(e,s,{get:()=>t[s],enumerable:!(r=se(t,s))||r.enumerable});return e},m=(e,t,a)=>($(e,t,"default"),a&&$(a,t,"default")),R=(e,t,a)=>(a=e!=null?re(oe(e)):{},$(t||!e||!e.__esModule?F(a,"default",{value:e,enumerable:!0}):a,e)),I=e=>$(F({},"__esModule",{value:!0}),e);import{Buffer as C}from"https://registry.koishi.chat/modules/buffer/index.js";import k from"https://registry.koishi.chat/modules/process/index.js";var u=D(()=>{});var g={};import*as Pe from"https://registry.koishi.chat/modules/koishi/index.js";var b=D(()=>{u();m(g,Pe)});var O=U((qe,V)=>{u();V.exports=typeof self=="object"?self.FormData:window.FormData});import ce from"https://registry.koishi.chat/modules/reggol/index.js";var J=U((Ue,W)=>{u();W.exports=ce});var H=U((je,ie)=>{u();var pe=Object.create,T=Object.defineProperty,fe=Object.getOwnPropertyDescriptor,he=Object.getOwnPropertyNames,ue=Object.getPrototypeOf,me=Object.prototype.hasOwnProperty,h=(e,t)=>T(e,"name",{value:t,configurable:!0}),K=(e,t)=>{for(var a in t)T(e,a,{get:t[a],enumerable:!0})},X=(e,t,a,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of he(t))!me.call(e,s)&&s!==a&&T(e,s,{get:()=>t[s],enumerable:!(r=fe(t,s))||r.enumerable});return e},B=(e,t,a)=>(a=e!=null?pe(ue(e)):{},X(t||!e||!e.__esModule?T(a,"default",{value:e,enumerable:!0}):a,e)),ge=e=>X(T({},"__esModule",{value:!0}),e),Y={};K(Y,{HttpPolling:()=>M,HttpServer:()=>S,Internal:()=>i,SenderError:()=>te,Telegram:()=>Z,TelegramBot:()=>v,TelegramMessenger:()=>N,adaptGuildMember:()=>L,adaptUser:()=>q,default:()=>Me,handleUpdate:()=>x});ie.exports=ge(Y);var o=(b(),I(g)),Z={};K(Z,{Internal:()=>i});var _e=B(O()),ye=B(J()),Q=new ye.default("telegram"),i=class{constructor(e){this.http=e}static define(e){i.prototype[e]=async function(t={}){var a,r;Q.debug("[request] %s %o",e,t);try{let s;t instanceof _e.default?s=await this.http.post("/"+e,t,{headers:t.getHeaders()}):s=await this.http.post("/"+e,t),Q.debug("[response] %o",s);let{ok:n,result:c}=s;if(n)return c;throw new Error(`Telegram API error ${s.data.error_code}. ${s.data.description}`)}catch(s){throw(r=(a=s.response)==null?void 0:a.data)!=null&&r.error_code&&s.response.data.description?new Error(`Telegram API error ${s.response.data.error_code}. ${s.response.data.description}`):s}}}};h(i,"Internal");i.define("answerInlineQuery");i.define("answerWebAppQuery");i.define("sendGame");i.define("setGameScore");i.define("getGameHighScores");i.define("setPassportDataErrors");i.define("sendInvoice");i.define("createInvoiceLink");i.define("answerShippingQuery");i.define("answerPreCheckoutQuery");i.define("sendSticker");i.define("getStickerSet");i.define("getCustomEmojiStickers");i.define("uploadStickerFile");i.define("createNewStickerSet");i.define("addStickerToSet");i.define("setStickerPositionInSet");i.define("deleteStickerFromSet");i.define("setStickerSetThumb");i.define("getUpdates");i.define("setWebhook");i.define("deleteWebhook");i.define("getWebhookInfo");i.define("getMe");i.define("logOut");i.define("close");i.define("sendMessage");i.define("forwardMessage");i.define("copyMessage");i.define("sendPhoto");i.define("sendAudio");i.define("sendDocument");i.define("sendVideo");i.define("sendAnimation");i.define("sendVoice");i.define("sendVideoNote");i.define("sendMediaGroup");i.define("sendLocation");i.define("editMessageLiveLocation");i.define("stopMessageLiveLocation");i.define("sendVenue");i.define("sendContact");i.define("sendPoll");i.define("sendDice");i.define("sendChatAction");i.define("getUserProfilePhotos");i.define("getFile");i.define("banChatMember");i.define("unbanChatMember");i.define("restrictChatMember");i.define("promoteChatMember");i.define("setChatAdministratorCustomTitle");i.define("banChatSenderChat");i.define("unbanChatSenderChat");i.define("setChatPermissions");i.define("exportChatInviteLink");i.define("createChatInviteLink");i.define("editChatInviteLink");i.define("revokeChatInviteLink");i.define("approveChatJoinRequest");i.define("declineChatJoinRequest");i.define("setChatPhoto");i.define("deleteChatPhoto");i.define("setChatTitle");i.define("setChatDescription");i.define("pinChatMessage");i.define("unpinChatMessage");i.define("unpinAllChatMessages");i.define("leaveChat");i.define("getChat");i.define("getChatAdministrators");i.define("getChatMemberCount");i.define("getChatMember");i.define("setChatStickerSet");i.define("deleteChatStickerSet");i.define("getForumTopicIconStickers");i.define("createForumTopic");i.define("editForumTopic");i.define("closeForumTopic");i.define("reopenForumTopic");i.define("deleteForumTopic");i.define("unpinAllForumTopicMessages");i.define("editGeneralForumTopic");i.define("closeGeneralForumTopic");i.define("reopenGeneralForumTopic");i.define("hideGeneralForumTopic");i.define("unhideGeneralForumTopic");i.define("answerCallbackQuery");i.define("setMyCommands");i.define("deleteMyCommands");i.define("getMyCommands");i.define("setChatMenuButton");i.define("getChatMenuButton");i.define("setMyDefaultAdministratorRights");i.define("getMyDefaultAdministratorRights");i.define("editMessageText");i.define("editMessageCaption");i.define("editMessageMedia");i.define("editMessageReplyMarkup");i.define("stopPoll");i.define("deleteMessage");var G=(b(),I(g)),ve=new G.Logger("telegram"),q=h(e=>({userId:e.id.toString(),username:e.username,nickname:e.first_name+(e.last_name?" "+e.last_name:""),isBot:e.is_bot}),"adaptUser"),L=h(e=>q(e.user),"adaptGuildMember");async function x(e,t){ve.debug("receive %s",JSON.stringify(e));let a=t.session();(0,G.defineProperty)(a,"telegram",Object.create(t.internal)),Object.assign(a.telegram,e);let r=e.message||e.edited_message||e.channel_post||e.edited_channel_post;if(r)a.type=e.message||e.channel_post?"message":"message-updated",await t.adaptMessage(r,a);else if(e.chat_join_request)a.timestamp=e.chat_join_request.date*1e3,a.type="guild-member-request",a.messageId=`${e.chat_join_request.chat.id}@${e.chat_join_request.from.id}`,a.content="",a.channelId=e.chat_join_request.chat.id.toString(),a.guildId=a.channelId;else if(e.my_chat_member)a.timestamp=e.my_chat_member.date*1e3,a.messageId=`${e.my_chat_member.chat.id}@${e.my_chat_member.from.id}`,a.content="",a.channelId=e.my_chat_member.chat.id.toString(),a.guildId=a.channelId,e.my_chat_member.old_chat_member.user.id.toString()===t.selfId&&(e.my_chat_member.new_chat_member.status==="left"?a.type="group-deleted":e.my_chat_member.old_chat_member.status==="left"&&(a.type="group-added"));else{let s=Object.keys(e).filter(n=>n!=="update_id")[0];s&&(a.type="telegram",a.subtype=(0,G.hyphenate)(s))}t.dispatch(a)}h(x,"handleUpdate");var j=(b(),I(g)),we=B(O());async function ee(e,t,a){let r,{filename:s,data:n,mime:c}=await e.ctx.http.file(a.attrs.url);a.type==="image"?r=c==="image/gif"?"animation":"photo":a.type==="file"?r="document":r=a.type;let d=new Blob([n],{type:c});return t.append(r,d,s),r}h(ee,"appendAsset");var be={photo:"sendPhoto",audio:"sendAudio",document:"sendDocument",video:"sendVideo",animation:"sendAnimation"},Se=["b","strong","i","em","u","ins","s","del","a"],N=class extends j.Messenger{constructor(e,t,a,r){super(e,t,a,r),this.asset=null,this.mode="default";let s=a||t.slice(8);this.payload={chat_id:s,parse_mode:"html",caption:""},a&&t!==a&&(this.payload.message_thread_id=+t)}async addResult(e){let t=this.bot.session();await this.bot.adaptMessage(e,t),this.results.push(t),t.app.emit(t,"send",t)}async sendAsset(){let e=new we.default;for(let r in this.payload)e.append(r,this.payload[r].toString());let t=await ee(this.bot,e,this.asset),a=await this.bot.internal[be[t]](e);await this.addResult(a),delete this.payload.reply_to_message,this.asset=null,this.payload.caption=""}async flush(){if(this.asset)await this.sendAsset();else if(this.payload.caption){let e=await this.bot.internal.sendMessage({chat_id:this.payload.chat_id,text:this.payload.caption,parse_mode:this.payload.parse_mode,reply_to_message_id:this.payload.reply_to_message_id,message_thread_id:this.payload.message_thread_id,disable_web_page_preview:!this.options.linkPreview});await this.addResult(e),delete this.payload.reply_to_message,this.payload.caption=""}}async visit(e){let{type:t,attrs:a,children:r}=e;if(t==="text")this.payload.caption+=j.segment.escape(a.content);else if(t==="p")await this.render(r),this.payload.caption+=`
`;else if(Se.includes(t))this.payload.caption+=e.toString();else if(t==="spl")this.payload.caption+="<tg-spoiler>",await this.render(r),this.payload.caption+="</tg-spoiler>";else if(t==="code"){let{lang:s}=a;this.payload.caption+=`<code${s?` class="language-${s}"`:""}>${j.segment.escape(a.content)}</code>`}else t==="at"?a.id&&(this.payload.caption+=`<a href="tg://user?id=${a.id}">@${a.name||a.id}</a>`):["image","audio","video","file"].includes(t)?(this.mode==="default"&&await this.flush(),this.asset=e):t==="figure"?(await this.flush(),this.mode="figure",await this.render(r),await this.flush(),this.mode="default"):t==="quote"?(await this.flush(),this.payload.reply_to_message_id=a.id):t==="message"?this.mode==="figure"?(await this.render(r),this.payload.caption+=`
`):(await this.flush(),await this.render(r),await this.flush()):await this.render(r)}};h(N,"TelegramMessenger");var y=(b(),I(g)),z=new y.Logger("telegram"),S=class extends y.Adapter.Server{async start(e){let{token:t,path:a,selfUrl:r}=e.config;a=(0,y.sanitize)(a||"/telegram"),r?r=(0,y.trimSlash)(r):r=e.ctx.root.config.selfUrl,e.ctx.router.post(a,async s=>{var n;let c=s.request.body,d=s.request.query.token,[p]=d.split(":"),l=this.bots.find(f=>f.selfId===p);if(((n=l?.config)==null?void 0:n.token)!==d)return s.status=403;s.body="OK",await x(c,l)}),e.initialize(async s=>{if(!await s.internal.setWebhook({url:r+a+"?token="+t,drop_pending_updates:!0}))throw new Error("Set webhook failed");z.debug("listening updates %c","telegram: "+s.selfId)})}async stop(){z.debug("http server closing")}};h(S,"HttpServer");(e=>{e.Config=y.Schema.object({protocol:y.Schema.const("server").required(),path:y.Schema.string().description("服务器监听的路径。").default("/telegram"),selfUrl:y.Schema.string().role("link").description("服务器暴露在公网的地址。缺省时将使用全局配置。")})})(S||(S={}));var _=(b(),I(g)),P=new _.Logger("telegram"),M=class extends _.Adapter.Client{constructor(){super(...arguments),this.offset=0}async start(e){e.initialize(async()=>{let t=0,a=!0,{retryTimes:r,retryInterval:s}=e.config,{url:n}=await e.internal.getWebhookInfo();n&&(P.warn("Bot currently has a webhook set up, trying to remove it..."),await e.internal.setWebhook({url:""})),(await e.internal.getUpdates({allowed_updates:[],timeout:0})).forEach(p=>{this.offset=Math.max(this.offset,p.update_id)});let d=h(async()=>{var p;if(e.status==="disconnect")return e.offline();try{let l=await e.internal.getUpdates({offset:this.offset+1,timeout:Math.ceil(e.config.pollingTimeout/1e3)});e.online(),t=0,a=!1;for(let f of l)this.offset=Math.max(this.offset,f.update_id),x(f,e);setTimeout(d,0)}catch(l){if(!_.Quester.isAxiosError(l)||!((p=l.response)!=null&&p.data))P.warn("failed to get updates. reason: %s",l.message);else{let{error_code:f,description:A}=l.response.data;P.warn("failed to get updates: %c %s",f,A)}if(a&&t>r)return e.error=l,e.status="offline";t++,e.status="reconnect",setTimeout(()=>d(),s)}},"polling");d(),P.debug("listening updates %c","telegram: "+e.selfId)})}async stop(){}};h(M,"HttpPolling");(e=>{e.Config=_.Schema.object({protocol:_.Schema.const("polling").required(!1),pollingTimeout:_.Schema.natural().role("ms").default(_.Time.second*25).description("通过长轮询获取更新时请求的超时 (单位为毫秒)。"),retryTimes:_.Schema.natural().description("初次连接时的最大重试次数。").default(6),retryInterval:_.Schema.natural().role("ms").default(_.Time.second*5).description("长轮询断开后的重试时间间隔 (单位为毫秒)。")})})(M||(M={}));var E=new o.Logger("telegram"),te=class extends Error{constructor(e,t,a,r){super(`Error when trying to send to ${t}, args: ${JSON.stringify(e)}, retcode: ${a}`),Object.defineProperties(this,{name:{value:"SenderError"},selfId:{value:r},code:{value:a},args:{value:e},url:{value:t}})}};h(te,"SenderError");var v=class extends o.Bot{constructor(e,t){var a;super(e,t),this.selfId=t.token.split(":")[0],this.local=t.files.local,this.http=this.ctx.http.extend({...t,endpoint:`${t.endpoint}/bot${t.token}`}),this.file=this.ctx.http.extend({...t,endpoint:`${t.files.endpoint||t.endpoint}/file/bot${t.token}`}),this.internal=new i(this.http),t.protocol==="server"?e.plugin(S,this):t.protocol==="polling"&&e.plugin(M,this);let r=t.selfUrl||e.root.config.selfUrl;if((a=t.files.server)!=null?a:r){let s=`/telegram/${this.selfId}`;this.server=r+s,e.router.get(s+"/:file+",async n=>{let{data:c,mime:d}=await this.$getFile(n.params.file);n.set("content-type",d),n.body=c})}}async initialize(e){let{username:t,userId:a,avatar:r,nickname:s}=await this.getLoginInfo();this.username=t,this.avatar=r,this.selfId=a,this.nickname=s,await e(this),E.debug("connected to %c","telegram:"+this.selfId),this.online()}async adaptMessage(e,t){let a=h((n,c)=>{let d=0,p=[];for(let l of c){let f=n.substr(l.offset,l.length);if(l.type==="mention"){if(f[0]!=="@")throw new Error("Telegram mention does not start with @: "+f);let A=f.slice(1);f==="@"+this.username?p.push((0,o.segment)("at",{id:this.selfId,name:A})):p.push((0,o.segment)("text",{content:f}))}else l.type==="text_mention"?p.push((0,o.segment)("at",{id:l.user.id})):p.push((0,o.segment)("text",{content:f}));l.offset>d&&p.splice(-1,0,(0,o.segment)("text",{content:n.slice(d,l.offset)})),d=l.offset+l.length}return d<n?.length&&p.push((0,o.segment)("text",{content:n.slice(d)})),p},"parseText");t.messageId=e.message_id.toString(),t.timestamp=e.date*1e3;let r=[];e.reply_to_message&&!(e.is_topic_message&&e.reply_to_message.forum_topic_created)&&(t.quote={},await this.adaptMessage(e.reply_to_message,t.quote));let s=e.text||e.caption;if(r.push(...a(s,e.entities||[])),e.caption&&r.push((0,o.segment)("text",{content:" "})),e.location&&r.push((0,o.segment)("location",{lat:e.location.latitude,lon:e.location.longitude})),e.photo){let n=e.photo.sort((c,d)=>d.file_size-c.file_size)[0];r.push((0,o.segment)("image",await this.$getFileFromId(n.file_id)))}if(e.sticker)try{let n=await this.internal.getFile({file_id:e.sticker.file_id});if(n.file_path.endsWith(".tgs"))throw new Error("tgs is not supported now");r.push((0,o.segment)("image",await this.$getFileFromPath(n.file_path)))}catch(n){E.warn("get file error",n),r.push((0,o.segment)("text",{content:`[${e.sticker.set_name||"sticker"} ${e.sticker.emoji||""}]`}))}else e.animation?r.push((0,o.segment)("image",await this.$getFileFromId(e.animation.file_id))):e.voice?r.push((0,o.segment)("audio",await this.$getFileFromId(e.voice.file_id))):e.video?r.push((0,o.segment)("video",await this.$getFileFromId(e.video.file_id))):e.document&&r.push((0,o.segment)("file",await this.$getFileFromId(e.document.file_id)));t.content=r.join(""),t.userId=e.from.id.toString(),t.author=q(e.from),e.chat.type==="private"?(t.subtype="private",t.channelId="private:"+e.chat.id):(t.subtype="group",t.guildId=e.chat.id.toString(),e.is_topic_message?t.channelId=e.message_thread_id.toString():t.channelId=t.guildId)}async sendMessage(e,t,a,r){return new N(this,e,a,r).send(t)}async sendPrivateMessage(e,t,a){return this.sendMessage("private:"+e,t,null,a)}async getMessage(){return null}async deleteMessage(e,t){t=+t,await this.internal.deleteMessage({chat_id:e,message_id:t})}static adaptGroup(e){return e.guildId=e.id+"",e.guildName=e.title,delete e.id,delete e.title,e}async getGuild(e){let t=await this.internal.getChat({chat_id:e});return v.adaptGroup(t)}async getGuildList(){return[]}async getGuildMember(e,t){if(t=+t,Number.isNaN(t))return null;let a=await this.internal.getChatMember({chat_id:e,user_id:t}),r=L(a);return await this.setAvatarUrl(r),r}async getGuildMemberList(e){let a=(await this.internal.getChatAdministrators({chat_id:e})).map(L);return await Promise.all(a.map(this.setAvatarUrl.bind(this))),a}async kickGuildMember(e,t,a){t=+t,await this.internal.banChatMember({chat_id:e,user_id:t,until_date:Date.now()+(a?0:o.Time.minute),revoke_messages:!0})}setGroupLeave(e){return this.internal.leaveChat({chat_id:e})}async handleGuildMemberRequest(e,t,a){let[r,s]=e.split("@"),n=t?"approveChatJoinRequest":"declineChatJoinRequest",c=await this.internal[n]({chat_id:r,user_id:+s});if(!c)throw new Error(`handel guild member request field ${c}`)}async getLoginInfo(){let e=await this.internal.getMe(),t=q(e);return await this.setAvatarUrl(t),t}async $getFile(e){return this.local?await this.ctx.http.file(e):await this.file.file(`/${e}`)}async $getFileFromId(e){try{let t=await this.internal.getFile({file_id:e});return await this.$getFileFromPath(t.file_path)}catch(t){E.warn("get file error",t)}}async $getFileFromPath(e){if(this.server)return{url:`${this.server}/${e}`};let{mime:t,data:a}=await this.$getFile(e);return{url:`data:${t};base64,`+(0,o.arrayBufferToBase64)(a)}}async setAvatarUrl(e){let{photos:[t]}=await this.internal.getUserProfilePhotos({user_id:+e.userId});if(!t)return;let{file_id:a}=t[t.length-1],r=await this.internal.getFile({file_id:a});if(this.server)e.avatar=`${this.server}/${r.file_path}`;else{let{endpoint:s}=this.file.config;e.avatar=`${s}/${r.file_path}`}}};h(v,"TelegramBot");v.prototype.platform="telegram";(e=>{e.Config=o.Schema.intersect([o.Schema.object({token:o.Schema.string().description("机器人的用户令牌。").role("secret").required(),protocol:o.Schema.const("polling").default("polling")}),o.Schema.union([S.Config,M.Config]).description("推送设置"),o.Quester.createConfig("https://api.telegram.org"),o.Schema.object({files:o.Schema.object({endpoint:o.Schema.string().description("文件请求的终结点。"),local:o.Schema.boolean().description("是否启用 [Telegram Bot API](https://github.com/tdlib/telegram-bot-api) 本地模式。"),server:o.Schema.boolean().description("是否启用文件代理。若开启将会使用 `selfUrl` 进行反代，否则会下载所有资源文件 (包括图片、视频等)。当配置了 `selfUrl` 时将默认开启。")})}).hidden(!0).description("文件设置")])})(v||(v={}));var Me=v});var w={};de(w,{default:()=>Ie});u();var ae=R(H(),1);m(w,R(H(),1));var Ie=ae.TelegramBot;export{Ie as default};
