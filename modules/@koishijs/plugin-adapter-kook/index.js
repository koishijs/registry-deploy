var ne=Object.create;var C=Object.defineProperty;var oe=Object.getOwnPropertyDescriptor;var ce=Object.getOwnPropertyNames;var le=Object.getPrototypeOf,ue=Object.prototype.hasOwnProperty;var J=(e,t)=>()=>(e&&(t=e(e=0)),t);var R=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),de=(e,t)=>{for(var r in t)C(e,r,{get:t[r],enumerable:!0})},I=(e,t,r,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of ce(t))!ue.call(e,s)&&s!==r&&C(e,s,{get:()=>t[s],enumerable:!(a=oe(t,s))||a.enumerable});return e},u=(e,t,r)=>(I(e,t,"default"),r&&I(r,t,"default")),D=(e,t,r)=>(r=e!=null?ne(le(e)):{},I(t||!e||!e.__esModule?C(r,"default",{value:e,enumerable:!0}):r,e)),M=e=>I(C({},"__esModule",{value:!0}),e);import{Buffer as P}from"https://registry.koishi.chat/modules/buffer/index.js";import E from"https://registry.koishi.chat/modules/process/index.js";var p=J(()=>{});var d={};import*as Te from"https://registry.koishi.chat/modules/koishi/index.js";var v=J(()=>{p();u(d,Te)});var K=R((Ie,z)=>{p();z.exports=typeof self=="object"?self.FormData:window.FormData});var W=R((Ee,se)=>{p();var pe=Object.create,x=Object.defineProperty,he=Object.getOwnPropertyDescriptor,fe=Object.getOwnPropertyNames,me=Object.getPrototypeOf,ge=Object.prototype.hasOwnProperty,i=(e,t)=>x(e,"name",{value:t,configurable:!0}),F=(e,t)=>{for(var r in t)x(e,r,{get:t[r],enumerable:!0})},Q=(e,t,r,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of fe(t))!ge.call(e,s)&&s!==r&&x(e,s,{get:()=>t[s],enumerable:!(a=he(t,s))||a.enumerable});return e},X=(e,t,r)=>(r=e!=null?pe(me(e)):{},Q(t||!e||!e.__esModule?x(r,"default",{value:e,enumerable:!0}):r,e)),_e=e=>Q(x({},"__esModule",{value:!0}),e),Y={};F(Y,{HttpServer:()=>S,Kook:()=>Z,KookBot:()=>O,KookMessenger:()=>b,WsClient:()=>k,adaptAuthor:()=>L,adaptGroup:()=>re,adaptMessage:()=>G,adaptSession:()=>$,adaptUser:()=>B,default:()=>be});se.exports=_e(Y);var _=(v(),M(d)),o=(v(),M(d)),Z={};F(Z,{Internal:()=>c,Signal:()=>ee,Type:()=>A,UserStatus:()=>te});var ee=(e=>(e[e.event=0]="event",e[e.hello=1]="hello",e[e.ping=2]="ping",e[e.pong=3]="pong",e[e.reconnect=4]="reconnect",e[e.resume=5]="resume",e))(ee||{}),A=(e=>(e[e.text=1]="text",e[e.image=2]="image",e[e.video=3]="video",e[e.file=4]="file",e[e.unknown=7]="unknown",e[e.audio=8]="audio",e[e.kmarkdown=9]="kmarkdown",e[e.card=10]="card",e[e.system=255]="system",e))(A||{}),te=(e=>(e[e.normal=0]="normal",e[e.banned=10]="banned",e))(te||{}),c=class{constructor(e){this.http=e}static define(e,t,r){c.prototype[e]=function(...a){let s={};return t==="GET"||t==="DELETE"?s.params=a[0]:s.data=a[0],this.http(t,r,s)}}};i(c,"Internal");c.define("getGuildList","GET","/guild/list");c.define("getGuildView","GET","/guild/view");c.define("getGuildUserList","GET","/guild/user-list");c.define("setGuildUserNickname","POST","/guild/nickname");c.define("leaveGuild","POST","/guild/leave");c.define("kickoutGuildUser","POST","/guild/kickout");c.define("getGuildMuteList","GET","/guild-mute/list");c.define("setGuildMute","POST","/guild-mute/create");c.define("unsetGuildMute","POST","/guild-mute/delete");var re=i(e=>({guildId:e.id,guildName:e.name}),"adaptGroup"),B=i(e=>({userId:e.id,avatar:e.avatar,username:e.username,discriminator:e.identify_num}),"adaptUser"),L=i(e=>({...B(e),nickname:e.nickname}),"adaptAuthor");function j(e,t,r={}){var a;if(t.author&&(r.author=L(t.author),r.userId=t.author.id),e.type===1)r.content=e.content.replace(/@(.+?)#(\d+)/,(s,n,f)=>(0,o.segment)("at",{id:f,name:n}).toString()).replace(/@全体成员/,()=>(0,o.segment)("at",{type:"all"}).toString()).replace(/@在线成员/,()=>(0,o.segment)("at",{type:"here"}).toString()).replace(/@role:(\d+);/,(s,n)=>(0,o.segment)("at",{role:n}).toString()).replace(/#channel:(\d+);/,(s,n)=>o.segment.sharp(n).toString()),r.elements=o.segment.parse(r.content);else if(e.type===2){let s=(0,o.segment)("image",{url:e.content,file:(a=t.attachments)==null?void 0:a.name});r.elements=[s],r.content=s.toString()}else if(e.type==9){r.content=e.content.replace(/\(met\)all\(met\)/g,()=>(0,o.segment)("at",{type:"all"}).toString()).replace(/\(met\)here\(met\)/g,()=>(0,o.segment)("at",{type:"here"}).toString()).replace(/\(chn\)(\d+)\(chn\)/g,(s,n)=>o.segment.sharp(n).toString());for(let s of t.kmarkdown.mention_part)r.content=r.content.replace(`(met)${s.id}(met)`,o.segment.at(s.id,{name:s.username}).toString());for(let s of t.kmarkdown.mention_role_part){let n=(0,o.segment)("at",{role:s.role_id,name:s.name});r.content=r.content.replace(`(rol)${s.role_id}(rol)`,n.toString())}r.content=r.content.replace(/\\\*/g,()=>"*").replace(/\\\\/g,()=>"\\").replace(/\\\(/g,()=>"(").replace(/\\\)/g,()=>")"),r.elements=o.segment.parse(r.content)}return r}i(j,"adaptMessageMeta");function G(e,t={}){return j(e,e,t),t.messageId=e.id,t}i(G,"adaptMessage");function H(e,t,r={}){j(e,t,r),r.messageId=e.msg_id,r.timestamp=e.msg_timestamp;let a=e.channel_type==="GROUP"?"group":"private";return r.subtype=a,t.quote&&(r.quote=j(t.quote,t.quote),r.quote.messageId=t.quote.id,r.quote.channelId=r.channelId,r.quote.subtype=a),r}i(H,"adaptMessageSession");function ae(e,t,r){H(e,t,r),r.guildId=t.guild_id,r.channelName=t.channel_name,e.channel_type==="GROUP"?(r.subtype="group",r.channelId=e.target_id):(r.subtype="private",r.channelId=t.code)}i(ae,"adaptMessageCreate");function N(e,t,r){H(e,t,r),r.messageId=t.msg_id,r.channelId=t.channel_id}i(N,"adaptMessageModify");function U(e,t){t.channelId=e.channel_id,t.messageId=e.msg_id,t.userId=e.user_id,t.emoji=e.emoji.id}i(U,"adaptReaction");function $(e,t){let r=e.session();if(t.type===255){let{type:a,body:s}=t.extra;switch(a){case"updated_message":case"updated_private_message":r.type="message-updated",N(t,s,r);break;case"deleted_message":case"deleted_private_message":r.type="message-deleted",N(t,s,r);break;case"added_reaction":case"private_added_reaction":r.type="reaction-added",U(s,r);break;case"deleted_reaction":case"private_deleted_reaction":r.type="reaction-deleted",U(s,r);break;default:return}}else if(r.type="message",ae(t,t.extra,r),!r.content)return;return r}i($,"adaptSession");var we=X(K()),h=(v(),M(d)),ve=new h.Logger("kook"),ye=[6,2,4],k=class extends h.Adapter.WsClient{constructor(){super(...arguments),this._sn=0}async prepare(e){let{url:t}=await e.request("GET","/gateway/index?compress=0"),r={Authorization:`Bot ${e.config.token}`};return e.ctx.http.ws(t,{headers:r})}heartbeat(e){if(!e.socket||e.status!=="online"){clearInterval(this._heartbeat);return}let t=0,r=i(()=>{if(e.socket){if(t>=2)return e.socket.close(1013);e.socket.send(JSON.stringify({s:2,sn:this._sn})),this._ping=setTimeout(r,ye[t++]*h.Time.second)}},"send");r()}async accept(e){this._sn=0,clearInterval(this._heartbeat),e.socket.addEventListener("message",async({data:t})=>{let r;try{r=JSON.parse(t.toString())}catch{return ve.warn("cannot parse message",t)}if(r.s===0){this._sn=Math.max(this._sn,r.sn);let a=$(e,r.d);a&&e.dispatch(a)}else r.s===1?(this._heartbeat=setInterval(()=>this.heartbeat(e),h.Time.minute*.5),Object.assign(e,await e.getSelf()),e.online()):r.s===3?clearTimeout(this._ping):r.s===5&&e.socket.close(1013)})}};i(k,"WsClient");(e=>{e.Config=h.Schema.intersect([h.Schema.object({protocol:h.Schema.const("ws").required(!1),token:h.Schema.string().description("机器人的用户令牌。").role("secret").required()}),h.Adapter.WsClient.Config])})(k||(k={}));var m=(v(),M(d)),ke=new m.Logger("kook"),S=class extends m.Adapter.Server{constructor(e,t){super();let{path:r}=t.config;r=(0,m.sanitize)(r),e.router.post(r,a=>{let{body:s}=a.request;ke.debug("receive %o",s);let{challenge:n}=s.d;if(a.status=200,n){a.body={challenge:n};return}let f=this.bots.find(T=>T.config.verifyToken===s.d.verify_token);if(!f)return;let q=$(f,s.d);q&&f.dispatch(q)})}async start(e){Object.assign(e,await e.getSelf()),e.online()}};i(S,"HttpServer");(e=>{e.Config=m.Schema.object({protocol:m.Schema.const("http").required(),path:m.Schema.string().description("服务器监听的路径。").default("/kook"),token:m.Schema.string().description("机器人的用户令牌。").role("secret").required(),verifyToken:m.Schema.string().description("机器人的验证令牌。").role("secret").required()})})(S||(S={}));var y=(v(),M(d)),V=X(K()),Se=["image","video","audio","file"],b=class extends y.Messenger{constructor(e,t,r,a){super(e,t,r,a),this.params={},this.additional={},this.buffer="",t.length>30?(this.params.chat_code=t,this.path="/user-chat/create-msg"):(this.params.target_id=t,this.path="/message/create")}async post(e,t){try{let r={...this.params,...this.additional,type:e,content:t},a=await this.bot.request("POST",this.path,r),s=this.bot.session();G(a,s),this.results.push(s),s.app.emit(s,"send",s)}catch(r){this.errors.push(r)}}async transformUrl({type:e,attrs:t}){if(["file:","base64:","data:"].some(r=>t.url.startsWith(r))){let r=new V.default,a=await this.bot.ctx.http.file(t.url);r.append("file",P.from(a.data),{filename:t.file||a.filename});let{url:s}=await this.bot.request("POST","/asset/create",r,r.getHeaders());return s}else if(!t.url.includes("kaiheila")){let r=await this.bot.ctx.http.get(t.url,{headers:{accept:e+"/*"},responseType:"stream"}),a=new V.default;a.append("file",r,{filename:"file"});let{url:s}=await this.bot.request("POST","/asset/create",a,a.getHeaders());return s}}async _sendCard(e,t){let r=t?"kmarkdown":"plain-text",a={type:r,content:""},s={type:"card",modules:[]},n=[],f=i(()=>{a.content=a.content.trim(),a.content&&(s.modules.push({type:"section",text:a}),a={type:r,content:""})},"flushText"),q=i(()=>{f(),s.modules.length&&(n.push(s),s={type:"card",modules:[]})},"flushCard");for(let T of e){let{type:g,attrs:l}=T;g==="text"?a.content+=l.content:g==="at"?l.id?a.content+=`@user#${l.id}`:l.type==="all"?a.content+="@全体成员":l.type==="here"?a.content+="@在线成员":l.role&&(a.content+=`@role:${l.role};`):g==="sharp"?a.content+=`#channel:${l.id};`:Se.includes(g)?(f(),await this.transformUrl(T),g==="image"?s.modules.push({type:"image-group",elements:[{type:"image",src:l.url}]}):s.modules.push({type:g,src:l.url})):g==="card"&&(q(),n.push(JSON.parse(l.content)))}q(),await this.post(10,JSON.stringify(n))}async flush(){let e=this.buffer.trim();e&&(await this.post(9,e),this.buffer="",this.additional={})}async visit(e){let{type:t,attrs:r,children:a}=e;if(t==="text")this.buffer+=r.content.replace(/[\\*`~()]/g,"\\$&");else if(t==="b"||t==="strong")this.buffer+="**",await this.render(a),this.buffer+="**";else if(t==="i"||t==="em")this.buffer+="*",await this.render(a),this.buffer+="*";else if(t==="u"||t==="ins")this.buffer+="(ins)",await this.render(a),this.buffer+="(ins)";else if(t==="s"||t==="del")this.buffer+="~~",await this.render(a),this.buffer+="~~";else if(t==="spl")this.buffer+="(spl)",await this.render(a),this.buffer+="(spl)";else if(t==="code")this.buffer+="`",await this.render(a),this.buffer+="`";else if(t==="a")this.buffer+="[",await this.render(a),this.buffer+=`](${r.href})`;else if(t==="p")await this.render(a),this.buffer+=`
`;else if(t==="at")r.id?this.buffer+=`(met)${r.id}(met)`:r.type==="all"?this.buffer+="(met)all(met)":r.type==="here"?this.buffer+="(met)here(met)":r.role&&(this.buffer+=`(rol)${r.role}(rol)`);else if(t==="code")this.buffer+=`\`${e.toString(!0)}\``;else if(t==="sharp")this.buffer+=`(chn)${r.id}(chn)`;else if(["image","video","audio","file"].includes(t)){await this.flush();let s=await this.transformUrl(e);await this.post(A[t],s)}else t==="quote"?(await this.flush(),this.additional.quote=r.id):t==="message"?(await this.flush(),await this.render(a),await this.flush()):await this.render(a)}};i(b,"KookMessenger");(e=>{e.Config=y.Schema.object({handleMixedContent:y.Schema.union([y.Schema.const("separate").description("将每个不同形式的内容分开发送"),y.Schema.const("card").description("使用卡片发送内容"),y.Schema.const("mixed").description("使用混合模式发送内容")]).role("radio").description("发送图文等混合内容时采用的方式。").default("separate")}).description("发送设置")})(b||(b={}));var O=class extends _.Bot{constructor(e,t){super(e,t),this.http=e.http.extend({headers:{Authorization:`Bot ${t.token}`,"Content-Type":"application/json"}}).extend(t),this.internal=new c(this.http),t.protocol==="http"?e.plugin(S,this):t.protocol==="ws"&&e.plugin(k,this)}async request(e,t,r={},a={}){return e==="GET"?(await this.http.get(t,{params:r,headers:a})).data:(r=r instanceof we.default?r:JSON.stringify(r),(await this.http(e,t,{data:r,headers:a})).data)}async sendMessage(e,t,r,a){return new b(this,e,r,a).send(t)}async sendPrivateMessage(e,t,r){let{code:a}=await this.request("POST","/user-chat/create",{target_id:e});return this.sendMessage(a,t,null,r)}async deleteMessage(e,t){e.length>30?await this.request("POST","/user-chat/delete-msg",{msg_id:t}):await this.request("POST","/message/delete",{msg_id:t})}async editMessage(e,t,r){r=_.segment.normalize(r).join(""),e.length>30?await this.request("POST","/user-chat/update-msg",{msg_id:t,content:r}):await this.request("POST","/message/update",{msg_id:t,content:r})}async getMessage(e,t){return e.length>30?G(await this.request("POST","/user-chat/view",{msg_id:t})):G(await this.request("POST","/message/view",{msg_id:t}))}async $createReaction(e,t,r){e.length>30?await this.request("POST","/direct-message/add-reaction",{msg_id:t,emoji:r}):await this.request("POST","/message/add-reaction",{msg_id:t,emoji:r})}async $deleteReaction(e,t,r,a){e.length>30?await this.request("POST","/direct-message/delete-reaction",{msg_id:t,emoji:r}):await this.request("POST","/message/delete-reaction",{msg_id:t,emoji:r,user_id:a})}async getSelf(){let e=B(await this.request("GET","/user/me"));return e.selfId=e.userId,delete e.userId,e}async getGuildList(){let{items:e}=await this.request("GET","/guild/list");return e.map(re)}async getGuildMemberList(e){let{items:t}=await this.request("GET","/guild/user-list",{guild_id:e});return t.map(L)}async setGroupNickname(e,t,r){await this.request("POST","/guild/nickname",{guild_id:e,user_id:t,nickname:r})}async leaveGroup(e){await this.request("POST","/guild/leave",{guild_id:e})}async kickGroup(e,t){await this.request("POST","/guild/kickout",{guild_id:e,user_id:t})}};i(O,"KookBot");(e=>{e.Config=_.Schema.intersect([_.Schema.object({protocol:_.Schema.const("ws").default("ws")}),_.Schema.union([k.Config,S.Config]),b.Config,_.Quester.createConfig("https://www.kookapp.cn/api/v3")])})(O||(O={}));O.prototype.platform="kook";var be=O});var w={};de(w,{default:()=>Oe});p();var ie=D(W(),1);u(w,D(W(),1));var Oe=ie.KookBot;export{Oe as default};
