var at=Object.defineProperty;var yt=Object.getOwnPropertyDescriptor;var _t=Object.getOwnPropertyNames;var bt=Object.prototype.hasOwnProperty;var G=(e,t)=>()=>(e&&(t=e(e=0)),t);var E=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var Y=(e,t,s,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of _t(t))!bt.call(e,n)&&n!==s&&at(e,n,{get:()=>t[n],enumerable:!(i=yt(t,n))||i.enumerable});return e},w=(e,t,s)=>(Y(e,t,"default"),s&&Y(s,t,"default"));var tt=e=>Y(at({},"__esModule",{value:!0}),e);import{Buffer as N}from"https://registry.koishi.chat/modules/buffer/index.js";import M from"https://registry.koishi.chat/modules/process/index.js";var j=G(()=>{});var T={};import*as Tt from"https://registry.koishi.chat/modules/cosmokit/index.js";var ct=G(()=>{j();w(T,Tt)});var ht=E((zt,lt)=>{j();var xt=Object.defineProperty,y=(e,t)=>xt(e,"name",{value:t,configurable:!0}),x=(ct(),tt(T)),ot=Symbol.for("satori.element");function q(e){return e&&typeof e=="object"&&e[ot]}y(q,"isElement");function et(e){if(typeof e=="string"||typeof e=="number"||typeof e=="boolean"){if(e=""+e,e)return A("text",{content:e})}else{if(q(e))return e;if(!(0,x.isNullable)(e))throw new TypeError(`Invalid content: ${e}`)}}y(et,"toElement");function J(e){return Array.isArray(e)?e.map(et).filter(t=>t):[et(e)].filter(t=>t)}y(J,"toElementArray");var L=class{get data(){return this.attrs}toString(e=!1){if(this.type==="text"&&"content"in this.attrs)return e?this.attrs.content:A.escape(this.attrs.content);let t=this.children.map(i=>i.toString(e)).join("");if(e)return t;let s=Object.entries(this.attrs).map(([i,n])=>(0,x.isNullable)(n)?"":(i=(0,x.hyphenate)(i),n===!0?` ${i}`:n===!1?` no-${i}`:` ${i}="${A.escape(""+n,!0)}"`)).join("");return this.children.length?`<${this.type}${s}>${t}</${this.type}>`:`<${this.type}${s}/>`}};y(L,"ElementConstructor");(0,x.defineProperty)(L,"name","Element");(0,x.defineProperty)(L.prototype,ot,!0);function A(e,...t){let s=Object.create(L.prototype),i={},n=[];if(t[0]&&typeof t[0]=="object"&&!q(t[0])&&!Array.isArray(t[0])){let d=t.shift();for(let[h,u]of Object.entries(d))(0,x.isNullable)(u)||(h==="children"?t.push(...(0,x.makeArray)(u)):i[h]=u)}for(let d of t)n.push(...J(d));return Object.assign(s,{type:e,attrs:i,children:n})}y(A,"Element");var vt=new Function("expr","context",`
  try {
    with (context) {
      return eval(expr)
    }
  } catch {}
`);(e=>{e.jsx=e,e.jsxs=e,e.jsxDEV=e,e.Fragment="template";function t(c,r){return typeof c!="string"?J(c):e.parse(c,r)}e.normalize=t,y(t,"normalize");function s(c,r=!1){let o=c.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return r?o.replace(/"/g,"&quot;"):o}e.escape=s,y(s,"escape");function i(c){return c.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#(\d+);/g,(r,o)=>o==="38"?r:String.fromCharCode(+o)).replace(/&#x([0-9a-f]+);/gi,(r,o)=>o==="26"?r:String.fromCharCode(parseInt(o,16))).replace(/&(amp|#38|#x26);/g,"&")}e.unescape=i,y(i,"unescape");function n(c,r={}){var o;let p=C(c);return r.caret?r.type&&((o=p[0])==null?void 0:o.type)!==r.type?void 0:p[0]:u(p,r.type||"*")[0]}e.from=n,y(n,"from");let d=/ *([ >+~]) */g;function h(c){return c.split(",").map(r=>{let o=[];r=r.trim();let p,g=" ";for(;p=d.exec(r);)o.push({type:r.slice(0,p.index),combinator:g}),g=p[1],r=r.slice(p.index+p[0].length);return o.push({type:r,combinator:g}),o})}e.parseSelector=h,y(h,"parseSelector");function u(c,r){if(!c||!r)return[];if(typeof c=="string"&&(c=C(c)),typeof r=="string"&&(r=h(r)),!r.length)return[];let o=[],p=[];for(let[g,b]of c.entries()){let S=[],f=[...r,...o];o=[];let v=!1;for(let l of f){let{type:_,combinator:O}=l[0];(_===b.type||_==="*")&&(l.length===1?v=!0:[" ",">"].includes(l[1].combinator)?S.push(l.slice(1)):l[1].combinator==="+"?o.push(l.slice(1)):r.push(l.slice(1))),O===" "&&S.push(l)}v&&p.push(c[g]),p.push(...u(b.children,S))}return p}e.select=u,y(u,"select");function k(c,r){var o;if(c=c.trim(),!/^[\w.]+$/.test(c))return(o=vt(c,r))!=null?o:"";let p=r;for(let g of c.split("."))if(p=p[g],(0,x.isNullable)(p))return"";return p??""}e.interpolate=k,y(k,"interpolate");let U=/<!--[\s\S]*?-->|<(\/?)([^!\s>/]*)([^>]*?)\s*(\/?)>/,W=/([^\s=]+)(?:="([^"]*)"|='([^']*)')?/g,mt=/([^\s=]+)(?:="([^"]*)"|='([^']*)'|=\{([^}]+)\})?/g,gt=/\{([^}]*)\}/;function C(c,r){let o=[];function p(l){l&&o.push(e("text",{content:l}))}y(p,"pushText");let g=r?mt:W,b;for(;b=U.exec(c);){S(c.slice(0,b.index));let[l,_,O,H,X]=b;if(c=c.slice(b.index+l.length),l.startsWith("<!"))continue;let F={source:l,type:O||e.Fragment,close:_,empty:X,attrs:{}},it;for(;it=g.exec(H);){let[jt,K,ft,nt=ft,rt]=it;rt?F.attrs[(0,x.camelize)(K)]=k(rt,r):(0,x.isNullable)(nt)?K.startsWith("no-")?F.attrs[(0,x.camelize)(K.slice(3))]=!1:F.attrs[(0,x.camelize)(K)]=!0:F.attrs[(0,x.camelize)(K)]=i(nt)}o.push(F)}S(c);function S(l){if(l=l.replace(/^\s*\n\s*/,"").replace(/\s*\n\s*$/,""),r){let _;for(;_=gt.exec(l);){let[O,H]=_;p(i(l.slice(0,_.index))),l=l.slice(_.index+O.length);let X=k(H,r);o.push(...J(X))}}p(i(l))}y(S,"parseContent");let f=[e(e.Fragment)];function v(l){for(;l>0;l--){let{children:_}=f.shift(),{source:O}=f[0].children.pop();f[0].children.push(e("text",{content:O})),f[0].children.push(..._)}}y(v,"rollback");for(let l of o)if(q(l))f[0].children.push(l);else if(l.close){let _=0;for(;_<f.length&&f[_].type!==l.type;)_++;if(_===f.length)f[0].children.push(e("text",{content:l.source}));else{v(_);let O=f.shift();delete O.source}}else{let _=e(l.type,l.attrs);f[0].children.push(_),l.empty||(_.source=l.source,f.unshift(_))}return v(f.length-1),f[0].children}e.parse=C,y(C,"parse");function Q(c,r,o){var p,g;let{type:b,attrs:S,children:f}=c;if(typeof r=="function")return r(c,o);{let v=(g=(p=r[b])!=null?p:r.default)!=null?g:!0;return typeof v=="function"&&(v=v(S,f,o)),v}}y(Q,"visit");function V(c,r,o){let p=typeof c=="string"?C(c):c,g=[];return p.forEach(b=>{let{type:S,attrs:f,children:v}=b,l=Q(b,r,o);l===!0?g.push(e(S,f,V(v,r,o))):l!==!1&&g.push(...t(l))}),typeof c=="string"?g.join(""):g}e.transform=V,y(V,"transform");async function Z(c,r,o){let p=typeof c=="string"?C(c):c,g=(await Promise.all(p.map(async b=>{let{type:S,attrs:f,children:v}=b,l=await Q(b,r,o);return l===!0?[e(S,f,await Z(v,r,o))]:l!==!1?t(l):[]}))).flat(1);return typeof c=="string"?g.join(""):g}e.transformAsync=Z,y(Z,"transformAsync");function I(c,...r){return(...o)=>{let p=e(c);return r.forEach((g,b)=>{(0,x.isNullable)(o[b])||(p.attrs[g]=o[b])}),o[r.length]&&Object.assign(p.attrs,o[r.length]),p}}y(I,"createFactory"),e.warn=y(()=>{},"warn");function B(c){return(r,...o)=>{let p="base64://";return typeof o[0]=="string"&&(p=`data:${o.shift()};base64,`),(0,x.is)("Buffer",r)?r=p+r.toString("base64"):(0,x.is)("ArrayBuffer",r)&&(r=p+(0,x.arrayBufferToBase64)(r)),r.startsWith("base64://")&&(0,e.warn)('protocol "base64:" is deprecated and will be removed in the future, please use "data:" instead'),e(c,{...o[0],url:r})}}y(B,"createAssetFactory"),e.text=I("text","content"),e.at=I("at","id"),e.sharp=I("sharp","id"),e.quote=I("quote","id"),e.image=B("image"),e.video=B("video"),e.audio=B("audio"),e.file=B("file")})(A||(A={}));lt.exports=A});var z={};import*as Ft from"https://registry.koishi.chat/modules/koishi/index.js";var pt=G(()=>{j();w(z,Ft)});var P={};import*as Mt from"https://registry.koishi.chat/modules/fsa-browserify/index.js";var ut=G(()=>{j();w(P,Mt)});var dt=E((Rt,St)=>{St.exports={commands:{dvc:{description:"gpt3.5-turbo或davinci-003",usage:`<>
  <message forward>
    <message id=1> gpt3.5后端参考自Lucent,https://lucent.blog/?p=118 </message>
    <message id=2>自建gpt后端https://github.com/initialencounter/mykoishi/blob/main/davinci-003#readme.md </message>
    <message id=3>对于部署者行为及所产生的任何纠纷， Koishi 及 koishi-plugin-davinci-003 概不负责</message>
    <message id=4>指令如下：</message>
    <message id=5>1.[重置会话] 请发送 "ai 重置会话"</message>
    <message id=6>2.[设置人格] 请发送 "ai 设置人格+人格描述"</message>
    <message id=7>3.[重置人格] 请发送 "ai 重置人格"</message>
    <message id=8>注意：重置会话不会清空人格,重置人格会重置会话!</message>
    <message id=9>设置人格后人格将一直存在，除非重置人格或重启逻辑端!</message>
  </message>
</>`,messages:{censor:"不合规，请检查输入内容是否含有违禁词","no-prompt":"你好！很高兴认识你！",thinking:"思考中……",err:"寄！",total_available:"滴！当前账户的余额为${0}",toolong:"滋滋..猪脑过载",switch:"当前存在人格{0}请输入编号","switch-err":"不存在人格可切换",get:"查询中...",clean:"舒服了"}},count:{description:"减少dvc的使用次数"},"dvc.img":{description:"chat-gpt图片功能"},"dvc.clear":{description:"5级权限-清空所有会话及人格"}}}});var kt=E(m=>{j();var wt=m&&m.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(m,"__esModule",{value:!0});m.logger=m.name=void 0;var $=ht(),a=(pt(),tt(z)),D=wt((ut(),tt(P)));m.name="davinci-003";m.logger=new a.Logger(m.name);var R=class extends a.Service{constructor(t,s){super(t,"dvc",!0),this.config=s,this.key=[5,188,209,154,2,90,41,129,174,177,125,55,77,165,40,97],this.output_type=s.output,this.g_voice_name=s.g_voice_name,this.aliasMap={埃洛伊:[],安柏:[],丽莎:[],菲谢尔:["皇女"],凯亚:[],迪卢克:["卢姥爷","姥爷"],琴:[],诺艾尔:["女仆"],芭芭拉:[],阿贝多:[],班尼特:["班尼哥"],迪奥娜:[],罗莎莉亚:[],莫娜:[],砂糖:[],雷泽:[],温迪:["巴巴托斯","风神"],优菈:[],可莉:[],重云:[],七七:[],烟绯:[],甘雨:[],香菱:[],北斗:[],辛焱:[],行秋:[],胡桃:[],刻晴:[],凝光:[],云堇:[],钟离:["岩神"],夜兰:[],申鹤:[],达达利亚:["公子","鸭鸦"],魈:[],宵宫:[],托马:[],早柚:[],五郎:[],久岐忍:["97忍","97"],九条裟罗:["裟罗"],枫原万叶:["万叶"],雷电将军:["雷神"],神里绫华:["绫华"],神里绫人:["绫人"],珊瑚宫心海:["心海"],鹿野院平藏:["平藏","小鹿"],荒泷一斗:["一斗"],八重神子:["神子"],提纳里:[],赛诺:[],柯莱:[],多莉:[],坎蒂丝:[],妮露:[],珐露珊:[],莱依拉:[],纳西妲:["草神"],流浪者:["散兵"]},this.charMap={};for(let n of Object.keys(this.aliasMap)){this.charMap[n]=n;for(let d of this.aliasMap[n])this.charMap[d]=n}this.openai=new st(s.key,t),this.reg=new RegExp(s.reg),this.sessions_cmd={},this.sessions={},this.access_token="",this.session_config={msg:[{role:"system",content:s.preset}]},!t.puppeteer&&s.output=="verbose"&&m.logger.warn("未启用puppter,将无法发送图片");let i=1;for(;s.alias.length<5;)s.alias.push(`davinci${i}`),i++;try{JSON.parse(D.default.readFileSync("./davinci-003-data.json").toString())}catch{D.default.writeFileSync("./davinci-003-data.json",'{"派蒙":"你是提瓦特大陆最优秀的旅行向导，名字叫“派蒙”,爱好是美食，我是来自异世界旅行者。你将为我的旅程提供向导。"}')}this.personality=JSON.parse(D.default.readFileSync("./davinci-003-data.json").toString()),t.command("dvc.credit").action(async({session:n})=>this.get_credit(n)),t.i18n.define("zh",dt()),t.middleware(async(n,d)=>this.middleware1(n,d)),t.command("dvc.img",{authority:s.authority,maxUsage:s.usage,minInterval:s.minInterval,usageName:"ai"}).action(async({session:n},d)=>this.dvc_img(n,d,s)),t.command("dvc <prompt:text>",{authority:s.authority}).alias(s.alias[0],s.alias[1],s.alias[2],s.alias[3],s.alias[4]).action(async({session:n},d)=>this.dvc(n,d)),t.command("dvc.count","统计次数的工具人",{maxUsage:s.usage,usageName:"ai"}).action(()=>{m.logger.info("usage-1")}),t.command("dvc.clear","清空所有会话及人格",{authority:5}).action(async({session:n})=>this.clear(n)),t.command("dvc.gvc <name>","切换dvc的原神语音角色").action(async(n,d)=>this.switch_gvc(d)),t.command("dvc.output <type:string>","切换dvc的输出方式").action(async(n,d)=>this.switch_output(d))}switch_gvc(t){return t?(t=this.charMap[t],t?(this.g_voice_name=t,"更换声音成功！"):"无法识别角色名。"):"请输入角色名。"}async clear(t){return this.sessions={},t.text("commands.dvc.messages.clean")}async get_token(){if(this.ifgettoken=!0,this.config.AK&&this.config.SK)try{let t={method:"POST",url:"https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id="+this.config.AK+"&client_secret="+this.config.SK};return(await this.ctx.http.axios(t)).data.access_token}catch(t){return m.logger.warn(t.toString()),""}else return""}async dvc_img(t,s,i){try{let n=await this.ctx.http.post(i.endpoint.replace("chat","img"),{msg:s,id:i.resolution,api_key:i.key});return a.segment.image(n.msg[0].content)}catch(n){return m.logger.warn(n),`${t.text("commands.dvc.messages.err")}${String(n)}`}}async dvc(t,s){if(!s)return t.text("commands.dvc.messages.no-prompt");if(t.content.length>this.config.max_tokens)return t.text("commands.dvc.messages.toolong");this.config.waiting&&t.send(t.text("commands.dvc.messages.thinking"));let i=s;if(this.ifgettoken||(this.access_token=await this.get_token()),this.access_token!=""&&await this.censor_request(t.content)==!1)return t.text("commands.dvc.messages.censor");let n=t.userId;if(this.config.superusr.indexOf(n)==-1&&t.execute("dvc.count"),s.slice(0,4)=="设置人格"){let h="小猪";try{h=s.match(this.reg)[0].slice(4,-1)}catch{m.logger.warn("未设置Ai的昵称，可忽略")}if(Object.keys(this.sessions_cmd).indexOf(n)>-1?Object.keys(this.sessions_cmd).forEach((u,k)=>{u.indexOf(n)==-1&&(this.sessions_cmd[k]=n+h)}):this.sessions_cmd[n]=h,h!="小猪"){this.personality[String(h)]=s.slice(4,s.length);try{D.default.writeFileSync("./davinci-003-data.json",JSON.stringify(this.personality))}catch(u){m.logger.warn(u)}}}else if(s.slice(0,4)=="切换人格")if(s.length==4){if(Object.keys(this.personality).length==0)return t.text("commands.dvc.messages.switch-errr");if(Object.keys(this.personality).length>1){let h=`
`;Object.keys(this.personality).forEach((U,W)=>{h+=String(W+1)+" "+U+`
`}),t.send(t.text("commands.dvc.messages.switch",[h]));let u=await t.prompt();if(!u||Number.isNaN(+u))return"请输入正确的序号。";let k=+u-1;if(!Object.keys(this.personality)[k])return"请输入正确的序号。";i="设置人格"+this.personality[Object.keys(this.personality)[k]],this.sessions_cmd[n]=Object.keys(this.personality)[k]}else i="设置人格"+this.personality[Object.keys(this.personality)[0]],this.sessions_cmd[n]=Object.keys(this.personality)[0]}else{let h=s.slice(4,s.length);if(!h||Number.isNaN(+h))return"请输入正确的序号。";let u=+h-1;if(!Object.keys(this.personality)[u])return"请输入正确的序号。";this.personality[Object.keys(this.personality)[u]]&&(i="设置人格"+this.personality[Object.keys(this.personality)[u]],this.sessions_cmd[n]=Object.keys(this.personality)[u])}if(this.config.type=="gpt3.5-js")try{return await this.chat(i,n)}catch(h){return m.logger.warn(h),`${t.text("commands.dvc.messages.err")}${String(h)}`}else if(this.config.type=="gpt3.5")try{let h=await this.ctx.http.post(this.config.endpoint,{msg:i,id:n,api_key:this.config.key});return await this.getContent(t.userId,h)}catch(h){return m.logger.warn(h),`${t.text("commands.dvc.messages.err")}${String(h)}`}else if(this.config.type=="gpt3.5-unit")try{let h=await this.chat_with_gpt([{role:"user",content:s}]),u={msg:[{role:"user",content:s},{role:"assistant",content:h}],id:0};return await this.getContent(t.userId,u)}catch(h){return m.logger.warn(h),`${t.text("commands.dvc.messages.err")}${String(h)}`}let d={engine:this.config.mode,prompt:s,temperature:this.config.temperature,max_tokens:this.config.max_tokens,top_p:1,frequency_penalty:0,presence_penalty:0};try{let h=await this.openai.complete(d),u={msg:[{role:"user",content:s},{role:"assistant",content:h}],id:0};return await this.getContent(t.userId,u)}catch(h){return m.logger.warn(h),`${t.text("commands.dvc.messages.err")}${String(h)}`}}async middleware1(t,s){let i=t.userId;return Object.keys(this.sessions_cmd).indexOf(i)==-1||Object.keys(this.sessions_cmd).forEach((n,d)=>{if(n==i&&t.content.indexOf(this.sessions_cmd[n])==0)return t.content.length==n.length?(t.execute("dvc"),s()):(t.execute(`dvc ${t.content.replace(this.sessions_cmd[n],"")}`),s())}),s()}switch_output(t){return["voice","default","verbose","minimal"].includes(t)?(this.output_type=t,"输出模式切换成功"):"模式错误,当前支持模式'voice'语音,'default'聊天记录,'verbose'图片,'minimal':文字"}async censor_request(t){try{let s={method:"POST",url:"https://aip.baidubce.com/rest/2.0/solution/v1/text_censor/v2/user_defined?access_token="+this.access_token,headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},data:{text:t}};return(await this.ctx.http.axios(s)).data.conclusion!="不合规"}catch(s){return m.logger.warn(String(s)),!0}}async get_credit(t){t.send(t.text("commands.dvc.messages.get"));try{let s="https://chat-gpt.aurorax.cloud/dashboard/billing/credit_grants",i=await this.ctx.http.get(s,{headers:{Authorization:"Bearer "+this.config.key}});return t.text("commands.dvc.messages.total_available",[i.total_available])}catch(s){return m.logger.warn(s),`${t.text("commands.dvc.messages.err")}${String(s)}`}}async getContent(t,s){if(this.output_type=="voice"){let n=await this.ctx.http.get(`https://ai-api.baimianxiao.cn/api/${this.encode(this.g_voice_name)}/${this.encode(s.msg[s.msg.length-1].content)}/0.4/0.6/1.12/${this.encode(Math.floor(Date.now()/1e3).toString())}.ai`,{responseType:"arraybuffer"});return a.h.audio(n,"audio/x-wav")}if(this.output_type=="minimal")return s.msg[s.msg.length-1].content;if(this.output_type=="default"){let n=(0,a.segment)("figure");for(var i of s.msg){if(i.role=="user"){n.children.push((0,a.segment)("message",{userId:t,nickname:i.role},i.content));continue}i.role=="assistant"?n.children.push((0,a.segment)("message",{userId:this.config.selfid,nickname:i.role},i.content)):n.children.push((0,a.segment)("message",{userId:t,nickname:i.role},i.content))}return n}else{let n=[];for(var i of s.msg){if(i.role=="user"){n.push((0,$.jsxs)("div",{style:"color:#723b8d;font-size: 15px;background:transparent;weidth=600px;height:50px,",children:[i.role,":",i.content]}));continue}i.role=="assistant"?n.push((0,$.jsxs)("div",{style:"color:#3b8d4f;font-size: 15px;background:transparent;weidth=600px;height:50px,",children:[i.role,":",i.content]})):n.push((0,$.jsxs)("div",{style:"color:#723b8d;font-size: 20px;background:transparent;weidth=400px",children:["gpt3.5人格设定:",i.content]}))}return(0,$.jsxs)("html",{children:[(0,$.jsx)("img",{style:"-webkit-user-select: none; display: block; margin: auto; padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); cursor: zoom-in;",src:"https://api.dujin.org/bing/m.php",width:"600",height:"1100"}),(0,$.jsxs)("div",{style:"position: absolute;top:20px;left:20px;width:695px;",children:[(0,$.jsx)("p",{style:"color:#723b8d;font-size: 80px",children:"chatgpt3.5-turbo"}),n,(0,$.jsx)("ftooter",{children:"create by koishi-plugin-davinci-003__v1.4.2"})]})]})}}encode(t){return N.from(t).map((s,i)=>s+15%(this.key[i%this.key.length]+i)).toString("hex")}deepClone(t){let s=JSON.stringify(t);return JSON.parse(s)}async chat_with_gpt(t){let s="https://chat-gpt.aurorax.cloud/v1/chat/completions";try{return(await this.ctx.http.axios({method:"post",url:"https://chat-gpt.aurorax.cloud/v1/chat/completions",headers:{Authorization:`Bearer ${this.config.key}`,"Content-Type":"application/json"},data:{model:"gpt-3.5-turbo",temperature:this.config.temperature,max_tokens:this.config.max_tokens,top_p:1,frequency_penalty:0,presence_penalty:0,messages:t}})).data.choices[0].message.content}catch(i){return m.logger.warn(i),{msg:[{role:"",content:String(i)}],id:1}}}get_chat_session(t){if(Object.keys(this.sessions).indexOf(t)==-1){let s=this.deepClone(this.session_config);s.id=t,this.sessions[t]=s}return this.sessions[t]}async chat(t,s){try{if(t=="")return"您好，我是人工智能助手，如果您有任何问题，请随时告诉我，我将尽力回答。\n如果您需要重置我们的会话，请回复`重置会话`";let i=this.get_chat_session(s);if(t.slice(0,4)=="重置会话")return i={msg:[{role:"system",content:i.msg[0]}],id:1},"会话已重置";if(t.slice(0,4)=="重置人格")return i.msg=[{role:"system",content:this.config.preset}],"人格重置成功";if(t.slice(0,4)=="设置人格")return i.msg=[{role:"system",content:t.slice(0,4)}],"人格设置成功";i.msg.push({role:"user",content:t});let n=await this.chat_with_gpt(i.msg);if(n.indexOf("This model's maximum context length is 4096 token")>-1||JSON.stringify(i).length>this.config.max_tokens){if(i.msg.length<2)return"文本过长";i.msg=[i.msg.slice(0,1).concat(i.msg.slice(2,i.msg).length-1)],n=await this.chat(t,s)}return i.msg.push({role:"assistant",content:n}),await this.getContent(s,i)}catch(i){return m.logger.warn(i),{msg:[{role:"sys",content:String(i)}],id:1}}}};(function(e){e.usage=`
## 注意事项
> 使用前在 <a style="color:yellow" href="https://beta.openai.com/account/api-keys">beta.openai.com</a> 中获取api-key<br>
如需使用内容审查,请前往<a style="color:yellow" href="https://ai.baidu.com/solution/censoring?hmsr=aibanner&hmpl=censoring">百度智能云</a> 获取AK和SK</br>
后端模式下，无需代理，服务端需要同步更新至3月8日2点后的版本，否则会报错<br>
<a style="color:yellow" href="https://github.com/initialencounter/mykoishi/blob/main/davinci-003#readme.md">GPT-3.5turbo自建后端教程</a><br>
对于部署者行为及所产生的任何纠纷， Koishi 及 <a style="color:yellow" href="https://github.com/initialencounter/mykoishi">koishi-plugin-davinci-003</a>概不负责。<br>
如果有更多文本内容想要修改，可以在<a style="color:yellow" href="/locales">本地化</a>中修改 zh 内容</br>
GPT-3.5turbo后端参考自<a style="color:yellow" href="https://lucent.blog">Lucent佬(呆呆木)</a><br>
反代api使用的是lucent佬(呆呆木)的，再次感谢！
`,e.Config=a.Schema.intersect([a.Schema.object({type:a.Schema.union([a.Schema.const("gpt3.5").description("GPT-3.5turbo-js,自建后端模式,默认地址为http://127.0.0.1:32336/chat"),a.Schema.const("gpt3.5-js").description("GPT-3.5turbo-js,推荐模式，无需后端"),a.Schema.const("gpt3.5-unit").description("GPT-3.5turbo-unit,超级节俭模式，无需后端，"),a.Schema.const("davinci-003").description("davici等旧模型,无需后端")]).default("gpt3.5-js").description("模型选择")}).description("基础设置"),a.Schema.union([a.Schema.object({type:a.Schema.const("gpt3.5-unit")}),a.Schema.object({type:a.Schema.const("gpt3.5-js")}),a.Schema.object({type:a.Schema.const("gpt3.5"),endpoint:a.Schema.string().description("API 服务器地址。").required()}),a.Schema.object({type:a.Schema.const("davinci-003"),temperature:a.Schema.number().description("偏题程度").default(0),mode:a.Schema.union([a.Schema.const("text-davinci-003").description("语言相关text-davinci-003"),a.Schema.const("text-curie-001").description("语言相关text-curie-001"),a.Schema.const("text-babbage-001").description("语言相关text-babbage-001"),a.Schema.const("text-ada-001").description("语言相关text-ada-001"),a.Schema.const("code-cushman-001").description("代码相关code-cushman-001"),a.Schema.const("code-davinci-003").description("代码相关code-davinci-003")]).description("模型选择").default("text-davinci-003")})]),a.Schema.object({key:a.Schema.string().description("api_key").required(),AK:a.Schema.string().description("百度智能云内容审核AK"),SK:a.Schema.string().description("内容审核SK防止api-key被封"),selfid:a.Schema.string().description("聊天记录头像的QQ号").default("3118087750"),preset:a.Schema.string().description("预设人格").default("你是提瓦特大陆最优秀的旅行向导，名字叫“派蒙”,爱好是美食，我是来自异世界旅行者。你将为我的旅程提供向导。"),reg:a.Schema.string().default("名字[是|叫]“[^,]+”").description("匹配人格的正则表达式"),waiting:a.Schema.boolean().default(!0).description("消息反馈，会发送思考中..."),max_tokens:a.Schema.number().description("请求长度").default(1024),authority:a.Schema.number().description("允许使用的最低权限").default(1),superusr:a.Schema.array(String).default(["3118087750"]).description("可以无限调用的用户,使用特殊指令super"),usage:a.Schema.computed(a.Schema.number()).description("每人每日可用次数").default(100),minInterval:a.Schema.computed(a.Schema.number()).default(5e3).description("连续调用的最小间隔,单位毫秒。"),alias:a.Schema.array(String).default(["davinci","达芬奇","ai"]).description("触发命令;别名"),g_voice_name:a.Schema.string().description("语音模式角色").default("甘雨"),resolution:a.Schema.union([a.Schema.const("256x256").description("256x256"),a.Schema.const("512x512").description("512x512"),a.Schema.const("1024x1024").description("1024x1024")]).default("1024x1024").description("生成图像的默认比例"),output:a.Schema.union([a.Schema.const("minimal").description("只发送文字消息"),a.Schema.const("default").description("以聊天记录形式发送"),a.Schema.const("verbose").description("将对话转成图片"),a.Schema.const("voice").description("发送语音")]).description("输出方式。").default("default")}).description("进阶设置")])})(R||(R={}));var st=class{constructor(t,s){this._api_key=t,this.ctx=s}async _send_request(t,s,i){let n=u=>u.replace(/([A-Z])/g," $1").split(" ").join("_").toLowerCase(),d={};for(let u in i)d[n(u)]=i[u];return(await this.ctx.http.axios({url:t,headers:{Authorization:`Bearer ${this._api_key}`,"Content-Type":"application/json"},data:Object.keys(d).length?d:"",method:s})).data.choices[0].text}async complete(t){let s=`https://chat-gpt.aurorax.cloud/v1/engines/${t.engine}/completions`;return delete t.engine,await this._send_request(s,"post",t)}};m.default=R});export default kt();
